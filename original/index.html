<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Go Faster</title>
  <link href="stylesheet.css" rel="stylesheet" />
</head>
<body dir="" class="markua010">
<div id="leanpub-toc">
<h2>Table of Contents</h2>
<ol class="toc">
<ul class='toc no-parts'>
  <li>
    <a href='#leanpub-auto-preface'>Preface</a>
  </li>
  <li>
    <a href='#leanpub-auto-about-this-book'>About this book</a>
  </li>
  <li>
    <a href='#leanpub-auto-about-the-author'>About the Author</a>
  </li>
  <li>
    <a href='#leanpub-auto-before-you-begin'>Before you begin</a>
  </li>
  <li>
    <a href='#leanpub-auto-chapter-1---introduction-to-go'>Chapter 1 - Introduction to Go</a>
    <ul>
      <li>
        <a href='#leanpub-auto-why-go'>1.1 Why Go?</a>
      </li>
      <li>
        <a href='#leanpub-auto-language-semantics'>1.2 Language semantics</a>
      </li>
      <li>
        <a href='#leanpub-auto-visibility'>1.3 Visibility</a>
      </li>
      <li>
        <a href='#leanpub-auto-comments-and-documentation'>1.4 Comments and documentation</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-chapter-2---the-go-command-line-interface-cli'>Chapter 2 - The Go command line interface (CLI)</a>
    <ul>
      <li>
        <a href='#leanpub-auto-version-information'>2.1 Version information</a>
      </li>
      <li>
        <a href='#leanpub-auto-environment-information'>2.2 Environment information</a>
      </li>
      <li>
        <a href='#leanpub-auto-module-and-workspace-management'>2.3 Module and workspace management</a>
      </li>
      <li>
        <a href='#leanpub-auto-format-your-code'>2.4 Format your code</a>
      </li>
      <li>
        <a href='#leanpub-auto-testing'>2.5 Testing</a>
      </li>
      <li>
        <a href='#leanpub-auto-cleanup'>2.6 Cleanup</a>
      </li>
      <li>
        <a href='#leanpub-auto-downloading-packages'>2.7 Downloading packages</a>
      </li>
      <li>
        <a href='#leanpub-auto-running-a-program'>2.8 Running a program</a>
      </li>
      <li>
        <a href='#leanpub-auto-building-your-program'>2.9 Building your program</a>
      </li>
      <li>
        <a href='#leanpub-auto-building-for-other-operating-systems-and-architectures'>2.10 Building for other operating systems and architectures</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-chapter-3---structure-of-a-go-program'>Chapter 3 - Structure of a Go program</a>
    <ul>
      <li>
        <a href='#leanpub-auto-packages-and-importing'>3.1 Packages and importing</a>
      </li>
      <li>
        <a href='#leanpub-auto-main-and-init-functions'>3.2 Main and Init functions</a>
      </li>
      <li>
        <a href='#leanpub-auto-developing-a-package'>3.3 Developing a package</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-chapter-4---project-organisation'>Chapter 4 - Project organisation</a>
    <ul>
      <li>
        <a href='#leanpub-auto-the-internal-folder'>4.1 The internal folder</a>
      </li>
      <li>
        <a href='#leanpub-auto-the-cmd-folder'>4.2 The cmd folder</a>
      </li>
      <li>
        <a href='#leanpub-auto-the-pkg-folder'>4.3 The pkg folder</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrapping-it-up'>4.4 Wrapping it up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-chapter-5---dependency-management'>Chapter 5 - Dependency management</a>
    <ul>
      <li>
        <a href='#leanpub-auto-modules'>5.1 Modules</a>
      </li>
      <li>
        <a href='#leanpub-auto-workspaces'>5.2 Workspaces</a>
      </li>
      <li>
        <a href='#leanpub-auto-vendoring'>5.3 Vendoring</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-chapter-6---variables-and-constants'>Chapter 6 - Variables and constants</a>
    <ul>
      <li>
        <a href='#leanpub-auto-variables'>6.1 Variables</a>
      </li>
      <li>
        <a href='#leanpub-auto-constants'>6.2 Constants</a>
      </li>
      <li>
        <a href='#leanpub-auto-scope'>6.3 Scope</a>
      </li>
      <li>
        <a href='#leanpub-auto-variable-semantics-pointers-and-values'>6.4 Variable semantics. Pointers and values</a>
      </li>
      <li>
        <a href='#leanpub-auto-value-initialisation'>6.5 Value initialisation</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-chapter-7---data-types'>Chapter 7 - Data types</a>
    <ul>
      <li>
        <a href='#leanpub-auto-basic-types'>7.1 Basic types</a>
      </li>
      <li>
        <a href='#leanpub-auto-aggregate-types'>7.2 Aggregate types</a>
      </li>
      <li>
        <a href='#leanpub-auto-reference-types'>7.3 Reference types</a>
      </li>
      <li>
        <a href='#leanpub-auto-interface-types'>7.4 Interface types</a>
      </li>
      <li>
        <a href='#leanpub-auto-creating-custom-types'>7.5 Creating custom types</a>
      </li>
      <li>
        <a href='#leanpub-auto-converting-between-types'>7.6 Converting between types</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-chapter-8---managing-program-flow'>Chapter 8 - Managing program flow</a>
    <ul>
      <li>
        <a href='#leanpub-auto-control-structures'>8.1 Control structures</a>
      </li>
      <li>
        <a href='#leanpub-auto-error-handling'>8.2 Error handling</a>
      </li>
      <li>
        <a href='#leanpub-auto-logging'>8.3 Logging</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-chapter-9---digging-deeper'>Chapter 9 - Digging deeper</a>
    <ul>
      <li>
        <a href='#leanpub-auto-developing-with-functions'>9.1 Developing with functions</a>
      </li>
      <li>
        <a href='#leanpub-auto-memory-management'>9.2 Memory management</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-receivers-with-custom-types'>9.3 Using receivers with custom types</a>
      </li>
      <li>
        <a href='#leanpub-auto-working-with-interfaces'>9.4 Working with interfaces</a>
      </li>
      <li>
        <a href='#leanpub-auto-type-assertion-and-reflection'>9.5 Type assertion and reflection</a>
      </li>
      <li>
        <a href='#leanpub-auto-introducing-generics'>9.6 Introducing Generics</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-chapter-10---concurrency'>Chapter 10 - Concurrency</a>
    <ul>
      <li>
        <a href='#leanpub-auto-goroutines'>10.1 Goroutines</a>
      </li>
      <li>
        <a href='#leanpub-auto-context'>10.2 Context</a>
      </li>
      <li>
        <a href='#leanpub-auto-blocking-execution-with-waitgroups'>10.3 Blocking execution with waitgroups</a>
      </li>
      <li>
        <a href='#leanpub-auto-sharing-variables-using-mutexes'>10.4 Sharing variables using mutexes</a>
      </li>
      <li>
        <a href='#leanpub-auto-communicating-with-channels'>10.5 Communicating with channels</a>
      </li>
      <li>
        <a href='#leanpub-auto-summary-2'>10.6 Summary</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-chapter-11---quality-assurance'>Chapter 11 - Quality Assurance</a>
    <ul>
      <li>
        <a href='#leanpub-auto-testing-1'>11.1 Testing</a>
      </li>
      <li>
        <a href='#leanpub-auto-benchmarking'>11.2 Benchmarking</a>
      </li>
      <li>
        <a href='#leanpub-auto-profiling'>11.3 Profiling</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-glossary'>Glossary</a>
  </li>
</ul>

</ol>
</div>
<div id="leanpub-main" class="markua010">
<h1 id="leanpub-auto-preface" class="chapter">Preface</h1>

<p><i>When I started learning Go I was productive with the language fairly quickly. After only a short time I could build fast, safe and stable applications which could run anywhere. Before long I was choosing Go in preference to PHP and Node JS - the other languages I’d been developing with - whenever possible.</i> </p>

<p><i>I continued my journey with Go and learned more as I went, but often, I’d find myself in a bind - Golang wouldn’t do what I wanted it to. I’d find workarounds sure, but they often seemed clunky. As I tackled more advanced problems this happened more frequently and at times it seemed like I couldn’t achieve what I wanted with Go at all!</i></p>

<p><i>After facing many of these challenges, I realised the actual problem wasn’t with Go, but with my knowledge. For one thing, I found I sometimes didn’t understand how Go wanted me to solve a problem - in the idiomatic ‘Go’ way. Other times, I discovered I had missed some of the more nuanced detail about a topic, which on the surface had appeared straightforward.</i> </p>

<p><i>In a nutshell, I had quickly acquired a core of knowledge about Go - enough to write programs - but I had limited understanding of what was happening under the hood when the compiler took my code off me and ran it.</i></p>

<p><i>So I decided to try cementing my understanding by teaching Go to others via a weekly Blog and on-site training sessions under the <a href="https://golangatspeed.com">GolangAtSpeed</a> brand.  Both aimed to discover and expose what I called “the longtail of Go”: the less obvious parts, the quirky idioms and the gotchas, the things that may catch other developers out too.</i></p>

<p><i>Covid-19 brought a premature end to the on-site training and the blog mostly fizzled out due to me jumping back into contract Go development at a time of uncertainty. But, I promised myself (and some blog readers) that I’d write a book on the same theme and, almost three years later, here it is!</i></p>

<p><i>Before you jump into the book itself, I want to thank you for purchasing it. I sincerely hope you enjoy it and get much value from it. I also hope you enjoy your journey with Go as much as I have my own, and that my book does indeed help you get there faster!</i></p>

<p><i>Finally, my learning journey is not yet complete, I’m simply sharing what I know in Go Faster because I think it may help others. So, if you have any feedback or spot any mistakes, please do reach out to me. In doing so you’ll help me improve the book for others who follow you!</i></p>

<p><i>Best wishes,</i></p>

<p><i>Ollie</i></p>


<h1 id="leanpub-auto-about-this-book" class="chapter">About this book</h1>

<p><i>Go Faster</i> is a book for those wanting to learn the Golang programming language. Though many great books have been published on this subject with the same aim, <i>Go Faster</i> takes a slightly different approach. </p>

<p>For starters, it recognises that Go is a relatively simple language with just 25 keywords and that most developers do not struggle to learn its limited syntax. </p>

<p>It acknowledges that most readers will be able to set up a Golang development environment using one of the operating system-specific binaries, without needing detailed instruction.</p>

<p>It recognises that most readers will have a basic level of programming knowledge already - possibly even prior experience with Go - but that that knowledge may differ, depending on their route into programming and the languages they have used to-date.</p>

<p>The examples in <i>Go Faster</i> are simple by design. There are no real world or useful applications, instead, all the non-essential code is stripped away to help the user see the principles being demonstrated and grasp the concepts.</p>

<p><i>Go Faster</i> is designed to assist developers coming from object-oriented programming. It elaborates in areas which can confuse since the Go programming paradigm is different than that of OOP. And like Go itself, <i>Go Faster</i> is opinionated with its semantics.</p>

<p>The book also covers features which are relatively new to the language. Features that many developers, even experienced ones, may not yet be familiar with, and many existing texts may not yet explore, such as Generics and Workspaces.</p>

<p>Finally, <i>Go Faster</i> reflects the author’s own journey learning Go and is laid out accordingly.  Not as an A-to-Z style reference, but in a way that should enable understanding earlier, laying solid building blocks on which the reader can progress.</p>

<p>If the author was learning Go again, this is the way they would structure their learning path, and hopefully, it is this structure which helps users at all levels gain a solid understanding of Go, quickly.</p>


<h1 id="leanpub-auto-about-the-author" class="chapter">About the Author</h1>

<p>Ollie Phillips is a Software Developer based in the United Kingdom. </p>

<p>Over the previous 8 years, he has worked with Go in various domains including Finance, Health, Learning Management and Cloud Automation. Most recently he was building tooling in Go for the <i>Morpheus Cloud Management Platform</i>. </p>

<p>He is also the author of the <a href="https://golangatspeed.com/">GolangAtSpeed</a> substack blog and is passionate about Go and helping others get productive with it.</p>


<h1 id="leanpub-auto-before-you-begin" class="chapter">Before you begin</h1>

<p>Some pointers to help you get the most from <i>Go Faster</i></p>

<h3 id="leanpub-auto-go-playground" class="subsection">Go Playground</h3>

<p>Throughout <i>Go Faster</i> we use example code which in most cases is also provided as executable snippets on the Go Playground.  You can also use the playground to test your code if you don’t have a local development environment. You can find it here:</p>

<p>https://go.dev/play/</p>

<p>All the examples, listed by chapter can also be found on Github here:</p>

<p>https://github.com/golangatspeed/GoFasterExamples</p>

<h3 id="leanpub-auto-installing-go" class="subsection">Installing Go</h3>

<p>If you do want to set up your local environment, you’ll need to download and install a recent version of Go. </p>

<p>At the time of writing the latest version is 1.19. You can get a distribution for your operating system here:</p>

<p>https://go.dev/dl/</p>

<h3 id="leanpub-auto-editing-code-locally" class="subsection">Editing code locally</h3>

<p>You’ll have more fun writing Go in a text editor which offers Go-specific helper functions such as code completion, formatting and automatic imports. </p>

<p>Either <i>Visual Studio Code</i> - with the appropriate plugins - or <i>Goland</i> which has full Go support out-of-the-box, is recommended. </p>

<p>There are links to download pages for both applications below.</p>

<ul>
  <li>Visual Studio Code - https://code.visualstudio.com/download</li>
  <li>Goland - https://www.jetbrains.com/go/</li>
</ul>

<h3 id="leanpub-auto-a-word-on-the-code-examples" class="subsection">A word on the code examples</h3>

<p><i>Go Faster</i> was written on <i>macOS</i>, so many of the command line examples will contain Mac/Linux-specific syntax. For example, directory paths are Mac/Linux style and not Windows style.</p>


<h1 id="leanpub-auto-chapter-1---introduction-to-go" class="chapter">Chapter 1 - Introduction to Go</h1>

<p>In this chapter, we’ll cover some essentials. First, we’ll lay out a quick introduction to Go explaining what makes it attractive as a programming language, then we’ll address some broader Go concepts and terminology that we will make use of as we progress.</p>

<h2 id="leanpub-auto-why-go" class="section">1.1 Why Go?</h2>

<p>Go, or Golang is a programming language developed by a team at Google.  Similar to C (or Clang), it draws inspiration from many other programming languages also.</p>

<p>Go is a high-performance language which runs directly against physical machine resources and not on a virtual machine, unlike Java for example. Further, asynchronous programming via concurrency and goroutines can fully utilise the multiple cores of modern CPUs better than many other multi-threaded languages.</p>

<p>Go is a compiled language. Your program code is built into an OS-specific executable and not interpreted at runtime. It is statically typed, so types are known - and fixed - at compile time. Memory management in Go is for the most part automatic. Memory allocation is done for us as required, and memory is deallocated when no longer in use via a <i>garbage collection</i> process. Together these traits help to eliminate many common programming errors.</p>

<p>Go is opinionated on many things, one of which is formatting. This opinion, together with its simple syntax, results in very readable and clear code.  Go has a complete suite of built-in tooling which includes utilities for testing, building, profiling and more. It is the readable code and powerful tooling which attract many developers to the language.</p>

<p>In version 1.11 Go modules were introduced for dependency management and are now the defacto approach.</p>

<p>In version 1.18 the hotly debated Generics feature was introduced together with Go workspaces.</p>

<h2 id="leanpub-auto-language-semantics" class="section">1.2 Language semantics</h2>

<p>Go is not <i>object-oriented</i> although it feels similar at times. </p>

<p>Possibly because of that similarity, or more likely familiarity with object-oriented programming (OOP) in general, developers often find themselves conversing about Go using <i>object-oriented</i> semantics which are often not appropriate to Go. </p>

<p>You may see and hear terms like <i>instance</i>, <i>object</i> and <i>method</i> - even <i>inheritance</i> - being used in the context of Go code, and while it sort of works, it is mostly incorrect.</p>

<p>Better we establish the right Go terminology early on and use it. Especially as the correct semantics can help us understand what Go is doing differently from OOP-based languages.</p>

<p>For example, while OOP has <i>inheritance</i>, Go has <i>composition</i> and <i>embedding</i>. There’s an overlap between these approaches but they are not the same thing.</p>

<p>Go does not have <i>objects</i> or <i>instances</i>, neither does it have <i>methods</i> in the OOP sense. Instead, we have <i>receivers</i> (or <i>receiver functions</i>), so named because they <i>receive</i> the value (or the address of the value) of the type on which they are bound. While conceptually similar to <i>methods</i>, Go <i>receivers</i> can be bound to any user-defined type, they are not constrained to a <i>class</i> hierarchy.</p>

<p>That said, <i>receivers</i> and <i>methods</i> are terms that are used interchangeably in Go. I generally use the term <i>receivers</i> and will do it exclusively throughout <i>Go Faster</i>, purely to break the link with OOP and class-based property access.</p>

<p>Like OOP, Go has <i>interfaces</i> - a very powerful aspect of the language when used appropriately - and of course, we have <i>functions</i>.</p>

<p>In Go, everything is a value. Even <i>pointers</i> are just a value, that value being the <i>address</i> of another value in memory. There’s no magic, but this concept is core to understanding how to work with values and pointers and avoid some common mistakes.</p>

<p>Errors are just values too, Go does not have exceptions. Errors must be checked and handled in your code, which despite being a little verbose and repetitive, contributes greatly to readability and comprehension.  </p>

<p>So, Go has some specific terminology such as <i>types</i>, <i>receivers</i> and <i>pointers</i> and we should use these. For anything else, it is more correct to refer to it as a <i>value</i> of something and not an <i>instance</i> of something - or indeed an <i>object</i>. </p>

<p>There’s quite a lot to unpack there, but don’t worry we will cover all of the above in more detail as we progress.</p>

<h2 id="leanpub-auto-visibility" class="section">1.3 Visibility</h2>

<p>Unlike <i>object-oriented programming</i>, Go does not have the concept of <i>public</i> and <i>private</i>. Instead, it uses the notion of <i>exported</i> and <i>unexported</i> visibility modifiers.</p>

<p>Any <i>variable</i>, <i>constant</i>, <i>function</i>, <i>receiver</i>, <i>type</i> or indeed <i>struct field</i>, declared with a lowercase first letter in its name, is considered <i>unexported</i> and cannot be directly accessed outside of its package namespace. </p>

<p>The same, when capitalised, is considered to be <i>exported</i> and fully visible to the code that imports the package. </p>

<p>The example code below illustrates the principle when applied to types, variables, functions and struct fields.  Note the exported struct field in the unexported struct type at line 9 which is a bit odd: an exported field on an unexported struct would appear to be completely redundant. </p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 1 - Visibility modifiers</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">exporting</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="n">type</code> <code class="n">ExportedStruct</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 4 </code>	<code class="n">unexportedField</code> <code class="n">string</code> 
<code class="linenos"> 5 </code>	<code class="n">ExportedField</code>   <code class="n">string</code>
<code class="linenos"> 6 </code><code class="p">}</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">type</code> <code class="n">unexportedStruct</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">ExportedField</code> <code class="n">string</code> <code class="o">//</code> <code class="n">how</code> <code class="k">is</code> <code class="n">this</code> <code class="n">useful</code><code class="err">?</code>
<code class="linenos">10 </code><code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="k">var</code> <code class="n">ExportedVariable</code> <code class="n">string</code>
<code class="linenos">13 </code><code class="k">var</code> <code class="n">unexportedVariable</code> <code class="n">string</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="k">func</code> <code class="n">ExportedFunc</code><code class="p">()</code> <code class="p">{</code> <code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="k">func</code> <code class="n">unexportedFunc</code><code class="p">()</code> <code class="p">{</code> <code class="p">}</code>
</pre></div>

</figure>


<p>Well, it is redundant when it comes to exporting that field outside of the package because the struct itself is unexported, but you may often see code written like this, simply because there is a need to perform some type of conversion of that struct field into an alternative data format, such as JSON. </p>

<p>We call this conversion process <i>marshalling</i> and Go will only <i>marshal</i> exported struct fields when creating the output. Unexported struct fields are ignored.</p>

<p>Why does <i>unexported</i> not mean <i>private</i>? Because unexported values can still be made available outside of the package. For example, there is nothing which prevents an exported function or receiver from returning an unexported value from the package namespace to the caller. While code like this can be a source of confusion, so it is not recommended practice, it’s perfectly possible to do this.</p>

<p>So when building packages for others to use, we should make decisions about <i>exporting</i> and <i>unexporting</i>, not on a need for concealment, but instead as a way of communicating which parts of our package should comprise the API that developers use, and which parts should not.</p>

<h2 id="leanpub-auto-comments-and-documentation" class="section">1.4 Comments and documentation</h2>

<p>The single-line and multi-line comment styles of Go are probably already familiar and are used in many languages inspired by C. See the example below.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 2 - Comment styles</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="k">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 4 </code>	<code class="o">//</code> <code class="n">This</code> <code class="k">is</code> <code class="n">a</code> <code class="n">single</code><code class="o">-</code><code class="n">line</code> <code class="n">comment</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code>	<code class="o">/*</code>
<code class="linenos"> 7 </code>		<code class="n">This</code> <code class="k">is</code> <code class="n">a</code> <code class="n">multi</code><code class="o">-</code><code class="n">line</code> <code class="n">comment</code>
<code class="linenos"> 8 </code>		<code class="n">which</code> <code class="n">spans</code> <code class="n">more</code> <code class="n">than</code> <code class="n">one</code>
<code class="linenos"> 9 </code>		<code class="n">line</code><code class="o">.</code>
<code class="linenos">10 </code>	<code class="o">*/</code>
<code class="linenos">11 </code><code class="p">}</code>
</pre></div>

</figure>


<p>For comments to be useful, they should be concise and precise and must be updated in line with the code. Stale comments which are not maintained with the codebase, detract from the code and may even confuse matters.</p>

<p>In Go, comments are especially useful since they are used to generate documentation. Developers write comments inline which then automatically form the basis of their software’s instruction manual. </p>

<p>The documentation itself is built from the code comments using a command line tool called <i>Godoc</i>. We’ll cover installing and using the tool shortly, but first, let’s outline some <i>standards</i> to help you get the most from the <i>Godoc</i> tool.</p>

<h3 id="leanpub-auto-comment-standards" class="subsection">1.4.1 Comment standards</h3>

<ol>
  <li>All exported functionality of a package is expected to have a comment. The comment should start with the <i>function</i>, <i>variable</i> or <i>type</i> name for which it is written, and should succinctly explain its purpose. Only comments in this format on exported functionality will be used to build documentation.</li>
  <li>The package itself should include a comment above the package name, which provides an overview of what the package does. This is used in the Overview section of the built documentation.</li>
  <li>Links can be included in comments via an absolute URL which includes the schema e.g. HTTPS. Relative URLs are ignored. The <i>Godoc</i> tool will parse and include links which meet the requirements in the documentation. </li>
  <li>Comments separated by a commented blank line will be interpreted as paragraphs and output as such in the package documentation.</li>
</ol>

<p>The example below shows a package with these requirements satisfied. The code is unimportant for the moment.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 3 - Making the most of comments in documentation</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">//</code> <code class="n">Package</code> <code class="n">user</code> <code class="n">implements</code> <code class="n">functionality</code> <code class="k">for</code> <code class="n">working</code> <code class="n">with</code> <code class="n">users</code><code class="o">.</code>
<code class="linenos"> 2 </code><code class="o">//</code>
<code class="linenos"> 3 </code><code class="o">//</code> <code class="n">This</code> <code class="n">content</code> <code class="n">will</code> <code class="n">be</code> <code class="ow">in</code> <code class="n">a</code> <code class="n">new</code> <code class="n">paragraph</code><code class="o">.</code>
<code class="linenos"> 4 </code><code class="n">package</code> <code class="n">user</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="o">//</code> <code class="n">User</code> <code class="k">is</code> <code class="n">a</code> <code class="n">representation</code> <code class="n">of</code> <code class="n">a</code> <code class="n">single</code> <code class="n">user</code>
<code class="linenos"> 7 </code><code class="n">type</code> <code class="n">User</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="n">Name</code> <code class="n">string</code>
<code class="linenos"> 9 </code><code class="p">}</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="o">//</code> <code class="n">NewUser</code> <code class="k">is</code> <code class="n">a</code> <code class="n">factory</code> <code class="n">that</code> <code class="n">allows</code> <code class="n">us</code> <code class="n">to</code> <code class="n">configure</code> <code class="n">the</code> <code class="n">properties</code>
<code class="linenos">12 </code><code class="o">//</code> <code class="n">of</code> <code class="n">a</code> <code class="n">new</code> <code class="n">User</code><code class="o">.</code>
<code class="linenos">13 </code><code class="o">//</code>
<code class="linenos">14 </code><code class="o">//</code> <code class="n">See</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">someurl</code><code class="o">.</code><code class="n">com</code> <code class="k">for</code> <code class="n">more</code> <code class="n">information</code><code class="o">.</code>
<code class="linenos">15 </code><code class="k">func</code> <code class="n">NewUser</code><code class="p">(</code><code class="n">name</code> <code class="n">string</code><code class="p">)</code> <code class="o">*</code><code class="n">User</code> <code class="p">{</code>
<code class="linenos">16 </code>	<code class="k">return</code> <code class="o">&amp;</code><code class="n">User</code><code class="p">{</code>
<code class="linenos">17 </code>		<code class="n">name</code><code class="p">:</code> <code class="n">name</code><code class="p">,</code>
<code class="linenos">18 </code>	<code class="p">}</code>
<code class="linenos">19 </code><code class="p">}</code>
</pre></div>

</figure>


<h3 id="leanpub-auto-installing-and-using-godoc" class="subsection">1.4.2 Installing and using Godoc</h3>

<p><i>Godoc</i> is an external package which can be downloaded and installed using the Go tool. Assuming you have installed Go locally, the following command will fetch the latest version of the package and install it in your workspace.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go install golang.org/x/tools/cmd/godoc@latest
</pre></div>

</figure>


<p>Once installed, the tool can display documentation for the Go standard library - useful when offline - from any terminal window with this command.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>godoc
</pre></div>

</figure>


<p>The command starts a document server on http://localhost:6060. You can specify a different port if 6060 is in use.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>godoc -http<code class="o">=</code>:9090
</pre></div>

</figure>


<p>For more information on using <i>Godoc</i> run the command with the help flag.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>godoc -h
</pre></div>

</figure>


<p>You can also preview how your code comments will appear as documentation using <i>Godoc</i>. For any package with <i>Go Modules</i> support, simply navigate to the folder which contains <code>go.mod</code> in a terminal window and run <i>Godoc</i>. </p>

<p>The documentation for the package will be created and listed under the “Third Party” section in the documentation server’s index.</p>

<h3 id="leanpub-auto-including-example-code" class="subsection">1.4.3 Including example code</h3>

<p>We can include code examples as part of the generated documentation. These appear as text “code” and “output” sections in the documentation. However, if you run <i>Godoc</i> with the <code>-play</code> option, any such examples become interactive. </p>

<p>When interactive, not only can you run code snippets on the Go Playground using the additional <i>Play</i> button which appears top right, but all examples included in the documentation become executable - and editable - programs and not just static text.  This is a really useful feature when learning about the standard library.</p>

<p><i>Godoc</i> examples are actually a type of test, and they are run and verified like other tests.  We cover testing later in the book, but just like other tests, examples must reside in files named with the <code>_test.go</code> suffix. </p>

<p>Within those files, examples are differentiated from normal tests as the function names use the <code>Example</code> and not the <code>Test</code> prefix as shown in the following example taken from the standard library <i>stringutil</i> package.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 4 - An example function</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">stringutil_test</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>    <code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code>    <code class="s2">"golang.org/x/example/stringutil"</code>
<code class="linenos"> 7 </code><code class="p">)</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">func</code> <code class="n">ExampleReverse</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">10 </code>    <code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">stringutil</code><code class="o">.</code><code class="n">Reverse</code><code class="p">(</code><code class="s2">"hello"</code><code class="p">))</code>
<code class="linenos">11 </code>    <code class="o">//</code> <code class="n">Output</code><code class="p">:</code> <code class="n">olleh</code>
<code class="linenos">12 </code><code class="p">}</code>
</pre></div>

</figure>


<p>Examples do not contain assertions normally associated with unit tests which determine pass or fail. Instead, they contain a commented <code>Output</code> line.</p>

<p>The Go test tool checks the actual output of an example function against the output which is on this line. If it matches it passes, if not it fails.</p>

<p>This is a useful and overlooked feature when you need to make assertions on functionality which outputs to Stdout.  You can use an <i>Example</i> to check it, there’s no need to pipe or redirect the output to a file or variable to compare it.</p>

<p>The online <a href="https://pkg.go.dev">Go package repository</a> hosts documentation in interactive mode, so you can also experiment with example code there.</p>


<h1 id="leanpub-auto-chapter-2---the-go-command-line-interface-cli" class="chapter">Chapter 2 - The Go command line interface (CLI)</h1>

<p>When you download Go you get the Go standard library packages and the Go CLI which is a tool for managing Go source code.  You’ll use it for much of what you do with Go, with one or two exceptions, for example, <i>Godoc</i> as we’ve seen.</p>

<p>Exploring all the functionality of the <i>Go</i> CLI is left as an exercise for the reader, this section aims to show you how to get started with the tool and highlight specific commands you’ll use most often.</p>

<p>You can list all the top-level options of the Go tool using this command.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go <code class="nb">help</code>
</pre></div>

</figure>


<p>If you want to get more help for a specific option use the same command followed by the option. For example, to learn more about the <code>version</code> option run the following command.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go <code class="nb">help</code> version
</pre></div>

</figure>


<h2 id="leanpub-auto-version-information" class="section">2.1 Version information</h2>

<p>Go has a backwards compatibility guarantee which means that code written in Go version 1.0 can still be compiled and run on the latest Go 1.x version.  This doesn’t work the other way, so code written in Go 1.19 may not compile on earlier versions of Go, so you’ll sometimes need to check the version you’re using.</p>

<p>To get the current installed Go version run this.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go version
</pre></div>

</figure>


<p>The output will be similar to below, showing the version, OS, and architecture.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go version go1.19 darwin/amd64
</pre></div>

</figure>


<h2 id="leanpub-auto-environment-information" class="section">2.2 Environment information</h2>

<p>You can inspect the configuration for your installed Go environment using this command.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go env
</pre></div>

</figure>


<p>This outputs all the configuration variables for your installation and can be useful if you are having issues with the Go tool.</p>

<p>The variables worth highlighting here are:</p>

<ul>
  <li>GOPATH - the location of your Go src code including the standard library</li>
  <li>GOMODCACHE - the location of modules which have been downloaded and cached</li>
  <li>GOPROXY - the proxy from which new packages are downloaded</li>
</ul>

<p>For information on other environment variables <a href="https://pkg.go.dev/cmd/go#hdr-Environment_variables">consult this page</a>.</p>

<h2 id="leanpub-auto-module-and-workspace-management" class="section">2.3 Module and workspace management</h2>

<p>In a later chapter, we’ll cover dependency management in Go and discuss the roles of modules and workspaces. For now, you can familiarise yourself with the module and workspace options via the <code>help</code> subcommand.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go mod <code class="nb">help</code>
<code class="linenos">2 </code>go work <code class="nb">help</code>
</pre></div>

</figure>


<h2 id="leanpub-auto-format-your-code" class="section">2.4 Format your code</h2>

<p>If you’re using an IDE like Visual Studio Code with the Go plugin installed, or Goland, then it’s likely your code is formatted automatically upon saving. If you don’t have this facility the <code>fmt</code> subcommand will format your Go source files according to Go standards. Running the tool against a Go source file is straightforward.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go fmt main.go
</pre></div>

</figure>


<h2 id="leanpub-auto-testing" class="section">2.5 Testing</h2>

<p>We’ll get to testing later in the book, for now, it’s enough to know that testing is initiated from the Go tool also. For example to run all the tests in your project use this command from within the project folder.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go <code class="nb">test</code> ./...
</pre></div>

</figure>


<h2 id="leanpub-auto-cleanup" class="section">2.6 Cleanup</h2>

<p><i>Clean</i> removes object files from package source directories. It’s useful if you build an executable and it is placed in the project workspace along with your source.  It can be removed, so that it is not committed to version control, with the following command.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go clean
</pre></div>

</figure>


<h2 id="leanpub-auto-downloading-packages" class="section">2.7 Downloading packages</h2>

<p>We can use the <code>get</code> command to download package dependencies and install them. We cover this in a later chapter but here’s an example which will add a dependency for a package, or if it is already available, it will upgrade the package to the latest version.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go get example.com/pkg
</pre></div>

</figure>


<h2 id="leanpub-auto-running-a-program" class="section">2.8 Running a program</h2>

<p>Assume you’ve written a program and all the code is saved in file <code>main.go</code>. To run the code navigate to the folder which contains <code>main.go</code> and execute this command.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go run main.go
</pre></div>

</figure>


<p>If package <code>main</code> was made up of multiple Go source files, as is often done to help organise the source code, we could pass all the files to the <code>run</code> command like this.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go run *.go
</pre></div>

</figure>


<aside class="information blurb">
    <p>The wildcard filename may not work on Windows systems, and you may even run into problems on Mac/Linux when external files for configuration or data are used by your program, in that the paths are not resolvable. So, it’s recommended to build the program and run the resulting executable if you encounter any problems.</p>

</aside>

<h2 id="leanpub-auto-building-your-program" class="section">2.9 Building your program</h2>

<p>To build an executable for your current operating system, simply use this command. </p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go build -o helloWorld ./...
</pre></div>

</figure>


<p>The <code>-o</code> flag is used to provide a specific name for the built executable. </p>

<p>By default, if no name is specified and the main package is at the root of your project folder the binary created will be named using the <i>module</i> name and the executable will be placed at the root of your project folder.</p>

<p>Later we’ll talk about project organisation and how the <code>cmd</code> folder is helpful.</p>

<p>If you use the <code>cmd</code> folder in your project executables will be built using their sub-folder names unless names are specified with the <code>-o</code> flag.</p>

<p>If we take an example project which contains the source for two executables, <i>api</i> and <i>cli</i>, the below commands would be needed to build them.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go build ./cmd/api
<code class="linenos">2 </code>go build ./cmd/cli
</pre></div>

</figure>


<p>The built executable files are again placed at the root of your project folder. It can be run from the root folder like this.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>./api
</pre></div>

</figure>


<h2 id="leanpub-auto-building-for-other-operating-systems-and-architectures" class="section">2.10 Building for other operating systems and architectures</h2>

<p>As we’ve seen, it’s simple to build a program for your operating system using <code>go build</code> but one of the best features of Go is that we can just as easily compile our code to run on other systems too. </p>

<p>It’s very straightforward to cross-compile source code to alternative targets.  We use the same <i>build</i> command as before but additionally specify both the <i>OS</i> and <i>Architecture</i> we want to build for using the <code>GOOS</code> and <code>GOARCH</code> environment variables.</p>

<p>By default, these variables are set to our local OS and architecture so we’re overriding them to build for a different target.</p>

<p>You can inspect all of the target platforms your Go version can compile for using this command.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go tool dist list
</pre></div>

</figure>


<p>In the console output, the text before the forward slash is the operating system, and the text afterwards is the architecture.</p>

<p>For example, on <i>macOS</i>, to build the <i>helloWorld</i> program as we did in section 2.9 but for Linux OS and a 64-bit AMD architecture we’d do this.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>env <code class="nv">GOOS</code><code class="o">=</code>linux <code class="nv">GOARCH</code><code class="o">=</code>amd64 go build -o helloWorld ./...
</pre></div>

</figure>


<p>To compile for Windows and a 64-bit ARM architecture we’d use this command instead.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>env <code class="nv">GOOS</code><code class="o">=</code>windows <code class="nv">GOARCH</code><code class="o">=</code>arm64 go build -o helloWorld ./...
</pre></div>

</figure>



<h1 id="leanpub-auto-chapter-3---structure-of-a-go-program" class="chapter">Chapter 3 - Structure of a Go program</h1>

<p>In this section, we’re going to walk through the structure of a Go program using a typical <i>Hello World</i> program. </p>

<p>The program itself only prints out a couple of strings - but it does more than you might first expect - run it now on the Go Playground to see for yourself.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 5 - Hello World in Go</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="n">_</code> <code class="s2">"github.com/golangatspeed/pkg/sideeffect"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">init</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Hello World!"</code><code class="p">)</code>
<code class="linenos">10 </code><code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">13 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Hello World again!"</code><code class="p">)</code>
<code class="linenos">14 </code><code class="p">}</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">HbshOM2vDed</code>
</pre></div>

</figure>


<aside class="information blurb">
    <p>There’s probably a bit more syntax in the above example than you might expect in a simple Hello World program, but the extra pieces will be explained and should be useful.</p>

</aside>

<h2 id="leanpub-auto-packages-and-importing" class="section">3.1 Packages and importing</h2>

<p>All Go code resides in a package. An application’s package is always <code>main</code>.</p>

<p>The <code>import</code> keyword is used to include other packages, from either the Go standard library as is the case with <code>fmt</code> or from external packages. </p>

<p>It’s common to see external packages following a semantic naming convention which represents their location on the web e.g. GitHub repository URL.</p>

<p>Rather than use the <code>import</code> keyword for each package we can use brackets around all packages, as we have done in the example. </p>

<p>The underscore which prefixes the imported external package is known as the <i>blank identifier</i>. This is how we tell the compiler that we don’t need to refer to the package contents in our code but we do need to run the <code>init()</code> function (see Section 3.2). </p>

<p>We call this importing a package for its <i>side-effects</i>. Without the blank identifier, the compiler would complain about the unused import.</p>

<p>The blank identifier has other uses which we’ll cover later.</p>

<h3 id="leanpub-auto-aliasing" class="subsection">3.1.1 Aliasing</h3>

<p>Packages can be prefixed with an alias which is useful when we experience naming collisions between similarly named packages, or wish to work with the package contents using a more semantic name than the package itself would otherwise allow. </p>

<p>Aliasing should be used judiciously to add clarity, and not as in the mischievous example below!</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 6 - How not to use aliasing</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="n">log</code> <code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="n">fmt</code> <code class="s2">"log"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"This looks like log.Println output?"</code><code class="p">)</code>
<code class="linenos">10 </code>	<code class="n">log</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"This looks like fmt.Println output?"</code><code class="p">)</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">zuXJ0If5OFn</code>
</pre></div>

</figure>


<h3 id="leanpub-auto-the-dot-import-prefix" class="subsection">3.1.2 The ‘dot’ import prefix</h3>

<p>There is also a <i>dot</i> prefix - a period - which can be used to promote the functionality of an imported package to the current package namespace, allowing the package prefix to be omitted when making calls to its contents.  </p>

<p>This is rarely seen in practice as it mainly detracts from clarity.  To illustrate, in the code example below, the <code>Println()</code> function could also be from the <code>fmt</code> package as well as the <code>log</code> package. Only by inspecting the imported packages are we able to determine which it is. </p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 7 - The dot import prefix</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="o">.</code> <code class="s2">"log"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="n">Println</code><code class="p">(</code><code class="s2">"This looks like log.Println output?"</code><code class="p">)</code>
<code class="linenos"> 9 </code><code class="p">}</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">SEUbOnOb6wH</code>
</pre></div>

</figure>


<h2 id="leanpub-auto-main-and-init-functions" class="section">3.2 Main and Init functions</h2>

<p>The <code>main()</code> function is considered to be the entry point of the application - the top of the call stack. There is only one per executable. It takes no arguments and expects no return values. </p>

<p>Every package including <code>main</code> can have an <code>init()</code> function. Every included package with an <code>init()</code> function will have that function executed <i>once</i> when the application starts. </p>

<p><code>init()</code> functions execute before <code>main()</code> but after package level variables are evaluated. Their use should be constrained to the initial setup, for example reading environment variables or a config file. </p>

<p>If you ran the <i>Hello World</i> program on the Go Playground you will have noticed the additional line (below) was printed before any of our program output?</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>This is the side effect?
</pre></div>

</figure>


<p>This is the output of the <code>init()</code> function in the package <code>github.com/golangatspeed/pkg/sideeffect</code>, executing before our <code>init()</code> function which itself executes before our <code>main()</code> function. </p>

<h2 id="leanpub-auto-developing-a-package" class="section">3.3 Developing a package</h2>

<p>If you are developing a package for use by other applications and not an executable, you will not have a <code>main()</code> function and your package name will be something other than <code>main</code>.</p>

<p>Below is a very simple package example. It’s the content of the package we imported from Github in the <i>Hello World</i> example.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 8 - Simple package</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="n">package</code> <code class="n">sideeffect</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code><code class="n">func</code> <code class="n">init</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">6 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"This is the side effect?"</code><code class="p">)</code>
<code class="linenos">7 </code><code class="p">}</code>
</pre></div>

</figure>


<p>A package may contain a combination of exported and unexported functionality as we discussed in Chapter 1, although this example package exports nothing.</p>


<h1 id="leanpub-auto-chapter-4---project-organisation" class="chapter">Chapter 4 - Project organisation</h1>

<p>Project organisation relates to how you choose to structure your Go code: both its location on disk and within the project folder.</p>

<p>We stated earlier that since Go 1.11, modules have allowed us to manage our projects outside of the <code>$GOPATH/src</code> folder - a big benefit, especially where a project contains more than just Go source code, as many projects organised as mono-repositories frequently do.</p>

<p>When it comes to structuring our code within the project code folder itself, Go is mostly unopinionated. There is one special case to mention - the optional <code>internal</code> folder - but beyond this, it’s up to us. </p>

<p>That said, there are some best practices which we might choose to adopt, which we’ll also cover in this section.</p>

<h2 id="leanpub-auto-the-internal-folder" class="section">4.1 The internal folder</h2>

<p>The <code>internal</code> folder gets special treatment from the Go tool which uses it to limit access to packages contained within it.  It effectively makes code invisible to another package unless it shares a common ancestor.</p>

<p>Most often this is used to prevent external modules from accessing code which a developer does not want to share or maintain a public API for. </p>

<p>Similar to using the unexported visibility modifier in the code itself, we should incorporate <code>internal</code> into our project organisation to hide entire packages which are for <i>internal</i> use only.</p>

<h2 id="leanpub-auto-the-cmd-folder" class="section">4.2 The cmd folder</h2>

<p>We’ve said package <code>main</code> is the entry point for your program already, but it also signals there is an executable which can be built by the Go tool.  </p>

<p>For simple programs <code>main</code> can be located at the root of the project folder structure.  The advantage is that users who run <code>go get</code> on the module will get the application built and installed automatically.</p>

<p>However, with this approach, there can only be one executable in your project and this often presents a problem.  What if you have multiple applications which share much of the same code? </p>

<p>For example, you have a HTTP rest-based API and also CLI which both use the same database access routines and wrapper logic. In this scenario, you’d need two projects. The shared code would have to be visible to both projects as external modules or duplicated in both projects and therefore maintained in two places.</p>

<p>This is not ideal, but fortunately, there’s a simple and widely used solution to the problem.  We simply move the executables (anything with package <code>main</code> into their own subfolder within a <code>cmd</code> folder.</p>

<p>There is no special significance in Go to the <code>cmd</code> folder name it could be anything, but short for <i>command</i> it has become a common practice to use <code>cmd</code>.</p>

<p>Using this approach we can manage multiple executables in one project and we can provide access to the common libraries they use without needing to put them in a third project.  Crucially, we are managing all the related code in one project without any need for duplication.</p>

<p>For the API and CLI example above we might have this folder structure.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code>cmd/
<code class="linenos"> 2 </code>    api/
<code class="linenos"> 3 </code>        main.go
<code class="linenos"> 4 </code>    cli/
<code class="linenos"> 5 </code>        main.go
<code class="linenos"> 6 </code>database/
<code class="linenos"> 7 </code>    *.go
<code class="linenos"> 8 </code>logic/
<code class="linenos"> 9 </code>    *.go
<code class="linenos">10 </code>go.mod
<code class="linenos">11 </code>go.sum
</pre></div>

</figure>


<h2 id="leanpub-auto-the-pkg-folder" class="section">4.3 The pkg folder</h2>

<p>So we’ve covered the benefits of <code>cmd</code> and <code>internal</code>, what might we gain from using a <code>pkg</code> folder in our project?</p>

<p>Again, the folder name has no special significance in Go, but this name and structure provide two benefits.</p>

<p>First, the name <code>pkg</code> is semantic and tells other developers what packages in our module are intended to be reusable outside of the module. Of course, this would be the case for any package not in the <code>internal</code> folder, which brings us nicely to the second benefit.</p>

<p>Most projects will have numerous other folders which reside at the root level inside the project folder. Folders for config, for build automation, maybe data folders or folders for assets such as images and scripts, to name just a few examples.</p>

<p>The point is that typically a Go project will have many other folders which will be nothing to do with your Go code.  If we structure all Go packages at the same level as these folders it becomes difficult to determine what is a Go package and what is not. Developers coming to your project for the first time will need to establish this by interrogating each folder.</p>

<p>Instead, locating all the Go packages in the <code>pkg</code> folder solves this problem very simply. We can see where all the public Go packages can be found without needing to inspect all the folders at the root level.</p>

<h2 id="leanpub-auto-wrapping-it-up" class="section">4.4 Wrapping it up</h2>

<p>Taking the example we’ve used throughout this section, using the above principles to organise our code, the structure of our project would look like this.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code>cmd/
<code class="linenos"> 2 </code>    api/
<code class="linenos"> 3 </code>        main.go
<code class="linenos"> 4 </code>    cli/
<code class="linenos"> 5 </code>        main.go
<code class="linenos"> 6 </code>internal/
<code class="linenos"> 7 </code>    hidden-package/
<code class="linenos"> 8 </code>        *.go
<code class="linenos"> 9 </code>pkg/
<code class="linenos">10 </code>    database/
<code class="linenos">11 </code>        *.go
<code class="linenos">12 </code>    logic/
<code class="linenos">13 </code>        *.go        
<code class="linenos">14 </code>go.mod
<code class="linenos">15 </code>go.sum
</pre></div>

</figure>


<p>None of this is set in stone, you may wish to organise your code differently, and not use the <code>internal</code> folder, but, if you adopt the practices outlined here, other developers will be able to identify where your Go code is located, if it contains executables, as well as understand which packages you intend for others to use, and which you do not.</p>


<h1 id="leanpub-auto-chapter-5---dependency-management" class="chapter">Chapter 5 - Dependency management</h1>

<p>In this chapter, we’re going to take a deep dive into dependency management in Go, which changed radically in Go 1.13 with the default adoption of modules and was refined further with the introduction of workspaces in Go 1.18. </p>

<p>After reading this section you’ll be comfortable creating and working with package dependencies in Go as well as managing modules and workspaces.</p>

<h2 id="leanpub-auto-modules" class="section">5.1 Modules</h2>

<p>Go modules were introduced as an experimental feature in Go version 1.11, and later became the default approach to dependency management in version 1.13.</p>

<p>Before the introduction of modules, as we’ve stated, package management was largely dependent on the <code>go get</code> command, and Go source code was managed in the <code>$GOPATH/src</code> folder. </p>

<p>Modules allow developers to organise their Go projects locally as they please. Projects no longer need to be located within the system <code>GOPATH</code> directory structure - an approach that was often inconvenient.</p>

<p>So what is a module?</p>

<p>A module comprises one or more Go packages managed by a <code>go.mod</code> file. This file defines the module’s identifier, the minimum version of Go required, and any external modules - together with their versions - on which the module depends.</p>

<p>The module’s identifier is also the import path for the module. Remote modules need to be resolvable by that path identifier.</p>

<p>Where external dependencies are a part of a project, an additional <code>go.sum</code> file sits alongside <code>go.mod</code>. This file contains hashes - or checksums - of dependencies and is used to fix versions and determine where dependencies have been modified. Unlike the <code>go.mod</code> file, <code>go.sum</code> should never be manually edited.</p>

<p>Below is an example of a very basic <code>go.mod</code> file for a module which has no dependencies outside of the standard library.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>module github.com/golangatspeed/pkg/sideeffect
<code class="linenos">2 </code>
<code class="linenos">3 </code>go <code class="m">1</code>.13
</pre></div>

</figure>


<p>Modules simplify and standardise the approach to dependency management and vendoring for everyone. Prior to module support, several third-party tools existed to solve the problem of dependency management.</p>

<p>Module management is a part of the standard Go tooling, and changes to <code>go.mod</code> can be initiated from the command line. The file can also be manually edited and this is often just as convenient. </p>

<p>To see all the available <i>go mod</i> commands run the below in your terminal.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go mod <code class="nb">help</code>
</pre></div>

</figure>


<h3 id="leanpub-auto-direct-versus-indirect-dependencies" class="subsection">5.1.1 Direct versus indirect dependencies</h3>

<p>A dependency on a module can be either <i>direct</i> or <i>indirect</i>. A direct dependency is simply a dependency that the module needs itself.</p>

<p>An indirect dependency is usually a dependency requirement of one of the direct dependencies or a dependency listed in <code>go.mod</code> which is not currently used in any of the module source files. </p>

<p>Indirect dependencies in <code>go.mod</code> are suffixed with <code>// indirect</code>.</p>

<p>Below is a more complete example of a <code>go.mod</code> file containing both direct and indirect external dependencies.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>module github.com/my-module
<code class="linenos">2 </code>
<code class="linenos">3 </code>go <code class="m">1</code>.17
<code class="linenos">4 </code>
<code class="linenos">5 </code>require <code class="o">(</code>
<code class="linenos">6 </code>	github.com/spoonboy-io/koan v0.1.0
<code class="linenos">7 </code>	github.com/TwiN/go-color v1.1.0 // indirect
<code class="linenos">8 </code>	golang.org/x/sys v0.0.0-20210630005230-0f9fa26af87c // indirect
<code class="linenos">9 </code><code class="o">)</code>
</pre></div>

</figure>


<h3 id="leanpub-auto-creating-and-updating-a-module" class="subsection">5.1.2 Creating and updating a module</h3>

<p>Module creation is straightforward via the <code>go mod init</code> command.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>// create the module
<code class="linenos">2 </code>go mod init *module-identifier*
</pre></div>

</figure>


<p>Remote modules included in your code with the <code>import</code> keyword, and which are not already available on your system, can generally be downloaded and added to <code>go.mod</code> with the <code>go mod tidy</code> command.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>// add dependencies and update go.mod
<code class="linenos">2 </code>go mod tidy
</pre></div>

</figure>


<p>Alternatively, use the traditional <code>go get</code> command from within your project workspace to fetch the module. This command is module aware so <code>go.mod</code> is automatically updated to include the new dependency.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go get *module-identifier*
</pre></div>

</figure>


<p>By default, both <code>go mod tidy</code> and <code>go get</code> will fetch the latest version of the module, equivalent to this command with the <code>@latest</code> suffix.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>// we don<code class="err">'</code>t need to explicitly add @latest, that is the default
<code class="linenos">2 </code>go get *module-identifier*@latest
</pre></div>

</figure>


<p>If you require a specific version of a module it is possible to obtain it by specifying the <i>tag</i>, <i>branch</i> or even <i>commit reference</i>. </p>

<p>Below are three examples which show how to download and use specific module versions by tag, branch and commit.  In all cases <code>go.mod</code> is updated with the requested version and <code>go.sum</code> will be used to track changes to that version.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>// get a specific tag <code class="o">(</code>version<code class="o">)</code>
<code class="linenos">2 </code>go get *module-identifier*@v1.0.0
<code class="linenos">3 </code>
<code class="linenos">4 </code>// get the development branch 
<code class="linenos">5 </code>go get *module-identifier*@my-dev-branch
<code class="linenos">6 </code>
<code class="linenos">7 </code>// get a specific commit reference @07434ea
<code class="linenos">8 </code>go get *module-identifier*@07434ea
</pre></div>

</figure>


<h3 id="leanpub-auto-the-replace-directive" class="subsection">5.1.3 The replace directive</h3>

<p>The <i>replace</i> directive provides a simple mechanism to substitute a required module with another version of that module. This code can either be stored locally on your machine or at an alternative remote URL.</p>

<p>Imagine finding a bug in a third-party module, reporting it and then being reliant on the code owner to fix their code.  Until it’s fixed your project can’t use that code or must accept the buggy code. Imagine another scenario, needing a new feature in a module, and asking the maintainer to add it. Until it is added, your project has to do without the feature.</p>

<p>In both above scenarios, the codebase can be forked and amended to fix the bug or add the feature. You can send a pull request to the respective maintainer(s) as a good citizen, but you then have to wait for it to be accepted before your project can use the updated code.</p>

<p>The <i>replace</i> directive presents a way around the above problem. We simply add a replace directive to <code>go.mod</code> which tells Go to use code in the forked repository in place of the original module.</p>

<p>When the original module is fixed or has the new feature added, the <i>replace</i> directive can simply be removed.  There is no impact on your go codebase: no need to find and replace every import statement which contains that module.</p>

<p>Replacements can be made using the <code>go mod replace</code> command but it is very simple to include them in <code>go.mod</code> directly. The example <code>go.mod</code> file below shows two replacements being made. </p>

<p>The first <i>replace</i> directive replaces the module with a locally available version using the absolute path to the module’s location on disk. </p>

<aside class="information blurb">
    <p>It’s worth stating the obvious here - that local replacements will break builds for other users who don’t have the module available at that location so they should probably be removed before the code is shared.</p>

</aside>

<p>The second <i>replace</i> directive substitutes in a forked repository and is safer to share. It achieves the same end, but other users will be able to build the project because the forked version is accessible on the Internet.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="k">module</code> <code class="n">github</code>.<code class="n">com</code><code class="o">/</code><code class="n">golangatspeed</code><code class="o">/</code><code class="n">replace-example</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="n">replace</code> <code class="n">github</code>.<code class="n">com</code><code class="o">/</code><code class="n">original</code><code class="o">/</code><code class="k">module</code> =&gt; /<code class="n">Users</code><code class="o">/</code><code class="n">olliephillips</code><code class="o">/</code><code class="n">module-my-version</code>
<code class="linenos">4 </code><code class="n">replace</code> <code class="n">github</code>.<code class="n">com</code><code class="o">/</code><code class="n">original</code><code class="o">/</code><code class="n">module-two</code> =&gt; <code class="n">github</code>.<code class="n">com</code><code class="o">/</code><code class="n">golangatspeed</code><code class="o">/</code><code class="n">module-two</code>
<code class="linenos">5 </code>
<code class="linenos">6 </code><code class="k">require</code> (
<code class="linenos">7 </code>	<code class="n">github</code>.<code class="n">com</code><code class="o">/</code><code class="n">original</code><code class="o">/</code><code class="k">module</code> <code class="n">v1</code><code class="mf">.0.0</code>
<code class="linenos">8 </code>	<code class="n">github</code>.<code class="n">com</code><code class="o">/</code><code class="n">original</code><code class="o">/</code><code class="n">module-two</code> <code class="n">v1</code><code class="mf">.0.0</code>
<code class="linenos">9 </code>)
</pre></div>

</figure>


<h2 id="leanpub-auto-workspaces" class="section">5.2 Workspaces</h2>

<p>The <i>workspace</i> feature was added in Go version 1.18 and furthered the flexibility of modules and dependency management generally. </p>

<p><i>Workspaces</i> allow replacements of modules to be made with modules found locally, <b>without</b> making changes to the <code>go.mod</code> file. </p>

<p>This avoids the problem of having to add and subsequently remove the replace directives, when working with local module versions, before committing code to version control.</p>

<p>A workspace is defined by a single <code>go.work</code> file and is best used for local development, so excluded from version control.</p>

<p>To create a workspace in your project use the commands below.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>// create a workspace file
<code class="linenos">2 </code>go work init 
<code class="linenos">3 </code>
<code class="linenos">4 </code>// or create the file and add a <code class="nb">local</code> path to the workspace
<code class="linenos">5 </code>go work init *path/to/module/or/modules*
</pre></div>

</figure>


<p>A <code>go.work</code> file created with the second of the two commands would have the following contents.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="k">go</code><code class="w"> </code><code class="mf">1.18</code><code class="w"></code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="k">use</code><code class="w"> </code><code class="o">*</code><code class="k">path</code><code class="o">/</code><code class="k">to</code><code class="o">/</code><code class="k">module</code><code class="o">/</code><code class="ow">or</code><code class="o">/</code><code class="n">modules</code><code class="o">*</code><code class="w"></code>
</pre></div>

</figure>


<p>Modules which are located within that path will be used in preference to any online versions or locally cached versions.</p>

<p>We can also use the <i>replace</i> directive to replace specific modules and versions in the <code>go.work</code> file instead of <code>go.mod</code>.</p>

<p>In summary, workspaces help developers isolate changes that should only apply in their development environment, so mitigating the risk of committing changes which would detrimentally impact other developers and their environments.</p>

<h2 id="leanpub-auto-vendoring" class="section">5.3 Vendoring</h2>

<p>Vendoring includes a local copy of external module dependencies inside the project itself in a <code>vendor</code> folder. Go then uses the vendored modules in builds and testing instead of their external equivalents. </p>

<p>Vendoring is useful in many situations. Where a project needs to be built on a machine with no internet access for example; or where strict dependency management has been adopted and submitting vendored modules to version control assists in that end.</p>

<p>Vendoring can also ensure that modules remain available to a project, even if the module is removed from the Internet. This risk is mitigated by the Go module proxy to an extent, but it can still happen - and a project which cannot locate a dependency cannot be built.</p>

<p>Finally, where builds are automated in some form of continuous integration process, build times can be reduced if modules are vendored locally and don’t need to be downloaded from the Internet for each build.</p>

<p>Vendoring is very straightforward, simply run the below command from within your project.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go mod vendor
</pre></div>

</figure>


<p>A <code>vendor</code> folder will be created with local copies of all external module dependencies. There is also a <code>modules.txt</code> file created which lists vendored modules and their versions and this is used as a manifest by the Go tool.</p>


<h1 id="leanpub-auto-chapter-6---variables-and-constants" class="chapter">Chapter 6 - Variables and constants</h1>

<p>Let’s discuss variables, constants and scope next. A word of warning, things may feel a little ‘chicken-and-egg’ for a short time, as we’ll have to briefly mention <i>type</i> which we haven’t covered so far, and won’t until the next chapter.</p>

<h2 id="leanpub-auto-variables" class="section">6.1 Variables</h2>

<p>We’ve said that Go is opinionated. Usually, there is a specific way to do something - maybe a couple of ways - but one area where being opinionated would have been nice is variable declaration and initialisation. There are too many ways to do it.</p>

<aside class="information blurb">
    <p><i>Declaration</i> is the act of creating a variable with a name and type, <i>type</i> being what the variable can hold, such as a number or a string. <i>Initialisation</i> is the act of setting a variable equal to some value at the time it is declared. <i>Assignment</i> is the act of changing the value stored in a variable by assigning a new value at any point during program execution.</p>

</aside>

<p>We’ll look at the different styles shortly so that you know how to recognise them but, generally speaking, for clarity you should limit the styles you employ in your code to just three, two of which use the <code>var</code> keyword, and the third a short-form declaration and initialisation using <code>:=</code>.</p>

<p>Here they are:</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 9 - Recommended variable declaration styles</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">//</code> <code class="n">Style</code> <code class="mf">1.</code> <code class="n">Declaration</code> <code class="n">only</code> <code class="ow">in</code> <code class="n">the</code> <code class="n">global</code> <code class="ow">or</code> <code class="n">function</code> <code class="n">scope</code>
<code class="linenos"> 2 </code><code class="k">var</code> <code class="n">myVar</code> <code class="nb nb-Type">int</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="o">//</code> <code class="n">Style</code> <code class="mf">2.</code> <code class="n">Short</code> <code class="n">form</code> <code class="n">declaration</code> <code class="ow">and</code> <code class="n">initialisation</code> <code class="n">within</code> <code class="n">the</code> <code class="n">function</code> <code class="n">scope</code> <code class="n">only</code>
<code class="linenos"> 5 </code><code class="n">myVar</code> <code class="p">:</code><code class="o">=</code> <code class="mi">10</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="o">//</code> <code class="n">Style</code> <code class="mf">3.</code> <code class="n">Multiple</code> <code class="n">variables</code><code class="p">,</code> <code class="n">omitting</code> <code class="n">the</code> <code class="n">repeating</code> <code class="k">var</code> <code class="n">keyword</code>
<code class="linenos"> 8 </code><code class="k">var</code> <code class="p">(</code>
<code class="linenos"> 9 </code>    <code class="n">myVar</code> <code class="nb nb-Type">int</code>
<code class="linenos">10 </code>    <code class="n">myVar2</code> <code class="nb nb-Type">int</code>
<code class="linenos">11 </code><code class="p">)</code>
</pre></div>

</figure>


<p>We’ll cover scope soon, but to summarise, you may use all three styles inside functions, but you cannot use <code>Style 2</code> in the global scope. </p>

<aside class="information blurb">
    <p>Note that when we refer to function scope, we mean anything, <i>not</i> in the global scope, so variables declared in receivers would also have function scope.</p>

</aside>

<p>You should probably move to the next section on constants in all honesty, but for completeness, the example program below shows all of the different styles which you may see, and indeed, can use. </p>

<p>Some are declarations, others also initialise the variable. Some infer the type, while others explicitly state the type, but they’re all valid ways to create variables.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 10 - All variable declaration styles</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">var</code> <code class="n">myVar1</code> <code class="nb">int</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">var</code> <code class="p">(</code>
<code class="linenos">10 </code>	<code class="n">myVar2</code> <code class="nb">int</code> <code class="o">=</code> <code class="mi">1</code>
<code class="linenos">11 </code>	<code class="n">myVar3</code> <code class="nb">int</code>
<code class="linenos">12 </code><code class="p">)</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="n">var</code> <code class="n">myVar4</code> <code class="nb">int</code> <code class="o">=</code> <code class="mi">4</code>
<code class="linenos">15 </code><code class="n">var</code> <code class="n">myVar5</code> <code class="o">=</code> <code class="mi">5</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">18 </code>	<code class="n">var</code> <code class="n">myVar6</code> <code class="nb">int</code>
<code class="linenos">19 </code>    <code class="n">var</code> <code class="n">myVar7</code><code class="p">,</code> <code class="n">myVar8</code> <code class="nb">int</code>
<code class="linenos">20 </code>	<code class="n">var</code> <code class="n">myVar9</code><code class="p">,</code> <code class="n">myVar10</code> <code class="o">=</code> <code class="mi">9</code><code class="p">,</code> <code class="mi">10</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code>	<code class="n">myVar11</code> <code class="o">:=</code> <code class="mi">11</code>
<code class="linenos">23 </code>	<code class="n">myVar12</code><code class="p">,</code> <code class="n">myVar13</code> <code class="o">:=</code> <code class="mi">12</code><code class="p">,</code> <code class="mi">13</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Go is not so opinionated on some things..."</code><code class="p">)</code>
<code class="linenos">26 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">myVar1</code><code class="p">,</code> <code class="n">myVar2</code><code class="p">,</code> <code class="n">myVar3</code><code class="p">,</code> <code class="n">myVar4</code><code class="p">,</code> <code class="n">myVar5</code><code class="p">)</code>
<code class="linenos">27 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">myVar6</code><code class="p">,</code> <code class="n">myVar7</code><code class="p">,</code> <code class="n">myVar8</code><code class="p">,</code> <code class="n">myVar9</code><code class="p">,</code> <code class="n">myVar10</code><code class="p">,</code> <code class="n">myVar11</code><code class="p">,</code> <code class="n">myVar12</code><code class="p">,</code> <code class="n">myVar13</code><code class="p">)</code>
<code class="linenos">28 </code><code class="p">}</code>
<code class="linenos">29 </code>
<code class="linenos">30 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">c8eFFqUfVTz</code>
</pre></div>

</figure>


<p>Let’s break that example down.</p>

<p>A variable can be created using the <code>var</code> keyword in the global scope or function scope e.g. myVar1 and myVar6.</p>

<p>If we declare the variable and type it will be initialised to its <i>nil</i> value e.g. myVar1. </p>

<p>We can initialise it ourselves and specify the type if we wish e.g. myVar4, or let the compiler infer it from the initialised value e.g. myVar5.</p>

<p>As with the <code>import</code> keyword, we can avoid repeating the <code>var</code> keyword by enclosing multiple declarations within braces. You can do this in the global or function scope.</p>

<p>Within the function scope - as well as the styles above - we can also use the short-form notation <code>:=</code> which declares and initialises a variable. Type is inferred based on the value e.g. myVar11.</p>

<p>Finally, we can declare multiple variables <b>of the same type</b> using standard or short form notation as a comma delimited list e.g. myVar7 and myVar8, myVar9 and myVar10 and myVar12 and myVar13.</p>

<p>A bit confusing yes?</p>

<aside class="information blurb">
    <p>Remember, Go is compiled and not interpreted. We don’t need clever optimisations in our syntax because the compiler will optimise our source code during a build. Our focus should be on writing clear code that the average Go developer can understand and limiting the styles we use to declare variables is a step towards that objective.</p>

</aside>

<p>To wrap up variables we should mention <i>unused</i> variables. </p>

<p>The Go compiler will complain if a variable within a function scope is not used by your program at build time.</p>

<p>It’s nice that the compiler has our backs - leaving unused code hanging about could be a source of confusion, but, it’s worth stating that the compiler will not complain about any unused global variables simply because they cannot be detected during compilation.</p>

<p>However, it’s common to have temporary placeholder code and if you’re not ready to use a variable in your program it can be frustrating to keep commenting it out to run your program.  </p>

<p>The solution is to use the variable in some way. A common approach is to print out the variable, but while this satisfies the compiler it can add noise when attempting to debug a program.</p>

<p>An alternative approach, which also keeps the compiler happy is to discard the unused variable using the <i>blank identifier</i>.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 11 - Discarding with the blank identifier</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">myVar</code> <code class="o">:=</code> <code class="mi">1</code>
<code class="linenos"> 7 </code>	<code class="n">_</code> <code class="o">=</code> <code class="n">myVar</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"compiler is happy"</code><code class="p">)</code>
<code class="linenos">10 </code><code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">NYjfpotoOtx</code>
</pre></div>

</figure>


<p>The example program above declares and initialises a variable then immediately discards it. The program outputs “compiler is happy” as expected, but if you comment out line 7 the compiler will not build the program and will output the following error:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>./prog.go:6:2: myVar declared but not used
<code class="linenos">2 </code>
<code class="linenos">3 </code>Go build failed.
</pre></div>

</figure>


<p>Temporarily discarding the variable is my preferred approach, because it is clear what the intent is, we’re saying we don’t need it <i>at the moment</i>.  </p>

<p>Whether we choose to comment out, print or discard the variable, all should be considered temporary measures for use during early development only.</p>

<h2 id="leanpub-auto-constants" class="section">6.2 Constants</h2>

<p>Constants are immutable values. They are declared with the <code>const</code> keyword and may be created in the same way as variables, with one exception, the short-form declaration <code>:=</code> is not valid for use with constants. </p>

<p>Just like variables, a constant’s type can be inferred if it not explicitly set. However, unlike variables this inference may be a loose typing. The type only becomes fixed at the point of conversion, or point of use.</p>

<p>Note, this fluidity applies only to numerical types.</p>

<p>Check out the example below which demonstrates this fluidity, then uncomment line 18 and run it again.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 12 - Loose typing of number constants</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">const</code> <code class="n">myConst</code> <code class="o">=</code> <code class="mi">1</code>
<code class="linenos"> 8 </code><code class="n">var</code> <code class="n">myVar</code> <code class="o">=</code> <code class="mi">1</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="n">func</code> <code class="n">needsAFloat</code><code class="p">(</code><code class="n">val</code> <code class="n">float64</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">11 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"looks like we got a float:"</code><code class="p">,</code> <code class="n">val</code><code class="p">)</code>
<code class="linenos">12 </code><code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">15 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"myConst is type '%T'</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">myConst</code><code class="p">)</code>
<code class="linenos">16 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"myVar is type '%T'</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">myVar</code><code class="p">)</code>
<code class="linenos">17 </code>	<code class="n">needsAFloat</code><code class="p">(</code><code class="n">myConst</code><code class="p">)</code>
<code class="linenos">18 </code>	<code class="o">//</code><code class="n">needsAFloat</code><code class="p">(</code><code class="n">myVar</code><code class="p">)</code>
<code class="linenos">19 </code><code class="p">}</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">MC8HsTfnVz9</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>myConst is <code class="nb">type</code> <code class="s1">'int'</code>
<code class="linenos">2 </code>myVar is <code class="nb">type</code> <code class="s1">'int'</code>
<code class="linenos">3 </code>looks like we got a float: <code class="m">1</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code>Program exited.
</pre></div>

</figure>


<h3 id="leanpub-auto-constants-and-the-iota-identifier" class="subsection">6.2.1 Constants and the iota identifier</h3>

<p>Sometimes the value stored by constant has meaning, but often that won’t be the case, instead we simply want to differentiate between constant values, in fact, any value would do.</p>

<p>Typically, where the value doesn’t have meaning and we simply want to tell between the constants we’ll use integer values.</p>

<p>We can, if we wish, manage these values manually by maintaining the list ourselves, as in the example below.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 13 - Managing number constants manually</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">const</code> <code class="p">(</code>
<code class="linenos"> 8 </code>	<code class="n">const1</code> <code class="o">=</code> <code class="mi">1</code>
<code class="linenos"> 9 </code>	<code class="n">const2</code> <code class="o">=</code> <code class="mi">2</code>
<code class="linenos">10 </code>	<code class="n">const3</code> <code class="o">=</code> <code class="mi">3</code>
<code class="linenos">11 </code>	<code class="n">const4</code> <code class="o">=</code> <code class="mi">4</code>
<code class="linenos">12 </code>	<code class="n">const5</code> <code class="o">=</code> <code class="mi">5</code>
<code class="linenos">13 </code><code class="p">)</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">16 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"constants values are:"</code><code class="p">,</code> <code class="n">const1</code><code class="p">,</code> <code class="n">const2</code><code class="p">,</code> <code class="n">const3</code><code class="p">,</code> <code class="n">const4</code><code class="p">,</code> <code class="n">const5</code><code class="p">)</code>
<code class="linenos">17 </code><code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">EVMSF3BCCn8</code>
</pre></div>

</figure>


<p>Output: </p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>constants values are: <code class="m">1</code> <code class="m">2</code> <code class="m">3</code> <code class="m">4</code> <code class="m">5</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>Alternatively, we can use the <i>iota</i> identifier as a shorthand way of initialising all the constants. </p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 14 - Managing number constants with iota</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">const</code> <code class="p">(</code>
<code class="linenos"> 8 </code>	<code class="n">const1</code> <code class="o">=</code> <code class="n">iota</code>
<code class="linenos"> 9 </code>	<code class="n">const2</code>
<code class="linenos">10 </code>	<code class="n">const3</code>
<code class="linenos">11 </code>	<code class="n">const4</code>
<code class="linenos">12 </code>	<code class="n">const5</code>
<code class="linenos">13 </code><code class="p">)</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">16 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"constants values are:"</code><code class="p">,</code> <code class="n">const1</code><code class="p">,</code> <code class="n">const2</code><code class="p">,</code> <code class="n">const3</code><code class="p">,</code> <code class="n">const4</code><code class="p">,</code> <code class="n">const5</code><code class="p">)</code>
<code class="linenos">17 </code><code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">h4fNoptnCJZ</code>
</pre></div>

</figure>


<p>Output: </p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>constants values are: <code class="m">0</code> <code class="m">1</code> <code class="m">2</code> <code class="m">3</code> <code class="m">4</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>Note <i>iota</i> is zero-based, if you wanted to start the sequence at 1 as in the previous example you would simply add 1 as shown below.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 15 - Rebasing the numbering from 1</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="k">const</code> <code class="p">(</code>
<code class="linenos">2 </code>	<code class="n">const1</code> <code class="o">=</code> <code class="n">iota</code> <code class="o">+</code> <code class="mi">1</code>
<code class="linenos">3 </code><code class="p">)</code>
</pre></div>

</figure>


<p>To use a non-linear sequence, we can employ the <i>blank identifier</i> once again to discard the specific iota values.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 16 - Non-linear constant sequences</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">const</code> <code class="p">(</code>
<code class="linenos"> 8 </code>	<code class="n">const1</code> <code class="o">=</code> <code class="n">iota</code>
<code class="linenos"> 9 </code>	<code class="n">_</code>
<code class="linenos">10 </code>	<code class="n">_</code>
<code class="linenos">11 </code>	<code class="n">const4</code>
<code class="linenos">12 </code>	<code class="n">const5</code>
<code class="linenos">13 </code><code class="p">)</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">16 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"constants values are:"</code><code class="p">,</code> <code class="n">const1</code><code class="p">,</code> <code class="n">const4</code><code class="p">,</code> <code class="n">const5</code><code class="p">)</code>
<code class="linenos">17 </code><code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">8</code><code class="n">QypEyOoxT2</code>
</pre></div>

</figure>


<p>Output: </p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>constants values are: <code class="m">0</code> <code class="m">3</code> <code class="m">4</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>Using <i>iota</i> can make constant management much easier, but can be prone to occasional problems if new constants are not added to the end of the list, but instead inserted into the list - say alphabetically - and the value itself has some meaning in your program. For example, the code below is fragile because we use the values, not the constants themselves in switch case comparisons.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 17 - Values used in place of named constants</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">const</code> <code class="p">(</code>
<code class="linenos"> 8 </code>	<code class="n">blue</code> <code class="o">=</code> <code class="n">iota</code>
<code class="linenos"> 9 </code>	<code class="o">//</code><code class="n">red</code>
<code class="linenos">10 </code>	<code class="n">yellow</code>
<code class="linenos">11 </code>	<code class="n">purple</code>
<code class="linenos">12 </code><code class="p">)</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">15 </code>	<code class="n">chosenColor</code> <code class="o">:=</code> <code class="n">yellow</code>
<code class="linenos">16 </code>	<code class="n">switch</code> <code class="n">chosenColor</code> <code class="p">{</code>
<code class="linenos">17 </code>	<code class="n">case</code> <code class="mi">0</code><code class="p">:</code>
<code class="linenos">18 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Chose blue"</code><code class="p">)</code>
<code class="linenos">19 </code>	<code class="n">case</code> <code class="mi">1</code><code class="p">:</code>
<code class="linenos">20 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Chose yellow"</code><code class="p">)</code>
<code class="linenos">21 </code>	<code class="n">case</code> <code class="mi">2</code><code class="p">:</code>
<code class="linenos">22 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Chose purple"</code><code class="p">)</code>
<code class="linenos">23 </code>	<code class="p">}</code>
<code class="linenos">24 </code><code class="p">}</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">n</code><code class="o">-</code><code class="n">POyR0</code><code class="o">-</code><code class="n">k7a</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Chose yellow
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>Uncomment line 9 and and now the program thinks we chose a different colour.</p>

<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Chose purple
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<aside class="information blurb">
    <p>If you use <i>iota</i> to simplify constant management, be sure to use constant names throughout your code and never perform comparisons on actual values, which could change as new constants are introduced into your codebase.</p>

</aside>

<h2 id="leanpub-auto-scope" class="section">6.3 Scope</h2>

<p>Scope is an important concept, especially for variables, so let’s review what we mean by <i>scope</i>.</p>

<p>A variable declared in the global scope may be accessed and mutated by any function in the same package. Equally, an exported package variable declared in the global scope may be mutated by any code that imports the package.</p>

<p>This is not the case for constants, since they cannot be mutated after first initialisation. For this reason, there’s a strong argument for only using constants in the global scope.</p>

<p>A variable of the same name can be declared in multiple scopes, as each scope has a separate namespace. Avoid this if possible, it can lead to something we call <i>variable shadowing</i> where it can become unclear what value is stored in the variable we are using in a specific scope.</p>

<p>Consider the example below where a variable is declared in both the global and function scope.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 18 - Global and function scope</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">var</code> <code class="n">myVar</code> <code class="o">=</code> <code class="mi">10</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="n">myVar</code> <code class="o">+=</code> <code class="mi">5</code>
<code class="linenos"> 9 </code>	<code class="n">var</code> <code class="n">myVar</code> <code class="nb">int</code>
<code class="linenos">10 </code>	<code class="n">myVar</code> <code class="o">-=</code> <code class="mi">5</code>
<code class="linenos">11 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"myVar is:"</code><code class="p">,</code> <code class="n">myVar</code><code class="p">)</code>
<code class="linenos">12 </code><code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">V7OT8HX_XMP</code>
</pre></div>

</figure>


<p>Go will use the locally scoped variable in preference to any parent scoped variable. In the example above we printed the <code>myVar</code> variable declared in <code>main()</code> as that was the locally scoped variable. </p>

<p>The same is also true for declarations made inside control structures like loop and conditional statements. Go will use the variable inside the control structure, in preference to the function or globally scoped variable.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 19 - Local scope in control structure</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">var</code> <code class="n">myVar</code> <code class="o">=</code> <code class="mi">10</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="o">//</code> <code class="k">global</code> <code class="n">scope</code>
<code class="linenos">11 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">myVar</code><code class="p">)</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>	<code class="n">myVar</code> <code class="o">:=</code> <code class="mi">5</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code>	<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="mi">1</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos">16 </code>		<code class="o">//</code><code class="n">control</code> <code class="n">structure</code> <code class="n">scope</code>
<code class="linenos">17 </code>		<code class="n">myVar</code> <code class="o">:=</code> <code class="mi">0</code>
<code class="linenos">18 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">myVar</code><code class="p">)</code>
<code class="linenos">19 </code>	<code class="p">}</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code>	<code class="o">//</code> <code class="n">function</code> <code class="n">scope</code>
<code class="linenos">22 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">myVar</code><code class="p">)</code>
<code class="linenos">23 </code><code class="p">}</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">edNkZtJuCPk</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="m">10</code>
<code class="linenos">2 </code><code class="m">0</code>
<code class="linenos">3 </code><code class="m">5</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code>Program exited.
</pre></div>

</figure>


<p>For this reason, duplicated variable names should be avoided for all but the most generic of values, such as errors.</p>

<h2 id="leanpub-auto-variable-semantics-pointers-and-values" class="section">6.4 Variable semantics. Pointers and values</h2>

<p>When working with variables we often need to pass them around as arguments and return values in functions and receivers. </p>

<p>In Go, we can share variables as <i>values</i> or <i>pointers</i>.  A value is a copy of the contents of the variable, whereas a pointer is a copy of the address of the variable in memory.</p>

<p>As stated in an earlier chapter, both are values, just different kinds of values, but to avoid confusion here, when we say <i>pass by value</i> we mean sharing a copy of the variable, whereas with <i>pass by reference</i> we mean sharing the memory address of the variable.</p>

<p>When we pass something to a function by value, the function receives a copy of that value. This could be ideal in a function which prints simple output, like a username for example, but, passing a copy of a value may not be ideal if we are passing a large struct around in our program, with each copy duplicating that value in memory. </p>

<p>The fact that we have a copy of the original value, and not the original value itself means we cannot mutate the original. In many cases, this change protection will be exactly what we want in code which should be able to read but not amend a value.</p>

<p>By contrast, if we pass by reference, the value we pass is the address in memory of the variable. It is not a copy of the variable, nor is it the original variable, it is simply the address of the original variable in hexadecimal form, which could look like this <code>0xc0000ac018</code>.</p>

<p>Using the memory address we can get the original variable stored in memory at that address by <i>dereferencing</i> the value and we may, if we wish, mutate that value using the same approach.</p>

<p>Two examples follow which show the syntax used to pass by value, pass by reference and deference the value.</p>

<p>In the first example, we have a function that accepts a value of type string. Although we attempt to change it, we are mutating a copy of the value and not the original, so the final output is unchanged.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 20 - Pass by value</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">SayHello</code><code class="p">(</code><code class="n">name</code> <code class="n">string</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Hello </code><code class="si">%s</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">name</code><code class="p">)</code>
<code class="linenos"> 9 </code>	<code class="n">name</code> <code class="o">=</code> <code class="s2">"Dave Blogs"</code>
<code class="linenos">10 </code><code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">13 </code>	<code class="n">name</code> <code class="o">:=</code> <code class="s2">"Joe Blogs"</code>
<code class="linenos">14 </code>	<code class="n">SayHello</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>
<code class="linenos">15 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>
<code class="linenos">16 </code><code class="p">}</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">uESKRz6r</code><code class="o">-</code><code class="n">tS</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Hello Joe Blogs
<code class="linenos">2 </code>Joe Blogs
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<p>Moving to the second example, the <code>SayHello()</code> function signature has been modified to accept a pointer to a value of type string. We use <code>*string</code> in the signature to denote this, and this function will no longer accept the value itself.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 21 - Pass by reference</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">SayHello</code><code class="p">(</code><code class="n">name</code> <code class="o">*</code><code class="n">string</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>
<code class="linenos"> 9 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Hello </code><code class="si">%s</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="o">*</code><code class="n">name</code><code class="p">)</code>
<code class="linenos">10 </code>	<code class="o">*</code><code class="n">name</code> <code class="o">=</code> <code class="s2">"Dave Blogs"</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">14 </code>	<code class="n">name</code> <code class="o">:=</code> <code class="s2">"Joe Blogs"</code>
<code class="linenos">15 </code>	<code class="n">SayHello</code><code class="p">(</code><code class="o">&amp;</code><code class="n">name</code><code class="p">)</code>
<code class="linenos">16 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>
<code class="linenos">17 </code><code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">7</code><code class="n">Ne6OPnCslN</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>0xc00009e210
<code class="linenos">2 </code>Hello Joe Blogs
<code class="linenos">3 </code>Dave Blogs
<code class="linenos">4 </code>
<code class="linenos">5 </code>Program exited.
</pre></div>

</figure>


<p>On line 15 we take a pointer to the <code>name</code> variable by prefixing it with the <i>&amp;</i> character and pass that as the single argument to <code>SayHello()</code>.</p>

<p>On line 8 we print the pointer stored in the <code>name</code> parameter which outputs a memory address, and on line 9 we dereference the value using the asterisk prefix - as in we ask for the value stored at that memory address - so that we may print it. </p>

<p>Finally, on line 10 we assign a new value to the dereferenced <code>name</code> variable and we can see that we have mutated the original variable as when we print it again at line 16, the new value is displayed.</p>

<h2 id="leanpub-auto-value-initialisation" class="section">6.5 Value initialisation</h2>

<p>Building on the information in the previous section we’re going to look at how we can create values and pointers.  </p>

<p>Values are simple, we’ve seen them many times in this section already. Whenever we create a variable and share it, we ordinarily pass it by value. Of course, we can obtain a pointer to it after creation if needs be, as we did at line 15 in the previous example.</p>

<p>So what if we want to work with pointers exclusively and we don’t want the value which can be copied, but a single representation of the thing in memory. To do this we need to take a pointer directly - the memory address - and share that.</p>

<p>There are three ways to achieve this. We can use the short-form <i>&amp;</i> prefix,the <i>new</i> function, and <i>make</i>. All give us a pointer to a value in memory. </p>

<p>The example below shows two approaches relevant to creating a <i>struct</i> type. We’ll cover structs in the next section, and later we’ll also look at the third approach, <i>make</i> when we consider reference types.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 22 - Obtaining a pointer directly</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nb">type</code> <code class="n">User</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">Name</code> <code class="n">string</code>
<code class="linenos"> 7 </code><code class="p">}</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">func</code> <code class="n">ChangeName</code><code class="p">(</code><code class="n">name</code> <code class="n">string</code><code class="p">,</code> <code class="n">user</code> <code class="o">*</code><code class="n">User</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="n">user</code><code class="o">.</code><code class="n">Name</code> <code class="o">=</code> <code class="n">name</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">14 </code>	<code class="n">u1</code> <code class="o">:=</code> <code class="n">new</code><code class="p">(</code><code class="n">User</code><code class="p">)</code>
<code class="linenos">15 </code>	<code class="n">u2</code> <code class="o">:=</code> <code class="o">&amp;</code><code class="n">User</code><code class="p">{</code>
<code class="linenos">16 </code>		<code class="n">Name</code><code class="p">:</code> <code class="s2">"Joe Blogs"</code><code class="p">,</code>
<code class="linenos">17 </code>	<code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code>	<code class="n">ChangeName</code><code class="p">(</code><code class="s2">"Dave Blogs"</code><code class="p">,</code> <code class="n">u1</code><code class="p">)</code>
<code class="linenos">20 </code>	<code class="n">ChangeName</code><code class="p">(</code><code class="s2">"Trevor Blogs"</code><code class="p">,</code> <code class="n">u2</code><code class="p">)</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"u1:"</code><code class="p">,</code> <code class="n">u1</code><code class="p">)</code>
<code class="linenos">23 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"u2:"</code><code class="p">,</code> <code class="n">u2</code><code class="p">)</code>
<code class="linenos">24 </code><code class="p">}</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">t3iJJ47laIt</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>u1: <code class="p">&amp;</code><code class="o">{</code>Dave Blogs<code class="o">}</code>
<code class="linenos">2 </code>u2: <code class="p">&amp;</code><code class="o">{</code>Trevor Blogs<code class="o">}</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<p>On line 14 we use the new keyword to obtain a pointer to a <i>nil</i> value of <i>User</i> and on line 15 we use the <i>&amp;</i> prefix to obtain another pointer to a <i>User</i> using struct literal syntax, which allows us to initialise it to a non-nil value.</p>

<aside class="information blurb">
    <p>Did you notice anything different in this example compared to Example 21?  </p>

</aside>
<p class="fake-para">We didn’t need to dereference the structs either to assign a new value or to print them, when previously we did?</p>

<p>Go performs automatic dereferencing on struct types for us which results in a much cleaner syntax.</p>

<p>Consider the <code>changeName()</code> function in the previous example. The syntax below is equivalent to that in Example 22. Although it is perfectly valid, and the compiler will not complain, it is less readable, so we should let Go perform the dereferencing on our behalf:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="k">func</code> <code class="n">ChangeName</code><code class="p">(</code><code class="n">name</code> <code class="n">string</code><code class="p">,</code> <code class="n">user</code> <code class="o">*</code><code class="n">User</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">2 </code>	<code class="p">(</code><code class="o">*</code><code class="n">user</code><code class="p">)</code><code class="o">.</code><code class="n">Name</code> <code class="o">=</code> <code class="n">name</code>
<code class="linenos">3 </code><code class="p">}</code>
</pre></div>

</figure>


<aside class="information blurb">
    <p>Note that when we print the structs at lines 26 &amp; 27, although Go performs the dereferencing automatically and prints the struct values it reminds us that we are working with pointers by prefixing the output with the <i>&amp;</i> character.</p>

</aside>


<h1 id="leanpub-auto-chapter-7---data-types" class="chapter">Chapter 7 - Data types</h1>

<p>In this chapter we’re going to review Go’s built-in data types, often referred to as <i>primitives</i>.</p>

<p>Data types define what a value can be and are fixed at compile time. In Go conversions between types must be performed explicitly. </p>

<p>We can split Go data types into several categories:- basic, aggregate, reference and interface, although the classifications are not strictly mutually exclusive, as we will see.</p>

<aside class="information blurb">
    <p>The term <i>reference type</i> has been removed from official Go terminology, and instead aggregate types and reference types are often referred to collectively as <i>composite types</i>. We’re going use the term anyway, and we’ll see why soon.</p>

</aside>

<h2 id="leanpub-auto-basic-types" class="section">7.1 Basic types</h2>

<p>Basic types include types for numbers, strings and booleans.</p>

<h3 id="leanpub-auto-number" class="subsection">7.1.1 Number</h3>

<p>There are multiple ways to represent numbers depending on how big that number is, whether it is positive or negative and whether it’s a whole number or a decimal.</p>

<p>Unless your program code needs to be optimised for memory usage, choose <i>int</i> for whole numbers and <i>float64</i> for decimals. Both types use 64 bits or 8 bytes in memory.</p>

<p>Don’t use specific integer types such as <i>int8</i>, <i>int16</i>, <i>int32</i> or <i>int64</i> unless forced to by an external dependency which accepts or returns these types specifically.</p>

<p>Similarly, if you <b>do</b> choose to store decimals as <i>float32</i> in your program, to perform operations on these values, for example using the standard library <a href="https://pkg.go.dev/math">math package</a>, you’ll need to convert them to <i>float64</i>, since the package accepts and returns <i>float64</i> types exclusively. </p>

<p>Performing type conversions such as the above may complicate your syntax and in many cases, this trade-off won’t be worth the memory saved by using types that occupy less memory. </p>

<p>If memory constraints do become a concern, you can revisit the types used by your program of course. The point is this is a performance optimisation, which should come later. </p>

<aside class="information blurb">
    <p>Did you know <i>int</i> is actually an alias for <i>int32</i> or <i>int64</i>. Which, depends on whether your code is compiled for 32-bit or 64-bit architecture. No such alias exists for <i>float</i> although <i>float</i> was once a valid type but was removed from the language in 2011 before Go version 1.0 was released.</p>

</aside>

<p>Go also supports unsigned integer types, where the value must be positive. For reasons already stated should you wish to use an unsigned integer use <i>uint</i> rather than a more specific type.</p>

<p>In addition to <i>int</i>, <i>uint</i> and <i>float64</i> types there are <i>complex</i> number types available in Go, but we’re not going to cover those.</p>

<p>Variables of any number type are initialised to zero.</p>

<p>Before leaving number types, a note about working with floating point numbers. Below is a <i>Gotcha</i> relating to floating point number precision. </p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 23 - Floating point number addition problem</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>	<code class="n">a</code> <code class="o">:=</code> <code class="mf">2.1</code>
<code class="linenos">10 </code>	<code class="n">b</code> <code class="o">:=</code> <code class="mf">4.2</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code>	<code class="n">c</code> <code class="o">:=</code> <code class="n">a</code> <code class="o">+</code> <code class="n">b</code>
<code class="linenos">13 </code>	<code class="n">d</code> <code class="o">:=</code> <code class="mf">2.1</code> <code class="o">+</code> <code class="mf">4.2</code>
<code class="linenos">14 </code>	<code class="n">e</code> <code class="o">:=</code> <code class="n">float64</code><code class="p">(</code><code class="mf">2.1</code><code class="p">)</code> <code class="o">+</code> <code class="n">float64</code><code class="p">(</code><code class="mf">4.2</code><code class="p">)</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">c</code> <code class="o">==</code> <code class="n">d</code><code class="p">)</code>
<code class="linenos">17 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">c</code> <code class="o">==</code> <code class="n">e</code><code class="p">)</code>
<code class="linenos">18 </code><code class="p">}</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">_uoAHQeoh9h</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nb">false</code>
<code class="linenos">2 </code><code class="nb">true</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<p>Looking at the simple additions in the example, we might expect both comparisons to be <i>true</i> but they are not. This is due to floating point number rounding precision. </p>

<p>A real-world scenario in which we could encounter problems caused by different precision is in unit testing. An assertion that should pass, fails because the expected result is ever so slightly different than the result obtained. </p>

<p>The takeaway is that comparisons between floating point numbers can be unreliable where their precision is different, so if you wish to add decimal numbers which are not already <i>float64</i> type it is worth performing that conversion explicitly.  </p>

<p>It’s also worth ensuring the same level of precision when making assertion comparisons in your unit tests.</p>

<h3 id="leanpub-auto-boolean" class="subsection">7.1.2 Boolean</h3>

<p>The type <i>bool</i> stores true and false values and it uses one byte in memory. A variable of type <i>bool</i> is initialised to its <i>nil</i> value which is false.</p>

<h3 id="leanpub-auto-string" class="subsection">7.1.3 String</h3>

<p>Though a basic type, a <i>string</i> actually points to a backing slice of bytes. We cover the <i>byte</i> type next but think of a slice as an array for the moment, we’ll also cover them soon.</p>

<p>To demonstrate, in the example below we print a portion of the string from index position 6 onwards by accessing the underlying byte slice:</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 24 - String cut using byte slice</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">myString</code> <code class="o">:=</code> <code class="s2">"Hello GolangAtSpeed"</code>
<code class="linenos"> 7 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">myString</code><code class="p">[</code><code class="mi">6</code><code class="p">:])</code>
<code class="linenos"> 8 </code><code class="p">}</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">egXJA0gm97x</code>
</pre></div>

</figure>


<aside class="information blurb">
    <p>In the example above we make a common mistake. The code could result in unexpected or buggy behaviour depending on the string literal we operate on. We’ll point out the gotcha shortly when we get to the <i>rune</i> type.</p>

</aside>

<p>Variables of type <i>string</i> have a value of an empty string at declaration.</p>

<h3 id="leanpub-auto-byte" class="subsection">7.1.4 Byte</h3>

<p>A <i>byte</i> is an alias for <i>uint8</i>. It stores integers between 0 and 255 (the largest number we can represent in binary with 8 bits).  Therefore a <i>byte</i> can be used to represent any single ASCII character. </p>

<p>As an alias for <i>uint8</i>, a variable of type <i>byte</i> is initialised to zero.</p>

<h3 id="leanpub-auto-rune" class="subsection">7.1.5 Rune</h3>

<p>We’ll start this section with a classic gotcha!  Check out the example program below in which we have two ‘identical’ strings but which appear to be of different length:</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 25 - Identical strings with different lengths</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="n">greet1</code><code class="o">:=</code> <code class="s2">"hello"</code>
<code class="linenos"> 9 </code>	<code class="n">greet2</code><code class="o">:=</code> <code class="s2">"һello"</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">greet1</code><code class="p">))</code>
<code class="linenos">12 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">greet2</code><code class="p">))</code>
<code class="linenos">13 </code><code class="p">}</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">ujUnmx</code><code class="o">-</code><code class="n">LsWu</code>
</pre></div>

</figure>


<p>Don’t worry, we’ll explain what’s happening here in our discussion of the <i>rune</i> type which follows.</p>

<p>To represent other characters beyond ASCII alone we need to use a <i>rune</i>.</p>

<p>A <i>rune</i> is an alias for <i>int32</i> which can represent a Unicode codepoint as a numerical value. As it’s an <i>int32</i> it is large enough to represent any Unicode character in a sequence of almost 150,000 at the time of writing. </p>

<p>ASCII is a subset of Unicode so ASCII character codes map directly to the same character codepoint in Unicode. </p>

<p>A Unicode codepoint also has a UTF-8 hexadecimal representation.  Go will present this hex as a sequence of up to 4 bytes, how many bytes, depends on the UTF-8 hexadecimal code itself.</p>

<p>Let’s illustrate with an example. In the program below we’ve a string which contains a single character - which happens to be our favorite Unicode character - the rocket. You can <a href="https://codepoints.net/U+1F680">inspect the character and its data here</a>.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 26 - Unicode codepoint with UTF-8 code</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"encoding/hex"</code>
<code class="linenos"> 5 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">myString</code> <code class="o">:=</code> <code class="s2">"🚀"</code>
<code class="linenos">10 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Unicode codepoint represented by rune:"</code><code class="p">,</code> <code class="p">[]</code><code class="n">rune</code><code class="p">(</code><code class="n">myString</code><code class="p">))</code>
<code class="linenos">11 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"UTF-8 code represented by up to 4 bytes:"</code><code class="p">,</code> <code class="p">[]</code><code class="n">byte</code><code class="p">(</code><code class="n">myString</code><code class="p">))</code>
<code class="linenos">12 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"UTF-8 code represented as Hexadecimal:"</code><code class="p">,</code> <code class="nb">hex</code><code class="o">.</code><code class="n">EncodeToString</code><code class="p">([]</code><code class="n">byte</code><code class="p">(</code><code class="n">myS</code>\
<code class="linenos">13 </code><code class="n">tring</code><code class="p">)))</code>
<code class="linenos">14 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"length"</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="n">myString</code><code class="p">))</code>
<code class="linenos">15 </code><code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">luDIj6DwPAG</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Unicode codepoint represented by rune: <code class="o">[</code><code class="m">128640</code><code class="o">]</code>
<code class="linenos">2 </code>UTF-8 code represented by up to <code class="m">4</code> bytes: <code class="o">[</code><code class="m">240</code> <code class="m">159</code> <code class="m">154</code> <code class="m">128</code><code class="o">]</code>
<code class="linenos">3 </code>UTF-8 code represented as Hexadecimal: f09f9a80
<code class="linenos">4 </code>length <code class="m">4</code>
<code class="linenos">5 </code>
<code class="linenos">6 </code>Program exited.
</pre></div>

</figure>


<p>The output shows the Unicode identifier for the rocket character stored as a rune. Then, the same UTF-8 hexadecimal representation encoded as a byte slice.</p>

<p>Next we output the bytes, converted to their hexadecimal equivalent. Note, this hexadecimal sequence matches the UTF-8 sequence for the rocket on the website above.</p>

<p>Finally, we output the string “length” and we see something odd. We get a length of 4 when the string is only one character. That’s right, <code>len()</code> operates on the underlying byte slice by default - not the string.</p>

<aside class="information blurb">
    <p>Careful here, it’s a common mistake to use <code>len()</code> to determine the length of a string. If you’re dealing purely with ASCII it will be fine, because one character is represented by one byte - swap a simple ASCII character like <i>a</i> into the Go Playground example to see for yourself - but if your string contains Unicode characters, <code>len()</code> will not be accurate, unless you wanted the number of bytes, not the number of actual characters. Think back to the string example in 7.1.3. What might happen if we printed a substring of a string which contained Unicode characters?</p>

</aside>

<p>To safely get the length of a string and not the length of the byte representation of the string, first convert it to a slice of runes as shown in the following example:</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 27 - Safely obtaining length of a string</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="n">myString</code> <code class="o">:=</code> <code class="s2">"🚀"</code>
<code class="linenos"> 9 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"length"</code><code class="p">,</code> <code class="nb">len</code><code class="p">([]</code><code class="n">rune</code><code class="p">(</code><code class="n">myString</code><code class="p">)))</code>
<code class="linenos">10 </code><code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">wTnoddQnjvJ</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>length 1
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>As an alias for <i>int32</i> a variable of type <i>rune</i> is initialised to zero at declaration.</p>

<aside class="information blurb">
    <p>Going back to the example at the start of this section, the second string contains a <a href="https://codepoints.net/U+04BB">cyrillic character</a> that looks like a “h” but it isn’t.  It’s not an ASCII character, it’s Unicode with a UTF-8 encoding of <code>D2 DB</code>. We need two bytes - and not one - to represent this character in the underlying byte slice, so the string length appears longer.</p>

</aside>

<h2 id="leanpub-auto-aggregate-types" class="section">7.2 Aggregate types</h2>

<p>Aggregate types are types that contain aggregates of other data types, either basic types or nested aggregate, reference and interface types.</p>

<p>In Go we refer to <i>array</i> and <i>struct</i> types as aggregate types.</p>

<h3 id="leanpub-auto-array" class="subsection">7.2.1 Array</h3>

<p>An <i>array</i> can contain a fixed number of elements of a single type. </p>

<p>Elements in an array are initialised to their <i>nil</i> value. For example, an array of type <i>int</i> with 5 elements, will have all 5 elements initialised to zero. Length of the array will be 5.</p>

<p>An <i>array</i> cannot be resized once declared, its length is fixed, and a part of its type. A variable with type <code>[5]int</code> is not considered to be of same type as a variable with type <code>[6]int</code>, despite both arrays holding integers.</p>

<p>An <i>array</i> has the same capacity as its length. We’ll cover <i>capacity</i> later when we discuss slices.</p>

<p>Arrays, as in many programming languages, are “zero-bound”. The first element in the array will be referenced by an index of 0 and not 1. </p>

<p>Two example programs are included next to demonstrate what we’ve discussed above.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 28 - Array length, capacity and element initialisation</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="n">var</code> <code class="n">intArray</code> <code class="p">[</code><code class="mi">5</code><code class="p">]</code><code class="nb">int</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Array length:"</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="n">intArray</code><code class="p">))</code>
<code class="linenos">11 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Array capacity:"</code><code class="p">,</code> <code class="n">cap</code><code class="p">(</code><code class="n">intArray</code><code class="p">))</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>	<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="nb">range</code> <code class="n">intArray</code> <code class="p">{</code>
<code class="linenos">14 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Array element index"</code><code class="p">,</code> <code class="n">i</code><code class="p">,</code> <code class="s2">"contains value"</code><code class="p">,</code> <code class="n">intArray</code><code class="p">[</code><code class="n">i</code><code class="p">])</code>
<code class="linenos">15 </code>	<code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code>	<code class="n">intArray</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">=</code> <code class="mi">1</code>
<code class="linenos">18 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">intArray</code><code class="p">)</code>
<code class="linenos">19 </code><code class="p">}</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">D_hs2NHHoAs</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code>Array length: 5
<code class="linenos"> 2 </code>Array capacity: 5
<code class="linenos"> 3 </code>Array element index 0 contains value 0
<code class="linenos"> 4 </code>Array element index 1 contains value 0
<code class="linenos"> 5 </code>Array element index 2 contains value 0
<code class="linenos"> 6 </code>Array element index 3 contains value 0
<code class="linenos"> 7 </code>Array element index 4 contains value 0
<code class="linenos"> 8 </code>[1 0 0 0 0]
<code class="linenos"> 9 </code>
<code class="linenos">10 </code>Program exited.
</pre></div>

</figure>


<p>Walking through the previous example, we first declare a variable of type <i>[5]int</i>. We print length and capacity which are both 5, and then iterate over the elements using the <i>range</i> keyword to show that each element in the array has been initialised to its nil value, which is zero for the <i>integer</i> type. For completeness, we then make a simple assignment to the first element in the array and print the entire variable.</p>

<p>The next example demonstrates how length is part of an arrays type.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 29 - Array length is part of its type definition</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">var</code> <code class="n">intArray</code> <code class="p">[</code><code class="mi">5</code><code class="p">]</code><code class="nb">int</code>
<code class="linenos"> 7 </code>	<code class="n">var</code> <code class="n">intArray2</code> <code class="p">[</code><code class="mi">6</code><code class="p">]</code><code class="nb">int</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>	<code class="k">if</code> <code class="n">intArray</code> <code class="o">==</code> <code class="n">intArray2</code> <code class="p">{</code>
<code class="linenos">10 </code>        <code class="o">//</code> <code class="n">this</code> <code class="n">will</code> <code class="n">never</code> <code class="nb">print</code>
<code class="linenos">11 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Array values and type are same"</code><code class="p">)</code>
<code class="linenos">12 </code>	<code class="p">}</code>
<code class="linenos">13 </code><code class="p">}</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">xgNuJjZQHZM</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">.</code><code class="o">/</code><code class="n">prog</code><code class="p">.</code><code class="k">go</code><code class="err">:</code><code class="mi">9</code><code class="err">:</code><code class="mi">17</code><code class="err">:</code><code class="w"> </code><code class="n">invalid</code><code class="w"> </code><code class="k">operation</code><code class="err">:</code><code class="w"> </code><code class="n">intArray</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="n">intArray2</code><code class="w"> </code><code class="p">(</code><code class="n">mismatched</code><code class="w"> </code><code class="n">types</code><code class="w"> </code><code class="o">[</code><code class="n">5</code><code class="o">]</code><code class="nc">int</code><code class="w"> </code><code class="n">an</code><code class="err">\</code><code class="w"></code>
<code class="linenos">2 </code><code class="n">d</code><code class="w"> </code><code class="o">[</code><code class="n">6</code><code class="o">]</code><code class="nc">int</code><code class="p">)</code><code class="w"></code>
<code class="linenos">3 </code>
<code class="linenos">4 </code><code class="k">Go</code><code class="w"> </code><code class="n">build</code><code class="w"> </code><code class="n">failed</code><code class="p">.</code><code class="w"></code>
</pre></div>

</figure>


<p>In this final example, we show two ways to declare and initialise an array to non-zero values:</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 30 - Set array length with the spread operator</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">intArray</code> <code class="o">:=</code> <code class="p">[</code><code class="mi">3</code><code class="p">]</code><code class="nb">int</code><code class="p">{</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">}</code>
<code class="linenos"> 7 </code>	<code class="n">intArray2</code> <code class="o">:=</code> <code class="p">[</code><code class="o">...</code><code class="p">]</code><code class="nb">int</code><code class="p">{</code><code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">6</code><code class="p">}</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">intArray</code><code class="p">)</code>
<code class="linenos">10 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">intArray2</code><code class="p">)</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">bxX2YplIPa8</code>
</pre></div>

</figure>


<p>First, we declare a variable <i>intArray</i> of type [3]int by specifying the length and capacity explicitly. </p>

<p>When declaring the second variable <i>intArray2</i> we do much the same, but instead, we use the number of elements in the array to initialise it using the <i>spread operator</i> denoted by the ellipse (three dots).</p>

<p>The spread operator has other uses, which we’ll see as we progress.</p>

<p>Arrays are rarely used in Go as most use cases favour slices over arrays which are generally more flexible. However, where we know the number of elements we need ahead of time, and this number is fixed, it can be more memory-efficient to use an array, and we’ll see why when we discuss slices later in the chapter.</p>

<h3 id="leanpub-auto-struct" class="subsection">7.2.2 Struct</h3>

<p>A <i>struct</i> - short for structure - is a type which can hold a collection of fields which are themselves typed.  <i>Structs</i> are useful for representing collections of data in our programs. </p>

<p>Structs can be used <i>anonymously</i> - their properties defined at the point of use - which is useful if we only need a temporary representation of something, or, we can use the struct type as a basis for building our own named custom types that represent the collections we work with in our program.</p>

<p>In both cases, fields are initialised to their nil values unless explicitly provided a value.</p>

<p>We show both approaches in the example below:</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 31 - Named custom struct type and anonymous struct</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="o">//</code> <code class="n">Named</code> <code class="n">custom</code> <code class="n">struct</code>
<code class="linenos"> 6 </code><code class="nb">type</code> <code class="n">User</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 7 </code>	<code class="n">Name</code> <code class="n">string</code>
<code class="linenos"> 8 </code>	<code class="n">Age</code>  <code class="nb">int</code>
<code class="linenos"> 9 </code><code class="p">}</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="o">//</code> <code class="n">Second</code> <code class="n">named</code> <code class="n">custom</code> <code class="n">struct</code>
<code class="linenos">12 </code><code class="nb">type</code> <code class="n">User2</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos">13 </code>	<code class="n">Name</code> <code class="n">string</code>
<code class="linenos">14 </code>	<code class="n">Age</code>  <code class="nb">int</code>
<code class="linenos">15 </code><code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">18 </code>	<code class="n">var</code> <code class="n">user</code> <code class="n">User</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code>	<code class="o">//</code> <code class="n">Anonymous</code> <code class="n">struct</code> <code class="n">created</code> <code class="n">at</code> <code class="n">point</code> <code class="n">of</code> <code class="n">use</code>
<code class="linenos">21 </code>	<code class="n">data</code> <code class="o">:=</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos">22 </code>		<code class="n">Name</code> <code class="n">string</code>
<code class="linenos">23 </code>		<code class="n">Age</code>  <code class="nb">int</code>
<code class="linenos">24 </code>	<code class="p">}{</code>
<code class="linenos">25 </code>		<code class="n">Name</code><code class="p">:</code> <code class="s2">"Joe Blogs"</code><code class="p">,</code>
<code class="linenos">26 </code>		<code class="n">Age</code><code class="p">:</code>  <code class="mi">20</code><code class="p">,</code>
<code class="linenos">27 </code>	<code class="p">}</code>
<code class="linenos">28 </code>
<code class="linenos">29 </code>	<code class="n">user</code> <code class="o">=</code> <code class="n">data</code>
<code class="linenos">30 </code>
<code class="linenos">31 </code>	<code class="o">//</code><code class="n">var</code> <code class="n">user2</code> <code class="n">User2</code>
<code class="linenos">32 </code>	<code class="o">//</code><code class="n">user2</code> <code class="o">=</code> <code class="n">user</code>
<code class="linenos">33 </code>
<code class="linenos">34 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">user</code><code class="p">)</code>
<code class="linenos">35 </code><code class="p">}</code>
<code class="linenos">36 </code>
<code class="linenos">37 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">gWnMhWF_OVK</code>
</pre></div>

</figure>


<p>At line 6 we define a named custom type <i>User</i> and we create a value of that struct type at line 18 in the variable <i>user</i>.</p>

<p>At line 21 we create an anonymous struct literal to represent some data, it’s fields happen to match the named <i>User</i> structs fields.</p>

<p>Since they match, we can assign the <i>data</i> variable directly to the <i>user</i> variable as we do on line 29.</p>

<p>We can <b>only</b> do this with anonymous struct types, not with named custom struct types. </p>

<p>To illustrate, if we uncomment line 31 and 32 and attempt to run the example code again we’ll get a compilation error, despite <i>User</i> and <i>User2</i> types having identical fields: </p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>./prog.go:32:10: cannot use user <code class="o">(</code>variable of <code class="nb">type</code> User<code class="o">)</code> as <code class="nb">type</code> User2 <code class="k">in</code> assignment
<code class="linenos">2 </code>
<code class="linenos">3 </code>Go build failed.
</pre></div>

</figure>

<p class="fake-para">Struct values can be compared using simple comparison operations. For them to be considered equal, they must either be of the same type or, one or both structs must be anonymous, and the values of all of their fields must also be equal.</p>

<p>With both custom struct types and anonymous structs, where we define them in their struct literal form we can omit the field names in the values on two conditions. First, we must provide the values in the same field order as the struct’s type definition and second, we must provide a value for all fields.</p>

<p>There’s a brief example showing this form below:</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 32 - Unnamed struct fields</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="o">//</code> <code class="n">Named</code> <code class="n">custom</code> <code class="n">struct</code>
<code class="linenos"> 6 </code><code class="nb">type</code> <code class="n">User</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 7 </code>	<code class="n">Name</code> <code class="n">string</code>
<code class="linenos"> 8 </code>	<code class="n">Age</code>  <code class="nb">int</code>
<code class="linenos"> 9 </code>	<code class="n">Sex</code>  <code class="n">string</code>
<code class="linenos">10 </code><code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">13 </code>	<code class="n">user</code> <code class="o">:=</code> <code class="n">User</code><code class="p">{</code>
<code class="linenos">14 </code>		<code class="s2">"Joe Blogs"</code><code class="p">,</code>
<code class="linenos">15 </code>		<code class="mi">20</code><code class="p">,</code>
<code class="linenos">16 </code>		<code class="s2">"Male"</code><code class="p">,</code>
<code class="linenos">17 </code>	<code class="p">}</code>
<code class="linenos">18 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">user</code><code class="p">)</code>
<code class="linenos">19 </code><code class="p">}</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">hun_q6dx</code><code class="o">-</code><code class="n">VC</code>
</pre></div>

</figure>


<p>Once declared we also can get and set struct fields by using a dot separator as below.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 33 - Get and set struct fields</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="o">//</code> <code class="n">Named</code> <code class="n">custom</code> <code class="n">struct</code>
<code class="linenos"> 6 </code><code class="nb">type</code> <code class="n">User</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 7 </code>	<code class="n">Name</code> <code class="n">string</code>
<code class="linenos"> 8 </code>	<code class="n">Age</code>  <code class="nb">int</code>
<code class="linenos"> 9 </code><code class="p">}</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">12 </code>	<code class="n">var</code> <code class="n">user</code> <code class="n">User</code> <code class="o">//</code> <code class="nb">all</code> <code class="n">fields</code> <code class="n">initialised</code> <code class="n">to</code> <code class="n">nil</code> <code class="n">value</code>
<code class="linenos">13 </code>	<code class="n">user</code><code class="o">.</code><code class="n">Name</code> <code class="o">=</code> <code class="s2">"Joe Blogs"</code>
<code class="linenos">14 </code>	<code class="n">user</code><code class="o">.</code><code class="n">Age</code> <code class="o">=</code> <code class="mi">20</code>
<code class="linenos">15 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"User is </code><code class="si">%s</code><code class="s2">. They are </code><code class="si">%d</code><code class="s2"> years of age"</code><code class="p">,</code> <code class="n">user</code><code class="o">.</code><code class="n">Name</code><code class="p">,</code> <code class="n">user</code><code class="o">.</code><code class="n">Age</code><code class="p">)</code>
<code class="linenos">16 </code><code class="p">}</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">gM5fADxC9gB</code>
</pre></div>

</figure>


<h4 id="leanpub-auto-composition-and-embedding" class="subsubsection">7.2.2.1 Composition and embedding</h4>

<p>Structs can be embedded inside other structs. By taking smaller pieces of code we can combine their attributes and behaviour into a new piece of code and add extra attributes and behaviour we need. </p>

<p>In Go, we call this <i>composition</i>.</p>

<p>We stated in chapter one that <i>composition</i> roughly aligns with inheritance in OOP but there are key differences. </p>

<p>Many OOP languages do not offer multiple inheritance, so users can only inherit one superset class of functionality. When using Go’s composition we can embed unlimited structs, each representing specific attributes and behaviour. </p>

<p>For clarity, the <i>behaviour</i> we talk of is provided by <i>receivers</i> which can be created on the custom struct types, just as on other any custom type. </p>

<p>Typically in OOP languages we inherit one big thing that <i>almost</i> does what we want, then extend and override it in our class to make it do want we need. In Go, composition is like building the thing from smaller pieces. This provides more flexibility but also the potential for more code reusability.</p>

<p>When we embed a struct inside another struct we <i>can</i> promote its fields and receivers so that they can be used as if they were a part of that struct. </p>

<p>The example below illustrates composition through struct embedding.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 34 - Composition and struct embedding</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nb">type</code> <code class="n">Eyes</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">Color</code> <code class="n">string</code>
<code class="linenos"> 7 </code>	<code class="n">Shape</code> <code class="n">string</code>
<code class="linenos"> 8 </code><code class="p">}</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="nb">type</code> <code class="n">Human</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos">11 </code>	<code class="n">Eyes</code>
<code class="linenos">12 </code><code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="nb">type</code> <code class="n">Dog</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos">15 </code>	<code class="n">Eyes</code> <code class="n">Eyes</code>
<code class="linenos">16 </code><code class="p">}</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">19 </code>	<code class="n">var</code> <code class="n">human</code> <code class="n">Human</code>
<code class="linenos">20 </code>	<code class="n">var</code> <code class="n">dog</code> <code class="n">Dog</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code>	<code class="o">//</code> <code class="n">promoted</code> <code class="n">field</code> <code class="n">access</code>
<code class="linenos">23 </code>	<code class="n">human</code><code class="o">.</code><code class="n">Color</code> <code class="o">=</code> <code class="s2">"Blue"</code>
<code class="linenos">24 </code>	<code class="n">human</code><code class="o">.</code><code class="n">Shape</code> <code class="o">=</code> <code class="s2">"Round"</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code>	<code class="o">//</code> <code class="n">long</code> <code class="n">form</code> <code class="n">field</code> <code class="n">access</code>
<code class="linenos">27 </code>	<code class="n">human</code><code class="o">.</code><code class="n">Eyes</code><code class="o">.</code><code class="n">Color</code> <code class="o">=</code> <code class="s2">"Brown"</code>
<code class="linenos">28 </code>
<code class="linenos">29 </code>	<code class="o">//</code> <code class="n">dog</code><code class="o">.</code><code class="n">Color</code> <code class="o">=</code> <code class="s2">"Brown"</code> <code class="o">//</code> <code class="n">won</code><code class="s1">'t build</code>
<code class="linenos">30 </code>
<code class="linenos">31 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">human</code><code class="p">,</code> <code class="n">dog</code><code class="p">)</code>
<code class="linenos">32 </code><code class="p">}</code>
<code class="linenos">33 </code>
<code class="linenos">34 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">6</code><code class="n">DSmzLgW3Xo</code>
</pre></div>

</figure>


<p>Picking out the important pieces, we embedded the <i>Eyes</i> struct in the <i>Human</i> struct. We can access its fields (and receivers) as if they were directly associated with the <i>Human</i> struct, as seen on lines 23 &amp; 24.</p>

<p>However, in this example, although we <i>can</i> do this, we lose some clarity in our syntax - what do colour and shape refer to - so we may consider using the long form field accessor, which is still available, as shown on line 27.</p>

<p>Note, the <i>Dog</i> struct also uses the <i>Eyes</i> struct, but we do not embed it this time. Instead, we use it as the type on a named field <i>Eyes</i>.  In this situation, only long-form access is possible, there is no field or receiver promotion.</p>

<p>Note also that when embedding struct types from imported packages the usual rules on visibility apply. Only exported functionality can be used.</p>

<p>Finally, the example serves also to illustrate the benefits of composition. We can reuse <i>Eyes</i> which describes attributes of colour and shape for anything that has eyes, of which <i>Human</i> and <i>Dog</i> are but just two examples.</p>

<h4 id="leanpub-auto-memory-use-alignment--padding" class="subsubsection">7.2.2.2 Memory use, alignment &amp; padding</h4>

<p>Before leaving structs we need to briefly mention memory use, and specifically alignment and padding.</p>

<p>Memory usage may be a consideration if a struct has a large number of fields and we are working with a many of these struct values in memory at the same time - perhaps when retrieving a list of rows from a database table of users, for example.</p>

<p>In such circumstances, it <i>may</i> be necessary to consider how struct fields are ordered, and possibly alternative integer types rather than the single <i>int</i> we’ve recommended thus far. The reason comes down to how structs and their fields are stored in memory.</p>

<p>Think of a 64-bit architecture as storing data in 8-byte slots.  An <i>int</i> variable, which in this architecture is an alias for <i>int64</i>, requires 8 bytes in memory and so would sit perfectly inside one of these slots. </p>

<p>Two <i>int32</i> types would occupy a slot, whereas an <i>int8</i> type occupies a single byte in memory, as does a <i>bool</i> type, so we could hold eight booleans or eight <i>int8</i> typed variables in a single 8-byte slot.</p>

<p>For efficiency of access, adjacent struct fields that cannot fit in the current 8-byte slot will use the next 8-byte slot in memory. This results in some level of <i>padding</i> in slots that do not utilise all eight bytes, meaning that not all memory used by the struct, is holding data.</p>

<p>Field ordering determines how much padding is required, so, large structs with suboptimal field type ordering may use significantly more memory, which can become an issue when we need to hold many of these struct values in memory at once.  </p>

<p>It’s simple to demonstrate with an example.  </p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 35 - Alignment and impact on memory</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"unsafe"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="nb">type</code> <code class="n">Suboptimal</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">bool1</code> <code class="nb">bool</code>
<code class="linenos">10 </code>	<code class="n">int1</code>  <code class="nb">int</code>
<code class="linenos">11 </code>	<code class="n">bool2</code> <code class="nb">bool</code>
<code class="linenos">12 </code>	<code class="n">int2</code>  <code class="nb">int</code>
<code class="linenos">13 </code>	<code class="n">bool3</code> <code class="nb">bool</code>
<code class="linenos">14 </code>	<code class="n">int3</code>  <code class="nb">int</code>
<code class="linenos">15 </code>	<code class="n">bool4</code> <code class="nb">bool</code>
<code class="linenos">16 </code>	<code class="n">int4</code>  <code class="nb">int</code>
<code class="linenos">17 </code><code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="nb">type</code> <code class="n">Optimal</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos">20 </code>	<code class="n">bool1</code> <code class="nb">bool</code>
<code class="linenos">21 </code>	<code class="n">bool2</code> <code class="nb">bool</code>
<code class="linenos">22 </code>	<code class="n">bool3</code> <code class="nb">bool</code>
<code class="linenos">23 </code>	<code class="n">bool4</code> <code class="nb">bool</code>
<code class="linenos">24 </code>	<code class="n">int1</code>  <code class="nb">int</code>
<code class="linenos">25 </code>	<code class="n">int2</code>  <code class="nb">int</code>
<code class="linenos">26 </code>	<code class="n">int3</code>  <code class="nb">int</code>
<code class="linenos">27 </code>	<code class="n">int4</code>  <code class="nb">int</code>
<code class="linenos">28 </code><code class="p">}</code>
<code class="linenos">29 </code>
<code class="linenos">30 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">31 </code>	<code class="n">subOptimal</code> <code class="o">:=</code> <code class="p">[</code><code class="mi">1000</code><code class="p">]</code><code class="n">Suboptimal</code><code class="p">{}</code>
<code class="linenos">32 </code>	<code class="n">sizeSuboptimal</code> <code class="o">:=</code> <code class="n">float64</code><code class="p">(</code><code class="n">unsafe</code><code class="o">.</code><code class="n">Sizeof</code><code class="p">(</code><code class="n">subOptimal</code><code class="p">))</code>
<code class="linenos">33 </code>
<code class="linenos">34 </code>	<code class="n">optimal</code> <code class="o">:=</code> <code class="p">[</code><code class="mi">1000</code><code class="p">]</code><code class="n">Optimal</code><code class="p">{}</code>
<code class="linenos">35 </code>	<code class="n">sizeOptimal</code> <code class="o">:=</code> <code class="n">float64</code><code class="p">(</code><code class="n">unsafe</code><code class="o">.</code><code class="n">Sizeof</code><code class="p">(</code><code class="n">optimal</code><code class="p">))</code>
<code class="linenos">36 </code>
<code class="linenos">37 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Size of suboptimal array = %v bytes</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">sizeSuboptimal</code><code class="p">)</code>
<code class="linenos">38 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Size of optimal array = %v bytes</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">sizeOptimal</code><code class="p">)</code>
<code class="linenos">39 </code>
<code class="linenos">40 </code>	<code class="n">diff</code> <code class="o">:=</code> <code class="p">(</code><code class="n">sizeSuboptimal</code> <code class="o">-</code> <code class="n">sizeOptimal</code><code class="p">)</code> <code class="o">/</code> <code class="n">sizeSuboptimal</code> <code class="o">*</code> <code class="mi">100</code>
<code class="linenos">41 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Padding means we're using </code><code class="si">%d%%</code><code class="s2"> more memory..."</code><code class="p">,</code> <code class="nb">int</code><code class="p">(</code><code class="n">diff</code><code class="p">))</code>
<code class="linenos">42 </code><code class="p">}</code>
<code class="linenos">43 </code>
<code class="linenos">44 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">q7GJI1xfEqb</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Size of suboptimal <code class="nv">array</code> <code class="o">=</code> <code class="m">64000</code> bytes
<code class="linenos">2 </code>Size of optimal <code class="nv">array</code> <code class="o">=</code> <code class="m">40000</code> bytes
<code class="linenos">3 </code>Padding and int <code class="nb">type</code> means we<code class="err">'</code>re using <code class="m">37</code>% more memory...
<code class="linenos">4 </code>
<code class="linenos">5 </code>Program exited.
</pre></div>

</figure>


<p>In the first <i>Suboptimal</i> struct we have an admittedly extreme example. Due to alignment, each <i>int</i> field is using the next 8-byte slot resulting in 7 bytes of padding for each <i>bool</i>, so 28 bytes of padding in total per struct value. </p>

<p>In the second <i>Optimal</i> struct, all of our <i>bool</i> fields fit in a single 8-byte slot, and all <i>int</i> fields take one 8-byte slot each. Because of this, the total padding for each struct value is only 4 bytes.</p>

<h2 id="leanpub-auto-reference-types" class="section">7.3 Reference types</h2>

<p>In this section, we’ll look at three other important Go data types: <i>maps</i>, <i>slices</i> and <i>channels</i>.</p>

<p>Recall we said <i>reference type</i> isn’t official Go terminology but that we’re going to use it anyway. The distinction is helpful when learning about pointer and value semantics, specifically when it is necessary to pass a pointer to mutate the original value and when it is not.</p>

<p>The reason we’re classing map, slice and channel as reference types is that values of these types behave as if they <i>were</i> pointers.</p>

<p>All are essentially descriptors which point to (or reference) some kind of backing data. When using the descriptor, operations are performed on that backing data automatically, there’s no need to use a pointer to work with the backing data.</p>

<p>Functions and pointers are also reference types by the above definition, but we’re not covering them here. We’re also specifically excluding strings. Of course, we know a string points to a backing slice of bytes, so fits the above definition, but strings are a special case, the backing data cannot be mutated directly.</p>

<p>Let’s look at how we work with each in turn.</p>

<h3 id="leanpub-auto-map" class="subsection">7.3.2 Map</h3>

<p>The <i>map</i> type provides for associative data storage.  Quite simply, keys can be associated with values and stored in memory. Both <i>key</i> and <i>value</i> have a type which may be different and together they comprise the maps type definition.</p>

<p>A map must be initialised before use. Prior to initialisation we have a <i>nil map</i> which we cannot use. Attempting to do so will cause our program to panic.</p>

<p>Post-initialisation we have an <i>empty map</i>, a descriptor which points to an initialised area of memory in which we can add our key and value pairs.</p>

<p>In the following example, we declare a variable of type <code>map[string]string</code> meaning the key and value are both of type string.  We then try to work with the nil map, without initialising it, and our program panics.</p>

<p>Uncomment line 7 and run again to initialise the map using the <code>make</code> keyword. Our program now runs as expected.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 36 - Trying to use a nil map</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">var</code> <code class="n">myMap</code> <code class="nb">map</code><code class="p">[</code><code class="n">string</code><code class="p">]</code><code class="n">string</code>
<code class="linenos"> 7 </code>	<code class="o">//</code><code class="n">myMap</code> <code class="o">=</code> <code class="n">make</code><code class="p">(</code><code class="nb">map</code><code class="p">[</code><code class="n">string</code><code class="p">]</code><code class="n">string</code><code class="p">)</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>	<code class="n">myMap</code><code class="p">[</code><code class="s2">"key"</code><code class="p">]</code> <code class="o">=</code> <code class="s2">"value"</code>
<code class="linenos">10 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">myMap</code><code class="p">)</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">dOBBmtyVYuV</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>panic: assignment to entry <code class="k">in</code> nil map
</pre></div>

</figure>


<p>Maps can be initialised to an empty map, with the <code>make</code> keyword or by using a map literal which may, optionally, be populated with keys and values.</p>

<p>The next example shows the options available when creating an empty map. The comments describe each approach.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 37 - Creating an empty map</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="o">//</code> <code class="n">declaration</code> <code class="n">followed</code> <code class="n">my</code> <code class="n">initialisation</code> <code class="k">with</code> <code class="n">make</code>
<code class="linenos"> 7 </code>	<code class="n">var</code> <code class="n">myMap</code> <code class="nb">map</code><code class="p">[</code><code class="n">string</code><code class="p">]</code><code class="n">string</code>
<code class="linenos"> 8 </code>	<code class="n">myMap</code> <code class="o">=</code> <code class="n">make</code><code class="p">(</code><code class="nb">map</code><code class="p">[</code><code class="n">string</code><code class="p">]</code><code class="n">string</code><code class="p">)</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code>	<code class="o">//</code> <code class="n">declaration</code> <code class="o">&amp;</code> <code class="n">initialisation</code> <code class="k">with</code> <code class="n">make</code>
<code class="linenos">11 </code>	<code class="n">myMap2</code> <code class="o">:=</code> <code class="n">make</code><code class="p">(</code><code class="nb">map</code><code class="p">[</code><code class="n">string</code><code class="p">]</code><code class="n">string</code><code class="p">)</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>	<code class="o">//</code> <code class="n">declaration</code> <code class="o">&amp;</code> <code class="n">initialisation</code> <code class="k">as</code> <code class="n">empty</code> <code class="nb">map</code> <code class="n">literal</code>
<code class="linenos">14 </code>	<code class="n">myMap3</code> <code class="o">:=</code> <code class="nb">map</code><code class="p">[</code><code class="n">string</code><code class="p">]</code><code class="n">string</code><code class="p">{}</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code>	<code class="o">//</code> <code class="n">declaration</code> <code class="o">&amp;</code> <code class="n">initialisation</code> <code class="k">as</code> <code class="nb">map</code> <code class="n">literal</code> <code class="k">with</code> <code class="n">key</code><code class="o">/</code><code class="n">values</code>
<code class="linenos">17 </code>	<code class="n">myMap4</code> <code class="o">:=</code> <code class="nb">map</code><code class="p">[</code><code class="n">string</code><code class="p">]</code><code class="n">string</code><code class="p">{</code>
<code class="linenos">18 </code>		<code class="s2">"key"</code><code class="p">:</code> <code class="s2">"value"</code><code class="p">,</code>
<code class="linenos">19 </code>	<code class="p">}</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">myMap</code><code class="p">,</code> <code class="n">myMap2</code><code class="p">,</code> <code class="n">myMap3</code><code class="p">,</code> <code class="n">myMap4</code><code class="p">)</code>
<code class="linenos">22 </code><code class="p">}</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">kDhy20FhD6B</code>
</pre></div>

</figure>


<p>Shortly, we’ll explore how to work with maps in our code, but before that here’s a quick demonstration of the <i>reference type</i> qualities of maps. </p>

<p>In the example below we pass the map by value and not as a pointer. Despite this, we are able to mutate the original value, because maps behave as if they were pointers:  </p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 38 - Map passed by value</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">alterMap</code><code class="p">(</code><code class="n">mp</code> <code class="nb">map</code><code class="p">[</code><code class="n">string</code><code class="p">]</code><code class="n">string</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">mp</code><code class="p">[</code><code class="s2">"myKey"</code><code class="p">]</code> <code class="o">=</code> <code class="s2">"my new value"</code>
<code class="linenos"> 7 </code><code class="p">}</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="n">myMap</code> <code class="o">:=</code> <code class="nb">map</code><code class="p">[</code><code class="n">string</code><code class="p">]</code><code class="n">string</code><code class="p">{</code>
<code class="linenos">11 </code>		<code class="s2">"myKey"</code><code class="p">:</code> <code class="s2">"my value"</code><code class="p">,</code>
<code class="linenos">12 </code>	<code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">myMap</code><code class="p">)</code>
<code class="linenos">15 </code>	<code class="n">alterMap</code><code class="p">(</code><code class="n">myMap</code><code class="p">)</code>
<code class="linenos">16 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">myMap</code><code class="p">)</code>
<code class="linenos">17 </code><code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">i20LKvkaC0J</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>map<code class="o">[</code>myKey:my value<code class="o">]</code>
<code class="linenos">2 </code>map<code class="o">[</code>myKey:my new value<code class="o">]</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<p>We <i>can</i> apply pointer semantics and the program will build and run. Indeed, in the example below we rewrite <code>alterMap()</code> to accept a pointer to the map. </p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 39 - Map passed by reference</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">alterMap</code><code class="p">(</code><code class="n">mp</code> <code class="o">*</code><code class="nb">map</code><code class="p">[</code><code class="n">string</code><code class="p">]</code><code class="n">string</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="p">(</code><code class="o">*</code><code class="n">mp</code><code class="p">)[</code><code class="s2">"myKey"</code><code class="p">]</code> <code class="o">=</code> <code class="s2">"my new value"</code>
<code class="linenos"> 7 </code><code class="p">}</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="n">myMap</code> <code class="o">:=</code> <code class="nb">map</code><code class="p">[</code><code class="n">string</code><code class="p">]</code><code class="n">string</code><code class="p">{</code>
<code class="linenos">11 </code>		<code class="s2">"myKey"</code><code class="p">:</code> <code class="s2">"my value"</code><code class="p">,</code>
<code class="linenos">12 </code>	<code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">myMap</code><code class="p">)</code>
<code class="linenos">15 </code>	<code class="n">alterMap</code><code class="p">(</code><code class="o">&amp;</code><code class="n">myMap</code><code class="p">)</code>
<code class="linenos">16 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">myMap</code><code class="p">)</code>
<code class="linenos">17 </code><code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">lgiCDOYzSrj</code>
</pre></div>

</figure>


<p>We get the same result from the program. However, it achieves nothing extra but makes the syntax less clear. We shouldn’t do this in our code, instead, we should pass maps by value and let the compiler worry about the semantics.</p>

<h4 id="leanpub-auto-working-with-maps" class="subsubsection">7.3.2.1 Working with maps</h4>

<p>We can create map keys and values by simply specifying the key and assigning it a value. The syntax is very similar when we access a key to obtain its value.</p>

<p>As well as accessing keys individually to obtain the corresponding value, we may also access the entire contents of a map by iterating over it in a loop. When iterating in this manner, it is impossible to predict in what order keys will be retrieved since map access is non-deterministic: keys are fetched neither on a LIFO nor FIFO basis, but instead pseudo-randomly.</p>

<p>We can determine the length of a map - how many keys it contains - using the <code>len()</code> function which we’ve seen previously when discussing arrays.</p>

<p>Removing a key from a map is performed with the <code>delete</code> keyword. Currently, keys must be removed one by one, there is no way to delete an entire map, although this <a href="https://go.dev/play/p/qIdnGrd0CYs?v=gotip">feature is in an experimental Go branch</a></p>

<p>The example below demonstrates the map operations we’ve just discussed, the code is commented to describe the operations but it should be fairly obvious.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 40 - Working with maps</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">var</code> <code class="n">myMap</code> <code class="o">=</code> <code class="n">make</code><code class="p">(</code><code class="nb">map</code><code class="p">[</code><code class="n">string</code><code class="p">]</code><code class="n">string</code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code>	<code class="o">//</code> <code class="n">create</code> <code class="n">three</code> <code class="n">keys</code> <code class="ow">in</code> <code class="n">the</code> <code class="nb">map</code>
<code class="linenos"> 9 </code>	<code class="n">myMap</code><code class="p">[</code><code class="s2">"key1"</code><code class="p">]</code> <code class="o">=</code> <code class="s2">"value1"</code>
<code class="linenos">10 </code>	<code class="n">myMap</code><code class="p">[</code><code class="s2">"key2"</code><code class="p">]</code> <code class="o">=</code> <code class="s2">"value2"</code>
<code class="linenos">11 </code>	<code class="n">myMap</code><code class="p">[</code><code class="s2">"key3"</code><code class="p">]</code> <code class="o">=</code> <code class="s2">"value3"</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>	<code class="o">//</code> <code class="n">obtain</code> <code class="n">the</code> <code class="n">number</code> <code class="n">of</code> <code class="n">key</code><code class="o">/</code><code class="n">values</code>
<code class="linenos">14 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Map keys:"</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="n">myMap</code><code class="p">))</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code>	<code class="o">//</code> <code class="n">access</code> <code class="n">the</code> <code class="n">value</code> <code class="n">stored</code> <code class="k">for</code> <code class="n">a</code> <code class="n">key</code>
<code class="linenos">17 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">myMap</code><code class="p">[</code><code class="s2">"key1"</code><code class="p">])</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code>	<code class="o">//</code> <code class="n">iterate</code> <code class="n">over</code> <code class="n">the</code> <code class="nb">map</code> <code class="k">with</code> <code class="nb">range</code> <code class="ow">and</code> <code class="nb">print</code> <code class="n">each</code> <code class="n">key</code><code class="o">/</code><code class="n">value</code>
<code class="linenos">20 </code>	<code class="k">for</code> <code class="n">k</code><code class="p">,</code> <code class="n">v</code> <code class="o">:=</code> <code class="nb">range</code> <code class="n">myMap</code> <code class="p">{</code>
<code class="linenos">21 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">k</code><code class="p">,</code> <code class="n">v</code><code class="p">)</code>
<code class="linenos">22 </code>	<code class="p">}</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code>	<code class="o">//</code> <code class="n">delete</code> <code class="n">key3</code>
<code class="linenos">25 </code>	<code class="n">delete</code><code class="p">(</code><code class="n">myMap</code><code class="p">,</code> <code class="s2">"key3"</code><code class="p">)</code>
<code class="linenos">26 </code>
<code class="linenos">27 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">myMap</code><code class="p">)</code>
<code class="linenos">28 </code><code class="p">}</code>
<code class="linenos">29 </code>
<code class="linenos">30 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">6</code><code class="o">-</code><code class="n">ht0hCoQFj</code>
</pre></div>

</figure>


<h4 id="leanpub-auto-safely-accessing-keys-in-a-map" class="subsubsection">7.3.2.2 Safely accessing keys in a map</h4>

<p>Obviously, care should be taken to ensure program code cannot read and write to a map - in fact to any variable - in a way that leaves the variable in an uncertain state. Known as a race condition, this is often a problem in asynchronous code, and it’s something we’ll cover in a later chapter when we look at goroutines and concurrency.</p>

<p>In this section, we are still concerned about safe access, but in ensuring that if we request the value stored for a key in the map, that the requested key exists in the map.</p>

<p>Should we request the value for a key which is not present, our program will return the nil or zero value for the map value type. To avoid this risk, we can make use of a second return value when we try to access a key.  This second return, a bool, will be false if the key is not present and true if it is.</p>

<aside class="information blurb">
    <p>This is a common cause of intermitment bugs. If we request the value of a key that does not exist, the returned nil value could be perfectly valid and our program will proceed to process that value as if the key had existed. That might not go to well for us.</p>

</aside>

<p>Two short examples follow. In the first, we do not check for the existence of a key, and our program receives valid data for a map key which does not exist:</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 41 - Unsafe map access</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">activeUser</code> <code class="o">:=</code> <code class="nb">map</code><code class="p">[</code><code class="n">string</code><code class="p">]</code><code class="nb">bool</code><code class="p">{</code>
<code class="linenos"> 7 </code>		<code class="s2">"Joe Blogs"</code><code class="p">:</code>  <code class="n">true</code><code class="p">,</code>
<code class="linenos"> 8 </code>		<code class="s2">"Dave Blogs"</code><code class="p">:</code> <code class="n">false</code><code class="p">,</code>
<code class="linenos"> 9 </code>	<code class="p">}</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code>	<code class="o">//</code> <code class="n">keys</code> <code class="n">exists</code> <code class="n">no</code> <code class="n">issue</code>
<code class="linenos">12 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Joe is active:"</code><code class="p">,</code> <code class="n">activeUser</code><code class="p">[</code><code class="s2">"Joe Blogs"</code><code class="p">])</code>
<code class="linenos">13 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Dave is active:"</code><code class="p">,</code> <code class="n">activeUser</code><code class="p">[</code><code class="s2">"Dave Blogs"</code><code class="p">])</code>
<code class="linenos">14 </code>	<code class="o">//</code> <code class="n">key</code> <code class="n">does</code> <code class="ow">not</code> <code class="n">exist</code>
<code class="linenos">15 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Trevor is active:"</code><code class="p">,</code> <code class="n">activeUser</code><code class="p">[</code><code class="s2">"Trevor Blogs"</code><code class="p">])</code>
<code class="linenos">16 </code><code class="p">}</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">9</code><code class="n">jX2B7x1eha</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Joe is active: <code class="nb">true</code>
<code class="linenos">2 </code>Dave is active: <code class="nb">false</code>
<code class="linenos">3 </code>Trevor is active: <code class="nb">false</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code>Program exited.
</pre></div>

</figure>


<p>In this second example, we correctly verify the key exists in the map, before attempting to work with the value associated with the key:</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 42 - Safe map access</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">activeUser</code> <code class="o">:=</code> <code class="nb">map</code><code class="p">[</code><code class="n">string</code><code class="p">]</code><code class="nb">bool</code><code class="p">{</code>
<code class="linenos"> 7 </code>		<code class="s2">"Joe Blogs"</code><code class="p">:</code>  <code class="n">true</code><code class="p">,</code>
<code class="linenos"> 8 </code>		<code class="s2">"Dave Blogs"</code><code class="p">:</code> <code class="n">false</code><code class="p">,</code>
<code class="linenos"> 9 </code>	<code class="p">}</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code>	<code class="k">if</code> <code class="n">active</code><code class="p">,</code> <code class="n">ok</code> <code class="o">:=</code> <code class="n">activeUser</code><code class="p">[</code><code class="s2">"Trevor Blogs"</code><code class="p">];</code> <code class="err">!</code><code class="n">ok</code> <code class="p">{</code>
<code class="linenos">12 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"User does not exist"</code><code class="p">)</code>
<code class="linenos">13 </code>	<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="linenos">14 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Trevor is active:"</code><code class="p">,</code> <code class="n">active</code><code class="p">)</code>
<code class="linenos">15 </code>	<code class="p">}</code>
<code class="linenos">16 </code><code class="p">}</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">a4zZyEM8viF</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>User does not exist
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>The takeaway is that we should always check for the existence of key in a map before trying to use its value in our program.</p>

<h3 id="leanpub-auto-slice" class="subsection">7.3.3 Slice</h3>

<p>Slices are one of the most versatile and commonly used data types in Go. Often we’ll use a slice in preference to a sized array without evening thinking about it. On other occasions, we may choose a slice specifically because we need a container for an unknown number of elements, which makes an array unsuitable, or certainly harder to work with.</p>

<p>Slices point to an underlying backing array of data, but Go manages that array for us.  Slices have a length and a capacity. Depending on how we create the slice, length and capacity can be the same, or different, which is not the case for arrays, where both length and capacity are the same.</p>

<aside class="information blurb">
    <p>Length, determined using the <code>len()</code> command is the number of elements which are initialised in the slice, either to a value of our choosing or to the nil value for the slice type.  Capacity, which we can determine with the <code>cap()</code> command is how many elements in total, are available in the backing array that underpins the slice.</p>

</aside>

<p>In the example below we create a slice of integers in five slightly different ways. </p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 43 - Creating a slice</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">var</code> <code class="n">sl1</code> <code class="p">[]</code><code class="nb">int</code>
<code class="linenos"> 7 </code>	<code class="n">sl2</code> <code class="o">:=</code> <code class="p">[]</code><code class="nb">int</code><code class="p">{}</code>
<code class="linenos"> 8 </code>	<code class="n">sl3</code> <code class="o">:=</code> <code class="p">[]</code><code class="nb">int</code><code class="p">{</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">}</code>
<code class="linenos"> 9 </code>	<code class="n">sl4</code> <code class="o">:=</code> <code class="n">make</code><code class="p">([]</code><code class="nb">int</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>
<code class="linenos">10 </code>	<code class="n">sl5</code> <code class="o">:=</code> <code class="n">make</code><code class="p">([]</code><code class="nb">int</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">4</code><code class="p">)</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code>	<code class="o">//</code> <code class="n">check</code> <code class="n">length</code>
<code class="linenos">13 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">sl1</code><code class="p">),</code> <code class="nb">len</code><code class="p">(</code><code class="n">sl2</code><code class="p">),</code> <code class="nb">len</code><code class="p">(</code><code class="n">sl3</code><code class="p">),</code> <code class="nb">len</code><code class="p">(</code><code class="n">sl4</code><code class="p">),</code> <code class="nb">len</code><code class="p">(</code><code class="n">sl5</code><code class="p">))</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code>	<code class="o">//</code> <code class="n">check</code> <code class="n">capacity</code>
<code class="linenos">16 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">cap</code><code class="p">(</code><code class="n">sl1</code><code class="p">),</code> <code class="n">cap</code><code class="p">(</code><code class="n">sl2</code><code class="p">),</code> <code class="n">cap</code><code class="p">(</code><code class="n">sl3</code><code class="p">),</code> <code class="n">cap</code><code class="p">(</code><code class="n">sl4</code><code class="p">),</code> <code class="n">cap</code><code class="p">(</code><code class="n">sl5</code><code class="p">))</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code>	<code class="k">if</code> <code class="n">sl1</code> <code class="o">==</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos">19 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"sl1 is nil!"</code><code class="p">)</code>
<code class="linenos">20 </code>	<code class="p">}</code>
<code class="linenos">21 </code>	<code class="k">if</code> <code class="n">sl2</code> <code class="o">!=</code> <code class="n">nil</code> <code class="o">&amp;&amp;</code> <code class="n">sl3</code> <code class="o">!=</code> <code class="n">nil</code> <code class="o">&amp;&amp;</code> <code class="n">sl4</code> <code class="o">!=</code> <code class="n">nil</code> <code class="o">&amp;&amp;</code> <code class="n">sl5</code> <code class="o">!=</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos">22 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"sl2, sl3, sl4 and sl5 are not nil!"</code><code class="p">)</code>
<code class="linenos">23 </code>	<code class="p">}</code>
<code class="linenos">24 </code><code class="p">}</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">922</code><code class="n">R9tr</code><code class="o">-</code><code class="mi">3</code><code class="n">Aq</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="m">0</code> <code class="m">0</code> <code class="m">5</code> <code class="m">5</code> <code class="m">1</code>
<code class="linenos">2 </code><code class="m">0</code> <code class="m">0</code> <code class="m">5</code> <code class="m">5</code> <code class="m">4</code>
<code class="linenos">3 </code>sl1 is nil!
<code class="linenos">4 </code>sl2, sl3, sl4 and sl5 are not nil!
<code class="linenos">5 </code>
<code class="linenos">6 </code>Program exited.
</pre></div>

</figure>


<p>Variable <code>sl1</code> is what is referred to as a <i>nil slice</i>.  At this point, it has no length nor capacity and indeed no backing array. Only a nil slice is equal to <code>nil</code>.</p>

<p><code>sl2</code> creates an empty slice literal. Again length and capacity are zero but we have a backing array. An empty slice like this cannot be compared to <code>nil</code>. </p>

<p>Variable <code>sl3</code> uses the same approach but initialises the slice with data such that its length and capacity equal the number of elements added.</p>

<p><code>sl4</code> is created with the <code>make</code> keyword. The single number 5 is used to set both the length and capacity to 5, whereas variable <code>sl5</code> uses <code>make</code> again to set the length and capacity to different values.</p>

<p>Slices are a reference type because there’s a backing data array, but we need to caveat that statement, because slices behave as a reference type only in certain circumstances.  Lets look at why.</p>

<p>Every slice has a descriptor - or slice header - which contains three important pieces of information about the slice. First, it contains a pointer to the backing array where the actual slice data is stored. Second, it contains the current length and lastly, the capacity of the backing array.</p>

<p>We can add new data to a slice and not concern ourselves with the finite length of the backing array. When the backing array has no capacity left in which to store data, Go will automatically create a new array on our behalf and copy the contents of the old array over. </p>

<p>At this point, the slice header is changed. The address of the new array is stored and we have a new length and capacity. </p>

<aside class="information blurb">
    <p>It’s worth us understanding the impact of this backing array replacement and we’ll cover it in more depth later in this section. </p>

</aside>

<p>Where there is sufficient capacity in the backing array to add the new element, the slice header is still changed because length is a property of the slice header and that is updated.</p>

<p>So, when does a slice behave as a reference type and when does it not?</p>

<p>The general rule is that if an operation on a slice does not modify the slice header it <i>can</i> be used as a reference type.</p>

<p>For example, if we add elements which exceed the capacity of the slice backing array, the slice header is updated with a new backing array. This is an entirely new value, elements added to this array will not be visible to the calling code.</p>

<p>Alternatively, if we alter existing elements in the slice and don’t add new elements, we don’t change the slice header. In such circumstances we’re able to modify the original value’s elements, and the caller will see the changes.</p>

<p>The following three examples demonstrate the different behaviours.</p>

<p>In the first example, we need a larger backing array as a result of the append operation in the <code>addToSlice()</code> function.</p>

<p>Go dutifully copies any existing elements over to a new array with new length and capacity. The slice header is changed, and the append operation is performed as expected, but to the new backing array.</p>

<p>The original is unchanged when we print it again on line 19. This append operation has effectively <i>unlinked</i> the slice from the original value we passed to <code>addToSlice()</code>. </p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 44 - Slice not behaving as a reference type</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">addToSlice</code><code class="p">(</code><code class="n">sl</code> <code class="p">[]</code><code class="nb">int</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">sl</code> <code class="o">=</code> <code class="n">append</code><code class="p">(</code><code class="n">sl</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>
<code class="linenos"> 7 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">sl</code><code class="p">)</code>
<code class="linenos"> 8 </code><code class="p">}</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">11 </code>	<code class="n">sl</code> <code class="o">:=</code> <code class="p">[]</code><code class="nb">int</code><code class="p">{}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>	<code class="n">sl</code> <code class="o">=</code> <code class="n">append</code><code class="p">(</code><code class="n">sl</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos">14 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">sl</code><code class="p">)</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code>	<code class="n">addToSlice</code><code class="p">(</code><code class="n">sl</code><code class="p">)</code>
<code class="linenos">17 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">sl</code><code class="p">)</code>
<code class="linenos">18 </code><code class="p">}</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">0</code><code class="n">cOx0y5Xc_L</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">[</code><code class="m">1</code><code class="o">]</code>
<code class="linenos">2 </code><code class="o">[</code><code class="m">1</code> <code class="m">2</code><code class="o">]</code>
<code class="linenos">3 </code><code class="o">[</code><code class="m">1</code><code class="o">]</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code>Program exited.
</pre></div>

</figure>


<p>To safely add to a slice in a function such as the above, recognising the append operation is creating a new value, we should return the new value to the caller, and share that going forwards. We show this below.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 45 - Safely return the new slice to caller</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">addToSlice</code><code class="p">(</code><code class="n">sl</code> <code class="p">[]</code><code class="nb">int</code><code class="p">)</code> <code class="p">[]</code><code class="nb">int</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">sl</code> <code class="o">=</code> <code class="n">append</code><code class="p">(</code><code class="n">sl</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>
<code class="linenos"> 7 </code>	<code class="k">return</code> <code class="n">sl</code>
<code class="linenos"> 8 </code><code class="p">}</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">11 </code>	<code class="n">sl</code> <code class="o">:=</code> <code class="p">[]</code><code class="nb">int</code><code class="p">{}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>	<code class="n">sl</code> <code class="o">=</code> <code class="n">append</code><code class="p">(</code><code class="n">sl</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos">14 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">sl</code><code class="p">)</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code>	<code class="n">sl</code> <code class="o">=</code> <code class="n">addToSlice</code><code class="p">(</code><code class="n">sl</code><code class="p">)</code>
<code class="linenos">17 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">sl</code><code class="p">)</code>
<code class="linenos">18 </code><code class="p">}</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">A</code><code class="o">-</code><code class="n">Lg98S0GRJ</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">[</code><code class="m">1</code><code class="o">]</code>
<code class="linenos">2 </code><code class="o">[</code><code class="m">1</code> <code class="m">2</code><code class="o">]</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<p>In the last of the three examples, we pass the slice to a <code>modifyElement()</code> function in which we increment every element by one. This has no impact on the contents of the slice header, so the calling code can see the changes made to the slice without us needing to explicitly return it.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 46 - Slice behaving as a reference type</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">incrementElement</code><code class="p">(</code><code class="n">sl</code> <code class="p">[]</code><code class="nb">int</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="nb">range</code> <code class="n">sl</code> <code class="p">{</code>
<code class="linenos"> 7 </code>		<code class="n">sl</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code class="o">++</code>
<code class="linenos"> 8 </code>	<code class="p">}</code>
<code class="linenos"> 9 </code><code class="p">}</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">12 </code>	<code class="n">sl</code> <code class="o">:=</code> <code class="p">[]</code><code class="nb">int</code><code class="p">{</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">}</code>
<code class="linenos">13 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">sl</code><code class="p">)</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code>	<code class="n">incrementElement</code><code class="p">(</code><code class="n">sl</code><code class="p">)</code>
<code class="linenos">16 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">sl</code><code class="p">)</code>
<code class="linenos">17 </code><code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">CvKjbcRyOAr</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">[</code><code class="m">1</code> <code class="m">2</code> <code class="m">3</code> <code class="m">4</code> <code class="m">5</code><code class="o">]</code>
<code class="linenos">2 </code><code class="o">[</code><code class="m">2</code> <code class="m">3</code> <code class="m">4</code> <code class="m">5</code> <code class="m">6</code><code class="o">]</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<aside class="information blurb">
    <p>Understanding the behaviour of slices is helpful in spotting and avoiding certain types of bugs. In practice, consider treating slices exclusively as values which must be passed to, and returned from functions. This results in clearer code and no hidden side-effects.  Should memory be identified as a constraint and copies of a slice are deemed expensive, either because of their size or type, then you may consider treating it as a reference type, but clearly comment the decision in your code.</p>

</aside>

<h4 id="leanpub-auto-working-with-slices" class="subsubsection">7.3.3.1 Working with slices</h4>

<p>Elements in a slice are accessed by index in exactly the same way as arrays. As with arrays, we can also obtain subsets of array elements using the <i>:</i> operator.</p>

<p>Let’s look at few examples obtaining subsets of a slice in this next example. We refer to this operation as <i>reslicing</i>.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 47 - Reslicing &amp; working with slices</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">sl</code> <code class="o">:=</code> <code class="p">[]</code><code class="nb">int</code><code class="p">{</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">9</code><code class="p">,</code> <code class="mi">10</code><code class="p">}</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Index 0:"</code><code class="p">,</code> <code class="n">sl</code><code class="p">[</code><code class="mi">0</code><code class="p">])</code>
<code class="linenos"> 9 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Elements Index 1 - 5 (not including 5):"</code><code class="p">,</code> <code class="n">sl</code><code class="p">[</code><code class="mi">1</code><code class="p">:</code><code class="mi">5</code><code class="p">])</code>
<code class="linenos">10 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Elements Index 5 - end:"</code><code class="p">,</code> <code class="n">sl</code><code class="p">[</code><code class="mi">5</code><code class="p">:])</code>
<code class="linenos">11 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Elements Index 0 - 3 (not including 3):"</code><code class="p">,</code> <code class="n">sl</code><code class="p">[</code><code class="mi">0</code><code class="p">:</code><code class="mi">3</code><code class="p">])</code>
<code class="linenos">12 </code><code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">Aiw7WhYGePH</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>First element: <code class="m">1</code>
<code class="linenos">2 </code>Elements <code class="m">1</code> - <code class="m">5</code> <code class="o">(</code>not including <code class="m">5</code><code class="o">)</code>: <code class="o">[</code><code class="m">2</code> <code class="m">3</code> <code class="m">4</code> <code class="m">5</code><code class="o">]</code>
<code class="linenos">3 </code>Elements <code class="m">5</code> - end: <code class="o">[</code><code class="m">6</code> <code class="m">7</code> <code class="m">8</code> <code class="m">9</code> <code class="m">10</code><code class="o">]</code>
<code class="linenos">4 </code>Elements <code class="m">0</code> - <code class="m">3</code> <code class="o">(</code>not including <code class="m">3</code><code class="o">)</code>: <code class="o">[</code><code class="m">1</code> <code class="m">2</code> <code class="m">3</code><code class="o">]</code>
<code class="linenos">5 </code>
<code class="linenos">6 </code>Program exited.
</pre></div>

</figure>


<p>Take care when working with subsets of slices. What may appear to be a copy or a new slice value, may infact be pointing at the same back array of data as the original slice. It is possible to mutate elements in the original by mutating elements in what you may believe to be a copy, when it is not.</p>

<p>This example below shows how an operation on variable <code>sl2</code> to change an element to 20, perhaps counter-intuitively also amends the element in the original slice <code>sl</code>, because the same backing array is used by both slice variables.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 48 - Slices of slices</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">sl</code> <code class="o">:=</code> <code class="p">[]</code><code class="nb">int</code><code class="p">{</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">9</code><code class="p">,</code> <code class="mi">10</code><code class="p">}</code>
<code class="linenos"> 7 </code>	<code class="n">sl2</code> <code class="o">:=</code> <code class="n">sl</code><code class="p">[</code><code class="mi">1</code><code class="p">:</code><code class="mi">5</code><code class="p">]</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"len sl: </code><code class="si">%d</code><code class="s2"> , cap sl: </code><code class="si">%d</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="n">sl</code><code class="p">),</code> <code class="n">cap</code><code class="p">(</code><code class="n">sl</code><code class="p">))</code>
<code class="linenos">10 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"len sl2: </code><code class="si">%d</code><code class="s2"> , cap sl2: </code><code class="si">%d</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="n">sl2</code><code class="p">),</code> <code class="n">cap</code><code class="p">(</code><code class="n">sl2</code><code class="p">))</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code>	<code class="n">sl2</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code> <code class="o">=</code> <code class="mi">20</code>
<code class="linenos">13 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Slice sl2:"</code><code class="p">,</code> <code class="n">sl2</code><code class="p">)</code>
<code class="linenos">14 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Slice sl:"</code><code class="p">,</code> <code class="n">sl</code><code class="p">)</code>
<code class="linenos">15 </code><code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">NAWtoteoj5x</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>len sl: <code class="m">10</code>, cap sl: <code class="m">10</code>
<code class="linenos">2 </code>len sl2: <code class="m">4</code>, cap sl2: <code class="m">9</code>
<code class="linenos">3 </code>Slice sl2: <code class="o">[</code><code class="m">2</code> <code class="m">3</code> <code class="m">20</code> <code class="m">5</code><code class="o">]</code>
<code class="linenos">4 </code>Slice sl: <code class="o">[</code><code class="m">1</code> <code class="m">2</code> <code class="m">3</code> <code class="m">20</code> <code class="m">5</code> <code class="m">6</code> <code class="m">7</code> <code class="m">8</code> <code class="m">9</code> <code class="m">10</code><code class="o">]</code>
<code class="linenos">5 </code>
<code class="linenos">6 </code>Program exited.
</pre></div>

</figure>


<aside class="information blurb">
    <p>If you want a new slice which you can safely edit and append to without risk of mutating the original, you can unlink it by explicitly taking a copy. We cover the built-in <code>copy()</code> function shortly. </p>

</aside>

<h4 id="leanpub-auto-append" class="subsubsection">7.3.3.2 Append</h4>

<p>We’ve seen the <code>append</code> command, which we used for adding additional elements to a slice.  We should mention that append function is <i>variadic</i>, meaning it can accept any number of trailing arguments.</p>

<p>This example shows the different syntax you may consider when using <code>append</code>, to add a single element or multiple new elements:</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 49 - Using append</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">sl</code> <code class="o">:=</code> <code class="p">[]</code><code class="nb">int</code><code class="p">{</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">}</code>
<code class="linenos"> 7 </code>	<code class="n">sl2</code> <code class="o">:=</code> <code class="p">[]</code><code class="nb">int</code><code class="p">{</code><code class="mi">7</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">9</code><code class="p">}</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>	<code class="n">sl</code> <code class="o">=</code> <code class="n">append</code><code class="p">(</code><code class="n">sl</code><code class="p">,</code> <code class="mi">3</code><code class="p">)</code>       <code class="o">//</code> <code class="n">add</code> <code class="n">single</code> <code class="n">element</code>
<code class="linenos">10 </code>	<code class="n">sl</code> <code class="o">=</code> <code class="n">append</code><code class="p">(</code><code class="n">sl</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code> <code class="o">//</code> <code class="n">add</code> <code class="n">many</code> <code class="n">new</code> <code class="n">elements</code>
<code class="linenos">11 </code>	<code class="n">sl</code> <code class="o">=</code> <code class="n">append</code><code class="p">(</code><code class="n">sl</code><code class="p">,</code> <code class="n">sl2</code><code class="o">...</code><code class="p">)</code>  <code class="o">//</code> <code class="n">append</code> <code class="nb">all</code> <code class="n">of</code> <code class="n">sl2</code> <code class="n">using</code> <code class="n">the</code> <code class="n">spread</code> <code class="n">operator</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">sl</code><code class="p">)</code>
<code class="linenos">14 </code><code class="p">}</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">WUPIBwbVCEL</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">[</code><code class="m">1</code> <code class="m">2</code> <code class="m">3</code> <code class="m">4</code> <code class="m">5</code> <code class="m">6</code> <code class="m">7</code> <code class="m">8</code> <code class="m">9</code><code class="o">]</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>Often we’ll combine both the mechanics of <i>append</i> and <i>reslicing</i> when manipulating slices.</p>

<p>For example, below we create a new slice with the element at the specified by index removed, whilst maintaining the ordering:</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 50 - Reslicing to remove a specified element from a slice</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">removeAtIndex</code><code class="p">(</code><code class="n">sl</code> <code class="p">[]</code><code class="nb">int</code><code class="p">,</code> <code class="n">index</code> <code class="nb">int</code><code class="p">)</code> <code class="p">[]</code><code class="nb">int</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="k">return</code> <code class="n">append</code><code class="p">(</code><code class="n">sl</code><code class="p">[:</code><code class="n">index</code><code class="p">],</code> <code class="n">sl</code><code class="p">[</code><code class="n">index</code><code class="o">+</code><code class="mi">1</code><code class="p">:]</code><code class="o">...</code><code class="p">)</code>
<code class="linenos"> 7 </code><code class="p">}</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="n">sl</code> <code class="o">:=</code> <code class="p">[]</code><code class="nb">int</code><code class="p">{</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">9</code><code class="p">,</code> <code class="mi">10</code><code class="p">}</code>
<code class="linenos">11 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">sl</code><code class="p">)</code>
<code class="linenos">12 </code>	<code class="n">sl</code> <code class="o">=</code> <code class="n">removeAtIndex</code><code class="p">(</code><code class="n">sl</code><code class="p">,</code> <code class="mi">9</code><code class="p">)</code>
<code class="linenos">13 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">sl</code><code class="p">)</code>
<code class="linenos">14 </code><code class="p">}</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">e_IrhpQHBXE</code>
</pre></div>

</figure>

<p class="fake-para">Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">[</code><code class="m">1</code> <code class="m">2</code> <code class="m">3</code> <code class="m">4</code> <code class="m">5</code> <code class="m">6</code> <code class="m">7</code> <code class="m">8</code> <code class="m">9</code> <code class="m">10</code><code class="o">]</code>
<code class="linenos">2 </code><code class="o">[</code><code class="m">1</code> <code class="m">2</code> <code class="m">3</code> <code class="m">4</code> <code class="m">5</code> <code class="m">6</code> <code class="m">7</code> <code class="m">8</code> <code class="m">9</code><code class="o">]</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<h4 id="leanpub-auto-copy" class="subsubsection">7.3.3.3 Copy</h4>

<p>We can use the <code>copy()</code> command to make a copy of an entire slice, or a subset of its elements. With <i>copy</i>, the elements are copied to a new backing array and we’re able to mutate elements in the copy, <b>without</b> impacting the source slice. </p>

<p>Let’s repeat Example 48 to demonstrate, but, instead of taking a shallow copy as we did in that example, we’ll use the <code>copy()</code> command.  This time the change we make to <code>sl2</code> has no side-effects, the source slice remains unchanged.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 51 - Using copy to create a slice with new backing array</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">sl</code> <code class="o">:=</code> <code class="p">[]</code><code class="nb">int</code><code class="p">{</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">9</code><code class="p">,</code> <code class="mi">10</code><code class="p">}</code>
<code class="linenos"> 7 </code>	<code class="n">sl2</code> <code class="o">:=</code> <code class="n">make</code><code class="p">([]</code><code class="nb">int</code><code class="p">,</code> <code class="mi">4</code><code class="p">)</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>	<code class="o">//</code> <code class="n">copy</code> <code class="n">parameter</code> <code class="n">order</code> <code class="ow">is</code> <code class="n">the</code> <code class="n">destination</code> <code class="n">then</code> <code class="n">the</code> <code class="n">source</code>
<code class="linenos">10 </code>	<code class="n">copy</code><code class="p">(</code><code class="n">sl2</code><code class="p">,</code> <code class="n">sl</code><code class="p">[</code><code class="mi">1</code><code class="p">:</code><code class="mi">5</code><code class="p">])</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code>	<code class="n">sl2</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code> <code class="o">=</code> <code class="mi">20</code>
<code class="linenos">13 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Slice sl2:"</code><code class="p">,</code> <code class="n">sl2</code><code class="p">)</code>
<code class="linenos">14 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Slice sl:"</code><code class="p">,</code> <code class="n">sl</code><code class="p">)</code>
<code class="linenos">15 </code><code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">YHVH</code><code class="o">-</code><code class="n">gE9lYW</code>
</pre></div>

</figure>

<p class="fake-para">Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Slice sl2: <code class="o">[</code><code class="m">2</code> <code class="m">3</code> <code class="m">20</code> <code class="m">5</code><code class="o">]</code>
<code class="linenos">2 </code>Slice sl: <code class="o">[</code><code class="m">1</code> <code class="m">2</code> <code class="m">3</code> <code class="m">4</code> <code class="m">5</code> <code class="m">6</code> <code class="m">7</code> <code class="m">8</code> <code class="m">9</code> <code class="m">10</code><code class="o">]</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<h4 id="leanpub-auto-resizing" class="subsubsection">7.3.3.4 Resizing</h4>

<p>To conclude our discussion of slices, we’re going to look at what happens when Go resizes a slice so that more data can be added.</p>

<p>We’ve said already that slices simplify matters when working with data of unknown length. If a slice has no room i.e. the backing array has no capacity, Go will handle creating additional capacity for us. It will copy the backing array to a new array with some extra capacity, pointing the slice header at the new backing array, and the old array will be garbage collected.</p>

<p>Like many conveniences, we won’t often think too much about what is happening in the background on the machine, but we should, because it can come with a cost.</p>

<p>Specifically, the new capacity of the backing array is not under our control. Go decides how much extra to provide in the new backing array based on an algorithm.</p>

<p>Now hands up, I’m not exactly sure what the algorithm does.  I <i>thought</i> that at some level of current capacity it doubled each time, then started to tail off, until eventually 25% additional capacity was allocated each time.</p>

<p>And, that rule mostly holds in my testing. At about the 1000 element mark, the throttling starts, but, in the example below clearly, there is more than 100% of new capacity created initially at levels below 1000 elements.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 52 - New Slice backing array with additional capacity</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="o">//</code> <code class="n">amend</code> <code class="n">this</code> <code class="n">start</code> <code class="n">capacity</code> <code class="n">to</code> <code class="n">see</code> <code class="n">the</code> <code class="n">impact</code>
<code class="linenos"> 9 </code>	<code class="n">cp</code> <code class="o">:=</code> <code class="mi">100</code>
<code class="linenos">10 </code>	<code class="n">sl</code> <code class="o">:=</code> <code class="n">make</code><code class="p">([]</code><code class="nb">int</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="n">cp</code><code class="p">)</code>
<code class="linenos">11 </code>	<code class="n">els</code> <code class="o">:=</code> <code class="mi">1000</code>
<code class="linenos">12 </code>	<code class="n">addr</code> <code class="o">:=</code> <code class="n">fmt</code><code class="o">.</code><code class="n">Sprintf</code><code class="p">(</code><code class="s2">"%p"</code><code class="p">,</code> <code class="n">sl</code><code class="p">)</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code>	<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">els</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos">15 </code>		<code class="n">sl</code> <code class="o">=</code> <code class="n">append</code><code class="p">(</code><code class="n">sl</code><code class="p">,</code> <code class="n">i</code><code class="p">)</code>
<code class="linenos">16 </code>		<code class="k">if</code> <code class="n">fmt</code><code class="o">.</code><code class="n">Sprintf</code><code class="p">(</code><code class="s2">"%p"</code><code class="p">,</code> <code class="n">sl</code><code class="p">)</code> <code class="o">!=</code> <code class="n">addr</code> <code class="p">{</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code>			<code class="o">//</code> <code class="n">when</code> <code class="n">we</code> <code class="n">detect</code> <code class="n">address</code> <code class="n">change</code> <code class="n">inspect</code>
<code class="linenos">19 </code>			<code class="n">extra</code> <code class="o">:=</code> <code class="p">(</code><code class="n">float64</code><code class="p">(</code><code class="n">cap</code><code class="p">(</code><code class="n">sl</code><code class="p">))</code> <code class="o">-</code> <code class="n">float64</code><code class="p">(</code><code class="n">cp</code><code class="p">))</code> <code class="o">/</code> <code class="n">float64</code><code class="p">(</code><code class="n">cp</code><code class="p">)</code> <code class="o">*</code> <code class="mi">100</code>
<code class="linenos">20 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"length: </code><code class="si">%d</code><code class="s2">, capacity: </code><code class="si">%d</code><code class="s2">, address: %p. Additional capacity: </code><code class="si">%0.2f%%</code><code class="se">\n\</code>
<code class="linenos">21 </code><code class="s2">"</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="n">sl</code><code class="p">),</code> <code class="n">cap</code><code class="p">(</code><code class="n">sl</code><code class="p">),</code> <code class="n">sl</code><code class="p">,</code> <code class="n">extra</code><code class="p">)</code>
<code class="linenos">22 </code>			<code class="n">cp</code> <code class="o">=</code> <code class="n">cap</code><code class="p">(</code><code class="n">sl</code><code class="p">)</code>
<code class="linenos">23 </code>			<code class="n">addr</code> <code class="o">=</code> <code class="n">fmt</code><code class="o">.</code><code class="n">Sprintf</code><code class="p">(</code><code class="s2">"%p"</code><code class="p">,</code> <code class="n">sl</code><code class="p">)</code>
<code class="linenos">24 </code>		<code class="p">}</code>
<code class="linenos">25 </code>	<code class="p">}</code>
<code class="linenos">26 </code>
<code class="linenos">27 </code>	<code class="n">overCap</code> <code class="o">:=</code> <code class="p">(</code><code class="n">float64</code><code class="p">(</code><code class="n">cap</code><code class="p">(</code><code class="n">sl</code><code class="p">))</code> <code class="o">-</code> <code class="n">float64</code><code class="p">(</code><code class="n">els</code><code class="p">))</code> <code class="o">/</code> <code class="n">float64</code><code class="p">(</code><code class="n">els</code><code class="p">)</code> <code class="o">*</code> <code class="mi">100</code>
<code class="linenos">28 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Backing array over capacity: </code><code class="si">%0.2f%%</code><code class="s2">"</code><code class="p">,</code> <code class="n">overCap</code><code class="p">)</code>
<code class="linenos">29 </code><code class="p">}</code>
<code class="linenos">30 </code>
<code class="linenos">31 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">JMbFUxzyNzK</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>length: <code class="m">101</code>, capacity: <code class="m">224</code>, address: 0xc000102000. Additional capacity: <code class="m">124</code>.00%
<code class="linenos">2 </code>length: <code class="m">225</code>, capacity: <code class="m">512</code>, address: 0xc00010c000. Additional capacity: <code class="m">128</code>.57%
<code class="linenos">3 </code>length: <code class="m">513</code>, capacity: <code class="m">848</code>, address: 0xc000112000. Additional capacity: <code class="m">65</code>.62%
<code class="linenos">4 </code>length: <code class="m">849</code>, capacity: <code class="m">1280</code>, address: 0xc00011e000. Additional capacity: <code class="m">50</code>.94%
<code class="linenos">5 </code>Backing array over capacity: <code class="m">28</code>.00%
<code class="linenos">6 </code>
<code class="linenos">7 </code>Program exited.
</pre></div>

</figure>


<p>In the above example, we set initial capacity and then incrementally use up the capacity by appending to the slice 1000 times.</p>

<p>We detect when the runtime creates a new backing array by observing when the memory address changes, at which point we output length and capacity, plus calculate a percentage increase.</p>

<p>On the Go Playground, change the <code>els</code> variable to a value of 50000 and run it again. You’ll see the resizing settle to about 25% additional capacity every time a new backing array is created.</p>

<p>But, we’re getting off the point a bit. It’s not so much how the algorithm works that concerns us here. No, the point is that when using slices, we can end up using more memory than we need because of this automatic resizing process.</p>

<p>In the previous example, we created capacity for 1280 integer values in memory, but we have only used 1000 elements of that.  So we’ve reserved 28% more memory than we need.  Now, these are just integers, so that’s only 2,240 bytes, but if the slice was a slice of structs, that 28% extra could be very significant in memory.</p>

<p>To wrap up, <b>if</b> memory use is identified as an issue in our program, we might consider how we optimise our slice usage.</p>

<p>With an operation such as the above, we know how much capacity is needed ahead of time, so could create the slice with the exact capacity we require or we could use an array instead.</p>

<p>Both approaches would reserve only the memory required for the data.</p>

<p>Where we don’t know the capacity we need exactly, but can reliably estimate it, we may be able to reduce memory use by testing different initial slice capacities and their impact when resizing takes place.</p>

<h3 id="leanpub-auto-channel" class="subsection">7.3.4 Channel</h3>

<p>Channels are a mechanism for communicating between asynchronous code. We’ll cover them in detail when we talk about Concurrency, here we’re going to briefly cover what they are, and how we create and use them, so we can demonstrate their <i>reference-type</i> characteristics.</p>

<p>Channels are created using the <code>make()</code> built-in function that we’ve used several times already. They can be <i>unbuffered</i> or <i>buffered</i> and are typed - each channel can send and receive values of a specific type. </p>

<p>In the sample program below, we have an unbuffered channel of <i>int</i> type which we share between two independent functions which use the channel to communicate.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 53 - Send and receive on unbuffered channel</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">send</code><code class="p">(</code><code class="n">ch</code> <code class="n">chan</code> <code class="nb">int</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="mi">100</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos"> 7 </code>		<code class="n">ch</code> <code class="o">&lt;-</code> <code class="n">i</code>
<code class="linenos"> 8 </code>	<code class="p">}</code>
<code class="linenos"> 9 </code><code class="p">}</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="n">func</code> <code class="n">read</code><code class="p">(</code><code class="n">ch</code> <code class="n">chan</code> <code class="nb">int</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">12 </code>	<code class="k">for</code> <code class="n">msg</code> <code class="o">:=</code> <code class="nb">range</code> <code class="n">ch</code> <code class="p">{</code>
<code class="linenos">13 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code>
<code class="linenos">14 </code>	<code class="p">}</code>
<code class="linenos">15 </code><code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">18 </code>	<code class="n">ch</code> <code class="o">:=</code> <code class="n">make</code><code class="p">(</code><code class="n">chan</code> <code class="nb">int</code><code class="p">)</code>
<code class="linenos">19 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">ch</code><code class="p">)</code>
<code class="linenos">20 </code>	<code class="n">go</code> <code class="n">read</code><code class="p">(</code><code class="n">ch</code><code class="p">)</code>
<code class="linenos">21 </code>	<code class="n">send</code><code class="p">(</code><code class="n">ch</code><code class="p">)</code>
<code class="linenos">22 </code><code class="p">}</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">f8M2OFSLnJA</code>
</pre></div>

</figure>


<p>In the above example, notice when we print the channel at line 19, the output is a memory address. When we create a channel using <code>make()</code> we get a pointer back automatically. So, we don’t need to pass by reference when we share the channel in our program, we’re already sharing the address.</p>

<p>A good rule of thumb is that if you create a variable using <code>make()</code> it is a reference type, and what you store is a memory address so there is no need to obtain a reference - which would be a pointer to a pointer if you think about it!</p>

<p>To summarise, in this section we’ve explored how some types behave as if they are pointers without us explicitly needing to pass them by reference. Though the reasons differ slightly, types like <i>map</i>, <i>slice</i> and <i>channel</i> can be shared as values because the variable is already a reference to the backing data.</p>

<h2 id="leanpub-auto-interface-types" class="section">7.4 Interface types</h2>

<p>We’re only going to touch on interfaces in this section. In <i>Chapter 9 - Digging deeper</i>, we’ll go much further. </p>

<p>So what is the <i>interface</i> type?</p>

<p>An interface represents behaviour, what something can do. Behaviour is defined by one or more <i>receiver</i> function signatures. These are functions with no implementation, only the argument types and return types are defined.</p>

<p>Notice we said <i>what something can do</i> rather than <i>what something is</i>? The distinction is important. </p>

<p>In Go, interfaces are implemented implicitly. You won’t see the <i>implements</i> keyword anywhere. Instead, in Go we use a principle known as <i>duck typing</i>.</p>

<p>If something can do what a duck does i.e. walk like a duck and quack lack a duck, then, as far as Go is concerned, it is a duck. Go doesn’t care if it is a real duck, just that it can do duck stuff.</p>

<p>This point needs reinforcing. We could have a dog type, but if the dog type has the <i>walk</i> and <i>quack</i> behaviours, that dog is as good as a duck.</p>

<p>Additionally, Go has an empty interface type. This is an interface that defines no behaviour. You will often see it represented by <code>interface{}</code> syntax and, since every type provides at least no behaviours, the empty interface is implemented by every single type!  </p>

<p>Personally, I struggled to grasp the significance of this initially, I recall it took me some time. Put another way, whereever you see <code>interface{}</code> you can substitute in <i>any</i> built-in or custom type. Used as argument in a function or receiver it means that for that parameter, any <i>type</i> is acceptable.</p>

<aside class="information blurb">
    <p>Coincidentally, in Go 1.18, as a part of the new generics implementation we can now use an alias for <code>interface{}</code> with the <code>Any</code> identifier. With <i>Any</i> the intent is much more obvious and I think I’d have grasped the empty interface far quicker with <i>Any</i>.</p>

</aside>

<p>To demonstrate a simple but typical use of interfaces we’ll look at the standard library’s <i>Stringer</i> interface.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>type Stringer interface {
<code class="linenos">2 </code>	String() string
<code class="linenos">3 </code>}
</pre></div>

</figure>


<p><i>Stringer</i> specifies just one behaviour, the ability to provide a custom string representation of itself. It uses a single receiver <code>String()</code> which takes no arguments but returns a value of type <i>string</i>.</p>

<p>For a type to implement the <i>Stringer</i> interface, it only needs to implement the <code>string</code> receiver. But, so what?</p>

<p>Consider the following example. The <code>Println()</code> statement on line 19, takes a <i>slice</i> and <i>map</i> value and outputs them to Stdout.</p>

<p>For each printed variable we get the value with helpful formatting which provides context about its type.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 54 - The Stringer interface</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">sl</code> <code class="o">:=</code> <code class="p">[]</code><code class="nb">int</code><code class="p">{</code><code class="mi">1</code><code class="p">,</code> <code class="mi">22</code><code class="p">,</code> <code class="mi">3</code><code class="p">}</code>
<code class="linenos"> 7 </code>	<code class="n">mp</code> <code class="o">:=</code> <code class="nb">map</code><code class="p">[</code><code class="n">string</code><code class="p">]</code><code class="n">string</code><code class="p">{</code><code class="s2">"name"</code><code class="p">:</code> <code class="s2">"Joe Blogs"</code><code class="p">}</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">sl</code><code class="p">,</code> <code class="n">mp</code><code class="p">)</code>
<code class="linenos">10 </code><code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">xl1phIcBej1</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">[</code><code class="m">1</code> <code class="m">22</code> <code class="m">3</code><code class="o">]</code> map<code class="o">[</code>name:Joe Blogs<code class="o">]</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>Under the hood, although <code>fmt.Println()</code> is a variadic function which accepts <a href="https://cs.opensource.google/go/go/+/refs/tags/go1.19.3:src/fmt/print.go;drc=668041ef66ddafffccf1863e6180b83ea1ad30c9;l=293">multiple empty interface types</a>, the logic which supports the function will output each variable using the <i>stringer</i> interface <b>if</b> it is implemented on the type. It does this by calling each type’s <code>String()</code> receiver which returns a string to print.</p>

<p>Both the built in <a href="https://cs.opensource.google/go/go/+/master:src/go/types/slice.go;drc=521828091c73e2af67bc2210b7c94cc54076f17b;l=19"><i>slice</i></a> and <a href="https://cs.opensource.google/go/go/+/master:src/go/types/map.go;drc=521828091c73e2af67bc2210b7c94cc54076f17b;l=24"><i>map</i></a> types implement the <i>stringer</i> interface. They both have a <code>String()</code> receiver bound to them.</p>

<p>Ultimately, the logic behind both implementations results in a type check. If the type is a <i>slice</i> the value is wrapped in square brackets like so <code>[]</code> and if the type is a <i>map</i> it is prefixed with <code>map[</code> and suffixed with <code>]</code>.</p>

<p>You can inspect that logic <a href="https://cs.opensource.google/go/go/+/master:src/go/types/typestring.go;drc=1fbfc2f6eba6cc88a8fb0ae8e83afe80553f65df;l=113">in this function</a>.</p>

<p>Before we leave interfaces for the moment, let’s create a custom struct and implement the <i>Stringer</i> interface on it.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 55 - Implementing Stringer on a custom struct type</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nb">type</code> <code class="n">person</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">name</code> <code class="n">string</code>
<code class="linenos"> 7 </code>	<code class="n">age</code>  <code class="nb">int</code>
<code class="linenos"> 8 </code><code class="p">}</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="n">func</code> <code class="p">(</code><code class="n">p</code> <code class="n">person</code><code class="p">)</code> <code class="n">String</code><code class="p">()</code> <code class="n">string</code> <code class="p">{</code>
<code class="linenos">11 </code>	<code class="k">return</code> <code class="n">fmt</code><code class="o">.</code><code class="n">Sprintf</code><code class="p">(</code><code class="s2">"Hey there I'm %v and I'm %v years young!"</code><code class="p">,</code> <code class="n">p</code><code class="o">.</code><code class="n">name</code><code class="p">,</code> <code class="n">p</code><code class="o">.</code><code class="n">age</code><code class="p">)</code>
<code class="linenos">12 </code><code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">15 </code>	<code class="n">st</code> <code class="o">:=</code> <code class="n">person</code><code class="p">{</code>
<code class="linenos">16 </code>		<code class="s2">"Joe Blogs"</code><code class="p">,</code>
<code class="linenos">17 </code>		<code class="mi">25</code><code class="p">}</code>
<code class="linenos">18 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">st</code><code class="p">)</code>
<code class="linenos">19 </code><code class="p">}</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">Oa4sBfwsx78</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Hey there I<code class="s1">'m Joe Blogs and I'</code>m <code class="m">25</code> years young!
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>Try deleting lines 10 - 12 and then run the example again. This time the default <i>stringer</i> implementation is used.  Since the <i>struct</i> type also implements the interface, the output is simplified and begins with <code>struct{</code> and ends with <code>}</code> as <a href="https://cs.opensource.google/go/go/+/master:src/go/types/typestring.go;drc=1fbfc2f6eba6cc88a8fb0ae8e83afe80553f65df;l=147">shown here</a>. </p>

<aside class="information blurb">
    <p>If a type implements the <i>Stringer</i> interface, the printed output of a variable of that type is likely a custom representation of the value stored by that variable, and it sometimes may not be what you expect.</p>

</aside>

<h2 id="leanpub-auto-creating-custom-types" class="section">7.5 Creating custom types</h2>

<p>So far we’ve looked at Go’s built-in types. We’ve also used named custom struct types.</p>

<p>We’ve said that types and the statically-typed nature of Go enable compile-time checking which makes our programs safer at runtime. </p>

<p>But, built-in types alone won’t protect us in all circumstances. Consider the example below.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 56 - Simple transposition error</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">divider</code><code class="p">(</code><code class="n">d</code><code class="p">,</code> <code class="n">n</code> <code class="nb">int</code><code class="p">)</code> <code class="n">float64</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="k">return</code> <code class="n">float64</code><code class="p">(</code><code class="n">n</code><code class="p">)</code> <code class="o">/</code> <code class="n">float64</code><code class="p">(</code><code class="n">d</code><code class="p">)</code>
<code class="linenos"> 7 </code><code class="p">}</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="n">var</code> <code class="n">n</code> <code class="o">=</code> <code class="mi">1</code>
<code class="linenos">11 </code>	<code class="n">var</code> <code class="n">d</code> <code class="o">=</code> <code class="mi">4</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>	<code class="n">result</code> <code class="o">:=</code> <code class="n">divider</code><code class="p">(</code><code class="n">n</code><code class="p">,</code> <code class="n">d</code><code class="p">)</code>
<code class="linenos">14 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">result</code><code class="p">)</code> <code class="o">//</code> <code class="n">we</code> <code class="n">think</code> <code class="n">we</code> <code class="n">will</code> <code class="n">get</code> <code class="mf">0.25</code>
<code class="linenos">15 </code><code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">XhTIz_A</code><code class="o">-</code><code class="n">dxd</code>
</pre></div>

</figure>


<p>Output: </p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="m">4</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>We have a basic function which expects two integers, a denominator and numerator. It performs a division calculation and returns the result.</p>

<p>But, when we call the function we make a simple transposition error when passing the numerator and denominator. </p>

<p>We got the parameters backwards. As both are integers, the compiler has no issue with our code, which builds and runs fine, but, instead of the <code>0.25</code> result we expected, we got a result of <code>4</code>, which is incorrect. This kind of mistake is very easy to make and can be hard to debug.</p>

<p>But, we can help ourselves a little here. We can employ Go’s type system to ensure this kind of error is something the Go compiler will flag during compilation.  And we do this by creating custom types.</p>

<p>Custom types are based on built-in types but they have their own type identity.  A custom type which can hold a <i>string</i> value is not the same as the <i>string</i> type, for example. It’s possible to convert it to a string, but unless it is converted it cannot be used as a <i>string</i>.</p>

<p>Let’s use custom types to rewrite the code in Example 56 and see if we can’t catch that transposition error when the code is compiled.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 57 - Type safety using custom types</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nb">type</code> <code class="n">numer</code> <code class="nb">int</code>
<code class="linenos"> 6 </code><code class="nb">type</code> <code class="n">denom</code> <code class="nb">int</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">divider</code><code class="p">(</code><code class="n">d</code> <code class="n">denom</code><code class="p">,</code> <code class="n">n</code> <code class="n">numer</code><code class="p">)</code> <code class="n">float64</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="k">return</code> <code class="n">float64</code><code class="p">(</code><code class="n">n</code><code class="p">)</code> <code class="o">/</code> <code class="n">float64</code><code class="p">(</code><code class="n">d</code><code class="p">)</code>
<code class="linenos">10 </code><code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">13 </code>	<code class="n">var</code> <code class="n">n</code> <code class="n">numer</code> <code class="o">=</code> <code class="mi">1</code>
<code class="linenos">14 </code>	<code class="n">var</code> <code class="n">d</code> <code class="n">denom</code> <code class="o">=</code> <code class="mi">4</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code>	<code class="n">result</code> <code class="o">:=</code> <code class="n">divider</code><code class="p">(</code><code class="n">n</code><code class="p">,</code> <code class="n">d</code><code class="p">)</code>
<code class="linenos">17 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">result</code><code class="p">)</code>
<code class="linenos">18 </code><code class="p">}</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">6</code><code class="n">UQcR54_wYX</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>./prog.go:16:20: cannot use n <code class="o">(</code>variable of <code class="nb">type</code> numer<code class="o">)</code> as <code class="nb">type</code> denom <code class="k">in</code> argument to <code class="se">\</code>
<code class="linenos">2 </code>divider
<code class="linenos">3 </code>./prog.go:16:23: cannot use d <code class="o">(</code>variable of <code class="nb">type</code> denom<code class="o">)</code> as <code class="nb">type</code> numer <code class="k">in</code> argument to <code class="se">\</code>
<code class="linenos">4 </code>divider
<code class="linenos">5 </code>
<code class="linenos">6 </code>Go build failed.
</pre></div>

</figure>


<p>What did we change? </p>

<p>First, we created two custom types <code>numer</code> and <code>denom</code> both based on the <code>int</code> type so they can hold integers but are <i>not</i> of type <code>int</code>. Each is distinct.</p>

<p>Next, we declared <code>n</code> and <code>d</code> with their respective types and finally, we modified the function signature so that it accepts one of each type and not two integers.</p>

<p>When we attempt to run the program we get a compilation error which indicates we are passing the wrong types and, upon inspection, it is clear why - we are using the variables the wrong way around.</p>

<p>If we swap the arguments on line 16, so that they are passed correctly, the program builds, runs and outputs the expected result.</p>

<p>So, developing using custom types is a habit to be encouraged. By defining custom types we’re able to add an extra layer of type checking, and thus, type safety.  The more safeguards we have in place, the more errors we can catch at compile time and the safer our programs will be when they run in production.</p>

<p>Finally, the last thing to say about custom types, which we briefly mentioned in Chapter 1, is that any custom type can have receivers bound to it. If you recall, this is a key difference between Go receivers and OOP methods, the latter forming part of a class structure.</p>

<p>The benefit is twofold. First, it means we can create receivers which use the type’s data directly, we don’t need to pass it via an argument in the receiver signature.</p>

<p>Secondly, we can use our custom types anywhere a particular interface is required, provided we can implement the interface for the type, which entails adding the required behaviour to our custom type.</p>

<p>So let’s wrap up this section by quickly adding a single <code>String()</code> receiver on the <i>numer</i> type, thereby implicitly implementing the <code>Stringer</code> interface. </p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 58 -  Implementing the Stringer interface on a custom type</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nb">type</code> <code class="n">numer</code> <code class="nb">int</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="p">(</code><code class="n">n</code> <code class="n">numer</code><code class="p">)</code> <code class="n">String</code><code class="p">()</code> <code class="n">string</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="k">return</code> <code class="n">fmt</code><code class="o">.</code><code class="n">Sprintf</code><code class="p">(</code><code class="s2">"Numerator is set to </code><code class="si">%d</code><code class="s2">"</code><code class="p">,</code> <code class="n">n</code><code class="p">)</code>
<code class="linenos"> 9 </code><code class="p">}</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">12 </code>	<code class="n">var</code> <code class="n">n</code> <code class="n">numer</code> <code class="o">=</code> <code class="mi">1</code>
<code class="linenos">13 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">n</code><code class="p">)</code>
<code class="linenos">14 </code><code class="p">}</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">RSGm_FPhf6L</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Numerator is <code class="nb">set</code> to <code class="m">1</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>When we run the program we get nicely formatted output with additional context about the <i>numer</i> typed variable, provided by the <code>String()</code> receiver.</p>

<h2 id="leanpub-auto-converting-between-types" class="section">7.6 Converting between types</h2>

<p>To complete our discussion of data types, for now, we’re going to look at how we convert values from one type to another.</p>

<h3 id="leanpub-auto-type-conversion" class="subsection">7.6.1 Type conversion</h3>

<p>Go does not support <i>type casting</i>, only type conversion. What’s the difference?</p>

<p>Type casting can often be used with non-compatible data types as well as compatible types, while <i>type conversion</i> is restricted to compatible data types, and this is the case with Go. You can’t convert a <i>string</i> to an <i>int</i> using type conversion, for example.</p>

<p>In other languages <i>type conversion</i> is often implicit, but in Go because of its strong type system the conversion is explicit. This requires we state what we want the compiler to convert the value to using a wrapper function. The compiler will perform the conversion if the types are compatible, or fail to build with an error if they are not.</p>

<p>The example below demonstrates several type conversions between compatible data types. Generally, type conversion between number types is fine. As is type conversion back and forth between <i>[]byte</i> and <i>string</i>.</p>

<p>The commented code also shows type conversions between incompatible data types, try removing the comments and running the program again. It won’t build, instead, we will receive compilation errors.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 59 -  Type conversion examples</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">var</code> <code class="n">myInt</code> <code class="o">=</code> <code class="mi">1</code>
<code class="linenos"> 7 </code>	<code class="n">var</code> <code class="n">myFloat</code> <code class="o">=</code> <code class="mf">0.0</code>
<code class="linenos"> 8 </code>	<code class="n">var</code> <code class="n">myString</code> <code class="o">=</code> <code class="s2">"Hello World"</code>
<code class="linenos"> 9 </code>	<code class="n">var</code> <code class="n">myBytes</code> <code class="o">=</code> <code class="p">[]</code><code class="n">byte</code><code class="p">{</code><code class="mi">240</code><code class="p">,</code> <code class="mi">159</code><code class="p">,</code> <code class="mi">154</code><code class="p">,</code> <code class="mi">128</code><code class="p">}</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Before conversion, myInt is: %T, myFloat is: %T, myString is: %T, myByt</code><code class="se">\</code>
<code class="linenos">12 </code><code class="s2">es is: %T</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code>
<code class="linenos">13 </code>		<code class="n">myInt</code><code class="p">,</code> <code class="n">myFloat</code><code class="p">,</code> <code class="n">myString</code><code class="p">,</code> <code class="n">myBytes</code><code class="p">)</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code>	<code class="n">convertedInt</code> <code class="o">:=</code> <code class="n">float64</code><code class="p">(</code><code class="n">myInt</code><code class="p">)</code>
<code class="linenos">16 </code>	<code class="n">convertedFloat</code> <code class="o">:=</code> <code class="nb">int</code><code class="p">(</code><code class="n">myFloat</code><code class="p">)</code>
<code class="linenos">17 </code>	<code class="n">convertedBytes</code> <code class="o">:=</code> <code class="n">string</code><code class="p">(</code><code class="n">myBytes</code><code class="p">)</code>
<code class="linenos">18 </code>	<code class="n">convertedString</code> <code class="o">:=</code> <code class="p">[]</code><code class="n">byte</code><code class="p">(</code><code class="n">myString</code><code class="p">)</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"After conversion, myInt is: %T, myFloat is: %T, myString is: %T, myByte</code><code class="se">\</code>
<code class="linenos">21 </code><code class="s2">s is: %T</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code>
<code class="linenos">22 </code>		<code class="n">convertedInt</code><code class="p">,</code> <code class="n">convertedFloat</code><code class="p">,</code> <code class="n">convertedString</code><code class="p">,</code> <code class="n">convertedBytes</code><code class="p">)</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code>	<code class="o">//</code> <code class="n">incompatible</code> <code class="n">data</code> <code class="n">types</code>
<code class="linenos">25 </code>	<code class="o">//</code><code class="n">convertedFloat2</code> <code class="o">:=</code> <code class="n">string</code><code class="p">(</code><code class="n">myFloat</code><code class="p">)</code>
<code class="linenos">26 </code>	<code class="o">//</code><code class="n">convertedBool</code> <code class="o">:=</code> <code class="nb">int</code><code class="p">(</code><code class="n">true</code><code class="p">)</code>
<code class="linenos">27 </code>	<code class="o">//</code><code class="n">convertedString2</code> <code class="o">:=</code> <code class="nb">int</code><code class="p">(</code><code class="n">myString</code><code class="p">)</code>
<code class="linenos">28 </code><code class="p">}</code>
<code class="linenos">29 </code>
<code class="linenos">30 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">FOkyY6XJp1q</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Before conversion, myInt is: int, myFloat is: float64, myString is: string, myBytes <code class="se">\</code>
<code class="linenos">2 </code>is: <code class="o">[]</code>uint8
<code class="linenos">3 </code>After conversion, myInt is: float64, myFloat is: int, myString is: <code class="o">[]</code>uint8, myBytes <code class="se">\</code>
<code class="linenos">4 </code>is: string
<code class="linenos">5 </code>
<code class="linenos">6 </code>Program exited.
</pre></div>

</figure>


<aside class="information blurb">
    <p>Note a simple gotcha.  The Go compiler will <b>not</b> error if you try to convert an <i>int</i> to a <i>string</i> using type conversion, but you will not get a string representation of the integer. The conversion to string will take place, but the integer is treated as a Unicode codepoint. In the following example we don’t get a string type of value “128640”, we get the Unicode rocket character.</p>

</aside>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 60 -  This won’t print what you expect</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">var</code> <code class="n">myInt</code> <code class="o">=</code> <code class="mi">128640</code>
<code class="linenos"> 7 </code>	<code class="n">convertedInt</code> <code class="o">:=</code> <code class="n">string</code><code class="p">(</code><code class="n">myInt</code><code class="p">)</code>
<code class="linenos"> 8 </code>	
<code class="linenos"> 9 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"The int is now a string: '</code><code class="si">%s</code><code class="s2">', of type '%T'</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">convertedInt</code><code class="p">,</code> <code class="n">converted</code>\
<code class="linenos">10 </code><code class="n">Int</code><code class="p">)</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">GHVwfyD</code><code class="o">-</code><code class="n">mlH</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>The int is now a string: <code class="s1">'🚀'</code>, of <code class="nb">type</code> <code class="s1">'string'</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<h3 id="leanpub-auto-other-conversion-mechanisms" class="subsection">7.6.2 Other conversion mechanisms</h3>

<p>So, <i>type conversion</i> won’t allow us to convert between incompatible data types and for some use-cases, even where it operates on compatible data types, the result of conversion may not be what was expected. </p>

<p>Fortunately, we have other options, particularly when converting to and from, strings.</p>

<p>A very simple way to solve the <i>problem</i> above, where the integer is converted to a string, not as is, but to a Unicode character, is to use the <code>fmt</code> package instead.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 61 -  fmt.Sprintf to the rescue</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">var</code> <code class="n">myInt</code> <code class="o">=</code> <code class="mi">128640</code>
<code class="linenos"> 7 </code>	<code class="n">convertedInt</code> <code class="o">:=</code> <code class="n">fmt</code><code class="o">.</code><code class="n">Sprintf</code><code class="p">(</code><code class="s2">"</code><code class="si">%d</code><code class="s2">"</code><code class="p">,</code> <code class="n">myInt</code><code class="p">)</code>
<code class="linenos"> 8 </code>	
<code class="linenos"> 9 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"The int is now a string: '</code><code class="si">%s</code><code class="s2">', of type '%T'</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">convertedInt</code><code class="p">,</code> <code class="n">converted</code>\
<code class="linenos">10 </code><code class="n">Int</code><code class="p">)</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">b6APk</code><code class="o">-</code><code class="n">xVK9X</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>The int is now a string: <code class="s1">'128640'</code>, of <code class="nb">type</code> <code class="s1">'string'</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>We can also perform conversions between strings and what would otherwise be incompatible data types using the <code>strconv</code> package from the standard library - a package which can assist us with all manner of string and numeric conversions. </p>

<p>Exploring the <a href="https://pkg.go.dev/strconv"><code>strconv</code> package</a> is left as an exercise for the reader, but the example below shows three common use cases.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 62 -  Package <i>strconv</i> examples</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"strconv"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">myInt</code> <code class="o">:=</code> <code class="mi">10</code>
<code class="linenos">10 </code>	<code class="n">myIntString</code> <code class="o">:=</code> <code class="s2">"10"</code>
<code class="linenos">11 </code>	<code class="n">myFloatString</code> <code class="o">:=</code> <code class="s2">"3.1415926535"</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>	<code class="o">//</code> <code class="nb">int</code> <code class="n">to</code> <code class="n">string</code>
<code class="linenos">14 </code>	<code class="n">resStr</code> <code class="o">:=</code> <code class="n">strconv</code><code class="o">.</code><code class="n">Itoa</code><code class="p">(</code><code class="n">myInt</code><code class="p">)</code>
<code class="linenos">15 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"resStr is '%T, of '%v'</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">resStr</code><code class="p">,</code> <code class="n">resStr</code><code class="p">)</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code>	<code class="o">//</code> <code class="n">string</code> <code class="n">to</code> <code class="nb">int</code>
<code class="linenos">18 </code>	<code class="k">if</code> <code class="n">resInt</code><code class="p">,</code> <code class="n">err</code> <code class="o">:=</code> <code class="n">strconv</code><code class="o">.</code><code class="n">Atoi</code><code class="p">(</code><code class="n">myIntString</code><code class="p">);</code> <code class="n">err</code> <code class="o">==</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos">19 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"resInt is '%T', '%v'</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">resInt</code><code class="p">,</code> <code class="n">resInt</code><code class="p">)</code>
<code class="linenos">20 </code>	<code class="p">}</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code>	<code class="o">//</code> <code class="n">string</code> <code class="n">to</code> <code class="nb">float</code>
<code class="linenos">23 </code>	<code class="k">if</code> <code class="n">resFloat</code><code class="p">,</code> <code class="n">err</code> <code class="o">:=</code> <code class="n">strconv</code><code class="o">.</code><code class="n">ParseFloat</code><code class="p">(</code><code class="n">myFloatString</code><code class="p">,</code> <code class="mi">64</code><code class="p">);</code> <code class="n">err</code> <code class="o">==</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos">24 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"resFloat is '%T', '%v'</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">resFloat</code><code class="p">,</code> <code class="n">resFloat</code><code class="p">)</code>
<code class="linenos">25 </code>	<code class="p">}</code>
<code class="linenos">26 </code><code class="p">}</code>
<code class="linenos">27 </code>
<code class="linenos">28 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">5</code><code class="n">kW2FyxBGgU</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>resStr is <code class="s1">'string, of '</code><code class="m">10</code><code class="s1">'</code>
<code class="linenos">2 </code><code class="s1">resInt is '</code>int<code class="s1">', '</code><code class="m">10</code><code class="s1">'</code>
<code class="linenos">3 </code><code class="s1">resFloat is '</code>float64<code class="s1">', '</code><code class="m">3</code>.1415926535<code class="err">'</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code>Program exited.
</pre></div>

</figure>


<p>Finally, to conclude this section, what should we do if <i>type conversion</i> won’t work since the types are incompatible, and there is no built-in helper function that does what we need, for example, to convert a <i>bool</i> to an <i>int</i>?</p>

<p>In these rare circumstances, we as developers get an opportunity to step up and devise a conversion helper of our own, rather than rely on the Go standard library for all of our needs ;)</p>

<p>In the example below we create a simple <code>boolToI()</code> helper function to perform just such a conversion.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 63 -  A custom BoolToI helper function</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">boolToI</code><code class="p">(</code><code class="n">b</code> <code class="nb">bool</code><code class="p">)</code> <code class="nb">int</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">var</code> <code class="n">bToI</code> <code class="nb">int</code>
<code class="linenos"> 7 </code>	<code class="k">if</code> <code class="n">b</code> <code class="p">{</code>
<code class="linenos"> 8 </code>		<code class="n">bToI</code> <code class="o">=</code> <code class="mi">1</code>
<code class="linenos"> 9 </code>	<code class="p">}</code>
<code class="linenos">10 </code>	<code class="k">return</code> <code class="n">bToI</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">14 </code>	<code class="n">myBool</code> <code class="o">:=</code> <code class="n">true</code>
<code class="linenos">15 </code>	<code class="n">myBool2</code> <code class="o">:=</code> <code class="n">false</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code>	<code class="n">boolAsInt</code> <code class="o">:=</code> <code class="n">boolToI</code><code class="p">(</code><code class="n">myBool</code><code class="p">)</code>
<code class="linenos">18 </code>	<code class="n">boolAsInt2</code> <code class="o">:=</code> <code class="n">boolToI</code><code class="p">(</code><code class="n">myBool2</code><code class="p">)</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"boolAsInt: </code><code class="si">%d</code><code class="s2">, boolAsInt2: </code><code class="si">%d</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">boolAsInt</code><code class="p">,</code> <code class="n">boolAsInt2</code><code class="p">)</code>
<code class="linenos">21 </code><code class="p">}</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">gseJ2vzyDSc</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>boolAsInt: <code class="m">1</code>, boolAsInt2: <code class="m">0</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>



<h1 id="leanpub-auto-chapter-8---managing-program-flow" class="chapter">Chapter 8 - Managing program flow</h1>

<p>Now that we’ve got many of the fundamentals in place, let’s look at how we bring it all to life. In this section, we’ll cover control structures and error handling: the glue of our program. </p>

<h2 id="leanpub-auto-control-structures" class="section">8.1 Control structures</h2>

<p>Programs are dumb. They need to be told how to respond to every input and outcome. We call this <i>flow control</i> and we may employ three forms of <i>control structure</i> logic in our programs to facilitate this: <i>sequence</i>, <i>selection</i> and, <i>iteration</i>.</p>

<p><i>Sequence</i> logic is linear. Statements are executed one after the other provided expectations are met.</p>

<p><i>Selection</i> logic concerns itself with the conditional flow - what to do when one or more, of several possible outcomes, is satisfied.</p>

<p><i>Iteration</i> logic covers the conditions under which a section of code should be repeatedly run, and of course, when that repetition should finish.</p>

<p>Let’s look at how we implement flow control in Go.</p>

<h3 id="leanpub-auto-sequence-logic" class="subsection">8.1.1 Sequence logic</h3>

<p>With <i>sequential</i> flow, execution continues statement by statement until a result is obtained and/or the function returns. Statements are ordered, such that the next builds on the last to achieve a result. Unless there is an error, panic or control signal to terminate, there is nothing to interrupt the execution of the logic.</p>

<p>Though we can call blocks of code asynchronously via a goroutine, the operations performed by such a goroutine would also execute in the same manner: top to bottom.</p>

<p>We may ocassionally see the <code>goto</code> statement used, which allows for an unconditional jump to a label identifier <b>within</b> the same function. </p>

<p>While it is unconditional, <code>goto</code> may be used to act on the result of some expectation or condition. </p>

<p>In the example below we use <code>goto</code> to implement an endless loop which cycles every three seconds. </p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 64 -  Using goto to restart function execution</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"time"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="n">START</code><code class="p">:</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Timer running"</code><code class="p">)</code>
<code class="linenos">13 </code>	<code class="n">time</code><code class="o">.</code><code class="n">Sleep</code><code class="p">(</code><code class="mi">3</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">)</code>
<code class="linenos">14 </code>	<code class="n">goto</code> <code class="n">START</code>
<code class="linenos">15 </code><code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">5</code><code class="n">dsPU41vPQ7</code>
</pre></div>

</figure>


<p>Output:</p>

<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Timer running
<code class="linenos">2 </code>Timer running
<code class="linenos">3 </code>Timer running
<code class="linenos">4 </code>...
</pre></div>

</figure>


<p>This example is included only for completeness. The use of <code>goto</code> is not common in Go, nor recommended. It can make code harder to read and reason about. We have alternative control structures we can use to achieve the same as <code>goto</code>.</p>

<p>We should also mention <i>defer</i> here since it is another exception to the normal sequential flow. The <code>defer</code> keyword is used to link associated logic to aid readability and help prevent bugs. </p>

<p>For instance, consider the operations of opening, reading and then closing a file. Between the opening and closing of the file, there could be many lines of code to process the file contents, the result being that the opening and close operations could become somewhat disassociated.</p>

<p>Failing to close the file would create a bug, but in long sequences of code, the omission of the close operation may be difficult to spot.</p>

<p>The <code>defer</code> keyword solves the problem by allowing us to position the open and close operations near one another. Any deferred statements are run before the function returns, if there are multiple deferred statements they are run on a LIFO basis.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code>    <code class="o">//</code> <code class="nv">open</code> <code class="nv">file</code>
<code class="linenos"> 2 </code>    <code class="nv">src</code>, <code class="nv">err</code> :<code class="o">=</code> <code class="nv">os</code>.<code class="nv">Open</code><code class="ss">(</code><code class="nv">filename</code><code class="ss">)</code>
<code class="linenos"> 3 </code>    <code class="k">if</code> <code class="nv">err</code> <code class="o">!=</code> <code class="nv">nil</code> {
<code class="linenos"> 4 </code>        <code class="k">return</code>
<code class="linenos"> 5 </code>    }
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code>    <code class="o">//</code> <code class="nv">defer</code> <code class="nv">closing</code> <code class="nv">file</code>
<code class="linenos"> 8 </code>    <code class="nv">defer</code> <code class="nv">src</code>.<code class="nv">Close</code><code class="ss">()</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code>    <code class="o">//</code> <code class="nv">file</code> <code class="nv">processing</code> <code class="nv">operations</code>
<code class="linenos">11 </code>    ...
</pre></div>

</figure>


<h3 id="leanpub-auto-selection-logic" class="subsection">8.1.2 Selection logic</h3>

<p>Go provides similar conditional statements to those found in other languages: </p>

<ul>
  <li>if/else/elseif</li>
  <li>switch/case/default</li>
</ul>

<h4 id="leanpub-auto-ifelseelseif" class="subsubsection">8.1.2.1 If/else/elseif</h4>

<p>When using if/else conditional logic, an established best practice is to minimise our use of <i>else</i> statements. We can often achieve this by making the <i>else</i> condition the default case.</p>

<p>Our motivation, once again, is improved readablity. For it is easier to understand how a program should run by reviewing code at the same level of indentation. Stepping into, and then out of, conditional code makes reasoning and comprehension more difficult.</p>

<p>Example 65 shows a fairly simple function written in a perfectly acceptable manner using <i>if</i> and <i>else</i> conditional statements. </p>

<p>In the example, we pass two numbers as arguments and the function tells us if the first number is even, and less than the second. </p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 65 -  Simple function with conditional if/else logic</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">isEvenLessThan</code><code class="p">(</code><code class="n">n</code> <code class="nb">int</code><code class="p">,</code> <code class="n">c</code> <code class="nb">int</code><code class="p">)</code> <code class="p">(</code><code class="nb">bool</code><code class="p">,</code> <code class="nb">bool</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="k">if</code> <code class="n">n</code><code class="o">%</code><code class="mi">2</code> <code class="o">==</code> <code class="mi">0</code> <code class="p">{</code>
<code class="linenos"> 7 </code>		<code class="k">if</code> <code class="n">n</code> <code class="o">&lt;</code> <code class="n">c</code> <code class="p">{</code>
<code class="linenos"> 8 </code>			<code class="k">return</code> <code class="n">true</code><code class="p">,</code> <code class="n">true</code>
<code class="linenos"> 9 </code>		<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="linenos">10 </code>			<code class="k">return</code> <code class="n">true</code><code class="p">,</code> <code class="n">false</code>
<code class="linenos">11 </code>		<code class="p">}</code>
<code class="linenos">12 </code>	<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="linenos">13 </code>		<code class="k">if</code> <code class="n">n</code> <code class="o">&lt;</code> <code class="n">c</code> <code class="p">{</code>
<code class="linenos">14 </code>			<code class="k">return</code> <code class="n">false</code><code class="p">,</code> <code class="n">true</code>
<code class="linenos">15 </code>		<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="linenos">16 </code>			<code class="k">return</code> <code class="n">false</code><code class="p">,</code> <code class="n">false</code>
<code class="linenos">17 </code>		<code class="p">}</code>
<code class="linenos">18 </code>	<code class="p">}</code>
<code class="linenos">19 </code><code class="p">}</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">22 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">isEvenLessThan</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="mi">10</code><code class="p">))</code>
<code class="linenos">23 </code><code class="p">}</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">hUPNR_4gRy_6</code>
</pre></div>

</figure>


<p>Output:</p>

<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nb">true</code> <code class="nb">true</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<aside class="information blurb">
    <p>The function <code>isEvenLessThan()</code> makes use of multiple return values, which we’ve not seen so far. We’ll cover this attribute of functions and receivers in Chapter 9 - Digging deeper.</p>

</aside>

<p>In Example 66, next, we rewrite the function logic in such as way that we can dispense with the <i>else</i> statements. By making use of the fact that variables are initialised to their <i>nil</i> value, we can simplify the conditional logic required to set the function return values. The result is less code, less indentation and, improved readability.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 66 -  Eliminating the <i>else</i> statements</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">isEvenLessThan</code><code class="p">(</code><code class="n">n</code> <code class="nb">int</code><code class="p">,</code> <code class="n">c</code> <code class="nb">int</code><code class="p">)</code> <code class="p">(</code><code class="nb">bool</code><code class="p">,</code> <code class="nb">bool</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">var</code> <code class="n">even</code><code class="p">,</code> <code class="n">less</code> <code class="nb">bool</code> <code class="o">//</code> <code class="n">initialised</code> <code class="n">to</code> <code class="n">false</code>
<code class="linenos"> 7 </code>	
<code class="linenos"> 8 </code>	<code class="k">if</code> <code class="n">n</code><code class="o">%</code><code class="mi">2</code> <code class="o">==</code> <code class="mi">0</code> <code class="p">{</code>
<code class="linenos"> 9 </code>		<code class="n">even</code> <code class="o">=</code> <code class="n">true</code>
<code class="linenos">10 </code>	<code class="p">}</code>
<code class="linenos">11 </code>	<code class="k">if</code> <code class="n">n</code> <code class="o">&lt;</code> <code class="n">c</code> <code class="p">{</code>
<code class="linenos">12 </code>		<code class="n">less</code> <code class="o">=</code> <code class="n">true</code>
<code class="linenos">13 </code>	<code class="p">}</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code>	<code class="k">return</code> <code class="n">even</code><code class="p">,</code> <code class="n">less</code>
<code class="linenos">16 </code><code class="p">}</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">19 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">isEvenLessThan</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="mi">10</code><code class="p">))</code>
<code class="linenos">20 </code><code class="p">}</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">lJm4fJ3REPa</code>
</pre></div>

</figure>


<p>Output:</p>

<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nb">true</code> <code class="nb">true</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<aside class="information blurb">
    <p>Of course, it won’t always be possible to remove all usage of <i>else</i>. In situations where we need to use it, we should try to minimise its footprint by writing the code in the <i>else</i> body as concisely as possible.</p>

</aside>

<p>Go also has an <i>elseif</i> conditional statement, which may help reduce our use of nested <i>if</i> and <i>else</i> statements.</p>

<h4 id="leanpub-auto-short-form-if-statement" class="subsubsection">8.1.2.2 Short-form if statement</h4>

<p>Where possible, it’s preferable to use a short-form <i>if</i> statement. Indeed it’s something we will see frequently when reviewing other users’ code.</p>

<p>It helps us reduce the verbosity of our syntax, which is particularly useful for operations such as error checking that we perform repeatedly. </p>

<p>The syntax appears slightly unusual initially, but it is worth getting used to. Once you are familiar with the short-form syntax it does not detract from clarity.</p>

<p>In the example below, we use a short-form <i>if</i> statement to print to Stdout <b>only</b> if the result is even. We discard the second return value, which we do not need, by using the <i>blank identifier</i>.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 67 - Short-form if statement</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="o">//</code> <code class="n">function</code> <code class="n">omitted</code> <code class="k">for</code> <code class="n">brevity</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="k">if</code> <code class="n">even</code><code class="p">,</code> <code class="n">_</code> <code class="o">:=</code> <code class="n">isEvenLessThan</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code> <code class="n">even</code> <code class="p">{</code>
<code class="linenos"> 9 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Result was even"</code><code class="p">)</code>
<code class="linenos">10 </code>	<code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code>    <code class="o">//</code><code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">even</code><code class="p">)</code>
<code class="linenos">13 </code><code class="p">}</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">qmoU</code><code class="o">-</code><code class="n">gAtzCw</code>
</pre></div>

</figure>


<p>Output:</p>

<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Result was even
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<aside class="information blurb">
    <p>Note that in this short-form if statement, the variable <code>even</code> is scoped to the <i>if</i> statement body. It exists only while that block is executed and not beyond it. Try uncommenting the last line to print <code>even</code> and running the code again.</p>

  <p>Note also, that if the variable <code>even</code> was declared in the parent function scope too, it would not be the value used in this <i>if</i> block. So take care with variable shadowing. Replacing <code>:=</code> with <code>=</code> would ensure that no new variables are declared, and the <code>even</code> variable used in the <i>if</i> statement body was the same as declared in the parent scope. </p>

</aside>

<h4 id="leanpub-auto-switchcasedefault" class="subsubsection">8.1.2.3 Switch/case/default</h4>

<p>An alternative to using an <i>if</i> condition with multiple <i>elseif</i> statements, is <i>switch</i>. When using <i>switch</i> we can implement all the conditional logic of <i>if/else/elseif</i>, and more.</p>

<p>In place of <i>elseif</i> statements, we can implement <i>case</i> statements. We can also use <i>default</i> to specify an equivalent to <i>else</i> if none of the <i>case</i> statement conditions match.</p>

<p>Go’s implementation of <i>switch</i> is slightly different to other languages. It only runs the matched <i>case</i> (and not those that follow) and then implicitly breaks out of the switch statement although we can use the <i>fallthrough</i> keyword to emulate how other languages implement <i>switch</i>.  </p>

<p>Another distinction is that in Go <i>switch</i> can operate on variables and constants of any type, and not only integers.</p>

<p>We show a couple of <i>switch</i> examples next. First, an example with a <i>default</i> statement which operates on a string variable. This executes if none of the case statements are matched and executed.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 68 -  Simple switch with default</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="n">myName</code> <code class="o">:=</code> <code class="s2">"Joe Blogs"</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code>	<code class="n">switch</code> <code class="n">myName</code> <code class="p">{</code>
<code class="linenos">11 </code>	<code class="n">case</code> <code class="s2">"Joe Blogs"</code><code class="p">:</code>
<code class="linenos">12 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Hi Joe!"</code><code class="p">)</code>
<code class="linenos">13 </code>	<code class="n">case</code> <code class="s2">"Dave Blogs"</code><code class="p">:</code>
<code class="linenos">14 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Hi Dave!"</code><code class="p">)</code>
<code class="linenos">15 </code>	<code class="n">default</code><code class="p">:</code>
<code class="linenos">16 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Hi there!"</code><code class="p">)</code>
<code class="linenos">17 </code>	<code class="p">}</code>
<code class="linenos">18 </code><code class="p">}</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">3</code><code class="n">FiTf9lGEDd</code>
</pre></div>

</figure>


<p>Output: </p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Hi Joe!
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>Next, we show an example of an <i>expressionless</i> switch statement which allows us to write more complex <i>case</i> conditions than would otherwise be possible.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 69 -  Expressionless switch statement</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="n">num</code> <code class="o">:=</code> <code class="mi">12</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code>	<code class="n">switch</code> <code class="p">{</code>
<code class="linenos">11 </code>	<code class="n">case</code> <code class="n">num</code> <code class="o">&gt;=</code> <code class="mi">0</code> <code class="o">&amp;&amp;</code> <code class="n">num</code> <code class="o">&lt;=</code> <code class="mi">10</code><code class="p">:</code>
<code class="linenos">12 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Between 0 and 10"</code><code class="p">)</code>
<code class="linenos">13 </code>	<code class="n">case</code> <code class="n">num</code> <code class="o">&gt;=</code> <code class="mi">10</code><code class="p">:</code>
<code class="linenos">14 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Greater than 10"</code><code class="p">)</code>
<code class="linenos">15 </code>	<code class="p">}</code>
<code class="linenos">16 </code><code class="p">}</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">cx8jV4QXHRI</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Greater than <code class="m">10</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>In this example, we use the short-form notation and set multiple match tests per <i>case</i> statement.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 70 - Short-form switch with multiple match tests</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="n">switch</code> <code class="n">letter</code> <code class="o">:=</code> <code class="s2">"z"</code><code class="p">;</code> <code class="n">letter</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">case</code> <code class="s2">"a"</code><code class="p">,</code> <code class="s2">"e"</code><code class="p">,</code> <code class="s2">"i"</code><code class="p">,</code> <code class="s2">"o"</code><code class="p">,</code> <code class="s2">"u"</code><code class="p">:</code>
<code class="linenos">10 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"letter was a vowel"</code><code class="p">)</code>
<code class="linenos">11 </code>	<code class="n">default</code><code class="p">:</code>
<code class="linenos">12 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"letter was not a vowel"</code><code class="p">)</code>
<code class="linenos">13 </code>	<code class="p">}</code>
<code class="linenos">14 </code><code class="p">}</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">DjPtZbdigfm</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>letter was not a vowel
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>The final example illustrates the use of <i>fallthrough</i>, which will execute the body of the next case and then exit the switch statement.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 71 - Fallthrough to execute the next case</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">day</code> <code class="o">:=</code> <code class="s2">"Mon"</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code>	<code class="n">switch</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">case</code> <code class="n">day</code> <code class="o">==</code> <code class="s2">"Mon"</code><code class="p">:</code>
<code class="linenos">10 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Monday"</code><code class="p">)</code>
<code class="linenos">11 </code>		<code class="n">fallthrough</code>
<code class="linenos">12 </code>	<code class="n">case</code> <code class="n">day</code> <code class="o">==</code> <code class="s2">"Tue"</code><code class="p">:</code>
<code class="linenos">13 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Tuesday"</code><code class="p">)</code>
<code class="linenos">14 </code>	<code class="n">case</code> <code class="n">day</code> <code class="o">==</code> <code class="s2">"Wed"</code><code class="p">:</code>
<code class="linenos">15 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Wednesday"</code><code class="p">)</code>
<code class="linenos">16 </code>	<code class="p">}</code>
<code class="linenos">17 </code><code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">hw1WLkjYPUb</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Monday
<code class="linenos">2 </code>Tuesday
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<aside class="information blurb">
    <p>It is an often-held misconception that <i>fallthrough</i> moves to the next case statement and then checks for a match, executing only if the case test is satisfied. Though intuitively this seems sensible, it is not the case - the body of the next case statement is executed whether or not there is a match.  </p>

</aside>

<h3 id="leanpub-auto-iteration-logic" class="subsection">8.1.3 Iteration logic</h3>

<p>Though many languages offer several constructs for implementing different types of loops, in Go we implement all loops using only <code>for</code> loops. </p>

<p>A single <code>for</code> keyword keeps matters simple and we’re able to emulate all of the looping mechanisms like <code>do while</code>, <code>while</code> and <code>for each</code>, if we know how to construct the <code>for</code> loop.</p>

<p>So, let’s look at all the different loop implementations we can create. </p>

<aside class="information blurb">
    <p>Let’s not be confused. Though we label the loops as their equivalents in other languages, we’re using only <code>for</code> to create them. That’s the only looping construct we have in Go!</p>

</aside>

<h4 id="leanpub-auto-infinite" class="subsubsection">8.1.3.1 Infinite</h4>

<p>Infinite loops are achieved using the most basic <code>for</code> loop syntax.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 72 - Infinite loop with for</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="o">//</code> <code class="n">this</code> <code class="n">will</code> <code class="n">timeout</code> <code class="n">on</code> <code class="n">the</code> <code class="n">playground</code>
<code class="linenos"> 9 </code>	<code class="k">for</code> <code class="p">{</code>
<code class="linenos">10 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"infinite loop"</code><code class="p">)</code>
<code class="linenos">11 </code>	<code class="p">}</code>
<code class="linenos">12 </code><code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">ZBcHX0L11Qq</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>infinite loop
<code class="linenos">2 </code>infinite loop
<code class="linenos">3 </code>infinite loop
<code class="linenos">4 </code>...
</pre></div>

</figure>


<h4 id="leanpub-auto-three-component" class="subsubsection">8.1.3.2 Three Component</h4>

<p>Common to most languages is the three-component loop which uses an <i>init statement</i>, a <i>loop condition</i> and a <i>post-loop statement</i> to specify the loop behaviour.</p>

<p>The three-component <code>for</code> loop is implemented in the same way in Go. </p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 73 - Three component loop with for</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="mi">5</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos"> 9 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"iteration"</code><code class="p">,</code> <code class="n">i</code><code class="o">+</code><code class="mi">1</code><code class="p">)</code>
<code class="linenos">10 </code>	<code class="p">}</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">IFE1</code><code class="o">-</code><code class="n">HGEGkQ</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>iteration <code class="m">1</code>
<code class="linenos">2 </code>iteration <code class="m">2</code>
<code class="linenos">3 </code>iteration <code class="m">3</code>
<code class="linenos">4 </code>iteration <code class="m">4</code>
<code class="linenos">5 </code>iteration <code class="m">5</code>
<code class="linenos">6 </code>
<code class="linenos">7 </code>Program exited.
</pre></div>

</figure>


<h4 id="leanpub-auto-while-equivalent" class="subsubsection">8.1.3.3 While equivalent</h4>

<p><i>While</i> loops execute while a certain condition exists. In the below example, the condition is that n should be less than or equal to 5.  The condition is checked before execution of a loop iteration. Notice how <code>n</code> finishes and prints at a value of <code>6</code>.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 74 - While equivalent using for</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="n">n</code> <code class="o">:=</code> <code class="mi">1</code>
<code class="linenos"> 9 </code>	<code class="k">for</code> <code class="n">n</code> <code class="o">&lt;=</code> <code class="mi">5</code> <code class="p">{</code>
<code class="linenos">10 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Iteration"</code><code class="p">,</code> <code class="n">n</code><code class="p">)</code>
<code class="linenos">11 </code>		<code class="n">n</code><code class="o">++</code>
<code class="linenos">12 </code>	<code class="p">}</code>
<code class="linenos">13 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"n finished at </code><code class="si">%d</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">n</code><code class="p">)</code>
<code class="linenos">14 </code><code class="p">}</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">oC25p</code><code class="o">-</code><code class="n">YNNBx</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Iteration <code class="m">1</code>
<code class="linenos">2 </code>Iteration <code class="m">2</code>
<code class="linenos">3 </code>Iteration <code class="m">3</code>
<code class="linenos">4 </code>Iteration <code class="m">4</code>
<code class="linenos">5 </code>Iteration <code class="m">5</code>
<code class="linenos">6 </code>n finished at <code class="m">6</code>
<code class="linenos">7 </code>
<code class="linenos">8 </code>Program exited.
</pre></div>

</figure>


<h4 id="leanpub-auto-do-while-equivalent" class="subsubsection">8.1.3.4 Do while equivalent</h4>

<p>A <code>do while</code> style loop is very similar to <code>while</code> but the condition check is made after the loop iteration.  In Go, using <code>for</code> alone the equivalent syntax would be like in the below example. Notice that <code>n</code> finishes at a value of <code>5</code>.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 75 - Do while equivalent with for</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">n</code> <code class="o">:=</code> <code class="mi">1</code>
<code class="linenos"> 7 </code>	<code class="k">for</code> <code class="n">ok</code> <code class="o">:=</code> <code class="n">true</code><code class="p">;</code> <code class="n">ok</code><code class="p">;</code> <code class="n">ok</code> <code class="o">=</code> <code class="n">n</code> <code class="o">!=</code> <code class="mi">5</code> <code class="p">{</code>
<code class="linenos"> 8 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Iteration"</code><code class="p">,</code> <code class="n">n</code><code class="p">)</code>
<code class="linenos"> 9 </code>		<code class="n">n</code><code class="o">++</code>
<code class="linenos">10 </code>	<code class="p">}</code>
<code class="linenos">11 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"n finished at </code><code class="si">%d</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">n</code><code class="p">)</code>
<code class="linenos">12 </code><code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">SZUMlRfW3Fn</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Iteration <code class="m">1</code>
<code class="linenos">2 </code>Iteration <code class="m">2</code>
<code class="linenos">3 </code>Iteration <code class="m">3</code>
<code class="linenos">4 </code>Iteration <code class="m">4</code>
<code class="linenos">5 </code>n finished at <code class="m">5</code>
<code class="linenos">6 </code>
<code class="linenos">7 </code>Program exited.
</pre></div>

</figure>


<h4 id="leanpub-auto-for-each" class="subsubsection">8.1.3.5 For Each</h4>

<p><i>For each</i> type implementations use the <i>range</i> keyword. We’ve seen <i>range</i> in many of the examples to date, and we can use it to iterate over collections such as <i>arrays</i>, <i>slices</i> and <i>maps</i> while getting convenient access to the data contained in the collection.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 76 - For each performed using idiomatic for range</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">sl</code> <code class="o">:=</code> <code class="p">[]</code><code class="nb">int</code><code class="p">{</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">}</code>
<code class="linenos"> 7 </code>	<code class="n">mp</code> <code class="o">:=</code> <code class="nb">map</code><code class="p">[</code><code class="n">string</code><code class="p">]</code><code class="n">string</code><code class="p">{</code><code class="s2">"key1"</code><code class="p">:</code> <code class="s2">"value1"</code><code class="p">,</code> <code class="s2">"key2"</code><code class="p">:</code> <code class="s2">"value2"</code><code class="p">}</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>	<code class="o">//</code> <code class="nb">slice</code><code class="o">/</code><code class="n">array</code>
<code class="linenos">10 </code>	<code class="k">for</code> <code class="n">index</code><code class="p">,</code> <code class="n">value</code> <code class="o">:=</code> <code class="nb">range</code> <code class="n">sl</code> <code class="p">{</code>
<code class="linenos">11 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"index: </code><code class="si">%d</code><code class="s2">, value: </code><code class="si">%d</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">index</code><code class="p">,</code> <code class="n">value</code><code class="p">)</code>
<code class="linenos">12 </code>	<code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code>	<code class="o">//</code> <code class="nb">map</code>
<code class="linenos">15 </code>	<code class="k">for</code> <code class="n">key</code><code class="p">,</code> <code class="n">value</code> <code class="o">:=</code> <code class="nb">range</code> <code class="n">mp</code> <code class="p">{</code>
<code class="linenos">16 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"key: </code><code class="si">%s</code><code class="s2">, value: </code><code class="si">%s</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">key</code><code class="p">,</code> <code class="n">value</code><code class="p">)</code>
<code class="linenos">17 </code>	<code class="p">}</code>
<code class="linenos">18 </code><code class="p">}</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">CVjj4pUtc2c</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>index: <code class="m">0</code>, value: <code class="m">1</code>
<code class="linenos">2 </code>index: <code class="m">1</code>, value: <code class="m">2</code>
<code class="linenos">3 </code>key: key1, value: value1
<code class="linenos">4 </code>key: key2, value: value2
<code class="linenos">5 </code>
<code class="linenos">6 </code>Program exited.
</pre></div>

</figure>


<aside class="information blurb">
    <p>Beware of trying to mutate a slice element within a <code>for range</code> loop using the <code>value</code> variable. This won’t work. The <code>value</code> variable is a copy of the slice element created at each iteration of the <code>for range</code> loop. Altering <code>value</code> will change it for that iteration only, and will not change the element in the slice itself.  To mutate the slice element properly we should use the index position of the element in the slice, so using the example above if we wanted to add 1 to each element in the slice we would do the following</p>

</aside>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="k">for</code><code class="w"> </code><code class="k">index</code><code class="p">,</code><code class="w"> </code><code class="k">value</code><code class="w"> </code><code class="err">:</code><code class="o">=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="n">sl</code><code class="w"> </code><code class="err">{</code><code class="w"></code>
<code class="linenos">2 </code><code class="w">	</code><code class="n">fmt</code><code class="p">.</code><code class="n">Printf</code><code class="p">(</code><code class="ss">"index: %d, value: %d\n"</code><code class="p">,</code><code class="w"> </code><code class="k">index</code><code class="p">,</code><code class="w"> </code><code class="k">value</code><code class="p">)</code><code class="w"></code>
<code class="linenos">3 </code><code class="w">    </code><code class="n">sl</code><code class="o">[</code><code class="n">index</code><code class="o">]++</code><code class="w"> </code><code class="o">//</code><code class="w"> </code><code class="ow">and</code><code class="w"> </code><code class="ow">not</code><code class="w"> </code><code class="k">value</code><code class="o">++</code><code class="w"></code>
<code class="linenos">4 </code><code class="err">}</code><code class="w"></code>
</pre></div>

</figure>


<h4 id="leanpub-auto-break--continue" class="subsubsection">8.1.3.6 Break &amp; Continue</h4>

<p>Go implements <code>break</code> and <code>continue</code> exactly as in C and similar languages. To exit out of the innermost loop and carry on execution we use <code>break</code>. To exit a single iteration and have the loop start the next iteration we use <code>continue</code>.</p>

<p>In this example we look for a value (3). When found we break out of the loop and print what we found.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 77 - Using break to exit a loop</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">sl</code> <code class="o">:=</code> <code class="p">[]</code><code class="nb">int</code><code class="p">{</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">}</code>
<code class="linenos"> 7 </code>	<code class="n">found</code> <code class="o">:=</code> <code class="mi">0</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>	<code class="k">for</code> <code class="n">_</code><code class="p">,</code> <code class="n">v</code> <code class="o">:=</code> <code class="nb">range</code> <code class="n">sl</code> <code class="p">{</code>
<code class="linenos">10 </code>		<code class="k">if</code> <code class="n">v</code> <code class="o">==</code> <code class="mi">3</code> <code class="p">{</code>
<code class="linenos">11 </code>			<code class="n">found</code> <code class="o">=</code> <code class="n">v</code>
<code class="linenos">12 </code>			<code class="k">break</code>
<code class="linenos">13 </code>		<code class="p">}</code>
<code class="linenos">14 </code>	<code class="p">}</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"found:"</code><code class="p">,</code> <code class="n">found</code><code class="p">)</code>
<code class="linenos">17 </code><code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">o2vXkdAYNk3</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>found: <code class="m">3</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>In this example we use <code>continue</code> to advance to the next iteration if a number is positive, so that we only print odd numbers.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 78 - Using continue to advance to next loop iteration</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">sl</code> <code class="o">:=</code> <code class="p">[]</code><code class="nb">int</code><code class="p">{</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">}</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code>	<code class="k">for</code> <code class="n">_</code><code class="p">,</code> <code class="n">v</code> <code class="o">:=</code> <code class="nb">range</code> <code class="n">sl</code> <code class="p">{</code>
<code class="linenos"> 9 </code>		<code class="k">if</code> <code class="n">v</code><code class="o">%</code><code class="mi">2</code> <code class="o">==</code> <code class="mi">0</code> <code class="p">{</code>
<code class="linenos">10 </code>			<code class="k">continue</code>
<code class="linenos">11 </code>		<code class="p">}</code>
<code class="linenos">12 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"</code><code class="si">%d</code><code class="s2"> is an odd number</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">v</code><code class="p">)</code>
<code class="linenos">13 </code>	<code class="p">}</code>
<code class="linenos">14 </code><code class="p">}</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">qbVGN5S3hLY</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="m">1</code> is an odd number
<code class="linenos">2 </code><code class="m">3</code> is an odd number
<code class="linenos">3 </code><code class="m">5</code> is an odd number
<code class="linenos">4 </code>
<code class="linenos">5 </code>Program exited.
</pre></div>

</figure>


<aside class="information blurb">
    <p>Note <code>break</code> is also used with <code>switch/case</code> statements and <code>select</code>, whereas <code>continue</code> is only relevant in <code>for</code> loops. </p>

</aside>

<h2 id="leanpub-auto-error-handling" class="section">8.2 Error handling</h2>

<p>Go’s error-handling capabilities have earned it a reputation as one of the most reliable languages for production-level applications. </p>

<p>We said right at the beginning when introducing Go that errors are just values.  In Go, there are no exceptions and no <i>try/catch</i> type operations. </p>

<p>We’re able to create error values, and, decide how we handle the error values we receive, in our program flow. Generally, we’ll either log the error if execution should continue, or return from the function/receiver with the error if it should not. As a rule, we shouldn’t do both.</p>

<p>The default, zero value of an error value is nil. Only non-nil values are considered to be errors. Function signatures should be designed with the error as the last return value, and it is generally expected that when returning a non-nil error value, any other return values should be set to their <i>nil</i> or <i>empty</i> representation rather than include data. Error values themselves, should usually be written all in lowercase.</p>

<p>In Go, errors are represented by the built-in type <i>error</i>. This type is an interface that defines the behavior of an error, which is any value that can describe itself as a string via an <code>error()</code> receiver.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>type error interface {
<code class="linenos">2 </code>    Error() string
<code class="linenos">3 </code>}
</pre></div>

</figure>


<p>For many use cases, when we don’t need to create custom error types, we’ll simply leverage Go’s built-in packages for handling errors, and we’ll look at how we use those first.</p>

<h3 id="leanpub-auto-error-helpers" class="subsection">8.2.1 Error helpers</h3>

<p>The most commonly used error helper package is <code>errors</code>. This package provides a simple way to create and manipulate errors. It contains helpers for creating errors, checking for errors, and formatting errors. </p>

<p>We can create an error using <code>errors.New(string)</code> this is factory type function for a built-in custom data struct type, <code>errorString</code> which implements the <code>error</code> interface.</p>

<p>We can see what is happening under the hood by inspecting the package. </p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">type</code> <code class="n">errorString</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 2 </code>    <code class="n">s</code> <code class="n">string</code>
<code class="linenos"> 3 </code><code class="p">}</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="k">func</code> <code class="p">(</code><code class="n">e</code> <code class="o">*</code><code class="n">errorString</code><code class="p">)</code> <code class="n">Error</code><code class="p">()</code> <code class="n">string</code> <code class="p">{</code>
<code class="linenos"> 6 </code>    <code class="k">return</code> <code class="n">e</code><code class="o">.</code><code class="n">s</code>
<code class="linenos"> 7 </code><code class="p">}</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="k">func</code> <code class="n">New</code><code class="p">(</code><code class="n">text</code> <code class="n">string</code><code class="p">)</code> <code class="n">error</code> <code class="p">{</code>
<code class="linenos">10 </code>    <code class="k">return</code> <code class="o">&amp;</code><code class="n">errorString</code><code class="p">{</code><code class="n">text</code><code class="p">}</code>
<code class="linenos">11 </code><code class="p">}</code>
</pre></div>

</figure>


<p>In the code snippet, <code>New(string)</code> creates a pointer of type <code>errorString</code>, sets the <code>s</code> field of the type and returns <code>errorString</code> which is an error because it satisfies the <i>error</i> interface.</p>

<p>We can also use <code>fmt.Errorf()</code> to generate formatted errors which include data. Ultimately this implementation also wraps <code>errors.New()</code>.</p>

<h4 id="leanpub-auto-predefined-errors" class="subsubsection">8.2.1.1 Predefined errors</h4>

<p>We can create predefined errors (often referred to as sentinel errors) in our code using either of the above approaches. We can then use the errors package to inspect the type of error returned using <code>errors.Is()</code>.  This gives us options about how we handle different classes of error perhaps based on severity: can we log and proceed or should we halt and return.  Predefined errors are also useful in unit testing when performing assertions.</p>

<p>In Example 79, we use predefined errors to check what kind of error was received.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 79 - Using errors.Is to handle different error values</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"errors"</code>
<code class="linenos"> 5 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">var</code> <code class="n">ErrScoreLessThanMin</code> <code class="o">=</code> <code class="n">errors</code><code class="o">.</code><code class="n">New</code><code class="p">(</code><code class="s2">"score is less than minimum"</code><code class="p">)</code>
<code class="linenos"> 9 </code><code class="n">var</code> <code class="n">ErrScoreOverMax</code> <code class="o">=</code> <code class="n">errors</code><code class="o">.</code><code class="n">New</code><code class="p">(</code><code class="s2">"score is greater than maximum"</code><code class="p">)</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="n">func</code> <code class="n">checkRating</code><code class="p">(</code><code class="n">score</code> <code class="nb">int</code><code class="p">)</code> <code class="p">(</code><code class="nb">int</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">12 </code>	<code class="nb">min</code> <code class="o">:=</code> <code class="mi">0</code>
<code class="linenos">13 </code>	<code class="nb">max</code> <code class="o">:=</code> <code class="mi">5</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code>	<code class="k">if</code> <code class="n">score</code> <code class="o">&lt;</code> <code class="nb">min</code> <code class="p">{</code>
<code class="linenos">16 </code>		<code class="k">return</code> <code class="mi">0</code><code class="p">,</code> <code class="n">ErrScoreLessThanMin</code>
<code class="linenos">17 </code>	<code class="p">}</code>
<code class="linenos">18 </code>	<code class="k">if</code> <code class="n">score</code> <code class="o">&gt;</code> <code class="nb">max</code> <code class="p">{</code>
<code class="linenos">19 </code>		<code class="k">return</code> <code class="mi">0</code><code class="p">,</code> <code class="n">ErrScoreOverMax</code>
<code class="linenos">20 </code>	<code class="p">}</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code>	<code class="k">return</code> <code class="n">score</code><code class="p">,</code> <code class="n">nil</code>
<code class="linenos">23 </code><code class="p">}</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">26 </code>	<code class="n">rating</code><code class="p">,</code> <code class="n">err</code> <code class="o">:=</code> <code class="n">checkRating</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code>
<code class="linenos">27 </code>	<code class="k">if</code> <code class="n">err</code> <code class="o">!=</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos">28 </code>		<code class="n">switch</code> <code class="p">{</code>
<code class="linenos">29 </code>		<code class="n">case</code> <code class="n">errors</code><code class="o">.</code><code class="n">Is</code><code class="p">(</code><code class="n">err</code><code class="p">,</code> <code class="n">ErrScoreLessThanMin</code><code class="p">):</code>
<code class="linenos">30 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"rating score too low"</code><code class="p">)</code>
<code class="linenos">31 </code>		<code class="n">case</code> <code class="n">errors</code><code class="o">.</code><code class="n">Is</code><code class="p">(</code><code class="n">err</code><code class="p">,</code> <code class="n">ErrScoreOverMax</code><code class="p">):</code>
<code class="linenos">32 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"rating score too high"</code><code class="p">)</code>
<code class="linenos">33 </code>		<code class="n">default</code><code class="p">:</code>
<code class="linenos">34 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"unexpected error: </code><code class="si">%s</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">err</code><code class="p">)</code>
<code class="linenos">35 </code>		<code class="p">}</code>
<code class="linenos">36 </code>		<code class="k">return</code>
<code class="linenos">37 </code>	<code class="p">}</code>
<code class="linenos">38 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Rating : </code><code class="si">%d</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">rating</code><code class="p">)</code>
<code class="linenos">39 </code><code class="p">}</code>
<code class="linenos">40 </code>
<code class="linenos">41 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">gb2eikJ9Hp6</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>rating score too low
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<h3 id="leanpub-auto-custom-error-types" class="subsection">8.2.2 Custom error types</h3>

<p>Custom error types allow us to convey more specific information about the error. </p>

<p>To create a custom error type, we need to create a new type that implements the error interface. This can be achieved by simply defining a new type that has an <code>Error() string</code> receiver.</p>

<p>In the example which follows we use a custom struct type for the custom error, the benefit being it allows us to store additional data about the error if we wish: data that is returned with the error and available to inspect by calling code, if desired.</p>

<p>The <code>Error() string</code> receiver is called when the error is converted to a string, which is what the <code>fmt</code> package does when it prints an error.</p>

<p>Once we’ve defined a custom error type, we can use it like any other error type in Go.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 80 - A custom error type</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"time"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="nb">type</code> <code class="n">MyError</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="o">//</code> <code class="n">struct</code> <code class="n">fields</code> <code class="n">here</code><code class="p">,</code> <code class="k">if</code> <code class="nb">any</code>
<code class="linenos">10 </code><code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="n">func</code> <code class="p">(</code><code class="n">e</code> <code class="n">MyError</code><code class="p">)</code> <code class="n">Error</code><code class="p">()</code> <code class="n">string</code> <code class="p">{</code>
<code class="linenos">13 </code>	<code class="k">return</code> <code class="n">fmt</code><code class="o">.</code><code class="n">Sprintf</code><code class="p">(</code><code class="s2">"this is custom error generated at </code><code class="si">%s</code><code class="s2">"</code><code class="p">,</code> <code class="n">time</code><code class="o">.</code><code class="n">Now</code><code class="p">())</code>
<code class="linenos">14 </code><code class="p">}</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="n">func</code> <code class="n">dummyFunctionError</code><code class="p">()</code> <code class="n">error</code> <code class="p">{</code>
<code class="linenos">17 </code>	<code class="k">return</code> <code class="o">&amp;</code><code class="n">MyError</code><code class="p">{}</code>
<code class="linenos">18 </code><code class="p">}</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">21 </code>	<code class="k">if</code> <code class="n">err</code> <code class="o">:=</code> <code class="n">dummyFunctionError</code><code class="p">();</code> <code class="n">err</code> <code class="o">!=</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos">22 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">err</code><code class="p">)</code>
<code class="linenos">23 </code>	<code class="p">}</code>
<code class="linenos">24 </code><code class="p">}</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">x7pZDTqda5O</code>
</pre></div>

</figure>


<p>Output: </p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>this is custom error generated at <code class="m">2009</code>-11-10 <code class="m">23</code>:00:00 +0000 UTC <code class="nv">m</code><code class="o">=</code>+0.000000001
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>In the example, the <code>dummyFunctionError()</code> function returns a custom error type. The caller can then check the error and handle it as needed. If additional fields were set on the error type, they could be inspected or logged.</p>

<h3 id="leanpub-auto-error-wrapping" class="subsection">8.2.3 Error wrapping</h3>

<p>Errors may be wrapped by creating a new error value that includes the original error as part of its message or data. </p>

<p>The <code>fmt.Errorf()</code> function formats a new error message that includes the original error value. The <code>%w</code> format specifier is used to include the original error in the error message.</p>

<p>Wrapping is useful when trying to understand where an error originated in our code.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>wrappedErr := fmt.Errorf("error occurred: %w", err)
</pre></div>

</figure>


<p>Once the error is wrapped, we can use the new error value like any other error in Go. We can also use <code>errors.Unwrap()</code> to unpack a wrapped error message should we need to work with the error values individually, and not as a single value.</p>

<p>Below is an example of wrapping and unwrapping errors in Go. Each <i>wrap</i> includes the function name that returned the error. Note, the program has no purpose other than to generate and wrap errors.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 81 - Error wrapping and unwrapping</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"errors"</code>
<code class="linenos"> 5 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">call3</code><code class="p">()</code> <code class="n">error</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="k">return</code> <code class="n">fmt</code><code class="o">.</code><code class="n">Errorf</code><code class="p">(</code><code class="s2">"call3: this is the original error"</code><code class="p">)</code>
<code class="linenos">10 </code><code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="n">func</code> <code class="n">call2</code><code class="p">()</code> <code class="n">error</code> <code class="p">{</code>
<code class="linenos">13 </code>	<code class="k">if</code> <code class="n">err</code> <code class="o">:=</code> <code class="n">call3</code><code class="p">();</code> <code class="n">err</code> <code class="o">!=</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos">14 </code>		<code class="k">return</code> <code class="n">fmt</code><code class="o">.</code><code class="n">Errorf</code><code class="p">(</code><code class="s2">"call2: %w"</code><code class="p">,</code> <code class="n">err</code><code class="p">)</code>
<code class="linenos">15 </code>	<code class="p">}</code>
<code class="linenos">16 </code>	<code class="k">return</code> <code class="n">nil</code>
<code class="linenos">17 </code><code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="n">func</code> <code class="n">call1</code><code class="p">()</code> <code class="n">error</code> <code class="p">{</code>
<code class="linenos">20 </code>	<code class="k">if</code> <code class="n">err</code> <code class="o">:=</code> <code class="n">call2</code><code class="p">();</code> <code class="n">err</code> <code class="o">!=</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos">21 </code>		<code class="k">return</code> <code class="n">fmt</code><code class="o">.</code><code class="n">Errorf</code><code class="p">(</code><code class="s2">"call1: %w"</code><code class="p">,</code> <code class="n">err</code><code class="p">)</code>
<code class="linenos">22 </code>	<code class="p">}</code>
<code class="linenos">23 </code>	<code class="k">return</code> <code class="n">nil</code>
<code class="linenos">24 </code><code class="p">}</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">27 </code>	<code class="k">if</code> <code class="n">err</code> <code class="o">:=</code> <code class="n">call1</code><code class="p">();</code> <code class="n">err</code> <code class="o">!=</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos">28 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">err</code><code class="p">)</code> <code class="o">//</code> <code class="n">prints</code> <code class="nb">all</code> <code class="n">wrapped</code> <code class="n">errors</code>
<code class="linenos">29 </code>
<code class="linenos">30 </code>		<code class="o">//</code> <code class="n">unwrap</code> <code class="n">the</code> <code class="n">errors</code> <code class="ow">and</code> <code class="nb">print</code>
<code class="linenos">31 </code>		<code class="n">err1</code> <code class="o">:=</code> <code class="n">errors</code><code class="o">.</code><code class="n">Unwrap</code><code class="p">(</code><code class="n">err</code><code class="p">)</code>
<code class="linenos">32 </code>		<code class="n">err2</code> <code class="o">:=</code> <code class="n">errors</code><code class="o">.</code><code class="n">Unwrap</code><code class="p">(</code><code class="n">err1</code><code class="p">)</code>
<code class="linenos">33 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">err1</code><code class="p">)</code>
<code class="linenos">34 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">err2</code><code class="p">)</code>
<code class="linenos">35 </code>	<code class="p">}</code>
<code class="linenos">36 </code><code class="p">}</code>
<code class="linenos">37 </code>
<code class="linenos">38 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">UzPyJIGc1DH</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>call1: call2: call3: this is the original error
<code class="linenos">2 </code>call2: call3: this is the original error
<code class="linenos">3 </code>call3: this is the original error
<code class="linenos">4 </code>
<code class="linenos">5 </code>Program exited.
</pre></div>

</figure>


<h3 id="leanpub-auto-panic-and-recover" class="subsection">8.2.4 Panic and recover</h3>

<p>The <i>panic</i> and <i>recover</i> functions are used in exceptional situations, such as for a runtime error which can’t be handled or following an unexpected event, which makes it unsafe to continue execution of the program in an unknown state.</p>

<p>A <i>panic</i> is caused either by a runtime error or an explicit call to the built-in <code>panic()</code> function, which is called with a single argument, which is the value that describes the <i>panic</i>. This value is typically an error, but it can be any value.</p>

<p><code>recover()</code> is used to recover from a <i>panic</i> and continue with the execution of the program.</p>

<p>When <code>panic()</code> is called, it stops the normal execution of the code and begins unwinding the call stack. It will call any <i>deferred</i> functions and run any clean-up code, such as that for closing open files or releasing resources. </p>

<p>Once the call stack has been completely unwound, the runtime will look for a <code>recover()</code> function. If found, it will be called with the value that was passed to the <code>panic()</code> function. The <code>recover()</code> function will then handle the panic and return a value to continue the normal execution of the program. That return value is the value it was passed via <code>panic()</code>.</p>

<p>If a <code>recover()</code> function is not implemented the program will exit, with a stack trace for debugging.</p>

<p>Below we show an example of using <code>panic()</code> and <code>recover()</code>. </p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 82 - Basic panic and recover</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"errors"</code>
<code class="linenos"> 5 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">dummyFunctionError</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">err</code> <code class="o">:=</code> <code class="n">errors</code><code class="o">.</code><code class="n">New</code><code class="p">(</code><code class="s2">"dummy unhandlable error"</code><code class="p">)</code>
<code class="linenos">10 </code>	<code class="k">if</code> <code class="n">err</code> <code class="o">!=</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos">11 </code>		<code class="n">panic</code><code class="p">(</code><code class="n">err</code><code class="p">)</code>
<code class="linenos">12 </code>	<code class="p">}</code>
<code class="linenos">13 </code><code class="p">}</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">16 </code>	<code class="n">defer</code> <code class="n">func</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">17 </code>		<code class="k">if</code> <code class="n">err</code> <code class="o">:=</code> <code class="n">recover</code><code class="p">();</code> <code class="n">err</code> <code class="o">!=</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos">18 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Recovered from panic:"</code><code class="p">,</code> <code class="n">err</code><code class="p">)</code>
<code class="linenos">19 </code>		<code class="p">}</code>
<code class="linenos">20 </code>	<code class="p">}()</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code>	<code class="n">dummyFunctionError</code><code class="p">()</code>
<code class="linenos">23 </code><code class="p">}</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">9</code><code class="n">vmgVqKTbU5</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Recovered from panic: dummy unhandlable error
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>In the above example, the <code>dummyFunctionError()</code> function panics if an error occurs, an error which we provide. The <code>main()</code> function includes a deferred <code>recover()</code> function which is called when the panic occurs. The <code>recover()</code> function handles the panic and prints a message to indicate that the panic was recovered from.</p>

<aside class="information blurb">
    <p>The <code>recover()</code> function can only be used inside of a deferred function. Using it outside will not affect the panic, which will continue.</p>

</aside>

<p>Finally, try commenting out or deleting lines 16 to 20 to see what happens if the deferred <code>recover()</code> function is not present. You should see the stack trace in the output</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>panic: dummy unhandlable error
<code class="linenos">2 </code>
<code class="linenos">3 </code>goroutine <code class="m">1</code> <code class="o">[</code>running<code class="o">]</code>:
<code class="linenos">4 </code>main.dummyFunctionError<code class="o">(</code>...<code class="o">)</code>
<code class="linenos">5 </code>	/tmp/sandbox1162862492/prog.go:10
<code class="linenos">6 </code>main.main<code class="o">()</code>
<code class="linenos">7 </code>	/tmp/sandbox1162862492/prog.go:16 +0x49
<code class="linenos">8 </code>
<code class="linenos">9 </code>Program exited.
</pre></div>

</figure>


<h2 id="leanpub-auto-logging" class="section">8.3 Logging</h2>

<p>To conclude the chapter we will briefly discuss logging.  Logging refers to the process of recording events or messages that happen during program flow, usually to provide debug or state information.</p>

<h3 id="leanpub-auto-log-package" class="subsection">8.3.1 Log package</h3>

<p>As a part of its standard library, Go implements a <code>log</code> package which offers several functions for logging messages, such as <code>Println()</code>, <code>Printf()</code>, and <code>Fatal()</code>.</p>

<p>We’ve already seen the <code>log</code> package when we looked at import aliasing in an earlier section but, to recap, it’s very simple to implement logging in Go.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="kn">import</code> <code class="s2">"log"</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">6 </code>    <code class="n">log</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Hello world!"</code><code class="p">)</code>
<code class="linenos">7 </code><code class="p">}</code>
</pre></div>

</figure>


<p>When run, the above program prints the message to <i>Stdout</i>.</p>

<p>The <code>log</code> package provides a simple and convenient way to add logging to our program, and for many use cases, we won’t need anything else.</p>

<p>However, there are some limitations with Go’s logging implementation when compared with other languages. For example, the <code>log</code> package does not support severity levels such as <i>info</i>, <i>warn</i> and <i>error</i>.</p>

<h3 id="leanpub-auto-custom-logger" class="subsection">8.3.2 Custom logger</h3>

<p>If we need more than the standard library can offer, we can create a custom <i>Logger</i>. This enables us to customize the way log messages are handled. Alternatively, we can use one of the available third-party logging packages, which themselves are implementations of a custom <i>Logger</i>.</p>

<p>We might choose to create a custom <i>Logger</i> if we need to direct output to a destination other than Stdout - a file for example - or, if we need more control over the formatting of logged message output.</p>

<aside class="information blurb">
    <p>Note that we don’t <i>need</i> to create a custom <i>Logger</i> in order to direct output to a different target. We can instead use the <code>log</code> package’s <code>SetOutput()</code> function to direct logs to any target which implements the <code>io.Writer</code> interface.</p>

</aside>

<p>To create a custom <code>Logger</code> we use the <code>New()</code> function, which returns a pointer to a <code>Logger</code> struct value. We need to pass an <code>io.writer</code> for the log target, a prefix <code>string</code> and, some flag arguments as part of the setup.</p>

<p>Many of the functions such as <code>Println()</code>,<code>Printf()</code>, and <code>Fatal()</code> are also implemented as receivers on the <code>Logger</code> struct, so we can use them on the custom <i>Logger</i> too. These might be enough for our needs.</p>

<p>But, we can override these default implementations, as well as create new receivers, by embedding the standard library <code>Logger</code> in a custom struct type.</p>

<p>Below is a very basic example of how we’d embed the standard library <code>Logger</code> in our logger struct, so by promoting its fields and receivers.  We override the default <code>Println</code> implementation with our own, allowing us to set a log level and format the output differently.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 83 - Embedding log.Logger to augment its features</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"log"</code>
<code class="linenos"> 6 </code>	<code class="s2">"os"</code>
<code class="linenos"> 7 </code><code class="p">)</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="nb">type</code> <code class="n">myWrappedLogger</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="o">*</code><code class="n">log</code><code class="o">.</code><code class="n">Logger</code>
<code class="linenos">11 </code>	<code class="n">level</code> <code class="n">string</code>
<code class="linenos">12 </code><code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="n">func</code> <code class="p">(</code><code class="n">ml</code> <code class="o">*</code><code class="n">myWrappedLogger</code><code class="p">)</code> <code class="n">Println</code><code class="p">(</code><code class="n">level</code> <code class="n">string</code><code class="p">,</code> <code class="n">v</code> <code class="o">...</code><code class="n">any</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">15 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Fancy Logger"</code><code class="p">)</code>
<code class="linenos">16 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"------------"</code><code class="p">)</code>
<code class="linenos">17 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Level: </code><code class="si">%s</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">level</code><code class="p">)</code>
<code class="linenos">18 </code>	<code class="n">ml</code><code class="o">.</code><code class="n">Output</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="n">fmt</code><code class="o">.</code><code class="n">Sprintln</code><code class="p">(</code><code class="n">v</code><code class="o">...</code><code class="p">))</code>
<code class="linenos">19 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"------------"</code><code class="p">)</code>
<code class="linenos">20 </code><code class="p">}</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">23 </code>	<code class="n">mwl</code> <code class="o">:=</code> <code class="n">myWrappedLogger</code><code class="p">{</code><code class="n">log</code><code class="o">.</code><code class="n">New</code><code class="p">(</code><code class="n">os</code><code class="o">.</code><code class="n">Stdout</code><code class="p">,</code> <code class="s2">"LogPrefix: "</code><code class="p">,</code> <code class="n">log</code><code class="o">.</code><code class="n">LstdFlags</code><code class="p">),</code> <code class="s2">""</code><code class="p">}</code>
<code class="linenos">24 </code>	<code class="n">mwl</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"error"</code><code class="p">,</code> <code class="s2">"this is the log output"</code><code class="p">)</code>
<code class="linenos">25 </code><code class="p">}</code>
<code class="linenos">26 </code>
<code class="linenos">27 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">ca17kF91BtL</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Fancy Logger
<code class="linenos">2 </code>------------
<code class="linenos">3 </code>Level: error
<code class="linenos">4 </code>LogPrefix: <code class="m">2009</code>/11/10 <code class="m">23</code>:00:00 this is the log output
<code class="linenos">5 </code>------------
<code class="linenos">6 </code>
<code class="linenos">7 </code>Program exited.
</pre></div>

</figure>


<p>Custom loggers provide a flexible and powerful way to handle logging. We can use them to log messages to a variety of different destinations, and to customize the format of log messages to suit any need.</p>


<h1 id="leanpub-auto-chapter-9---digging-deeper" class="chapter">Chapter 9 - Digging deeper</h1>

<p>Now that we have a good grasp of Go fundamentals, next we will delve deeper into the language and explore more advanced concepts. We’ll expand upon previously covered topics and introduce new techniques such as assertion, reflection, and Go’s new generics implementation, tools which should enhance our abilities as Go programmers.</p>

<h2 id="leanpub-auto-developing-with-functions" class="section">9.1 Developing with functions</h2>

<p>We’ve used functions a few times already. We’ve called functions from standard library packages such as <code>log</code> and <code>fmt</code> and we’ve also created functions in the examples ourselves.</p>

<p>Next, we’ll focus on some of the less common aspects of functions in programming languages, features which we do have in Go. Specifically, we’ll focus on function signatures including variadic arguments, and return styles, including multiple returns.</p>

<aside class="information blurb">
    <p>Note, that what we cover here, is equally applicable when working with <i>receivers</i>.</p>

</aside>

<h3 id="leanpub-auto-function-parameters" class="subsection">9.1.1 Function parameters</h3>

<p>Functions often accept values passed to satisfy parameters in the function signature. </p>

<p>In Go, when defining function parameters we need to specify both the variable name and its type.  To shorten the signature somewhat we can group parameters of the same type if it makes sense to do so, and it <b>isn’t</b> detrimental to the API.</p>

<p>The snippets below show ungrouped and grouped parameters.  See how in this case, grouping makes the ordering less intuitive.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">//</code> <code class="n">ungrouped</code> <code class="n">parameters</code>
<code class="linenos"> 2 </code><code class="k">func</code> <code class="n">normalParams</code><code class="p">(</code><code class="n">name</code> <code class="n">string</code><code class="p">,</code> <code class="n">age</code> <code class="nb nb-Type">int</code><code class="p">,</code> <code class="n">houseNumber</code> <code class="nb nb-Type">int</code><code class="p">,</code> <code class="n">address1</code> <code class="n">string</code><code class="p">,</code> <code class="n">address2</code> <code class="n">s</code>\
<code class="linenos"> 3 </code><code class="n">tring</code><code class="p">){</code>
<code class="linenos"> 4 </code>    <code class="o">...</code>
<code class="linenos"> 5 </code><code class="p">}</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="o">//</code> <code class="n">grouped</code> <code class="n">parameters</code><code class="p">,</code> <code class="n">which</code> <code class="n">makes</code> <code class="n">the</code> <code class="n">API</code> <code class="n">a</code> <code class="n">bit</code> <code class="n">awkward</code> <code class="ow">in</code> <code class="n">this</code> <code class="n">example</code>
<code class="linenos"> 8 </code><code class="k">func</code> <code class="n">groupedParams</code><code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="n">address1</code><code class="p">,</code> <code class="n">address2</code> <code class="n">string</code><code class="p">,</code> <code class="n">houseNumber</code><code class="p">,</code> <code class="n">age</code> <code class="nb nb-Type">int</code><code class="p">){</code>
<code class="linenos"> 9 </code>    <code class="o">...</code>
<code class="linenos">10 </code><code class="p">}</code>
</pre></div>

</figure>


<p>Long function signatures can also be split with line breaks to improve readability. No escape character is needed when doing so.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">//</code> <code class="n">split</code> <code class="n">over</code> <code class="n">lines</code>
<code class="linenos"> 2 </code><code class="k">func</code> <code class="n">normalParams</code><code class="p">(</code>
<code class="linenos"> 3 </code>	<code class="n">name</code> <code class="n">string</code><code class="p">,</code> 
<code class="linenos"> 4 </code>	<code class="n">age</code> <code class="nb nb-Type">int</code><code class="p">,</code>
<code class="linenos"> 5 </code>	<code class="n">houseNumber</code> <code class="nb nb-Type">int</code><code class="p">,</code> 
<code class="linenos"> 6 </code>	<code class="n">address1</code> <code class="n">string</code><code class="p">,</code> 
<code class="linenos"> 7 </code>	<code class="n">address2</code> <code class="n">string</code><code class="p">,</code>
<code class="linenos"> 8 </code>	<code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="k">return</code>
<code class="linenos">10 </code><code class="p">}</code>
</pre></div>

</figure>


<aside class="information blurb">
    <p>Note the trailing comma which is required when the parameters (or arguments) are separated in this manner.</p>

</aside>

<h3 id="leanpub-auto-variadic-arguments" class="subsection">9.1.2 Variadic arguments</h3>

<p>Go functions can accept variadic arguments. A variadic argument comprises one or more values which are supplied to a single function parameter, building a slice of those values for use within the function body.</p>

<p>There can be only one variadic parameter in each function signature and it must be the last parameter.  It is also optional, so we can omit the argument if we wish.</p>

<p>A parameter which accepts variadic arguments is denoted by the <i>spread</i> operator, which precedes its type e.g. <code>...string</code>.</p>

<p>Within the function body, we will need to inspect the slice length to determine if one, multiple or no values were passed to the variadic parameter, and then handle those values accordingly.</p>

<p>Let’s demonstrate with an example function which includes a variadic parameter, in which we call the function four different ways to demonstrate its flexibility.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 84 - Passing values as variadic arguments</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">myVariadicFunc</code><code class="p">(</code><code class="n">name</code> <code class="n">string</code><code class="p">,</code> <code class="n">address</code> <code class="o">...</code><code class="n">string</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Hello </code><code class="si">%s</code><code class="s2">!</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">name</code><code class="p">)</code>
<code class="linenos"> 7 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Addresses:"</code><code class="p">)</code>
<code class="linenos"> 8 </code>	<code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="n">address</code><code class="p">)</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="p">{</code>
<code class="linenos"> 9 </code>		<code class="k">for</code> <code class="n">i</code><code class="p">,</code> <code class="n">addr</code> <code class="o">:=</code> <code class="nb">range</code> <code class="n">address</code> <code class="p">{</code>
<code class="linenos">10 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"</code><code class="si">%d</code><code class="s2">: </code><code class="si">%s</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">i</code><code class="o">+</code><code class="mi">1</code><code class="p">,</code> <code class="n">addr</code><code class="p">)</code>
<code class="linenos">11 </code>		<code class="p">}</code>
<code class="linenos">12 </code>	<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="linenos">13 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"No address data supplied"</code><code class="p">)</code>
<code class="linenos">14 </code>	<code class="p">}</code>
<code class="linenos">15 </code><code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">18 </code>	<code class="o">//</code> <code class="n">single</code> <code class="n">argument</code>
<code class="linenos">19 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Single Argument"</code><code class="p">)</code>
<code class="linenos">20 </code>	<code class="n">myVariadicFunc</code><code class="p">(</code><code class="s2">"Joe Bloggs"</code><code class="p">,</code> <code class="s2">"Address 1"</code><code class="p">)</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code>	<code class="o">//</code> <code class="n">multiple</code> <code class="n">arguments</code>
<code class="linenos">23 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"</code><code class="se">\n</code><code class="s2">Multiple Arguments"</code><code class="p">)</code>
<code class="linenos">24 </code>	<code class="n">myVariadicFunc</code><code class="p">(</code><code class="s2">"Joe Bloggs"</code><code class="p">,</code> <code class="s2">"Address 1"</code><code class="p">,</code> <code class="s2">"Address 2"</code><code class="p">,</code> <code class="s2">"Address 3"</code><code class="p">)</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code>	<code class="o">//</code> <code class="n">no</code> <code class="n">argument</code>
<code class="linenos">27 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"</code><code class="se">\n</code><code class="s2">No argument"</code><code class="p">)</code>
<code class="linenos">28 </code>	<code class="n">myVariadicFunc</code><code class="p">(</code><code class="s2">"Joe Bloggs"</code><code class="p">)</code>
<code class="linenos">29 </code>
<code class="linenos">30 </code>	<code class="o">//</code> <code class="n">passing</code> <code class="n">a</code> <code class="n">pre</code><code class="o">-</code><code class="n">built</code> <code class="nb">slice</code><code class="p">,</code> <code class="n">note</code> <code class="n">the</code> <code class="n">trailing</code> <code class="n">spread</code> <code class="n">operator</code>
<code class="linenos">31 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"</code><code class="se">\n</code><code class="s2">Passing a slice as a variadic argument"</code><code class="p">)</code>
<code class="linenos">32 </code>	<code class="n">addresses</code> <code class="o">:=</code> <code class="p">[]</code><code class="n">string</code><code class="p">{</code><code class="s2">"Address 1"</code><code class="p">,</code> <code class="s2">"Address 2"</code><code class="p">}</code>
<code class="linenos">33 </code>	<code class="n">myVariadicFunc</code><code class="p">(</code><code class="s2">"Joe Bloggs"</code><code class="p">,</code> <code class="n">addresses</code><code class="o">...</code><code class="p">)</code>
<code class="linenos">34 </code><code class="p">}</code>
<code class="linenos">35 </code>
<code class="linenos">36 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">NPutwf2aF4l</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code>Single Argument
<code class="linenos"> 2 </code>Hello Joe Bloggs!
<code class="linenos"> 3 </code>Addresses:
<code class="linenos"> 4 </code><code class="m">1</code>: Address <code class="m">1</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code>Multiple Arguments
<code class="linenos"> 7 </code>Hello Joe Bloggs!
<code class="linenos"> 8 </code>Addresses:
<code class="linenos"> 9 </code><code class="m">1</code>: Address <code class="m">1</code>
<code class="linenos">10 </code><code class="m">2</code>: Address <code class="m">2</code>
<code class="linenos">11 </code><code class="m">3</code>: Address <code class="m">3</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>No argument
<code class="linenos">14 </code>Hello Joe Bloggs!
<code class="linenos">15 </code>Addresses:
<code class="linenos">16 </code>No address data supplied
<code class="linenos">17 </code>
<code class="linenos">18 </code>Passing a slice as a variadic argument
<code class="linenos">19 </code>Hello Joe Bloggs!
<code class="linenos">20 </code>Addresses:
<code class="linenos">21 </code><code class="m">1</code>: Address <code class="m">1</code>
<code class="linenos">22 </code><code class="m">2</code>: Address <code class="m">2</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code>Program exited.
</pre></div>

</figure>


<h3 id="leanpub-auto-multiple-return-values" class="subsection">9.1.3 Multiple return values</h3>

<p>Another feature not present in many other programming languages is support for multiple function return values. </p>

<p>Typically, we’ll take advantage of this by using two return values in our functions, usually to pass an error value, or boolean value (to denote success or failure), in addition to the value we are interested in. </p>

<p>While the flexibilty to return more than two values <i>is</i> often useful, there’s a balance to be found. If the number of values we want from a function goes beyond three, it could mean our API would benefit from having those values as fields on a struct, or keys in a map. This way we could use a single value to return virtually unlimited data without complicating our codebase. It’s also much easier to maintain.</p>

<aside class="information blurb">
    <p>I used three as the <i>standard</i> since I couldn’t find a function in the Go standard library with more than three return values. Of course, there are no hard rules here, but, as Go developers, we should always consider the readability of our code.</p>

</aside>

<p>When using multiple returns we must comma delimit them and enclose the group in brackets. For example, here is the signature for <code>Split()</code> from the standard library <i>strings</i> package.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="k">func</code> <code class="n">Split</code><code class="p">(</code><code class="n">s</code><code class="p">,</code> <code class="n">sep</code> <code class="n">string</code><code class="p">)</code> <code class="p">(</code><code class="n">string</code><code class="p">,</code> <code class="n">string</code><code class="p">,</code> <code class="nb nb-Type">bool</code><code class="p">){}</code>
</pre></div>

</figure>


<h3 id="leanpub-auto-function-return-styles" class="subsection">9.1.4 Function return styles</h3>

<p>Functions can use <i>either</i> of two return styles, <i>Anonymous</i> or <i>Named</i> return parameters.  We can’t mix styles within the same function.</p>

<p>We saw an example of anonymous return parameters just above in the <code>Split()</code> function signature. That same signature using named return parameters could look like this.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="k">func</code> <code class="n">Split</code><code class="p">(</code><code class="n">s</code><code class="p">,</code> <code class="n">sep</code> <code class="n">string</code><code class="p">)</code> <code class="p">(</code><code class="n">param1</code><code class="p">,</code> <code class="n">param2</code> <code class="n">string</code><code class="p">,</code> <code class="n">param3</code> <code class="nb nb-Type">bool</code><code class="p">){}</code>
</pre></div>

</figure>


<p>When using named return parameters, there is no need to return the parameters explicitly. A simple <code>return</code> statemement, referred to as a <i>naked</i> return, is sufficient.  Note also that we don’t need to declare the variables explicitly in the function body, in the same way that we don’t need to declared the input parameters in the function body. The return body of the function, performs the declaration and intialisation.</p>

<p>An example will make this much clearer.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 85 - Anonymous and named return parameters</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">anonymousReturns</code><code class="p">(</code><code class="n">firstname</code><code class="p">,</code> <code class="n">lastname</code> <code class="n">string</code><code class="p">)</code> <code class="n">string</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="k">return</code> <code class="n">fmt</code><code class="o">.</code><code class="n">Sprintf</code><code class="p">(</code><code class="s2">"</code><code class="si">%s</code><code class="s2"> </code><code class="si">%s</code><code class="s2">"</code><code class="p">,</code> <code class="n">firstname</code><code class="p">,</code> <code class="n">lastname</code><code class="p">)</code>
<code class="linenos"> 9 </code><code class="p">}</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="n">func</code> <code class="n">namedReturns</code><code class="p">(</code><code class="n">firstname</code><code class="p">,</code> <code class="n">lastname</code> <code class="n">string</code><code class="p">)</code> <code class="p">(</code><code class="n">fullname</code> <code class="n">string</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">12 </code>	<code class="n">fullname</code> <code class="o">=</code> <code class="n">fmt</code><code class="o">.</code><code class="n">Sprintf</code><code class="p">(</code><code class="s2">"</code><code class="si">%s</code><code class="s2"> </code><code class="si">%s</code><code class="s2">"</code><code class="p">,</code> <code class="n">firstname</code><code class="p">,</code> <code class="n">lastname</code><code class="p">)</code>
<code class="linenos">13 </code>	<code class="k">return</code>
<code class="linenos">14 </code><code class="p">}</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">17 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">anonymousReturns</code><code class="p">(</code><code class="s2">"Joe"</code><code class="p">,</code> <code class="s2">"Bloggs"</code><code class="p">))</code>
<code class="linenos">18 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">namedReturns</code><code class="p">(</code><code class="s2">"Joe"</code><code class="p">,</code> <code class="s2">"Bloggs"</code><code class="p">))</code>
<code class="linenos">19 </code><code class="p">}</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">RdVlD9CwJS4</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Joe Bloggs
<code class="linenos">2 </code>Joe Bloggs
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<p>We have two simple functions, the first uses anonymous return parameters in the signature, the style we’ve used in all the examples up to this point.</p>

<p>The second function employs named return parameters.  Observe the <i>naked</i> return statement. Observe also, that we make an assignment to <code>fullname</code>, we’re not actually declaring it.  Try replacing the <code>=</code> with the shortform to declare/initialise it <code>:=</code> then run the example again.</p>

<p>The compiler complains that there are no new variables, since <code>fullname</code> was declared in the function signature.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>./prog.go:12:11: no new variables on left side of :<code class="o">=</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Go build failed.
</pre></div>

</figure>


<p>The style you choose to adopt is largely a matter of preference.  For larger functions with multiple return values, one can argue that named return parameters make the function body less clear and harder to read.</p>

<p>The counter to that is that the function signature itself is much more explicit. Developers have a clearer idea of what a function will give them back when named returns are used. With anonymous return parameters, the developer is presented with a list of types and they will need to inspect the function body to ascertain the usefulness of the values returned for those types.</p>

<p>The other consideration is the potential for bugs and confusion.</p>

<p>Because named return parameters are declared in the signature, and because they are initialised to their zero value, they satisfy the function return automatically even if they are never assigned.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 86 - Bug risk or not?</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">anonymousReturns</code><code class="p">()</code> <code class="p">(</code><code class="n">string</code><code class="p">,</code> <code class="n">string</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="n">var</code> <code class="n">firstname</code><code class="p">,</code> <code class="n">lastname</code> <code class="n">string</code> <code class="o">//</code> <code class="n">we</code> <code class="n">had</code> <code class="n">to</code> <code class="n">declare</code> <code class="n">lastname</code>
<code class="linenos"> 9 </code>	<code class="n">firstname</code> <code class="o">=</code> <code class="s2">"Joe"</code>
<code class="linenos">10 </code>	<code class="k">return</code> <code class="n">firstname</code><code class="p">,</code> <code class="n">lastname</code> <code class="o">//</code> <code class="n">we</code> <code class="n">had</code> <code class="n">to</code> <code class="k">return</code> <code class="n">lastname</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="n">func</code> <code class="n">namedReturns</code><code class="p">()</code> <code class="p">(</code><code class="n">firstname</code><code class="p">,</code> <code class="n">lastname</code> <code class="n">string</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">14 </code>	<code class="n">firstname</code> <code class="o">=</code> <code class="s2">"Joe"</code>
<code class="linenos">15 </code>	<code class="k">return</code> <code class="o">//</code> <code class="n">did</code> <code class="n">we</code> <code class="n">forget</code> <code class="n">the</code> <code class="n">signature</code> <code class="n">also</code> <code class="n">includes</code> <code class="err">`</code><code class="n">lastname</code><code class="err">`?</code>
<code class="linenos">16 </code><code class="p">}</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">19 </code>	<code class="n">mask</code> <code class="o">:=</code> <code class="s2">"firstname: '</code><code class="si">%s</code><code class="s2">', lastname: '</code><code class="si">%s</code><code class="s2">'</code><code class="se">\n</code><code class="s2">"</code>
<code class="linenos">20 </code>	<code class="n">f1</code><code class="p">,</code> <code class="n">l1</code> <code class="o">:=</code> <code class="n">anonymousReturns</code><code class="p">()</code>
<code class="linenos">21 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="n">mask</code><code class="p">,</code> <code class="n">f1</code><code class="p">,</code> <code class="n">l1</code><code class="p">)</code>
<code class="linenos">22 </code>	<code class="n">f2</code><code class="p">,</code> <code class="n">l2</code> <code class="o">:=</code> <code class="n">namedReturns</code><code class="p">()</code>
<code class="linenos">23 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="n">mask</code><code class="p">,</code> <code class="n">f2</code><code class="p">,</code> <code class="n">l2</code><code class="p">)</code>
<code class="linenos">24 </code><code class="p">}</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">gHxfLdGgTaX</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>firstname: <code class="s1">'Joe'</code>, lastname: <code class="s1">''</code>
<code class="linenos">2 </code>firstname: <code class="s1">'Joe'</code>, lastname: <code class="s1">''</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<p>Compare the two functions in previous example.  In the first, the <code>lastname</code> variable must be explictly created and explicitly returned by us. Yes, it could still be its zero value, but that would be down to us, it would be our mistake.</p>

<p>But, in the second function, we’ve not made an assignment either, and we don’t mention the <code>lastname</code> variable at all, not even in a comment, and nor does the naked return.</p>

<p>But, <code>lastname</code> is returned as its zero value and passed back up the call stack. That could well be ok, something we plan to come back to, but we might not have intended to do this. What if we’ve forgotten we added it to the function signature in the first place?</p>

<aside class="information blurb">
    <p>Edge case? Yes, probably, but that’s a mistake I’ve made myself. It’s especially easy to make when the function body is large, so the function signature isn’t in view to remind us. I’d suggest taking care when using named returns.  For most usecases anonymous return parameters will be a better choice, but that’s only <i>in my opinion</i>.</p>

</aside>

<h3 id="leanpub-auto-functions-are-a-type" class="subsection">9.1.5 Functions are a type</h3>

<p>Functions are themselves a type. Values of the type can be created and used just like any Go type. This means functions can be assigned to variables, passed as arguments to other functions, and returned as values from functions.</p>

<p>We call functions which accept and return other functions, <i>higher-order functions</i> and they offer a high degree of flexibility in how we arrange our code. Functions which accept other functions are also known as <i>callbacks</i>.</p>

<p>The example below shows a simple callback type function, we can implement as many different formatting functions as we wish. Providing they are of the type, of <code>func(string)string</code>, we can use them in <code>Formatter()</code>.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 87 - Callback style functions</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"strings"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="o">//</code> <code class="n">Formatter</code> <code class="n">accepts</code> <code class="nb">any</code> <code class="n">func</code> <code class="n">of</code> <code class="nb">type</code> <code class="n">func</code> <code class="p">(</code><code class="n">string</code><code class="p">)</code> <code class="n">string</code>
<code class="linenos"> 9 </code><code class="n">func</code> <code class="n">Formatter</code><code class="p">(</code><code class="nb">str</code> <code class="n">string</code><code class="p">,</code> <code class="nb">format</code> <code class="n">func</code><code class="p">(</code><code class="ow">in</code> <code class="n">string</code><code class="p">)</code> <code class="n">string</code><code class="p">)</code> <code class="n">string</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="k">return</code> <code class="nb">format</code><code class="p">(</code><code class="nb">str</code><code class="p">)</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">14 </code>	<code class="n">upper</code> <code class="o">:=</code> <code class="n">func</code><code class="p">(</code><code class="ow">in</code> <code class="n">string</code><code class="p">)</code> <code class="n">string</code> <code class="p">{</code>
<code class="linenos">15 </code>		<code class="k">return</code> <code class="n">strings</code><code class="o">.</code><code class="n">ToUpper</code><code class="p">(</code><code class="ow">in</code><code class="p">)</code>
<code class="linenos">16 </code>	<code class="p">}</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code>	<code class="n">lower</code> <code class="o">:=</code> <code class="n">func</code><code class="p">(</code><code class="ow">in</code> <code class="n">string</code><code class="p">)</code> <code class="n">string</code> <code class="p">{</code>
<code class="linenos">19 </code>		<code class="k">return</code> <code class="n">strings</code><code class="o">.</code><code class="n">ToLower</code><code class="p">(</code><code class="ow">in</code><code class="p">)</code>
<code class="linenos">20 </code>	<code class="p">}</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code>	<code class="n">myText</code> <code class="o">:=</code> <code class="s2">"SomE rANDOm text TO foRmat"</code>
<code class="linenos">23 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">Formatter</code><code class="p">(</code><code class="n">myText</code><code class="p">,</code> <code class="n">upper</code><code class="p">))</code>
<code class="linenos">24 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">Formatter</code><code class="p">(</code><code class="n">myText</code><code class="p">,</code> <code class="n">lower</code><code class="p">))</code>
<code class="linenos">25 </code><code class="p">}</code>
<code class="linenos">26 </code>
<code class="linenos">27 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">KXSxlwcWJB4</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>SOME RANDOM TEXT TO FORMAT
<code class="linenos">2 </code>some random text to format
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<p>We should also mention <i>closures</i>. A <i>closure</i> is a function that remembers the values of the variables from the place where it was created, as if it was bound to them. Nothing here is unique to Go, but closures can be useful when we want to use a function in a different place, but we still want it to have access to the variables it needs.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 88 - Closure functions</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">x</code> <code class="o">:=</code> <code class="mi">10</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code>	<code class="n">increment</code> <code class="o">:=</code> <code class="n">func</code><code class="p">()</code> <code class="nb">int</code> <code class="p">{</code>
<code class="linenos"> 9 </code>		<code class="n">x</code><code class="o">++</code>
<code class="linenos">10 </code>		<code class="k">return</code> <code class="n">x</code>
<code class="linenos">11 </code>	<code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">increment</code><code class="p">())</code> <code class="o">//</code> <code class="n">prints</code> <code class="mi">11</code>
<code class="linenos">14 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">increment</code><code class="p">())</code> <code class="o">//</code> <code class="n">prints</code> <code class="mi">12</code>
<code class="linenos">15 </code><code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">x8XnvAM6O9C</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="m">11</code>
<code class="linenos">2 </code><code class="m">12</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<p>Observe, in the example above, that the <code>increment</code> function has access to the <code>x</code> variable even though it is defined outside of the function. This is possible because <code>increment</code> is a closure.</p>

<h3 id="leanpub-auto-pointer-or-value-returns" class="subsection">9.1.5 Pointer or value returns</h3>

<p>When writing functions, we need to decide whether to return values or pointers. The decision can have an impact on both memory use and how memory is managed. This shouldn’t be an initial consideration, as always we should prioritise correctness and maintainability until we can verify we have some performance issues.</p>

<p>The choice between returning a value or a pointer from a function should depend on the intended use case. If we want to create a single value of something in a function and share it throughout our program, we should return a pointer to that value. On the other hand, if we only need to use the value within the function and do not need to mutate anything we share up the call stack, it may be more efficient to return a copy of the value instead of a pointer.</p>

<p>A good example of when it is beneficial to return a pointer is when creating a database connection. By returning a pointer, multiple parts of the program can use the same connection simultaneously, rather than each part creating its own connection. This can help to improve the efficiency of the program by reducing the number of connections that need to be created and managed.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 89 - Pointer return for database connection</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nb">type</code> <code class="n">Database</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">ConnString</code> <code class="n">string</code>
<code class="linenos"> 7 </code><code class="p">}</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="o">//</code> <code class="n">NewDatabase</code> <code class="ow">is</code> <code class="n">a</code> <code class="n">naive</code> <code class="n">factory</code> <code class="n">to</code> <code class="n">create</code> <code class="n">a</code> <code class="n">database</code> <code class="n">connection</code>
<code class="linenos">10 </code><code class="o">//</code> <code class="n">it</code> <code class="n">returns</code> <code class="n">a</code> <code class="n">pointer</code> <code class="n">to</code> <code class="n">share</code> <code class="n">the</code> <code class="n">address</code> <code class="n">of</code> <code class="n">the</code> <code class="n">connection</code> <code class="n">info</code>
<code class="linenos">11 </code><code class="n">func</code> <code class="n">NewDatabase</code><code class="p">(</code><code class="n">server</code><code class="p">,</code> <code class="n">username</code><code class="p">,</code> <code class="n">password</code> <code class="n">string</code><code class="p">)</code> <code class="o">*</code><code class="n">Database</code> <code class="p">{</code>
<code class="linenos">12 </code>	<code class="k">if</code> <code class="n">db</code> <code class="o">!=</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos">13 </code>		<code class="k">return</code> <code class="n">db</code>
<code class="linenos">14 </code>	<code class="p">}</code>
<code class="linenos">15 </code>	<code class="n">connString</code> <code class="o">:=</code> <code class="n">fmt</code><code class="o">.</code><code class="n">Sprintf</code><code class="p">(</code><code class="s2">"</code><code class="si">%s</code><code class="s2">@</code><code class="si">%s</code><code class="s2">:</code><code class="si">%s</code><code class="s2">"</code><code class="p">,</code> <code class="n">username</code><code class="p">,</code> <code class="n">server</code><code class="p">,</code> <code class="n">password</code><code class="p">)</code>
<code class="linenos">16 </code>	<code class="k">return</code> <code class="o">&amp;</code><code class="n">Database</code><code class="p">{</code><code class="n">connString</code><code class="p">}</code>
<code class="linenos">17 </code><code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="n">var</code> <code class="n">db</code> <code class="o">*</code><code class="n">Database</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">22 </code>	<code class="n">db</code> <code class="o">=</code> <code class="n">NewDatabase</code><code class="p">(</code><code class="s2">"localhost"</code><code class="p">,</code> <code class="s2">"joeblogs"</code><code class="p">,</code> <code class="s2">"password"</code><code class="p">)</code>
<code class="linenos">23 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Connection String: %+v</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">db</code><code class="p">)</code>
<code class="linenos">24 </code><code class="p">}</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">0</code><code class="n">afFBh0GaFG</code>
</pre></div>

</figure>


<p>Generally, returning a pointer forces the compiler to allocate that variable to slower memory, and we’ll talk more about this in the next section on <i>memory management</i>.</p>

<h2 id="leanpub-auto-memory-management" class="section">9.2 Memory management</h2>

<p>Go performs memory management on our behalf. The compiler chooses where to put the values our program creates - on either the <i>stack</i> or the <i>heap</i> - when compiling our program, and the garbage collector manages heap memory during program execution.</p>

<p>The <i>stack</i> is a region of memory used for storing local variables and function parameters. The total size of the stack is limited in size but stack memory offers fast access. Each function call or goroutine starts with an initial stack of 2KB dedicated to it. This may be grown as required. </p>

<p>The <i>heap</i> is a region of memory used for dynamically-allocated objects at runtime, or variables the compiler decides to put there and not on the stack. Heap memory is shared and not bound to any one function. There’s more heap memory available than stack memory, but it’s also slower to access. The process of garbage collection on the heap adds further overhead.</p>

<p>We refer to variables placed on the heap as <i>allocations</i>. As a rule of thumb, the fewer allocations our programs make, the better. An allocation represents data in slower access memory, which has to be cleaned up by the garbage collector.</p>

<aside class="information blurb">
    <p>It is not our intention to eliminate allocations. That’s often impossible. For example, the simple act of printing using <code>fmt.Println()</code> may create allocations. The compiler treats this function from the standard library, like any custom function. If it cannot be sure what the function does with the argument it receives, it cannot determine the lifetime of the value. Contrast that with the Go’s built-in <code>println()</code> function. The compiler <i>always</i> knows that <code>println()</code> does nothing else with the passed argument, so can leave the data on the stack, and no allocations are made.</p>

</aside>

<p>The goal is to minimise allocations, especially in functions that are called frequently. Indeed the compiler will make many optimisations at compilation time, one of which is <i>inlining</i>, where code in function bodies is pulled into the main function eliminating calls and returns, and in many cases reducing allocations in the process.</p>

<p>The compiler uses a process known as <i>escape analysis</i> to determine what can be <i>inlined</i>, it uses the same process to determine whether a value can sit on the stack or must be placed on the heap. The compiler will make an allocation for multiple reasons. Wherever an address is shared, rather than a copy of the value, the compiler will make an allocation if it cannot be certain it is not used beyond the scope of the current function’s lifetime. </p>

<p>As a <i>general</i> rule passing values around rather than pointers allows us to reduce allocations.</p>

<p>We can observe the escape analysis performed by the compiler, and we’ll do this shortly.</p>

<h3 id="leanpub-auto-garbage-collection" class="subsection">9.2.3 Garbage collection</h3>

<p>Heap memory management is the responsibility of the garbage collector which will deallocate memory when it can no longer find any references to it. The garbage collector is packaged with every Go program.</p>

<p>At runtime, the garbage collection process has a cost. Known as the GC pause, historically it was a <i>stop-the-world</i> type operation in which all goroutines were paused while heap memory was deallocated. In most applications this pause was imperceptible, but in high-throughput, high-performance applications it could cause performance issues such as bottlenecks and throttling.</p>

<p>In modern versions of Go, the garbage collection process is more sophisticated, it does not need to suspend all goroutines at the same time and generally completes much faster.</p>

<h3 id="leanpub-auto-observing-compiler-escape-analysis" class="subsection">9.2.4 Observing compiler escape analysis</h3>

<p>So, we have some basic criteria which may indicate when the compiler will use the heap and not the stack, but, the fact is, we will not be able to read a complex piece of code and reliably determine which type of memory will be chosen and how many allocations will result.</p>

<p>Furthermore, the algorithm, or ruleset, which decides what is stack memory and what is heap is constantly being refined. So, rather than guess, it’s better that we undertake the same escape analysis that the compiler performs during compilation. </p>

<p>The snippet below shows how we use the <code>-gcflags "-m"</code> flag to view escape analysis output when running or building a program.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="c1">## build</code>
<code class="linenos">2 </code>go build -gcflags<code class="o">=</code><code class="s2">"-m"</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code><code class="c1">## run</code>
<code class="linenos">5 </code>go run -gcflags<code class="o">=</code><code class="s2">"-m"</code> ./main.go
</pre></div>

</figure>


<aside class="information blurb">
    <p>Unfortunately, it’s not possible to pass build flags when we run code on the Go Playground. To see the output from the following examples yourself, you’ll need to run the code in a local environment, or just follow the output included.</p>

</aside>

<p>Alongside escape analysis we can also use benchmarks, part of the testing suite we’ll cover later, to determine when allocations are made. So, for each example, we’ll create a benchmark file which we’ll be able to run with this command. </p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go <code class="nb">test</code> -bench . -benchmen
</pre></div>

</figure>


<p>The command instructs the <i>go test</i> tool to run all benchmarks, and include benchmark metrics for memory in the output.</p>

<p>Benchmarks will tell us how many allocations a piece of code makes. Escape analysis lets us identify the specific lines of code which cause those allocations.</p>

<aside class="information blurb">
    <p>A word on inlining. We are not passing the <code>-l</code> flag which turns off inlining globally. Instead, we will use the <code>//go:noinline</code> compiler directive in our examples to prevent functions from being inlined. This is my preference, since the benchmarks will also run with inlining disabled without changing the benchmark command.</p>

</aside>

<p>The code shown below is used to generate the benchmark results. In a later chapter, we’ll cover benchmarking when we discuss <i>quality assurance</i>.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="kn">import</code> <code class="s2">"testing"</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code><code class="n">func</code> <code class="n">BenchmarkMain</code><code class="p">(</code><code class="n">b</code> <code class="o">*</code><code class="n">testing</code><code class="o">.</code><code class="n">B</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">6 </code>	<code class="k">for</code> <code class="n">i</code><code class="o">:=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code> <code class="n">b</code><code class="o">.</code><code class="n">N</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos">7 </code>		<code class="n">main</code><code class="p">()</code>
<code class="linenos">8 </code>	<code class="p">}</code>
<code class="linenos">9 </code><code class="p">}</code>
</pre></div>

</figure>


<p>In this first example we’re not calling any of our own code, we’re simply using the standard library <code>fmt</code> package and the built-in <code>println()</code> function.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 90 - Escape analysis with benchmark</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">input1</code> <code class="o">:=</code> <code class="mi">1</code>
<code class="linenos"> 7 </code>	<code class="n">input2</code> <code class="o">:=</code> <code class="s2">"Joe Blogs"</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">input1</code><code class="p">)</code>
<code class="linenos">10 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">input2</code><code class="p">)</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code>	<code class="o">//</code><code class="n">println</code><code class="p">(</code><code class="n">input1</code><code class="p">)</code>
<code class="linenos">13 </code>	<code class="o">//</code><code class="n">println</code><code class="p">(</code><code class="n">input2</code><code class="p">)</code>
<code class="linenos">14 </code><code class="p">}</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">rqTcK20eVqV</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>// go run -gcflags<code class="o">=</code><code class="s2">"-m"</code> ./main.go
<code class="linenos">2 </code>./main.go:11:13: input1 escapes to heap
<code class="linenos">3 </code>./main.go:12:13: input2 escapes to heap
<code class="linenos">4 </code>
<code class="linenos">5 </code>// go <code class="nb">test</code> -bench . -benchmen
<code class="linenos">6 </code><code class="m">51032</code>             <code class="m">22628</code> ns/op              <code class="m">16</code> B/op          <code class="m">1</code> allocs/op
</pre></div>

</figure>


<p>The escape analysis output is abbreviated. We are interested in messages which say <code>x escapes to heap</code> or <code>moved to heap: x</code>.</p>

<p>If we see <code>x escapes to heap</code>, it means the value is leaving the functions local scope. It <i>often</i> means that the compiler will store the value on the heap, but not always. </p>

<p>If we see <code>moved to heap: x</code>, that’s a clear message that the compiler has decided the value needs to be allocated on the heap, and there will be an allocation associated with that decision.</p>

<p>Looking at the above example output, we may expect the compiler to have made two allocations, but looking at the benchmark output, it only made one, see <code>1 allocs/op</code> on the right of the output. The allocation is made on the string value.  The compiler does not know that the function does not reslice the string’s backing data so it puts it on the heap. Comment the code appropriately and run it again to see.</p>

<aside class="information blurb">
    <p>That’s the first takeaway. Escape analysis and benchmarking are worth using together, and <i>escapes to heap</i> does not always mean an allocation was made.</p>

</aside>

<p>Finally, alter the code to use the <code>println()</code> built-in function, and no allocations are made. The compiler knows exactly what this function does with the passed argument, so places everything on the stack.</p>

<p>In the next example, we create several functions of our own and use escape analysis with benchmarking to understand the allocations which may result.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 91 - Escape analysis on function returns</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">//</code> <code class="n">go</code> <code class="n">run</code> <code class="o">-</code><code class="n">gcflags</code><code class="o">=</code><code class="s2">"-m"</code> <code class="o">./</code><code class="n">main</code><code class="o">.</code><code class="n">go</code>
<code class="linenos"> 2 </code><code class="o">//</code> <code class="n">go</code> <code class="n">test</code> <code class="o">-</code><code class="n">bench</code> <code class="o">.</code> <code class="o">-</code><code class="n">benchmem</code>
<code class="linenos"> 3 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">type</code> <code class="n">Customer</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">Name</code> <code class="n">string</code>
<code class="linenos"> 7 </code>	<code class="n">Email</code> <code class="n">string</code>
<code class="linenos"> 8 </code>	<code class="n">Age</code> <code class="nb nb-Type">int</code>
<code class="linenos"> 9 </code><code class="p">}</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="o">//</code><code class="n">go</code><code class="p">:</code><code class="n">noinline</code>
<code class="linenos">12 </code><code class="k">func</code> <code class="n">NewCustomer</code><code class="p">(</code><code class="n">name</code> <code class="n">string</code><code class="p">)</code> <code class="n">Customer</code> <code class="p">{</code>
<code class="linenos">13 </code>	<code class="n">cust</code> <code class="p">:</code><code class="o">=</code> <code class="n">Customer</code><code class="p">{</code><code class="n">Name</code><code class="p">:</code><code class="n">name</code><code class="p">}</code>
<code class="linenos">14 </code>	<code class="k">return</code> <code class="n">cust</code>
<code class="linenos">15 </code><code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="o">//</code><code class="n">go</code><code class="p">:</code><code class="n">noinline</code>
<code class="linenos">18 </code><code class="k">func</code> <code class="n">NewCustomer2</code><code class="p">(</code><code class="n">name</code> <code class="n">string</code><code class="p">)</code> <code class="o">*</code><code class="n">Customer</code> <code class="p">{</code>
<code class="linenos">19 </code>	<code class="n">cust2</code> <code class="p">:</code><code class="o">=</code> <code class="n">Customer</code><code class="p">{</code><code class="n">Name</code><code class="p">:</code><code class="n">name</code><code class="p">}</code>
<code class="linenos">20 </code>	<code class="k">return</code> <code class="o">&amp;</code><code class="n">cust2</code>
<code class="linenos">21 </code><code class="p">}</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code><code class="o">//</code><code class="n">go</code><code class="p">:</code><code class="n">noinline</code>
<code class="linenos">24 </code><code class="k">func</code> <code class="n">NewCustomer3</code><code class="p">(</code><code class="n">name</code> <code class="n">string</code><code class="p">)</code> <code class="o">*</code><code class="n">Customer</code> <code class="p">{</code>
<code class="linenos">25 </code>	<code class="k">return</code> <code class="o">&amp;</code><code class="n">Customer</code><code class="p">{</code><code class="n">Name</code><code class="p">:</code><code class="n">name</code><code class="p">}</code>
<code class="linenos">26 </code><code class="p">}</code>
<code class="linenos">27 </code>
<code class="linenos">28 </code><code class="k">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">29 </code>	<code class="n">input</code> <code class="p">:</code><code class="o">=</code> <code class="s2">"Joe Blogs"</code>
<code class="linenos">30 </code>	<code class="n">_</code> <code class="o">=</code> <code class="n">NewCustomer</code><code class="p">(</code><code class="n">input</code><code class="p">)</code>
<code class="linenos">31 </code>	<code class="n">_</code> <code class="o">=</code> <code class="n">NewCustomer2</code><code class="p">(</code><code class="n">input</code><code class="p">)</code>
<code class="linenos">32 </code>	<code class="n">_</code> <code class="o">=</code> <code class="n">NewCustomer3</code><code class="p">(</code><code class="n">input</code><code class="p">)</code>
<code class="linenos">33 </code><code class="p">}</code>
<code class="linenos">34 </code>
<code class="linenos">35 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">rC5x05MpKP5</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>// go run -gcflags<code class="o">=</code><code class="s2">"-m"</code> ./main.go
<code class="linenos">2 </code>./main.go:19:2: moved to heap: cust2
<code class="linenos">3 </code>./main.go:25:9: <code class="p">&amp;</code>Customer<code class="o">{</code>...<code class="o">}</code> escapes to heap
<code class="linenos">4 </code>
<code class="linenos">5 </code>// go <code class="nb">test</code> -bench . -benchmen
<code class="linenos">6 </code><code class="m">15239967</code>                <code class="m">66</code>.54 ns/op           <code class="m">96</code> B/op          <code class="m">2</code> allocs/op
</pre></div>

</figure>


<p>In this example, we have three very similar <i>factory</i> style functions which create and return a <code>Customer{}</code>, either as a value or as a pointer. </p>

<p>The first function returns a value, which is a copy of the value created inside the function. The compiler knows everything can sit on the stack - when the function is finished that copy does not reference anything inside the function. There are no allocations made.</p>

<p>The second function creates a <code>Customer{}</code> value <code>cust2</code>, but then its address is taken and a pointer is returned. The compiler can’t know how this value will be accessed and used later and it lives beyond the function’s lifetime, so this value can’t sit on the stack, it must be <i>moved to the heap</i>.</p>

<p>The final function is similar to the last, except an address is immediately taken and returned. Escape analysis indicates this <i>escapes to the heap</i> indicating there may be an allocation, and the benchmark results confirm that an allocation was made.</p>

<h2 id="leanpub-auto-using-receivers-with-custom-types" class="section">9.3 Using receivers with custom types</h2>

<p>Let’s dig deeper into receivers.</p>

<p>Receivers are essentially a different kind of function. All the learning we’ve acquired in the earlier section on <code>developing with functions</code> is valid here too. However, unlike functions, receivers have a unique characteristic that makes them similar to methods in OOP.</p>

<p>Unlike methods which exist on a class, receivers can be bound to any user-defined type, which allows the receiver to access the value of that type. For example, if a receiver is bound to a custom struct, it can access the fields of the struct just like a method can access the properties of a class. </p>

<p>Receivers are useful when writing functionality intended to work with a value of a specific type, for example, <i>getter</i> and <i>setter</i> routines which read the value and can change the value. </p>

<p>Because they can be bound to a custom type, receivers have internal access to the value of that type. This avoids the <i>value</i> having to be passed into the receiver as arguments, which would be necessary if we chose to use functions to perform the <i>getter</i> and <i>setter</i> operations mentioned above. </p>

<p>Similarly, because the access is internal, any mutation of the value is also performed inside the receiver and not by return values as would be the case with functions.</p>

<p>Receivers can either <i>receive</i> a copy of the value, which as you would expect can only be read, not mutated, or, they can receive a pointer to the value, which allows the receiver to mutate the value from within the receiver body.  These are known as <i>value receivers</i> and <i>pointer receivers</i> respectively. We covered <i>pointer</i> and <i>value</i> semantics in Chapter 6.</p>

<aside class="information blurb">
    <p>A <i>value receiver</i> gets a copy of the value on every call, which could be significant in size for large types. A <i>pointer receiver</i> uses less memory since only a copy of the memory address is passed into the receiver on every call. Consequently, for very large types, there can be a case for using <i>pointer receivers</i> even if the value will only be read and not mutated.</p>

</aside>

<p>In the same way receivers have access to the value, they can also access other receivers bound to the same type, which means we can call other receivers from within receivers.</p>

<p>In the next example, we show a value and pointer receiver implementation on the same <code>customer</code> struct. Mixing them in this way is not considered good practice - we’re doing it here to keep the example concise.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 92 - Value and pointer receivers</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nb">type</code> <code class="n">customer</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">Name</code> <code class="n">string</code>
<code class="linenos"> 7 </code><code class="p">}</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="o">//</code> <code class="n">UpdateName</code> <code class="ow">is</code> <code class="n">a</code> <code class="n">pointer</code> <code class="n">receiver</code>
<code class="linenos">10 </code><code class="n">func</code> <code class="p">(</code><code class="n">c</code> <code class="o">*</code><code class="n">customer</code><code class="p">)</code> <code class="n">UpdateName</code><code class="p">(</code><code class="n">newStr</code> <code class="n">string</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">11 </code>	<code class="n">c</code><code class="o">.</code><code class="n">Name</code> <code class="o">=</code> <code class="n">newStr</code>
<code class="linenos">12 </code><code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="o">//</code> <code class="n">PrintName</code> <code class="ow">is</code> <code class="n">a</code> <code class="n">value</code> <code class="n">receiver</code>
<code class="linenos">15 </code><code class="n">func</code> <code class="p">(</code><code class="n">c</code> <code class="n">customer</code><code class="p">)</code> <code class="n">PrintName</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">16 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"This is reading the value: </code><code class="si">%s</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">c</code><code class="o">.</code><code class="n">Name</code><code class="p">)</code>
<code class="linenos">17 </code>    <code class="n">c</code><code class="o">.</code><code class="n">PrintLine</code><code class="p">()</code> <code class="o">//</code> <code class="n">calling</code> <code class="n">another</code> <code class="n">receiver</code>
<code class="linenos">18 </code><code class="p">}</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="n">func</code> <code class="p">(</code><code class="n">customer</code><code class="p">)</code> <code class="n">PrintLine</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">21 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"-------------------------------------"</code><code class="p">)</code>
<code class="linenos">22 </code><code class="p">}</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">25 </code>	<code class="n">var</code> <code class="n">cust</code> <code class="o">=</code> <code class="o">&amp;</code><code class="n">customer</code><code class="p">{</code><code class="s2">"Joe Blogs"</code><code class="p">}</code>
<code class="linenos">26 </code>
<code class="linenos">27 </code>	<code class="o">//</code> <code class="n">read</code> <code class="n">via</code> <code class="n">value</code> <code class="n">receiver</code>
<code class="linenos">28 </code>	<code class="n">cust</code><code class="o">.</code><code class="n">PrintName</code><code class="p">()</code>
<code class="linenos">29 </code>
<code class="linenos">30 </code>	<code class="o">//</code> <code class="n">update</code>
<code class="linenos">31 </code>	<code class="n">cust</code><code class="o">.</code><code class="n">UpdateName</code><code class="p">(</code><code class="s2">"Dave Blogs"</code><code class="p">)</code>
<code class="linenos">32 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Updated string is value: </code><code class="si">%s</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">cust</code><code class="o">.</code><code class="n">Name</code><code class="p">)</code>
<code class="linenos">33 </code>	<code class="n">cust</code><code class="o">.</code><code class="n">PrintLine</code><code class="p">()</code>
<code class="linenos">34 </code><code class="p">}</code>
<code class="linenos">35 </code>
<code class="linenos">36 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">qTBFdsIDdCL</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>This is reading the value: Joe Blogs
<code class="linenos">2 </code>-------------------------------------
<code class="linenos">3 </code>Updated string is value: Dave Blogs
<code class="linenos">4 </code>-------------------------------------
<code class="linenos">5 </code>
<code class="linenos">6 </code>Program exited.
</pre></div>

</figure>


<aside class="information blurb">
    <p>The <code>Printline()</code> receiver makes no use of the <code>customer</code> value at all, so we have removed the variable accessor <code>c</code> to indicate this is the case. The only case for using a receiver rather than a function here is that in text editors with code completion, it will form part of the same prompt API as it is bound to the same <code>customer</code> type.</p>

</aside>

<p>Finally, a few <i>suggested</i> style rules when using receivers. The compiler will not enforce these rules, but they do help improve the consistency and clarity of our code.</p>

<p>If one or more of our receivers should mutate the value on which it is bound, then we need to use at least one <i>pointer receiver</i>, so should make all receivers bound to that type, a <i>pointer receiver</i>.</p>

<p>Conversely, if nothing mutates the value but only reads it, then we should bind only <i>value receivers</i> to the type, <b>unless</b> we are dealing with very large types and making copies of values would be very inefficient.</p>

<p>We should use a short variable to access to the value inside the receiver body. The context and scope are very clear. There is no need for semantic naming.</p>

<p>If a receiver neither reads nor mutates the value, we should remove the variable accessor entirely as a mechanism for communicating this. We may also consider using a simple function instead since there is no need for the receiver to be bound to a type it neither reads nor mutates.</p>

<h2 id="leanpub-auto-working-with-interfaces" class="section">9.4 Working with interfaces</h2>

<p>We’ve already discussed interfaces in Chapter 7 on <i>type</i>. Despite my intention, we covered many of the core points of learning back then.</p>

<p>In this section we’re going to quickly recap, and then look at some interface implementations of our own, demonstrating their value in building flexible, more extensible programs. We’re also going use interfaces to create mock representations of services which we can use in our testing.  We’ll try not to go too deep into testing itself at this stage. </p>

<h3 id="leanpub-auto-recapping" class="subsection">9.4.1 Recapping</h3>

<p>In Go, an interface is a set of receiver signatures. A value of an interface type can hold any value that implements those receivers. Interfaces are a way to specify the required behaviour of a type: if a type has the receivers specified by an interface, then it is said to implement that interface. It does not need to be explicitly stated in the code that it implements the interface.</p>

<p>The empty interface, <code>interface{}</code> aliased <code>any</code>, specifies no behaviour. Consequently, all built-in and user-defined types implement this interface since they all have at least no receivers bound to them. So we can supply any type as a value for the empty interface.</p>

<p>Interfaces are useful when we want to define generic behaviour that several types may need to implement. They allow us to write code using the interface - an abstraction of the implementation - instead of the implementation itself.</p>

<p>Writing code that accepts interfaces in preference to concrete types is a common pattern in Go. For example, many functions accept the <i>io.writer</i> and <i>io.reader</i> interfaces, enabling them to call the <i>Write</i> and <i>Read</i> implementations on the interface value passed. The function knows how to use the interface value because the interface defines the receiver signature  parameters and return types. It cares nothing for the underlying implementation itself, only that it <i>has</i> an implementation. </p>

<aside class="information blurb">
    <p>While accepting interface values makes code more flexible, we generally prefer not to return interfaces except in specific situations such as the one we’ll see shortly. It’s rarely a good idea to return an empty interface type. Doing so imposes a burden on the caller and can result in ugly syntax. The caller may need to perform <i>type switch</i> logic on each return value to determine what the concrete type is, and then how to handle it.</p>

</aside>

<h3 id="leanpub-auto-creating-interfaces-of-our-own" class="subsection">9.4.2 Creating interfaces of our own</h3>

<p>Consider this fictional scenario. We are writing a program that has a requirement to store data, when it restarts it should be able to access that same data. </p>

<p>We need a store for the data, and a means to write to and read from that store.  We’re not using an in-memory store such as a <i>map</i> because it can’t persist the data beyond the current runtime. We might use a map as a cache, for fast data access but we’re not doing since there’s no requirement for exceptionally fast reads and writes.</p>

<p>So, the next simplest store we could use would be a file-based store, with data getting written to disk. We decided to implement a file store and the below code is what we came up with.  Three receivers bound to the struct will let us perform all the CRUD operations we need, with the update operation being a rewrite of the entire record for an id.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 93 - Simple file store</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">filestore</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="o">//</code> <code class="n">FileStore</code> <code class="k">is</code> <code class="n">a</code> <code class="n">struct</code> <code class="n">representation</code> <code class="n">of</code> <code class="n">a</code> <code class="n">file</code> <code class="n">based</code> <code class="n">store</code>
<code class="linenos"> 4 </code><code class="n">type</code> <code class="n">FileStore</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 5 </code>	<code class="n">Folder</code> <code class="n">string</code>
<code class="linenos"> 6 </code><code class="p">}</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="o">//</code> <code class="n">Set</code> <code class="n">writes</code> <code class="n">a</code> <code class="n">payload</code> <code class="n">to</code> <code class="n">the</code> <code class="n">file</code> <code class="n">store</code>
<code class="linenos"> 9 </code><code class="k">func</code> <code class="p">(</code><code class="n">fs</code> <code class="o">*</code><code class="n">FileStore</code><code class="p">)</code> <code class="n">Set</code><code class="p">(</code><code class="n">payload</code> <code class="p">[]</code><code class="n">byte</code><code class="p">)</code> <code class="p">(</code><code class="n">string</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="k">return</code> <code class="s2">""</code><code class="p">,</code> <code class="n">nil</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="o">//</code> <code class="n">Get</code> <code class="n">retrieves</code> <code class="n">an</code> <code class="n">item</code> <code class="n">of</code> <code class="n">data</code> <code class="n">from</code> <code class="n">the</code> <code class="n">store</code> <code class="n">by</code> <code class="n">id</code>
<code class="linenos">14 </code><code class="k">func</code> <code class="p">(</code><code class="n">fs</code> <code class="o">*</code><code class="n">FileStore</code><code class="p">)</code> <code class="n">Get</code><code class="p">(</code><code class="n">id</code> <code class="n">string</code><code class="p">)</code> <code class="p">([]</code><code class="n">byte</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">15 </code>	<code class="k">return</code> <code class="p">[]</code><code class="n">byte</code><code class="p">{},</code> <code class="n">nil</code>
<code class="linenos">16 </code><code class="p">}</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="o">//</code> <code class="n">Delete</code> <code class="n">removes</code> <code class="n">an</code> <code class="n">item</code> <code class="n">of</code> <code class="n">data</code> <code class="n">from</code> <code class="n">the</code> <code class="n">store</code> <code class="n">by</code> <code class="n">id</code>
<code class="linenos">19 </code><code class="k">func</code> <code class="p">(</code><code class="n">fs</code> <code class="o">*</code><code class="n">FileStore</code><code class="p">)</code> <code class="n">Delete</code><code class="p">(</code><code class="n">id</code> <code class="n">string</code><code class="p">)</code> <code class="n">error</code> <code class="p">{</code>
<code class="linenos">20 </code>	<code class="k">return</code> <code class="n">nil</code>
<code class="linenos">21 </code><code class="p">}</code>
</pre></div>

</figure>


<aside class="information blurb">
    <p>Note the implementation is not needed for the examples, let’s pretend we know what it is and that we have added it to the above code. For now, we can simply use NOOPs. </p>

</aside>

<p>We’d use the file store in our code like this. Again note we’re only concerned with how to create and access the store. Processing and error checking would be needed on the return values, but we’ve discarded them here.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 94 - Using the store</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"store/filestore"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="o">//</code> <code class="n">new</code> <code class="n">file</code> <code class="n">store</code>
<code class="linenos"> 7 </code>	<code class="n">fs</code> <code class="o">:=</code> <code class="o">&amp;</code><code class="n">filestore</code><code class="o">.</code><code class="n">FileStore</code><code class="p">{</code><code class="s2">"data"</code><code class="p">}</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>	<code class="o">//</code> <code class="n">write</code> <code class="n">to</code> <code class="n">it</code>
<code class="linenos">10 </code>	<code class="nb">id</code><code class="p">,</code> <code class="n">err</code> <code class="o">:=</code> <code class="n">fs</code><code class="o">.</code><code class="n">Set</code><code class="p">([]</code><code class="n">byte</code><code class="p">(</code><code class="s2">"some data"</code><code class="p">))</code>
<code class="linenos">11 </code>	<code class="n">_</code><code class="p">,</code> <code class="n">_</code> <code class="o">=</code> <code class="nb">id</code><code class="p">,</code> <code class="n">err</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>	<code class="o">//</code> <code class="n">read</code> <code class="n">an</code> <code class="n">item</code>
<code class="linenos">14 </code>	<code class="n">data</code><code class="p">,</code> <code class="n">err</code> <code class="o">:=</code> <code class="n">fs</code><code class="o">.</code><code class="n">Get</code><code class="p">(</code><code class="s2">"xyz"</code><code class="p">)</code>
<code class="linenos">15 </code>	<code class="n">_</code><code class="p">,</code> <code class="n">_</code> <code class="o">=</code> <code class="n">data</code><code class="p">,</code> <code class="n">err</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code>	<code class="o">//</code> <code class="n">delete</code> <code class="n">an</code> <code class="n">item</code>
<code class="linenos">18 </code>	<code class="n">err</code> <code class="o">=</code> <code class="n">fs</code><code class="o">.</code><code class="n">Delete</code><code class="p">(</code><code class="s2">"xyz"</code><code class="p">)</code>
<code class="linenos">19 </code>	<code class="n">_</code> <code class="o">=</code> <code class="n">err</code>
<code class="linenos">20 </code><code class="p">}</code>
</pre></div>

</figure>


<p>Everything is good. With this piece complete we can continue to write the rest of our application.</p>

<p>But, then we get a new requirement. The business wants the ability to configure additional storage types. We should support databases and also key-value stores such as <i>Redis</i> and <i>etcd</i>. The requirements do not state specifically which.</p>

<p>We now face a challenge. The requirements are vague, and we can’t possibly write implementations for every type of database or key-value store the business <i>may</i> wish to use. </p>

<p>How can we accommodate this change so that we can move on? Maybe we report that we are blocked until the business tells us exactly what it needs, or maybe we know how to use interfaces.</p>

<p>Luckily for us, we’ve recently learned about interfaces, so we decide to perform a small refactor of our project. If we refactor around interfaces we suspect we won’t need to concern ourselves with those unknown implementations at the moment, while making it very simple to accommodate them when the business makes its mind up.</p>

<p>Let’s design the interface. Where should we start?</p>

<p>Well, we know what the program needs to do regardless of the storage medium chosen. It needs to <i>read</i>, <i>write</i> and <i>delete</i> on the store. So we will create an interface that represents this behaviour.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 95 - Interface design</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="n">package</code> <code class="n">store</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="o">//</code> <code class="n">ReadWriteDeleter</code> <code class="n">must</code> <code class="n">be</code> <code class="n">implemented</code> <code class="k">for</code> <code class="n">each</code> <code class="n">storage</code> <code class="n">mechanism</code>
<code class="linenos">4 </code><code class="n">type</code> <code class="n">ReadWriteDeleter</code> <code class="n">interface</code> <code class="p">{</code>
<code class="linenos">5 </code>	<code class="n">Read</code><code class="p">(</code><code class="n">id</code> <code class="n">string</code><code class="p">)</code> <code class="p">(</code><code class="n">payload</code> <code class="p">[]</code><code class="n">byte</code><code class="p">,</code> <code class="n">err</code> <code class="n">error</code><code class="p">)</code>
<code class="linenos">6 </code>	<code class="n">Write</code><code class="p">(</code><code class="n">payload</code> <code class="p">[]</code><code class="n">byte</code><code class="p">)</code> <code class="p">(</code><code class="n">id</code> <code class="n">string</code><code class="p">,</code> <code class="n">err</code> <code class="n">error</code><code class="p">)</code>
<code class="linenos">7 </code>	<code class="n">Delete</code><code class="p">(</code><code class="n">id</code> <code class="n">string</code><code class="p">)</code> <code class="n">error</code>
<code class="linenos">8 </code><code class="p">}</code>
</pre></div>

</figure>


<p>We’ve named our interface <i>ReadWriteDeleter</i> and we defined three behaviours on the interface. Though we changed the naming slightly, the signatures are otherwise the same as those of the receivers we implemented on the <code>FileStore</code> struct.</p>

<aside class="information blurb">
    <p>We should use small interfaces whenever possible, each with a limited set of behaviour since implementation is simpler. This tends to make an interface more flexible. Interfaces are also composable, just like structs, so we can build more specific large interface types from smaller interfaces by embedding them. We could for example, have composed our <i>ReadWriteDeleter</i> interface from three smaller interfaces, <i>Reader</i>, <i>Writer</i>, and <i>Deleter</i>.</p>

  <p>Observe also the naming convention. That’s generally the idiomatic way of naming an interface in Go. For example, <i>io.Reader</i> defines a <i>Read</i> receiver and <i>io.ReadWriter</i> defines both <i>Read</i> and <i>Write</i> receivers. Our <i>store.ReadWriteDeleter</i> interface defines, <i>Read</i>, <i>Write</i> and <i>Delete</i> receivers.</p>

</aside>

<p>We’re also going to add a factory function to the <i>store</i> package. This will allow us to quickly swap between stores. We use a switch statement so we can create store types when we need to. Currently, we only have one <code>case</code> statement as we only have a file store.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 96 - Implementing store.NewStore</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">//</code> <code class="n">NewStore</code> <code class="n">creates</code> <code class="n">a</code> <code class="n">store</code> <code class="n">from</code> <code class="n">available</code> <code class="n">stores</code><code class="p">,</code> <code class="n">depending</code> <code class="n">on</code> <code class="n">storeType</code> <code class="n">argument</code>
<code class="linenos"> 2 </code><code class="k">func</code> <code class="n">NewStore</code><code class="p">(</code><code class="n">storeType</code> <code class="n">string</code><code class="p">)</code> <code class="n">ReadWriteDeleter</code> <code class="p">{</code>
<code class="linenos"> 3 </code>	<code class="k">var</code> <code class="n">s</code> <code class="n">ReadWriteDeleter</code>
<code class="linenos"> 4 </code>	<code class="n">switch</code> <code class="n">storeType</code> <code class="p">{</code>
<code class="linenos"> 5 </code>	<code class="n">case</code> <code class="s2">"file"</code><code class="p">:</code>
<code class="linenos"> 6 </code>		<code class="n">s</code> <code class="o">=</code> <code class="o">&amp;</code><code class="n">filestore</code><code class="o">.</code><code class="n">FileStore</code><code class="p">{</code>
<code class="linenos"> 7 </code>			<code class="n">Folder</code><code class="p">:</code> <code class="s2">"data"</code><code class="p">,</code>
<code class="linenos"> 8 </code>		<code class="p">}</code>
<code class="linenos"> 9 </code>	<code class="p">}</code>
<code class="linenos">10 </code>	<code class="k">return</code> <code class="n">s</code>
<code class="linenos">11 </code><code class="p">}</code>
</pre></div>

</figure>


<p>Happy with our chosen interface design, and our <code>NewStore</code> factory function, next we’ll alter our <code>FileStore</code> struct type to make sure it implements the interface. This involves changing two receiver names.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 97 - Implementing store.ReadWriteDeleter</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">filestore</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="o">//</code> <code class="n">FileStore</code> <code class="k">is</code> <code class="n">a</code> <code class="n">struct</code> <code class="n">representation</code> <code class="n">of</code> <code class="n">a</code> <code class="n">file</code> <code class="n">based</code> <code class="n">store</code>
<code class="linenos"> 4 </code><code class="n">type</code> <code class="n">FileStore</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 5 </code>	<code class="n">Folder</code> <code class="n">string</code>
<code class="linenos"> 6 </code><code class="p">}</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="o">//</code> <code class="n">Write</code> <code class="n">writes</code> <code class="n">a</code> <code class="n">payload</code> <code class="n">to</code> <code class="n">the</code> <code class="n">file</code> <code class="n">store</code>
<code class="linenos"> 9 </code><code class="k">func</code> <code class="p">(</code><code class="n">fs</code> <code class="o">*</code><code class="n">FileStore</code><code class="p">)</code> <code class="n">Write</code><code class="p">(</code><code class="n">payload</code> <code class="p">[]</code><code class="n">byte</code><code class="p">)</code> <code class="p">(</code><code class="n">string</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="k">return</code> <code class="s2">""</code><code class="p">,</code> <code class="n">nil</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="o">//</code> <code class="n">Read</code> <code class="n">retrieves</code> <code class="n">an</code> <code class="n">item</code> <code class="n">of</code> <code class="n">data</code> <code class="n">from</code> <code class="n">the</code> <code class="n">store</code> <code class="n">by</code> <code class="n">id</code>
<code class="linenos">14 </code><code class="k">func</code> <code class="p">(</code><code class="n">fs</code> <code class="o">*</code><code class="n">FileStore</code><code class="p">)</code> <code class="n">Read</code><code class="p">(</code><code class="n">id</code> <code class="n">string</code><code class="p">)</code> <code class="p">([]</code><code class="n">byte</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">15 </code>	<code class="k">return</code> <code class="p">[]</code><code class="n">byte</code><code class="p">{},</code> <code class="n">nil</code>
<code class="linenos">16 </code><code class="p">}</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="o">//</code> <code class="n">Delete</code> <code class="n">removes</code> <code class="n">an</code> <code class="n">item</code> <code class="n">of</code> <code class="n">data</code> <code class="n">from</code> <code class="n">the</code> <code class="n">store</code> <code class="n">by</code> <code class="n">id</code>
<code class="linenos">19 </code><code class="k">func</code> <code class="p">(</code><code class="n">fs</code> <code class="o">*</code><code class="n">FileStore</code><code class="p">)</code> <code class="n">Delete</code><code class="p">(</code><code class="n">id</code> <code class="n">string</code><code class="p">)</code> <code class="n">error</code> <code class="p">{</code>
<code class="linenos">20 </code>	<code class="k">return</code> <code class="n">nil</code>
<code class="linenos">21 </code><code class="p">}</code>
</pre></div>

</figure>


<p>The last thing we need to do is amend the code that creates and uses the store.  We’ll use the factory to create the store, and then work with the interface value’s <i>Read</i>, <i>Write</i> and <i>Delete</i> functionality in preference to a specific store type. The changes are minor.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 98 - Refactoring to use the interface</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"store/store"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="o">//</code> <code class="n">new</code> <code class="n">store</code><code class="p">,</code> <code class="n">currently</code> <code class="n">a</code> <code class="n">file</code> <code class="n">store</code>
<code class="linenos"> 9 </code>	<code class="n">st</code> <code class="o">:=</code> <code class="n">store</code><code class="o">.</code><code class="n">NewStore</code><code class="p">(</code><code class="s2">"file"</code><code class="p">)</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code>	<code class="o">//</code> <code class="n">write</code> <code class="n">to</code> <code class="n">it</code>
<code class="linenos">12 </code>	<code class="nb">id</code><code class="p">,</code> <code class="n">err</code> <code class="o">:=</code> <code class="n">st</code><code class="o">.</code><code class="n">Write</code><code class="p">([]</code><code class="n">byte</code><code class="p">(</code><code class="s2">"some data"</code><code class="p">))</code>
<code class="linenos">13 </code>	<code class="n">_</code><code class="p">,</code> <code class="n">_</code> <code class="o">=</code> <code class="nb">id</code><code class="p">,</code> <code class="n">err</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code>	<code class="o">//</code> <code class="n">read</code> <code class="n">an</code> <code class="n">item</code>
<code class="linenos">16 </code>	<code class="n">data</code><code class="p">,</code> <code class="n">err</code> <code class="o">:=</code> <code class="n">st</code><code class="o">.</code><code class="n">Read</code><code class="p">(</code><code class="s2">"xyz"</code><code class="p">)</code>
<code class="linenos">17 </code>	<code class="n">_</code><code class="p">,</code> <code class="n">_</code> <code class="o">=</code> <code class="n">data</code><code class="p">,</code> <code class="n">err</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code>	<code class="o">//</code> <code class="n">delete</code> <code class="n">an</code> <code class="n">item</code>
<code class="linenos">20 </code>	<code class="n">err</code> <code class="o">=</code> <code class="n">st</code><code class="o">.</code><code class="n">Delete</code><code class="p">(</code><code class="s2">"xyz"</code><code class="p">)</code>
<code class="linenos">21 </code>	<code class="n">_</code> <code class="o">=</code> <code class="n">err</code>
<code class="linenos">22 </code><code class="p">}</code>
</pre></div>

</figure>


<p>That’s it we’re done. Our program is now working with an interface and not a specific store implementation.</p>

<p>To add a new store type, say a database, we’d create an implementation for the database, which also satisfies the <i>store.ReadWriteDeleter</i> interface, and add a case statement in the <code>store.NewStore()</code> factory to create a database store.</p>

<p>The only change we’d need to make in <code>main()</code> would be to pass “database” as an argument to <code>store.NewStore()</code> on line 9, so the factory function creates a database store instead of a file store.</p>

<p>To see how flexible our code is now that it uses interfaces, why don’t you go ahead and add a new store for yourself? It should only take minutes.</p>

<h3 id="leanpub-auto-using-interfaces-in-testing" class="subsection">9.4.3 Using interfaces in testing</h3>

<p>When testing our software, often, the code we need to test has external dependencies such as third party libraries, APIs or databases, to name just a few examples.</p>

<p>Whether these components are available during testing may depend on the type of testing undertaken. If we’re conducting <i>integration testing</i>, we’re testing the system as a whole so it could make sense to perform those tests using real implementations. If we’re conducting <i>unit testing</i>, which focuses on testing the pieces of code which comprise the program, it’s often inconvenient to test using real implementations, and in some cases it’s impossible.</p>

<p>To avoid needing real implementations, we can create <i>mock</i> or <i>fake</i> implementations of our external dependencies, and use those in our testing instead.</p>

<p>One way to do this in Go is with interfaces. By creating an interface for the external dependency, and refactoring our code to use the interface and not the dependency directly, we can create a mock/fake implementation of the dependency, one which satisfies the same interface. This is ideal when unit testing.</p>

<p>In the next example, we’ll walk step-by-step through this process.  We’ll create an abstraction for a notification service using an interface, then amend our code to use that interface. We’ll modify the notification service implementation so that it implements the interface, and finally, create a mock implementation of the service which we can use during testing.</p>

<p>Let’s begin.</p>

<p>In our current implementation <code>SendNotification()</code> calls a helper function <code>makeCallToApi()</code> to send using the external notifications API. The code inside <code>makeCallToApi()</code> is not relevant for the example, and we’re discarding any errors.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 99 - SendNotification function</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="o">//</code> <code class="n">SendNotification</code> <code class="n">sends</code> <code class="n">a</code> <code class="n">notification</code> <code class="n">using</code> <code class="n">the</code> <code class="n">external</code> <code class="n">notification</code> <code class="n">API</code><code class="o">.</code>
<code class="linenos"> 4 </code><code class="k">func</code> <code class="n">SendNotification</code><code class="p">(</code><code class="n">to</code><code class="p">,</code> <code class="n">notification</code> <code class="n">string</code><code class="p">)</code> <code class="n">error</code> <code class="p">{</code>
<code class="linenos"> 5 </code>    <code class="k">if</code> <code class="n">err</code> <code class="p">:</code><code class="o">=</code> <code class="n">makeCallToAPI</code><code class="p">(</code><code class="n">to</code><code class="p">,</code> <code class="n">notification</code><code class="p">);</code> <code class="n">err</code> <code class="o">!=</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos"> 6 </code>        <code class="k">return</code> <code class="n">err</code>
<code class="linenos"> 7 </code>    <code class="p">}</code>
<code class="linenos"> 8 </code>    <code class="k">return</code> <code class="n">nil</code>
<code class="linenos"> 9 </code><code class="p">}</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="o">//</code> <code class="n">helper</code> <code class="n">to</code> <code class="n">make</code> <code class="n">the</code> <code class="n">REST</code> <code class="n">call</code> <code class="n">to</code> <code class="n">API</code> <code class="n">to</code> <code class="n">send</code> <code class="n">notification</code>
<code class="linenos">12 </code><code class="k">func</code> <code class="n">makeCallToAPI</code><code class="p">(</code><code class="n">to</code><code class="p">,</code> <code class="n">notification</code> <code class="n">string</code><code class="p">)</code> <code class="n">error</code> <code class="p">{</code>
<code class="linenos">13 </code>    <code class="k">return</code> <code class="n">nil</code>
<code class="linenos">14 </code><code class="p">}</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="k">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">17 </code>    <code class="n">_</code> <code class="o">=</code> <code class="n">SendNotification</code><code class="p">(</code><code class="s2">"Joe Blogs"</code><code class="p">,</code> <code class="s2">"Hello there!"</code><code class="p">)</code>
<code class="linenos">18 </code><code class="p">}</code>
</pre></div>

</figure>


<p>Let’s quickly inspect the current unit test for the <code>SendNotification()</code> function.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 100 - A basic unit test</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="k">func</code> <code class="n">TestSendNotification</code><code class="p">(</code><code class="n">t</code> <code class="o">*</code><code class="n">testing</code><code class="o">.</code><code class="n">T</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">2 </code>    <code class="n">err</code> <code class="p">:</code><code class="o">=</code> <code class="n">SendNotification</code><code class="p">(</code><code class="s2">"Test Joe Blogs"</code><code class="p">,</code> <code class="s2">"Test message"</code><code class="p">)</code>
<code class="linenos">3 </code>    <code class="k">if</code> <code class="n">err</code> <code class="o">!=</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos">4 </code>        <code class="n">t</code><code class="o">.</code><code class="n">Errorf</code><code class="p">(</code><code class="s2">"expected nil, got %v"</code><code class="p">,</code> <code class="n">err</code><code class="p">)</code>
<code class="linenos">5 </code>    <code class="p">}</code>
<code class="linenos">6 </code><code class="p">}</code>
</pre></div>

</figure>


<p>At the moment the unit test would make calls to the notifications API. If it has a valid <i>API key</i> or <i>access token</i> testing this function could send real notifications. If it doesn’t have access - which is more likely - it will always error causing the test to fail.</p>

<p>We can’t really test it properly at the moment, but, with a little work we can do better.</p>

<p>The first thing to do is to create an interface. We’ve called it <i>Notifier</i> and it defines a single <i>Notify</i> receiver.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 101 - Notifier service interface</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nv">package</code> <code class="nv">service</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="o">//</code> <code class="nv">Notifier</code> <code class="nv">must</code> <code class="nv">be</code> <code class="nv">implemented</code> <code class="k">for</code> <code class="nv">any</code> <code class="nv">service</code> <code class="nv">we</code> <code class="nv">use</code> <code class="nv">to</code> <code class="k">send</code> <code class="nv">notifications</code>.
<code class="linenos">4 </code><code class="nv">type</code> <code class="nv">Notifier</code> <code class="nv">interface</code> {
<code class="linenos">5 </code>    <code class="nv">Notify</code><code class="ss">(</code><code class="nv">to</code> <code class="nv">string</code>, <code class="nv">notification</code> <code class="nv">string</code><code class="ss">)</code> <code class="nv">error</code>
<code class="linenos">6 </code>}
</pre></div>

</figure>


<p>Painless. Next, lets modify our existing service to use this interface. We’ll create a struct, and bind a <i>Notify</i> receiver to it, which will implement <i>Notifier</i>. Inside <code>Notify()</code> we’ll make the call to the <code>makeCallToAPI()</code> function.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 102 - Modifying the notification code</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">notifications</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="o">//</code> <code class="n">NotifyService</code> <code class="n">provides</code> <code class="k">for</code> <code class="n">sending</code> <code class="n">notifications</code> <code class="n">using</code> <code class="n">external</code> <code class="n">API</code>
<code class="linenos"> 4 </code><code class="n">type</code> <code class="n">NotifyService</code> <code class="n">struct</code> <code class="p">{}</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="o">//</code> <code class="n">Notify</code> <code class="n">sends</code> <code class="n">notification</code>
<code class="linenos"> 7 </code><code class="k">func</code> <code class="p">(</code><code class="n">n</code> <code class="o">*</code><code class="n">NotifyService</code><code class="p">)</code> <code class="n">Notify</code> <code class="p">(</code><code class="n">to</code><code class="p">,</code> <code class="n">notification</code> <code class="n">string</code><code class="p">)</code> <code class="n">error</code> <code class="p">{</code>
<code class="linenos"> 8 </code>    <code class="k">if</code> <code class="n">err</code> <code class="p">:</code><code class="o">=</code> <code class="n">makeCallToAPI</code><code class="p">(</code><code class="n">to</code><code class="p">,</code> <code class="n">notification</code><code class="p">);</code> <code class="n">err</code> <code class="o">!=</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos"> 9 </code>        <code class="k">return</code> <code class="n">err</code>
<code class="linenos">10 </code>    <code class="p">}</code>
<code class="linenos">11 </code>    <code class="k">return</code> <code class="n">nil</code>
<code class="linenos">12 </code><code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="o">//</code> <code class="n">helper</code> <code class="n">to</code> <code class="n">make</code> <code class="n">the</code> <code class="n">REST</code> <code class="n">call</code> <code class="n">to</code> <code class="n">API</code> <code class="n">to</code> <code class="n">send</code> <code class="n">notification</code>
<code class="linenos">15 </code><code class="k">func</code> <code class="n">makeCallToAPI</code><code class="p">(</code><code class="n">to</code><code class="p">,</code> <code class="n">notification</code> <code class="n">string</code><code class="p">)</code> <code class="n">error</code> <code class="p">{</code>
<code class="linenos">16 </code>    <code class="k">return</code> <code class="n">nil</code>
<code class="linenos">17 </code><code class="p">}</code>
</pre></div>

</figure>


<p>The final step is to modify <code>main()</code> so it uses the interface in place of a concrete implementation.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 103 - Modify main()</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"notifications"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="o">//</code> <code class="n">SendNotification</code> <code class="n">sends</code> <code class="n">a</code> <code class="n">notification</code> <code class="n">using</code> <code class="n">a</code> <code class="n">Notifier</code> <code class="n">service</code>
<code class="linenos"> 6 </code><code class="n">func</code> <code class="n">SendNotification</code><code class="p">(</code><code class="n">svc</code> <code class="n">service</code><code class="o">.</code><code class="n">Notifier</code><code class="p">,</code> <code class="n">to</code><code class="p">,</code> <code class="n">notification</code> <code class="n">string</code><code class="p">)</code> <code class="n">error</code> <code class="p">{</code>
<code class="linenos"> 7 </code>    <code class="k">return</code> <code class="n">svc</code><code class="o">.</code><code class="n">Notify</code><code class="p">(</code><code class="n">to</code><code class="p">,</code> <code class="n">notification</code><code class="p">)</code>
<code class="linenos"> 8 </code><code class="p">}</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">11 </code>    <code class="o">//</code> <code class="n">create</code> <code class="n">a</code> <code class="n">service</code>
<code class="linenos">12 </code>    <code class="n">notifySvc</code> <code class="o">:=</code> <code class="o">&amp;</code><code class="n">notifications</code><code class="o">.</code><code class="n">NotifyService</code><code class="p">{}</code>
<code class="linenos">13 </code>    <code class="n">_</code> <code class="o">=</code> <code class="n">SendNotification</code><code class="p">(</code><code class="n">notifySvc</code><code class="p">,</code> <code class="s2">"Joe Blogs"</code><code class="p">,</code> <code class="s2">"Hello there!"</code><code class="p">)</code>
<code class="linenos">14 </code><code class="p">}</code>
</pre></div>

</figure>


<p>That process should feel familiar. It’s mostly the same as in the last section. We’ve already improved our code by making it more flexible. For example, should the business decide to use an alternative notifications service it would be straightforward to add.</p>

<p>But, that’s not our goal here. We want to test the code, and the changes we’ve just made, mean it’s significantly easier to do this too.</p>

<p>Rather than add an additional <i>real</i> notifications service, we’re going to add a mock notifications service. We’ll create it in the same notifications package we used for the real implementation.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 104 - Creating a mock notifications service</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">notifications</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="o">//</code> <code class="n">MockNotifyService</code> <code class="n">provides</code> <code class="k">for</code> <code class="n">sending</code> <code class="n">test</code> <code class="n">notifications</code>
<code class="linenos"> 4 </code><code class="n">type</code> <code class="n">MockNotifyService</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 5 </code>    <code class="n">sent</code> <code class="p">[][]</code><code class="n">string</code>
<code class="linenos"> 6 </code><code class="p">}</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="o">//</code> <code class="n">Notify</code> <code class="n">mocks</code> <code class="n">sending</code> <code class="n">a</code> <code class="n">notification</code> 
<code class="linenos"> 9 </code><code class="k">func</code> <code class="p">(</code><code class="n">mn</code> <code class="o">*</code><code class="n">MockNotifyService</code><code class="p">)</code> <code class="n">Notify</code> <code class="p">(</code><code class="n">to</code> <code class="n">string</code><code class="p">,</code> <code class="n">notification</code> <code class="n">string</code><code class="p">)</code> <code class="n">error</code> <code class="p">{</code>
<code class="linenos">10 </code>    <code class="n">mn</code><code class="o">.</code><code class="n">sent</code> <code class="o">=</code> <code class="n">append</code><code class="p">(</code><code class="n">mn</code><code class="o">.</code><code class="n">sent</code><code class="p">,</code> <code class="p">[]</code><code class="n">string</code><code class="p">{</code><code class="n">to</code><code class="p">,</code> <code class="n">notification</code><code class="p">})</code>
<code class="linenos">11 </code>    <code class="k">return</code> <code class="n">nil</code>
<code class="linenos">12 </code><code class="p">}</code>
</pre></div>

</figure>


<p>The mock service doesn’t make a call to the <code>makeCallToAPI()</code> helper function. Instead, it uses a slice to store any notifications which would have been sent.</p>

<p>Now we can update the unit test.  We create a pointer to a mock service and pass it as an argument to <code>SendNotification()</code> instead of the real service. </p>

<p>To verify that we did indeed send a test message, we check that an element has been added to the <code>sent</code> slice.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 105 - A better unit test</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code> 
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="k">func</code> <code class="n">TestSendNotification</code><code class="p">(</code><code class="n">t</code> <code class="o">*</code><code class="n">testing</code><code class="o">.</code><code class="n">T</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 4 </code>	<code class="n">tstSvc</code> <code class="p">:</code><code class="o">=</code> <code class="o">&amp;</code><code class="n">notifications</code><code class="o">.</code><code class="n">MockNotifyService</code><code class="p">{}</code>
<code class="linenos"> 5 </code>	<code class="k">if</code> <code class="n">err</code> <code class="p">:</code><code class="o">=</code> <code class="n">SendNotification</code><code class="p">(</code><code class="n">tstSvc</code><code class="p">,</code> <code class="s2">"Test Joe Blogs"</code><code class="p">,</code> <code class="s2">"Test message"</code><code class="p">);</code> <code class="n">err</code> <code class="o">!=</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos"> 6 </code>		<code class="n">t</code><code class="o">.</code><code class="n">Fatalf</code><code class="p">(</code><code class="s2">"Something went wrong, unexpected error: %v"</code><code class="p">,</code> <code class="n">err</code><code class="p">)</code>
<code class="linenos"> 7 </code>	<code class="p">}</code>
<code class="linenos"> 8 </code>	<code class="k">if</code> <code class="n">len</code><code class="p">(</code><code class="n">tstSvc</code><code class="o">.</code><code class="n">sent</code><code class="p">)</code> <code class="o">!=</code> <code class="mi">1</code> <code class="p">{</code>
<code class="linenos"> 9 </code>		<code class="n">t</code><code class="o">.</code><code class="n">Errorf</code><code class="p">(</code><code class="s2">"expected 1 notification, got </code><code class="si">%d</code><code class="s2">"</code><code class="p">,</code> <code class="n">len</code><code class="p">(</code><code class="n">tstSvc</code><code class="o">.</code><code class="n">sent</code><code class="p">))</code>
<code class="linenos">10 </code>	<code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code>	<code class="o">//</code> <code class="n">check</code> <code class="n">that</code> <code class="n">we</code> <code class="n">stored</code> <code class="n">the</code> <code class="n">expected</code> <code class="n">data</code>
<code class="linenos">13 </code><code class="p">}</code>
</pre></div>

</figure>


<p>Don’t worry if the syntax of the unit test is confusing, we’ll come back to testing later when we discuss quality assurance. </p>

<p>We could go further with the test, and perhaps verify that the data stored in <code>sent</code> matches what was used in the test. This would confirm that we’re passing and handling the correct parameters in the service. You can add that piece to the test yourself if you wish.</p>

<h3 id="leanpub-auto-when-to-add-interfaces" class="subsection">9.4.4 When to add interfaces</h3>

<p>Unless we are certain that interfaces will improve our application, they shouldn’t be our starting point.  Notice, how in both the storage and unit test scenarios, the usecase for interfaces was identified after the application already existed. Consequently, the behaviour we needed to abstract was <i>fairly</i> obvious to us.</p>

<p>If we attempt to build our application around interfaces from the start, there a risk we add complexity which isn’t ever justified - what if the business never asks for another storage type, or we could pass a different API key and use a test notifications API?</p>

<p>Did we <i>really</i> need an interface to provide a mock? The modifications we made were as much about being able to inject our dependencies so that we can swap them, as interfaces specifically.</p>

<p>Why not leverage the typed nature of functions and inject the <code>makeCallToAPI()</code> function?  Then simply mock that as in the examples below?</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 106 - Injecting makeCallToAPI()</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="o">//</code> <code class="n">SendNotification</code> <code class="n">sends</code> <code class="n">a</code> <code class="n">notification</code> <code class="n">using</code> <code class="n">the</code> <code class="n">external</code> <code class="n">notification</code> <code class="n">API</code><code class="o">.</code>
<code class="linenos"> 6 </code><code class="n">func</code> <code class="n">SendNotification</code><code class="p">(</code><code class="n">provider</code> <code class="n">func</code><code class="p">(</code><code class="n">string</code><code class="p">,</code> <code class="n">string</code><code class="p">)</code> <code class="n">error</code><code class="p">,</code> <code class="n">to</code><code class="p">,</code> <code class="n">notification</code> <code class="n">string</code><code class="p">)</code> \
<code class="linenos"> 7 </code><code class="n">error</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="k">if</code> <code class="n">err</code> <code class="o">:=</code> <code class="n">provider</code><code class="p">(</code><code class="n">to</code><code class="p">,</code> <code class="n">notification</code><code class="p">);</code> <code class="n">err</code> <code class="o">!=</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos"> 9 </code>		<code class="k">return</code> <code class="n">err</code>
<code class="linenos">10 </code>	<code class="p">}</code>
<code class="linenos">11 </code>	<code class="k">return</code> <code class="n">nil</code>
<code class="linenos">12 </code><code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="o">//</code> <code class="n">helper</code> <code class="n">to</code> <code class="n">make</code> <code class="n">the</code> <code class="n">REST</code> <code class="n">call</code> <code class="n">to</code> <code class="n">API</code> <code class="n">to</code> <code class="n">send</code> <code class="n">notification</code>
<code class="linenos">15 </code><code class="n">func</code> <code class="n">makeCallToAPI</code><code class="p">(</code><code class="n">to</code><code class="p">,</code> <code class="n">notification</code> <code class="n">string</code><code class="p">)</code> <code class="n">error</code> <code class="p">{</code>
<code class="linenos">16 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">to</code><code class="p">,</code> <code class="n">notification</code><code class="p">)</code>
<code class="linenos">17 </code>	<code class="k">return</code> <code class="n">nil</code>
<code class="linenos">18 </code><code class="p">}</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">21 </code>	<code class="n">_</code> <code class="o">=</code> <code class="n">SendNotification</code><code class="p">(</code><code class="n">makeCallToAPI</code><code class="p">,</code> <code class="s2">"Joe Blogs"</code><code class="p">,</code> <code class="s2">"Hello there!"</code><code class="p">)</code>
<code class="linenos">22 </code><code class="p">}</code>
</pre></div>

</figure>



<figure class="code with-caption" dir="ltr">
  <figcaption>Example 107 - An alternative mock and unit test</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"testing"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">var</code> <code class="n">sent</code> <code class="p">[][]</code><code class="n">string</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="o">//</code> <code class="n">Notify</code> <code class="n">mocks</code> <code class="n">sending</code> <code class="n">a</code> <code class="n">notification</code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">mockCallToAPI</code> <code class="p">(</code><code class="n">to</code> <code class="n">string</code><code class="p">,</code> <code class="n">notification</code> <code class="n">string</code><code class="p">)</code> <code class="n">error</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">sent</code> <code class="o">=</code> <code class="n">make</code><code class="p">([][]</code><code class="n">string</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code> <code class="o">//</code> <code class="n">reset</code> <code class="n">the</code> <code class="nb">slice</code>
<code class="linenos">10 </code>	<code class="n">sent</code> <code class="o">=</code> <code class="n">append</code><code class="p">(</code><code class="n">sent</code><code class="p">,</code> <code class="p">[]</code><code class="n">string</code><code class="p">{</code><code class="n">to</code><code class="p">,</code> <code class="n">notification</code><code class="p">})</code>
<code class="linenos">11 </code>	<code class="k">return</code> <code class="n">nil</code>
<code class="linenos">12 </code><code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="n">func</code> <code class="n">TestSendNotification</code><code class="p">(</code><code class="n">t</code> <code class="o">*</code><code class="n">testing</code><code class="o">.</code><code class="n">T</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">15 </code>	<code class="k">if</code> <code class="n">err</code> <code class="o">:=</code> <code class="n">SendNotification</code><code class="p">(</code><code class="n">mockCallToAPI</code><code class="p">,</code> <code class="s2">"Test Joe Blogs"</code><code class="p">,</code> <code class="s2">"Test message"</code><code class="p">);</code> <code class="n">err</code> <code class="o">!=</code>\
<code class="linenos">16 </code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos">17 </code>		<code class="n">t</code><code class="o">.</code><code class="n">Fatalf</code><code class="p">(</code><code class="s2">"Something went wrong, unexpected error: %v"</code><code class="p">,</code> <code class="n">err</code><code class="p">)</code>
<code class="linenos">18 </code>	<code class="p">}</code>
<code class="linenos">19 </code>	<code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="n">sent</code><code class="p">)</code> <code class="o">!=</code> <code class="mi">1</code> <code class="p">{</code>
<code class="linenos">20 </code>		<code class="n">t</code><code class="o">.</code><code class="n">Errorf</code><code class="p">(</code><code class="s2">"expected 1 notification, got </code><code class="si">%d</code><code class="s2">"</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="n">sent</code><code class="p">))</code>
<code class="linenos">21 </code>	<code class="p">}</code>
<code class="linenos">22 </code><code class="p">}</code>
</pre></div>

</figure>


<p>By attempting to build using interfaces too soon, we also risk creating the wrong abstractions, because there is no existing concrete implementation to use for reference.</p>

<p>We <i>could</i> end up rewriting code if we make early assumptions about the abstractions we need, which then later prove to be incorrect.</p>

<h3 id="leanpub-auto-summary" class="subsection">9.4.5 Summary</h3>

<p>That concludes our discussion on interfaces though we will touch on them again shortly when discussing both <i>type assertion</i> and <i>generics</i>. </p>

<p>In this section, we’ve compounded our knowledge of interfaces. We developed two solid examples which demonstrate how we refactor concrete implementations into abstractions using interfaces, and we’ve shown the value of interfaces in general.</p>

<p>But, we also know the risks of trying to implement interfaces prematurely, and, though the testing scenario was an excellent use case for interfaces, we saw it wasn’t the <i>interface</i> itself that made the code simple to test, but the dependency injection pattern we applied, which enabled us to substitute mock dependencies <i>during</i> testing.</p>

<h2 id="leanpub-auto-type-assertion-and-reflection" class="section">9.5 Type assertion and reflection</h2>

<p>During program execution, we may need to inspect and manipulate values of unknown type or work with concrete types represented by interface values. To do this, we can use techniques like <i>type assertion</i> and <i>reflection</i>.</p>

<h3 id="leanpub-auto-type-assertion" class="subsection">9.5.1 Type assertion</h3>

<p>Type assertion is a method for verifying the underlying type of an interface value. It allows for checking if a variable is of a specific concrete type, and if it is, obtaining a copy of its value as that type. We’re then able to work with the concrete value, not the interface value.</p>

<p>In the example below, we have a simple struct with one <code>Greeting</code> field. It satisfies <code>MyInterface</code>, so we can assign the struct value to the interface. </p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 108 - Type assertion provides the concrete type</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nb">type</code> <code class="n">MyInterface</code> <code class="n">interface</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">Do</code><code class="p">()</code> <code class="n">error</code>
<code class="linenos"> 7 </code><code class="p">}</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="nb">type</code> <code class="n">MyStruct</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="n">Greeting</code> <code class="n">string</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="n">func</code> <code class="p">(</code><code class="n">ms</code> <code class="n">MyStruct</code><code class="p">)</code> <code class="n">Do</code><code class="p">()</code> <code class="n">error</code> <code class="p">{</code>
<code class="linenos">14 </code>	<code class="k">return</code> <code class="n">nil</code>
<code class="linenos">15 </code><code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">18 </code>	<code class="n">var</code> <code class="n">x</code> <code class="n">MyInterface</code>
<code class="linenos">19 </code>	<code class="n">x</code> <code class="o">=</code> <code class="n">MyStruct</code><code class="p">{</code><code class="n">Greeting</code><code class="p">:</code> <code class="s2">"Hello"</code><code class="p">}</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code>	<code class="o">//</code> <code class="n">cannot</code> <code class="n">access</code> <code class="n">the</code> <code class="n">concrete</code> <code class="nb">type</code><code class="p">,</code> <code class="err">`</code><code class="n">Greeting</code><code class="err">`</code> <code class="n">field</code> <code class="ow">is</code> <code class="ow">not</code> <code class="n">visible</code>
<code class="linenos">22 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"This will generate compilation error"</code><code class="p">,</code> <code class="n">x</code><code class="o">.</code><code class="n">Greeting</code><code class="p">)</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code>	<code class="o">//</code> <code class="n">perform</code> <code class="nb">type</code> <code class="n">assertion</code>
<code class="linenos">25 </code>	<code class="n">y</code> <code class="o">:=</code> <code class="n">x</code><code class="o">.</code><code class="p">(</code><code class="n">MyStruct</code><code class="p">)</code>
<code class="linenos">26 </code>
<code class="linenos">27 </code>	<code class="o">//</code> <code class="n">we</code> <code class="n">can</code> <code class="n">now</code> <code class="n">access</code> <code class="n">the</code> <code class="n">structs</code> <code class="n">fields</code>
<code class="linenos">28 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"'Greeting' set to: </code><code class="si">%s</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">y</code><code class="o">.</code><code class="n">Greeting</code><code class="p">)</code>
<code class="linenos">29 </code><code class="p">}</code>
<code class="linenos">30 </code>
<code class="linenos">31 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">n9njIiD7Kk1</code>
</pre></div>

</figure>


<p>Output: </p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>./prog.go:22:56: x.Greeting undefined <code class="o">(</code><code class="nb">type</code> MyInterface has no field or method Greet<code class="se">\</code>
<code class="linenos">2 </code>ing<code class="o">)</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code>Go build failed.
</pre></div>

</figure>


<p>However, since interfaces only define behaviour and not state, we cannot access the <code>Greeting</code> field via the interface. We get a compilation error when we try.</p>

<p>Comment out line 22 and run the example again. We perform a type assertion, asserting the type is <code>MyStruct</code>.  The assertion is correct, so variable <code>y</code> receives a copy of the <code>MyStruct</code> value. With this concrete value, we can now access its receivers and fields.</p>

<p>An improperly constructed type assertion may introduce the risk of a runtime panic should the assertion fail - meaning the interface value does not hold the asserted concrete type.</p>

<p>For example, the following code will compile as expected but will panic when the program is run, since the type assertion cannot succeed. Type assertions are runtime, and not compile-time, checks.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 109 - Invalid type assertion, compiles but will panic</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="k">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 4 </code>	<code class="k">var</code> <code class="n">i</code> <code class="n">interface</code><code class="p">{}</code>
<code class="linenos"> 5 </code>	<code class="n">i</code> <code class="o">=</code> <code class="s2">"this is a string"</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code>	<code class="o">//</code> <code class="n">we</code> <code class="nb">assert</code> <code class="n">the</code> <code class="n">interface</code> <code class="n">contains</code> <code class="n">a</code> <code class="n">integer</code> <code class="n">value</code>
<code class="linenos"> 8 </code>	<code class="n">x</code> <code class="p">:</code><code class="o">=</code> <code class="n">i</code><code class="o">.</code><code class="p">(</code><code class="nb nb-Type">int</code><code class="p">)</code>
<code class="linenos"> 9 </code>	<code class="n">_</code> <code class="o">=</code> <code class="n">x</code>
<code class="linenos">10 </code><code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">j3egltwQKPo</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>panic: interface conversion: interface <code class="o">{}</code> is string, not int
</pre></div>

</figure>


<p>Fortunately, Go has us covered. A type assertion returns a second, <i>boolean</i> value, which indicates the success or failure of the operation. We should always handle this second value in our code to avoid a panic.</p>

<p>In the next example, the previous code has been rewritten to avoid the panic risk. Now when the type assertion fails, <code>x</code> contains its initialised <i>zero value</i>, which is <code>0</code>.  Of course, in production, this may not be ideal either, and we may still choose to log the error and shut down the program rather than allow execution to continue. </p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 110 - Safely performing a type assertion</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">var</code> <code class="n">i</code> <code class="n">interface</code><code class="p">{}</code>
<code class="linenos"> 7 </code>	<code class="n">i</code> <code class="o">=</code> <code class="s2">"this is a string"</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>	<code class="o">//</code> <code class="n">we</code> <code class="k">assert</code> <code class="n">that</code> <code class="n">it</code> <code class="ow">is</code> <code class="ow">in</code> <code class="n">interface</code> <code class="n">contains</code> <code class="n">an</code> <code class="n">integer</code> <code class="n">value</code>
<code class="linenos">10 </code>	<code class="n">x</code><code class="p">,</code> <code class="n">ok</code> <code class="o">:=</code> <code class="n">i</code><code class="o">.</code><code class="p">(</code><code class="nb">int</code><code class="p">)</code>
<code class="linenos">11 </code>	<code class="k">if</code> <code class="n">ok</code> <code class="p">{</code>
<code class="linenos">12 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"We have an integer of: </code><code class="si">%d</code><code class="s2">"</code><code class="p">,</code> <code class="n">x</code><code class="p">)</code>
<code class="linenos">13 </code>	<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="linenos">14 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"We don't have an integer, setting to zero value: </code><code class="si">%d</code><code class="s2">"</code><code class="p">,</code> <code class="n">x</code><code class="p">)</code>
<code class="linenos">15 </code>	<code class="p">}</code>
<code class="linenos">16 </code><code class="p">}</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">3</code><code class="n">jfW7_hkRjM</code>
</pre></div>

</figure>


<p>Since interfaces can be satisfied by many types, we often can’t assert that the interface value holds a single type. So, in this situation we can use a special <i>type switch</i> assertion to determine which, of any number of concrete types, is contained in the interface value.</p>

<p>A <i>type switch</i> style of assertion also allows us to provide a <i>default</i> case which is useful should the interface hold an unexpected type. Note, that a type switch assertion will not panic, even if no default case statement is supplied. </p>

<p>The code in the example below demonstrates a <i>type switch</i> style assertion.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 111 - Type switch style assertion with default case</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">var</code> <code class="n">i</code> <code class="n">interface</code><code class="p">{}</code> <code class="o">=</code> <code class="s2">"hello"</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code>	<code class="n">switch</code> <code class="n">v</code> <code class="o">:=</code> <code class="n">i</code><code class="o">.</code><code class="p">(</code><code class="nb">type</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">case</code> <code class="nb">int</code><code class="p">:</code>
<code class="linenos">10 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"i is an int with value %v</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">v</code><code class="p">)</code>
<code class="linenos">11 </code>	<code class="n">case</code> <code class="n">string</code><code class="p">:</code>
<code class="linenos">12 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"i is a string with value %v</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">v</code><code class="p">)</code>
<code class="linenos">13 </code>	<code class="n">default</code><code class="p">:</code>
<code class="linenos">14 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"i is of an unknown type with value %v</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">v</code><code class="p">)</code>
<code class="linenos">15 </code>	<code class="p">}</code>
<code class="linenos">16 </code><code class="p">}</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">0</code><code class="n">ovjw0QFJtL</code>
</pre></div>

</figure>


<p>So, in summary, <i>type assertion</i> is used when we know the concrete type stored in the interface value at compile time, and we want to get and use the underlying value during runtime. It could be a single type in the interface or one of several types which satisfy that interface. Correctly used, type assertion can provide a safe and performant conversion of the abstract interface value into its concrete type.</p>

<h3 id="leanpub-auto-reflection" class="subsection">9.5.2 Reflection</h3>

<p>Reflection allows us to inspect the <i>type</i> and <i>value</i> of a variable at runtime.</p>

<p>We use the standard library’s <i>reflect</i> package to obtain information about a variable. We’re also able to manipulate the variable, for instance calling its receivers and updating its fields, using the same <i>reflect</i> package.</p>

<aside class="information blurb">
    <p>Note, only exported struct fields are accessible using reflection. Attempting to access an unexported field will result in a panic.</p>

</aside>

<p>Let’s now look at a few common applications of the reflect package. In this first example we use reflection to discover the type of a variable.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 112 - Discover the type of a variable</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"reflect"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">x</code> <code class="o">:=</code> <code class="s2">"hello"</code>
<code class="linenos">10 </code>	<code class="n">t</code> <code class="o">:=</code> <code class="n">reflect</code><code class="o">.</code><code class="n">TypeOf</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>
<code class="linenos">11 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">t</code><code class="p">)</code>
<code class="linenos">12 </code><code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">HFJswkAEnB5</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>string
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>Next, we’ll use reflection to inspect a variable to determine if it holds a value or a pointer.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 113 - Does a variable hold a value or a pointer?</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"reflect"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">x</code> <code class="o">:=</code> <code class="s2">"hello"</code> <code class="o">//</code> <code class="n">value</code>
<code class="linenos">10 </code>	<code class="n">y</code> <code class="o">:=</code> <code class="o">&amp;</code><code class="n">x</code>      <code class="o">//</code> <code class="n">pointer</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code>	<code class="n">v1</code> <code class="o">:=</code> <code class="n">reflect</code><code class="o">.</code><code class="n">ValueOf</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>
<code class="linenos">13 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"x is pointer:"</code><code class="p">,</code> <code class="n">v1</code><code class="o">.</code><code class="n">Kind</code><code class="p">()</code> <code class="o">==</code> <code class="n">reflect</code><code class="o">.</code><code class="n">Ptr</code><code class="p">)</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code>	<code class="n">v2</code> <code class="o">:=</code> <code class="n">reflect</code><code class="o">.</code><code class="n">ValueOf</code><code class="p">(</code><code class="n">y</code><code class="p">)</code>
<code class="linenos">16 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"y is a pointer:"</code><code class="p">,</code> <code class="n">v2</code><code class="o">.</code><code class="n">Kind</code><code class="p">()</code> <code class="o">==</code> <code class="n">reflect</code><code class="o">.</code><code class="n">Ptr</code><code class="p">)</code>
<code class="linenos">17 </code><code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">Y7p3BSuVGjN</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>x is pointer: <code class="nb">false</code>
<code class="linenos">2 </code>y is a pointer: <code class="nb">true</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<p>In this third example, we’re going to use reflection to work with both the exported fields and receivers of a struct.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 114 - Working with struct fields and receivers</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"reflect"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="nb">type</code> <code class="n">Person</code> <code class="n">struct</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">Age</code> <code class="nb">int</code>
<code class="linenos">10 </code><code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="n">func</code> <code class="p">(</code><code class="n">m</code> <code class="o">*</code><code class="n">Person</code><code class="p">)</code> <code class="n">SayHello</code><code class="p">(</code><code class="n">name</code> <code class="n">string</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">13 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Hello </code><code class="si">%s</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">name</code><code class="p">)</code>
<code class="linenos">14 </code><code class="p">}</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">17 </code>	<code class="n">p</code> <code class="o">:=</code> <code class="o">&amp;</code><code class="n">Person</code><code class="p">{</code><code class="n">Age</code><code class="p">:</code> <code class="mi">22</code><code class="p">}</code>
<code class="linenos">18 </code>	<code class="n">v</code> <code class="o">:=</code> <code class="n">reflect</code><code class="o">.</code><code class="n">ValueOf</code><code class="p">(</code><code class="n">p</code><code class="p">)</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code>	<code class="o">//</code> <code class="n">call</code> <code class="n">the</code> <code class="n">receiver</code><code class="o">/</code><code class="n">method</code> <code class="k">with</code> <code class="n">argument</code>
<code class="linenos">21 </code>	<code class="n">sayHello</code> <code class="o">:=</code> <code class="n">v</code><code class="o">.</code><code class="n">MethodByName</code><code class="p">(</code><code class="s2">"SayHello"</code><code class="p">)</code>
<code class="linenos">22 </code>	<code class="n">name</code> <code class="o">:=</code> <code class="n">reflect</code><code class="o">.</code><code class="n">ValueOf</code><code class="p">(</code><code class="s2">"Joe Blogs"</code><code class="p">)</code>
<code class="linenos">23 </code>	<code class="n">sayHello</code><code class="o">.</code><code class="n">Call</code><code class="p">([]</code><code class="n">reflect</code><code class="o">.</code><code class="n">Value</code><code class="p">{</code><code class="n">reflect</code><code class="o">.</code><code class="n">Value</code><code class="p">(</code><code class="n">name</code><code class="p">)})</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code>	<code class="o">//</code> <code class="n">access</code> <code class="n">the</code> <code class="n">Age</code> <code class="n">field</code><code class="p">,</code> <code class="ow">and</code> <code class="n">change</code> <code class="n">it</code>
<code class="linenos">26 </code>	<code class="n">age</code> <code class="o">:=</code> <code class="n">v</code><code class="o">.</code><code class="n">Elem</code><code class="p">()</code><code class="o">.</code><code class="n">FieldByName</code><code class="p">(</code><code class="s2">"Age"</code><code class="p">)</code>
<code class="linenos">27 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Current age:"</code><code class="p">,</code> <code class="n">age</code><code class="o">.</code><code class="n">Int</code><code class="p">())</code>
<code class="linenos">28 </code>	<code class="n">age</code><code class="o">.</code><code class="n">SetInt</code><code class="p">(</code><code class="mi">42</code><code class="p">)</code>
<code class="linenos">29 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"New age:"</code><code class="p">,</code> <code class="n">age</code><code class="o">.</code><code class="n">Int</code><code class="p">())</code>
<code class="linenos">30 </code><code class="p">}</code>
<code class="linenos">31 </code>
<code class="linenos">32 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">D1GKlMeHs0V</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Hello Joe Blogs
<code class="linenos">2 </code>Current age: <code class="m">22</code>
<code class="linenos">3 </code>New age: <code class="m">42</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code>Program exited.
</pre></div>

</figure>


<p>As we can see, reflection is a powerful tool. Some tasks would not be possible without the dynamic type checking provided by reflection, but remember, with great power comes great responsibility.</p>

<p>Reflection adds significant complexity, making our code harder to read and understand, but it also has a performance cost.</p>

<p>Reflection is slower than direct access because it involves checking and converting between different types. Reflection uses heap memory, and allocations on the heap must be managed by the garbage collector. In tight or high iteration loops, the impact of reflection on speed and memory may be significant.</p>

<p>The following simple example compares the speed of direct variable access, with access via reflection.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 115 - Speed of direct access vs reflection</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"reflect"</code>
<code class="linenos"> 6 </code>	<code class="s2">"time"</code>
<code class="linenos"> 7 </code><code class="p">)</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">var</code> <code class="n">i</code> <code class="nb">int</code> <code class="o">=</code> <code class="mi">42</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="n">func</code> <code class="n">DirectAccess</code><code class="p">()</code> <code class="n">time</code><code class="o">.</code><code class="n">Duration</code> <code class="p">{</code>
<code class="linenos">12 </code>	<code class="n">start</code> <code class="o">:=</code> <code class="n">time</code><code class="o">.</code><code class="n">Now</code><code class="p">()</code>
<code class="linenos">13 </code>	<code class="k">for</code> <code class="n">j</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">j</code> <code class="o">&lt;</code> <code class="mi">100000</code><code class="p">;</code> <code class="n">j</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos">14 </code>		<code class="n">val</code> <code class="o">:=</code> <code class="n">i</code>
<code class="linenos">15 </code>		<code class="n">_</code> <code class="o">=</code> <code class="n">val</code>
<code class="linenos">16 </code>	<code class="p">}</code>
<code class="linenos">17 </code>	<code class="n">elapsed</code> <code class="o">:=</code> <code class="n">time</code><code class="o">.</code><code class="n">Since</code><code class="p">(</code><code class="n">start</code><code class="p">)</code>
<code class="linenos">18 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Direct variable access: </code><code class="si">%s</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">elapsed</code><code class="p">)</code>
<code class="linenos">19 </code>	<code class="k">return</code> <code class="n">elapsed</code>
<code class="linenos">20 </code><code class="p">}</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code><code class="n">func</code> <code class="n">ReflectAccess</code><code class="p">()</code> <code class="n">time</code><code class="o">.</code><code class="n">Duration</code> <code class="p">{</code>
<code class="linenos">23 </code>	<code class="n">start</code> <code class="o">:=</code> <code class="n">time</code><code class="o">.</code><code class="n">Now</code><code class="p">()</code>
<code class="linenos">24 </code>	<code class="k">for</code> <code class="n">j</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">j</code> <code class="o">&lt;</code> <code class="mi">100000</code><code class="p">;</code> <code class="n">j</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos">25 </code>		<code class="n">val</code> <code class="o">:=</code> <code class="n">reflect</code><code class="o">.</code><code class="n">ValueOf</code><code class="p">(</code><code class="n">i</code><code class="p">)</code>
<code class="linenos">26 </code>		<code class="n">_</code> <code class="o">=</code> <code class="n">val</code>
<code class="linenos">27 </code>	<code class="p">}</code>
<code class="linenos">28 </code>	<code class="n">elapsed</code> <code class="o">:=</code> <code class="n">time</code><code class="o">.</code><code class="n">Since</code><code class="p">(</code><code class="n">start</code><code class="p">)</code>
<code class="linenos">29 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Access using reflection: </code><code class="si">%s</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">elapsed</code><code class="p">)</code>
<code class="linenos">30 </code>	<code class="k">return</code> <code class="n">elapsed</code>
<code class="linenos">31 </code><code class="p">}</code>
<code class="linenos">32 </code>
<code class="linenos">33 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">34 </code>	<code class="n">elapsed1</code> <code class="o">:=</code> <code class="n">DirectAccess</code><code class="p">()</code>
<code class="linenos">35 </code>	<code class="n">elapsed2</code> <code class="o">:=</code> <code class="n">ReflectAccess</code><code class="p">()</code>
<code class="linenos">36 </code>	<code class="n">inc</code> <code class="o">:=</code> <code class="p">((</code><code class="n">elapsed2</code> <code class="o">-</code> <code class="n">elapsed1</code><code class="p">)</code> <code class="o">/</code> <code class="n">elapsed1</code><code class="p">)</code> <code class="o">*</code> <code class="mi">100</code>
<code class="linenos">37 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Reflection takes </code><code class="si">%d%%</code><code class="s2"> longer than direct access"</code><code class="p">,</code> <code class="n">inc</code><code class="p">)</code>
<code class="linenos">38 </code><code class="p">}</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Direct variable access: <code class="m">34</code>.685µs
<code class="linenos">2 </code>Access using reflection: <code class="m">314</code>.971µs
<code class="linenos">3 </code>Reflection takes <code class="m">800</code>% longer than direct access%    
</pre></div>

</figure>


<h2 id="leanpub-auto-introducing-generics" class="section">9.6 Introducing Generics</h2>

<p><i>Generics</i> are a feature in most statically typed programming languages. Generics, or generic programming, allows us to write more reusable code by abstracting types away. It provides a way to reduce duplication, which would otherwise arise when writing functionality compatible with more than just a single type.</p>

<p>Go wasn’t designed with support for generics but after much debate over several years, generics support was added to the language in version 1.18.</p>

<p>Mechanically, generics enable us to write code with values whose type can be specified later at the point of use, while maintaining type safety using syntax to place constraints on which types may be accepted.</p>

<p>In a later section we will examine generics in detail, and through several examples, we’ll learn how to do generic programming in Go.</p>

<p>But first we need to understand the problem, which is essentially a side-effect of <i>static typing</i>.</p>

<h3 id="leanpub-auto-before-generics" class="subsection">9.6.1 Before generics</h3>

<p>Consider the simple <code>sumInt64()</code> function in the following example. It’s designed to add two integers of the <i>int64</i> type. An unremarkable, trivial function.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 116 - Adding two <i>int64</i> integers</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">sumInt64</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code> <code class="n">int64</code><code class="p">)</code> <code class="n">int64</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="k">return</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code>
<code class="linenos"> 7 </code><code class="p">}</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">sumInt64</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">))</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">XDU49bgxRs_j</code>
</pre></div>

</figure>


<p>The problem is that its parameter and return typing mean it can only add <i>int64</i> types. </p>

<p>But, we can’t count on all integers being of this type, so what do we do when we need to add <i>int8</i>, <i>int16</i>, or <i>int32</i> typed integers? </p>

<p>One obvious approach is to duplicate the same function three more times, one for each integer type that we’ll need to add. </p>

<p>In the following example, we implement those new functions. Notice, that the function body is always the same, only the <i>parameter</i> and <i>return</i> types are different.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 117 - Adding other integer types</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">sumInt8</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code> <code class="n">int8</code><code class="p">)</code> <code class="n">int8</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="k">return</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code>
<code class="linenos"> 7 </code><code class="p">}</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">func</code> <code class="n">sumInt16</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code> <code class="n">int16</code><code class="p">)</code> <code class="n">int16</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="k">return</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="n">func</code> <code class="n">sumInt32</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code> <code class="n">int32</code><code class="p">)</code> <code class="n">int32</code> <code class="p">{</code>
<code class="linenos">14 </code>	<code class="k">return</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code>
<code class="linenos">15 </code><code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="n">func</code> <code class="n">sumInt64</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code> <code class="n">int64</code><code class="p">)</code> <code class="n">int64</code> <code class="p">{</code>
<code class="linenos">18 </code>	<code class="k">return</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code>
<code class="linenos">19 </code><code class="p">}</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">22 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">sumInt8</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">))</code>
<code class="linenos">23 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">sumInt16</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">))</code>
<code class="linenos">24 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">sumInt32</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">))</code>
<code class="linenos">25 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">sumInt64</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">))</code>
<code class="linenos">26 </code><code class="p">}</code>
<code class="linenos">27 </code>
<code class="linenos">28 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">Q3SzagyF</code><code class="o">-</code><code class="n">CS</code>
</pre></div>

</figure>


<p>With the function duplicated, we can now add any integer type, which is great, but it does feel a bit awkward. All that duplication just to add two numbers?</p>

<p>Perhaps there is another way to solve the problem.</p>

<p>Well, there is/was. Before Go 1.18 we could already use a <i>form</i> of generic programming with <i>interfaces</i>. By using the empty interface specifically, rather than duplicating the function as we did in the previous example, we could write a single implementation that accepts the <code>interface{}</code> type as parameters and then performs a <i>type switch</i> on the arguments to determine how to handle them. </p>

<p>This approach has drawbacks too, which we will come to, but first, let’s look at how we could write a single function that could add any pair of same typed integers.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 118 - A single sumIntAny implementation</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"errors"</code>
<code class="linenos"> 5 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 6 </code>	<code class="s2">"reflect"</code>
<code class="linenos"> 7 </code><code class="p">)</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">func</code> <code class="n">sumIntAny</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code> <code class="n">interface</code><code class="p">{})</code> <code class="p">(</code><code class="n">interface</code><code class="p">{},</code> <code class="n">error</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="k">if</code> <code class="n">reflect</code><code class="o">.</code><code class="n">TypeOf</code><code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">!=</code> <code class="n">reflect</code><code class="o">.</code><code class="n">TypeOf</code><code class="p">(</code><code class="n">y</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">11 </code>		<code class="k">return</code> <code class="n">nil</code><code class="p">,</code> <code class="n">errors</code><code class="o">.</code><code class="n">New</code><code class="p">(</code><code class="s2">"mismatched  types"</code><code class="p">)</code>
<code class="linenos">12 </code>	<code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code>	<code class="n">switch</code> <code class="n">v</code> <code class="o">:=</code> <code class="n">x</code><code class="o">.</code><code class="p">(</code><code class="nb">type</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">15 </code>	<code class="n">case</code> <code class="n">int8</code><code class="p">:</code>
<code class="linenos">16 </code>		<code class="k">return</code> <code class="n">v</code> <code class="o">+</code> <code class="n">y</code><code class="o">.</code><code class="p">(</code><code class="n">int8</code><code class="p">),</code> <code class="n">nil</code>
<code class="linenos">17 </code>	<code class="n">case</code> <code class="n">int16</code><code class="p">:</code>
<code class="linenos">18 </code>		<code class="k">return</code> <code class="n">v</code> <code class="o">+</code> <code class="n">y</code><code class="o">.</code><code class="p">(</code><code class="n">int16</code><code class="p">),</code> <code class="n">nil</code>
<code class="linenos">19 </code>	<code class="n">case</code> <code class="n">int32</code><code class="p">:</code>
<code class="linenos">20 </code>		<code class="k">return</code> <code class="n">v</code> <code class="o">+</code> <code class="n">y</code><code class="o">.</code><code class="p">(</code><code class="n">int32</code><code class="p">),</code> <code class="n">nil</code>
<code class="linenos">21 </code>	<code class="n">case</code> <code class="n">int64</code><code class="p">:</code>
<code class="linenos">22 </code>		<code class="k">return</code> <code class="n">v</code> <code class="o">+</code> <code class="n">y</code><code class="o">.</code><code class="p">(</code><code class="n">int64</code><code class="p">),</code> <code class="n">nil</code>
<code class="linenos">23 </code>	<code class="p">}</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code>	<code class="k">return</code> <code class="n">nil</code><code class="p">,</code> <code class="n">nil</code>
<code class="linenos">26 </code><code class="p">}</code>
<code class="linenos">27 </code>
<code class="linenos">28 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">29 </code>	<code class="n">res</code><code class="p">,</code> <code class="n">err</code> <code class="o">:=</code> <code class="n">sumIntAny</code><code class="p">(</code><code class="n">int8</code><code class="p">(</code><code class="mi">1</code><code class="p">),</code> <code class="n">int8</code><code class="p">(</code><code class="mi">2</code><code class="p">))</code>
<code class="linenos">30 </code>	<code class="k">if</code> <code class="n">err</code> <code class="o">!=</code> <code class="n">nil</code> <code class="p">{</code>
<code class="linenos">31 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">err</code><code class="p">)</code>
<code class="linenos">32 </code>	<code class="p">}</code>
<code class="linenos">33 </code>
<code class="linenos">34 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Result:"</code><code class="p">,</code> <code class="n">res</code><code class="p">)</code>
<code class="linenos">35 </code>	<code class="o">//</code><code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Addition:"</code><code class="p">,</code> <code class="n">res</code><code class="o">+</code><code class="n">res</code><code class="p">)</code>
<code class="linenos">36 </code><code class="p">}</code>
<code class="linenos">37 </code>
<code class="linenos">38 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">GZ0JOBSwu9_n</code>
</pre></div>

</figure>


<p>One problem is evident immediately.  The function is now significantly more complex.  </p>

<p>We need to call it by explicitly stating which integer types we are passing. We need to check that whatever values are passed are the same concrete type so we can add them, and we have an error return value in case they are not.</p>

<p>We’re using a <i>type switch</i> to handle the different types that could be represented by <code>interface{}</code> before performing the integer addition. But what if a string is passed, we don’t handle strings currently, and we should probably return an error?</p>

<p>Another problem is the return type. Without performing a type conversion, we have to return the same type as was passed. Since this can be one of four integer types, we can only represent this with the empty interface.</p>

<p>We could choose to convert to an arbitrary integer type and return that type, but which one? If the caller passes <i>int8</i> values, does it make sense to return an <i>int64</i> result?</p>

<p>So we stick with the empty interface return, but that creates friction for the caller. The calling code, must introspect the interface, probably with another <i>type switch</i>.</p>

<p>The <code>fmt.Println()</code> performs that type switch internally, which is why it can print the value held in the interface, but try uncommenting line 35 to perform the simple addition. The program won’t compile.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>./prog.go:35:27: invalid operation: operator + not defined on res <code class="o">(</code>variable of <code class="nb">type</code> <code class="se">\</code>
<code class="linenos">2 </code>interface<code class="o">{})</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code>Go build failed.
</pre></div>

</figure>


<p>So both solutions are clunky when you stop and think, but as Go developers, we’ve never known any different. This is just how it is - the price of type safety!</p>

<p>But, for other developers coming from languages which support generic programming, this is not how we should do it at all. They may find the above approaches quite naive compared to a solution based on generics.</p>

<p>Their frustration is genuine. Perhaps there is a better way?</p>

<h3 id="leanpub-auto-solving-the-problem-with-generics" class="subsection">9.6.2 Solving the problem with generics</h3>

<p>In this section, we’re going to tackle the same problem using generics. </p>

<p>We’ll start with a simple but naive example, and build on that over several more examples until we understand everything that the current implementation of generics gives us, plus what might come in later versions of Go.</p>

<aside class="information blurb">
    <p>To work with generics examples locally, you’ll need a Go version of 1.18 or above.  At the time of writing the Go Playground has Go 1.19 available, so all the examples included here, will run over there.</p>

</aside>

<p>One way a generic function differs from a normal function is that we can pass additional type parameters with constraints. </p>

<p>Think of these as placeholders for type.  The concrete type will be assigned by the compiler when the function is called. The constraint provides some hints to the compiler about what that type is allowed to be.  This means some checks are possible during compilation, and we’ll see this in action shortly.</p>

<p>The type parameters together with their constraints are passed in square braces which must immediately follow the function’s name. </p>

<p>In the snippet below we illustrate with a single type parameter and constraint. This is sufficient for our solution, but we’re not restricted to a single type parameter/constraint, and we’ll show an example of that later on.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="n">func</code> <code class="n">SumAny</code><code class="p">[</code><code class="n">T</code> <code class="n">any</code><code class="p">]</code> <code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code> <code class="n">T</code><code class="p">)</code> <code class="n">T</code> <code class="p">{</code>
<code class="linenos">2 </code>    <code class="p">...</code>
<code class="linenos">3 </code><code class="p">}</code>
</pre></div>

</figure>


<p>So how do we reason about this unusual syntax? Let’s walk through it.</p>

<p><code>T</code>, is a placeholder or <i>alias</i> for a <i>type</i>  which has the constraint <code>any</code> which means it can be any type. We could have passed the empty interface type, <code>interface{}</code> instead. </p>

<p>Both <code>x</code> and <code>y</code> parameters use the type <i>alias</i> for their type. The single return value is also using the alias. So, whatever type is passed for <code>x</code> and <code>y</code> - which must be the same - will also be the return type.</p>

<p>It’s like a template, with real types being substituted for the placeholders when they become known. </p>

<p>The capitalization of the type parameter <code>T</code> is not a requirement, but things get a little (very) confusing if we mix lowercase type parameters with variable parameters. We’re adopting the capitalization convention to improve readability. </p>

<p>Finally, <code>T</code> has no special significance, we could have used any name for the type parameter. Single letter or a semantic name. Once again, convention is good. We’ll use the single letter, just as we’ll use capitalisation.</p>

<p>So, now that we understand the semantics a little better, let’s implement that function body of the <code>SumAny()</code> function. </p>

<p>It should be straightforward enough.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 119 - A generic implementation of SumAny</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"reflect"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">SumAny</code><code class="p">[</code><code class="n">T</code> <code class="nb">any</code><code class="p">](</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code> <code class="n">T</code><code class="p">)</code> <code class="n">T</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="k">return</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code>
<code class="linenos">10 </code><code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">13 </code>	<code class="n">res</code> <code class="o">:=</code> <code class="n">SumAny</code><code class="p">(</code><code class="n">int16</code><code class="p">(</code><code class="mi">1</code><code class="p">),</code> <code class="n">int16</code><code class="p">(</code><code class="mi">2</code><code class="p">))</code>
<code class="linenos">14 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">res</code><code class="p">)</code>
<code class="linenos">15 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">reflect</code><code class="o">.</code><code class="n">TypeOf</code><code class="p">(</code><code class="n">res</code><code class="p">))</code>
<code class="linenos">16 </code><code class="p">}</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">jbzggpV7uM8</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>./prog.go:9:9: invalid operation: operator + not defined on x <code class="o">(</code>variable of <code class="nb">type</code> T co<code class="se">\</code>
<code class="linenos">2 </code>nstrained by any<code class="o">)</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code>Go build failed.
</pre></div>

</figure>


<p>It doesn’t compile. </p>

<p>The constraint we specified allows this function to accept <i>any</i> type, but not all types can be summed with the addition operator, since not all types are numbers. </p>

<p>The compiler recognises this during compilation, so this does’t introduce a panic risk fortunately. It looks like what we need instead is a constraint that accepts only <i>any</i> integer type?</p>

<p>There are two ways we can achieve this. We can use a type parameter constraint list or we can create our own constraint using an interface. </p>

<p>We’ll implement the same function again using both approaches.</p>

<p>First, let’s use a type constraint list. We need to specify all valid types for our function and we do this using a <i>pipe</i> delimited list.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"reflect"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">SumAny</code><code class="p">[</code><code class="n">T</code> <code class="n">int8</code> <code class="o">|</code> <code class="n">int32</code> <code class="o">|</code> <code class="n">int64</code> <code class="o">|</code> <code class="nb">int</code><code class="p">](</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code> <code class="n">T</code><code class="p">)</code> <code class="n">T</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="k">return</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code>
<code class="linenos">10 </code><code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">13 </code>	<code class="n">res</code> <code class="o">:=</code> <code class="n">SumAny</code><code class="p">(</code><code class="n">int16</code><code class="p">(</code><code class="mi">1</code><code class="p">),</code> <code class="n">int16</code><code class="p">(</code><code class="mi">2</code><code class="p">))</code>
<code class="linenos">14 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">res</code><code class="p">)</code>
<code class="linenos">15 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">reflect</code><code class="o">.</code><code class="n">TypeOf</code><code class="p">(</code><code class="n">res</code><code class="p">))</code>
<code class="linenos">16 </code><code class="p">}</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">yZemwfvY6ST</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>./prog.go:13:15: int16 does not implement int8<code class="p">|</code>int32<code class="p">|</code>int64<code class="p">|</code>int <code class="o">(</code>int16 missing <code class="k">in</code> int<code class="se">\</code>
<code class="linenos">2 </code><code class="m">8</code> <code class="p">|</code> int32 <code class="p">|</code> int64 <code class="p">|</code> int<code class="o">)</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code>Go build failed.
</pre></div>

</figure>


<p>Again it doesn’t build. This time, because we are passing <code>int16</code> types to the function, and we deliberately didn’t include that type in the constraint list. </p>

<p>Add it to the list and run the example again - don’t forget the pipe separator! </p>

<p>You should now see this output, and notice the return type used was <code>int16</code> too, because the type placeholder <code>T</code> became <code>int16</code> when the function was called.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="m">3</code>
<code class="linenos">2 </code>int16
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<p>We’ve just written our first generic function in Go! The function signature is <i>bit</i> harder to read, but it’s avoided us duplicating the function three or four times. Neither did we need to perform complex type switch style assertions in this single implementation. In fact the function body is the same as we started with.</p>

<p>However, we can do better.  We can create our own constraints, which are interfaces basically, and specify the types allowed for that constraint. This single act will restore order in our codebase.</p>

<aside class="information blurb">
    <p>Go has two built-in constraints <i>any</i>, which we’ve seen, and <i>comparable</i>, which allows any type which supports equality comparisons with the <code>==</code> and <code>!=</code> operators.</p>

  <p>In later releases it’s probable that the standard library will include a new <a href="https://cs.opensource.google/go/x/exp/+/a68e582f:constraints/constraints.go">constraints package</a>, which could include an <code>Integer</code> constraint, but for now, if we need to go further than <i>comparable</i> we must build the constraint ourselves.</p>

</aside>

<p>In this next example, we’ll a create custom constraint <i>Numeric</i> by moving the constraint list into a new interface type.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 121 - Creating a custom constraint</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"reflect"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="nb">type</code> <code class="n">Numeric</code> <code class="n">interface</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">int8</code> <code class="o">|</code> <code class="n">int16</code> <code class="o">|</code> <code class="n">int32</code> <code class="o">|</code> <code class="n">int64</code> <code class="o">|</code> <code class="nb">int</code>
<code class="linenos">10 </code><code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="n">func</code> <code class="n">SumAny</code><code class="p">[</code><code class="n">T</code> <code class="n">Numeric</code><code class="p">](</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code> <code class="n">T</code><code class="p">)</code> <code class="n">T</code> <code class="p">{</code>
<code class="linenos">13 </code>	<code class="k">return</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code>
<code class="linenos">14 </code><code class="p">}</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">17 </code>	<code class="n">res</code> <code class="o">:=</code> <code class="n">SumAny</code><code class="p">(</code><code class="n">int16</code><code class="p">(</code><code class="mi">1</code><code class="p">),</code> <code class="n">int16</code><code class="p">(</code><code class="mi">2</code><code class="p">))</code>
<code class="linenos">18 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">res</code><code class="p">)</code>
<code class="linenos">19 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">reflect</code><code class="o">.</code><code class="n">TypeOf</code><code class="p">(</code><code class="n">res</code><code class="p">))</code>
<code class="linenos">20 </code><code class="p">}</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">IxpNJBWPkZo</code>
</pre></div>

</figure>


<p>The output is identical to before, and the <code>SumAny()</code> function signature is simple to read again. As a bonus <i>Numeric</i> is reusable, we can avoid the constraint list in the next generic function that performs addition or subtraction, and instead use the <i>Numeric</i> constraint.</p>

<p>As you might expect, custom constraints, since they are interfaces, are composable. This allows us to build less restrictive constraints by composing from restrictive constraints.</p>

<p>In the next example, we’ll amend the code so that <code>SumAny()</code> can also perform addition on unsigned integers, a glaring omission.  But, rather than use one big constraint list, we will use composition to create the <i>Numeric</i> constraint, by creating and embedding a <i>Signed</i> and <i>Unsigned</i> constraint.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 122 - Using composition with constraints</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"reflect"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="nb">type</code> <code class="n">Numeric</code> <code class="n">interface</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">Signed</code> <code class="o">|</code> <code class="n">Unsigned</code>
<code class="linenos">10 </code><code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="nb">type</code> <code class="n">Unsigned</code> <code class="n">interface</code> <code class="p">{</code>
<code class="linenos">13 </code>	<code class="n">uint8</code> <code class="o">|</code> <code class="n">uint16</code> <code class="o">|</code> <code class="n">uint32</code> <code class="o">|</code> <code class="n">uint64</code> <code class="o">|</code> <code class="n">uint</code>
<code class="linenos">14 </code><code class="p">}</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="nb">type</code> <code class="n">Signed</code> <code class="n">interface</code> <code class="p">{</code>
<code class="linenos">17 </code>	<code class="n">int8</code> <code class="o">|</code> <code class="n">int16</code> <code class="o">|</code> <code class="n">int32</code> <code class="o">|</code> <code class="n">int64</code> <code class="o">|</code> <code class="nb">int</code>
<code class="linenos">18 </code><code class="p">}</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="n">func</code> <code class="n">SumAny</code><code class="p">[</code><code class="n">T</code> <code class="n">Numeric</code><code class="p">](</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code> <code class="n">T</code><code class="p">)</code> <code class="n">T</code> <code class="p">{</code>
<code class="linenos">21 </code>	<code class="k">return</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code>
<code class="linenos">22 </code><code class="p">}</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">25 </code>	<code class="n">res</code> <code class="o">:=</code> <code class="n">SumAny</code><code class="p">(</code><code class="n">int16</code><code class="p">(</code><code class="mi">1</code><code class="p">),</code> <code class="n">int16</code><code class="p">(</code><code class="mi">2</code><code class="p">))</code>
<code class="linenos">26 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">res</code><code class="p">)</code>
<code class="linenos">27 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">reflect</code><code class="o">.</code><code class="n">TypeOf</code><code class="p">(</code><code class="n">res</code><code class="p">))</code>
<code class="linenos">28 </code><code class="p">}</code>
<code class="linenos">29 </code>
<code class="linenos">30 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">2</code><code class="n">yARr7xNBG8</code>
</pre></div>

</figure>


<p>Kudos to the Go development team! That is incredibly elegant in its simplicity, and the way it builds on what we already know.</p>

<p>But what about custom types?</p>

<p>We can use custom types in constraint lists and constraints, just like built-in types, but Go provides a modifier we can apply to built-in types, so that any user-defined type, which is based on one of the built-in types can be allowed. </p>

<p>Let’s take our example in a slightly different direction to illustrate this.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 123 - Allow any type with underlying type <i>int</i></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"reflect"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="nb">type</code> <code class="n">OnlyInt</code> <code class="n">interface</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="nb">int</code>
<code class="linenos">10 </code>	<code class="o">//</code> <code class="o">~</code><code class="nb">int</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="nb">type</code> <code class="n">myInt</code> <code class="nb">int</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="n">func</code> <code class="n">SumAny</code><code class="p">[</code><code class="n">T</code> <code class="n">OnlyInt</code><code class="p">](</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code> <code class="n">T</code><code class="p">)</code> <code class="n">T</code> <code class="p">{</code>
<code class="linenos">16 </code>	<code class="k">return</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code>
<code class="linenos">17 </code><code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">20 </code>	<code class="n">var</code> <code class="n">myInt</code> <code class="n">myInt</code> <code class="o">=</code> <code class="mi">1</code>
<code class="linenos">21 </code>	<code class="n">res</code> <code class="o">:=</code> <code class="n">SumAny</code><code class="p">(</code><code class="n">myInt</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>
<code class="linenos">22 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">res</code><code class="p">)</code>
<code class="linenos">23 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">reflect</code><code class="o">.</code><code class="n">TypeOf</code><code class="p">(</code><code class="n">res</code><code class="p">))</code>
<code class="linenos">24 </code><code class="p">}</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">b8jNMrEtUcL</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>./prog.go:21:15: myInt does not implement OnlyInt <code class="o">(</code>possibly missing ~ <code class="k">for</code> int <code class="k">in</code> con<code class="se">\</code>
<code class="linenos">2 </code>straint OnlyInt<code class="o">)</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code>Go build failed.
</pre></div>

</figure>


<p>Once again, this code fails to compile, but the compiler message is very helpful. We are trying to pass a value of type <i>myInt</i>, a user-defined type which has the underlying type of <i>int</i>. </p>

<p>If you uncomment line 10, and comment out line 9, this tilde modifier tells the compiler that we will accept any type which has the underlying type of <i>int</i>.</p>

<p>The code should now compile and run, producing the following output.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="m">3</code>
<code class="linenos">2 </code>main.myInt
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<p>The last example we’re going to look at demonstrates how we can use multiple type parameters each with its own constraint.  It’s quite contrived but serves to illustrate the point.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 124 - Multiple type parameters</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"reflect"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">MakeAddToMap</code><code class="p">[</code><code class="n">K</code> <code class="n">comparable</code><code class="p">,</code> <code class="n">V</code> <code class="nb">any</code><code class="p">](</code><code class="n">k</code> <code class="n">K</code><code class="p">,</code> <code class="n">v</code> <code class="n">V</code><code class="p">)</code> <code class="nb">map</code><code class="p">[</code><code class="n">K</code><code class="p">]</code><code class="n">V</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">mp</code> <code class="o">:=</code> <code class="n">make</code><code class="p">(</code><code class="nb">map</code><code class="p">[</code><code class="n">K</code><code class="p">]</code><code class="n">V</code><code class="p">)</code>
<code class="linenos">10 </code>	<code class="n">mp</code><code class="p">[</code><code class="n">k</code><code class="p">]</code> <code class="o">=</code> <code class="n">v</code>
<code class="linenos">11 </code>	<code class="k">return</code> <code class="n">mp</code>
<code class="linenos">12 </code><code class="p">}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">15 </code>	<code class="n">mp</code> <code class="o">:=</code> <code class="n">MakeAddToMap</code><code class="p">(</code><code class="s2">"key"</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos">16 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">reflect</code><code class="o">.</code><code class="n">TypeOf</code><code class="p">(</code><code class="n">mp</code><code class="p">))</code>
<code class="linenos">17 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">mp</code><code class="p">)</code>
<code class="linenos">18 </code><code class="p">}</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">DFeMUaFqBzG</code>
</pre></div>

</figure>


<p>Output: </p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>map<code class="o">[</code>string<code class="o">]</code>int
<code class="linenos">2 </code>map<code class="o">[</code>key:1<code class="o">]</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<p>Notice that we use the built-in <i>comparable</i> constraint on the <code>K</code> type parameter, as not every type can be used for a map key. If we had specified <i>any</i> the program would have failed to build.</p>

<p>The syntax is again a little confusing, but I suspect as we start to see more generic programming in Go, we’ll get used to it.</p>

<h3 id="leanpub-auto-summary-1" class="subsection">9.6.3 Summary</h3>

<p>We should now have a fairly good grasp of generics. Let’s recap on what we’ve learned.</p>

<p>We know how to apply generic programming to solve some of the types of problems where traditionally we’ve just written more code, or settled for some type assertion. </p>

<p>We’ve seen the complexity generics can introduce into our syntax, and, while accepting that novelty and our unfamiliarity are factors, we’ve discovered ways we can mitigate this with custom constraints and composition, for example.</p>

<p>And, future versions of Go will likely add further features, and it’s likely that more built-in constraints will be introduced which will reduce the footprint of generics further still.</p>

<p>But of course, not everything requires us to apply generics. Often a little duplication is absolutely fine. Such code is often simple to read, and simple to reason about. We must recognise that maintaining code is often the responsibility of a team of developers so we should be considerate of them, and their abilities, especially when applying features which are relatively new, and that not everybody has experience with.</p>


<h1 id="leanpub-auto-chapter-10---concurrency" class="chapter">Chapter 10 - Concurrency</h1>

<p>One of the most attractive features of Go is its support for <i>concurrency</i> which provides the ability to run multiple tasks at once. </p>

<p>In this chapter, we’re going to explore Go’s concurrency features, including <i>goroutines</i>, <i>waitgroups</i>, and <i>channels</i>. We’ll learn how to use them, why they work well together, and how <i>context</i> also contributes to writing safer concurrent programs.</p>

<p>We’ll also look at another more traditional style of concurrent programming, one where we share memory but use <i>mutexes</i> to lock memory for use by a single process at a time. </p>

<p>By the end of this chapter, we’ll have the ability to identify opportunities for using concurrency in our programs. We’ll know how to use the appropriate tools and, understand the risks associated with introducing asynchronous code blocks into our codebase.</p>

<aside class="information blurb">
    <p><i>Concurrency</i> is not the same as <i>parallelism</i>. With concurrency, Go’s included <i>scheduler</i> manages tasks which are in a <i>runnable</i> state, starting and stopping them based on several factors. The result is that <i>usually</i>, tasks complete much faster than if they were run sequentially, <b>but</b>, they are not all running at the same time.</p>

</aside>

<h2 id="leanpub-auto-goroutines" class="section">10.1 Goroutines</h2>

<p>Goroutines are the foundations of asynchronous programming in Go. They allow multiple functions to run concurrently within a single program by scheduling them as lightweight operations, on top of threads. Each goroutine is created with an initial stack size of 2KB which can be grown as required. </p>

<p>Goroutines are <i>non-blocking</i>. When a goroutine is started it returns immediately, leaving the function to be handled asynchronously by the Go scheduler.</p>

<p>The Go scheduler starts and stops goroutines based on several factors, which include:</p>

<ul>
  <li>Goroutine priority</li>
  <li>Channel communication</li>
  <li>System load</li>
  <li>Available processors</li>
  <li>Goroutine stack size</li>
  <li>Number of existing goroutines.</li>
</ul>

<p>Regarding <i>priority</i>, the Go scheduler dynamically assigns priority based on the goroutine’s state, how long it has been blocked, and how many other goroutines are blocked and waiting to run.</p>

<p><i>Channel communication</i> will often block goroutines, so the scheduler may start a goroutine while another is blocked, waiting to send or receive on the channel.</p>

<p>Another consideration for the Go scheduler is <i>stack size</i>. Goroutines with a large stack size may put pressure on system resources so <i>may</i> be scheduled less frequently.</p>

<p>We don’t usually care about goroutine scheduling which takes place in the background - with possibly one exception. By default, the Go scheduler will schedule goroutines on all available CPU cores. </p>

<p>In most situations this is appropriate, but we may find our Go application is overutilising resources, limiting memory and CPU available to other applications on the same hardware. In such circumstances we can limit the CPU cores the scheduler can utilise using <code>GOMAXPROCS</code>. </p>

<p>This value can be set either as an environment variable of the same name or within the program itself using the <i>runtime</i> package, which means the CPU cores available to the program can be restricted for specific execution paths.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 125 - Setting GOMAXPROCS during runtime</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"runtime"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Setting GOMAXPROCS to 5, previously was </code><code class="si">%d</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">runtime</code><code class="o">.</code><code class="n">GOMAXPROCS</code><code class="p">(</code><code class="mi">5</code><code class="p">))</code>
<code class="linenos">10 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Setting GOMAXPROCS to 2, previously was </code><code class="si">%d</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">runtime</code><code class="o">.</code><code class="n">GOMAXPROCS</code><code class="p">(</code><code class="mi">2</code><code class="p">))</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">ptFRl7NAoT_6</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Setting GOMAXPROCS to <code class="m">5</code>, previous was <code class="m">8</code>
<code class="linenos">2 </code>Setting GOMAXPROCS to <code class="m">2</code>, previous was <code class="m">5</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code>Program exited.
</pre></div>

</figure>


<aside class="information blurb">
    <p>The return value of <code>runtime.GOMAXPROCS()</code> is the previously set value, not the value just set. We ran the function twice to demonstrate that.</p>

</aside>

<h3 id="leanpub-auto-the-go-keyword" class="subsection">10.1.1 The <i>go</i> keyword</h3>

<p>Although goroutines are very easy to create, it’s rare that we can simply create a goroutine and forget about it. However, writing code that runs asynchronously in a goroutine is very simple, only requiring that we prefix a function invocation with the <code>go</code> keyword.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">//</code><code class="w"> </code><code class="n">calling</code><code class="w"> </code><code class="n">a</code><code class="w"> </code><code class="n">named</code><code class="w"> </code><code class="k">function</code><code class="w"> </code><code class="k">as</code><code class="w"> </code><code class="n">a</code><code class="w"> </code><code class="n">goroutine</code><code class="w"></code>
<code class="linenos">2 </code><code class="k">go</code><code class="w"> </code><code class="n">sendEmail</code><code class="p">(...)</code><code class="w"></code>
<code class="linenos">3 </code>
<code class="linenos">4 </code><code class="o">//</code><code class="w"> </code><code class="n">wrapping</code><code class="w"> </code><code class="n">code</code><code class="w"> </code><code class="ow">in</code><code class="w"> </code><code class="n">an</code><code class="w"> </code><code class="n">anonymous</code><code class="w"> </code><code class="n">concurrent</code><code class="w"> </code><code class="k">function</code><code class="w"></code>
<code class="linenos">5 </code><code class="k">go</code><code class="w"> </code><code class="n">func</code><code class="p">()</code><code class="err">{</code><code class="w"></code>
<code class="linenos">6 </code><code class="w">    </code><code class="p">...</code><code class="w"></code>
<code class="linenos">7 </code><code class="err">}</code><code class="p">()</code><code class="w"></code>
</pre></div>

</figure>


<p>In practice, we usually at least want to be sure the function completes and using goroutines alone as in the previous example isn’t sufficient to guarantee that.  To illustrate this, check out the gotcha below, in which the expected output never prints.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 126 - Where is the output?</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="n">go</code> <code class="n">func</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Will this print?"</code><code class="p">)</code>
<code class="linenos">10 </code>	<code class="p">}()</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code>	<code class="o">//</code><code class="n">time</code><code class="o">.</code><code class="n">Sleep</code><code class="p">(</code><code class="mi">1</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">)</code>
<code class="linenos">13 </code><code class="p">}</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">nd5nwv5b3ok</code>
</pre></div>

</figure>


<p>Because the goroutine returns immediately, program execution continues. In this case, the program completes and exits before the body of the goroutine is scheduled and executed.</p>

<p>Uncomment line 12 which pauses the program, preventing it from terminating, for long enough that we see the expected output.</p>

<p>As well as completion, we often want to know the result of an operation performed by a goroutine, and, if anything went wrong.  But since goroutines return immediately we can’t use traditional function return values. Even if we could, it would be unwise since it could easily lead to race conditions and other synchronization issues.</p>

<p>So, usually, we don’t use goroutines in insolation. Instead, we combine them with <i>waitgroups</i> and <i>channels</i> which we’ll cover shortly.</p>

<h2 id="leanpub-auto-context" class="section">10.2 Context</h2>

<p>Go introduced <i>Context</i> in version 1.7 in 2016. Context solves one important problem for us: <i>it provides a way to maintain control across processes</i>. </p>

<p>Its application is not limited to use with goroutines, but it fits well with our discussion of concurrency, and the problems of communication and control we may encounter when writing asynchronous code.</p>

<p>We’ve already seen how simple it is to run something concurrently using a goroutine and we’ll look at the different approaches we can employ for signalling and messaging, <b>from</b> goroutines, back to our main program, later in this chapter.</p>

<p>But what about the other way?  How does our main program communicate with a goroutine once it has started? How does it cancel a goroutine, for example, if the program must exit, allowing the goroutine the opportunity to clean up after itself and end gracefully?</p>

<p>We also need to manage goroutines during execution and not just when closing down our program. For example, if we are blocking while waiting for goroutines to finish their work, a single goroutine that can’t complete its work could result in allocated memory which we can’t reclaim and a slow or unresponsive program.</p>

<p>So, while it’s easy to run a function concurrently by starting it in a new goroutine, managing that goroutine once it has started, is not as straightforward.</p>

<p>The context package solves this problem.  Using a context, we can communicate <i>timeouts</i>, <i>deadlines</i>, <i>cancellations</i>, and other request-scoped values across API boundaries, processes and goroutines.</p>

<p>We still can’t ensure a goroutine finishes its work - many factors will be beyond our control - but the context package allows us to limit the execution window for that work.</p>

<h3 id="leanpub-auto-conventions" class="subsection">10.2.1 Conventions</h3>

<p>There are two conventions we need to be aware of. We should use <i>ctx</i> as the idiomatic name for a variable which holds a context and, any function or receiver which accepts a context value, should take it as the first parameter.</p>

<h3 id="leanpub-auto-the-contextbackground-empty-context" class="subsection">10.2.2 The context.Background() empty context</h3>

<p>The function <code>context.Background()</code> returns an empty context or <code>emptyCtx</code>. Think of it as the parent or root context, it has no cancellation rules, and no values or deadline.</p>

<p>Since context can be chained: a child can inherit a parent context and can add to the context, so cancellation rules, values, and deadlines can be added later.</p>

<p>Although its application is normally limited to <code>main()</code>, <code>context.Background()</code> is often used in testing of functions which require a context.</p>

<h3 id="leanpub-auto-the-contexttodo-empty-context" class="subsection">10.2.3 The context.TODO() empty context</h3>

<p>This is essentially a placeholder. In fact, <code>context.TODO()</code> returns the same empty context as <code>context.Background()</code>, but the intended purpose of <code>context.TODO()</code> is different. </p>

<p>Since not all Go code uses context and, when developing or refactoring our code to use context it may not be immediately obvious how the context will be made available, we have <code>TODO</code>, a placeholder. We’re saying we know this function will accept a context, but we don’t know much more than that at this time.</p>

<p><code>context.TODO()</code> should be used in function arguments in preference to <code>context.Background()</code>, the compiler differentiates between them when checking for correct context propagation.</p>

<h3 id="leanpub-auto-context-with-cancellation" class="subsection">10.2.4 Context with cancellation</h3>

<p>Cancellation allows us to manually cancel those goroutines which have been written to handle and honour the context contract. </p>

<p>We have to write code in the goroutine to accomplish this, it isn’t an automatic process. Goroutines which don’t honour the contract will not terminate, despite a cancellation signal.</p>

<p>To implement cancellation on the current <code>context</code> we use the <code>context.WithCancel()</code> function.  This returns a <i>cancelFunc</i> type, a function, which we can defer, or call explicitly in response to an event such as a control signal to terminate our program.</p>

<p>In the example below, we call the <code>cancel()</code> function after a short delay. One goroutine has been written to handle the context and returns on the cancellation signal. The second goroutine doesn’t handle context, so carries on regardless, or at least until the timer unblocks and the program exits. </p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 127 - Using context.WithCancel()</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"context"</code>
<code class="linenos"> 5 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 6 </code>	<code class="s2">"time"</code>
<code class="linenos"> 7 </code><code class="p">)</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="n">ctx</code> <code class="o">:=</code> <code class="n">context</code><code class="o">.</code><code class="n">Background</code><code class="p">()</code>
<code class="linenos">11 </code>	<code class="n">ctx</code><code class="p">,</code> <code class="n">cancel</code> <code class="o">:=</code> <code class="n">context</code><code class="o">.</code><code class="n">WithCancel</code><code class="p">(</code><code class="n">ctx</code><code class="p">)</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>	<code class="o">//</code> <code class="n">wait</code> <code class="mi">5</code> <code class="n">seconds</code> <code class="n">then</code> <code class="n">call</code> <code class="n">the</code> <code class="n">cancelFunc</code>
<code class="linenos">14 </code>	<code class="o">//</code> <code class="n">which</code> <code class="n">will</code> <code class="n">stop</code> <code class="nb">any</code> <code class="n">running</code> <code class="n">goroutines</code> <code class="n">which</code> <code class="n">honour</code> <code class="n">context</code>
<code class="linenos">15 </code>	<code class="n">go</code> <code class="n">func</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">16 </code>		<code class="n">time</code><code class="o">.</code><code class="n">Sleep</code><code class="p">(</code><code class="mi">5</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">)</code>
<code class="linenos">17 </code>		<code class="n">cancel</code><code class="p">()</code>
<code class="linenos">18 </code>	<code class="p">}()</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code>	<code class="o">//</code> <code class="n">no</code> <code class="n">context</code>
<code class="linenos">21 </code>	<code class="n">go</code> <code class="n">func</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">22 </code>		<code class="k">for</code> <code class="p">{</code>
<code class="linenos">23 </code>			<code class="n">time</code><code class="o">.</code><code class="n">Sleep</code><code class="p">(</code><code class="mi">2</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">)</code>
<code class="linenos">24 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"I'm Dave Blogs and I AM unstoppable"</code><code class="p">)</code>
<code class="linenos">25 </code>		<code class="p">}</code>
<code class="linenos">26 </code>	<code class="p">}()</code>
<code class="linenos">27 </code>
<code class="linenos">28 </code>	<code class="o">//</code> <code class="k">with</code> <code class="n">context</code>
<code class="linenos">29 </code>	<code class="n">go</code> <code class="n">func</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">30 </code>		<code class="k">for</code> <code class="p">{</code>
<code class="linenos">31 </code>			<code class="n">select</code> <code class="p">{</code>
<code class="linenos">32 </code>			<code class="n">case</code> <code class="o">&lt;-</code><code class="n">time</code><code class="o">.</code><code class="n">After</code><code class="p">(</code><code class="mi">1</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">):</code>
<code class="linenos">33 </code>				<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"I'm Joe Blogs I'm unstoppable!"</code><code class="p">)</code>
<code class="linenos">34 </code>			<code class="n">case</code> <code class="o">&lt;-</code><code class="n">ctx</code><code class="o">.</code><code class="n">Done</code><code class="p">():</code>
<code class="linenos">35 </code>				<code class="n">err</code> <code class="o">:=</code> <code class="n">ctx</code><code class="o">.</code><code class="n">Err</code><code class="p">()</code>
<code class="linenos">36 </code>				<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"I SPOKE TOO SOON... '%v' OH NO!</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">err</code><code class="p">)</code>
<code class="linenos">37 </code>				<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Cleanup and graceful shutdown type stuff performed here..."</code><code class="p">)</code>
<code class="linenos">38 </code>				<code class="k">return</code>
<code class="linenos">39 </code>			<code class="p">}</code>
<code class="linenos">40 </code>		<code class="p">}</code>
<code class="linenos">41 </code>	<code class="p">}()</code>
<code class="linenos">42 </code>
<code class="linenos">43 </code>	<code class="o">//</code> <code class="n">exit</code> <code class="n">after</code> <code class="mi">20</code> <code class="n">seconds</code>
<code class="linenos">44 </code>	<code class="n">time</code><code class="o">.</code><code class="n">Sleep</code><code class="p">(</code><code class="mi">20</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">)</code>
<code class="linenos">45 </code><code class="p">}</code>
<code class="linenos">46 </code>
<code class="linenos">47 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">aAbmie_rtVV</code>
</pre></div>

</figure>


<p>See how we extended the parent context, building on the empty context returned by <code>context.Background()</code> and adding the cancellation to it?</p>

<p>Note also how one of the goroutines has been written to honour context? We’re using a select statement and listening for signals on both the <code>time.After()</code> and <code>ctx.Done()</code> channels. When we receive on the latter channel, we have the opportunity to stop what we are doing gracefully and generate logs before returning.</p>

<p>Finally, observe how <code>ctx.Err()</code> provides specific information about why the context ended, in this case its value was “context canceled”.</p>

<h3 id="leanpub-auto-context-with-timeout" class="subsection">10.2.5 Context with timeout</h3>

<p>In the previous example, we created a context which could send cancellation signals. Although we cheated by running the cancellation function after a short delay, we could have called it conditionally.</p>

<p>In this section, we’re going to create a context which has a <i>timeout</i>. Timeout specifies a duration of time. When we create a context with a timeout we are stating how long we are prepared to wait for the results of the goroutine. The context will expire when that duration of time has elapsed.</p>

<aside class="information blurb">
    <p>In this example and the examples which follow, the way we handle the context contract inside our goroutines is identical to the way we did it for cancellation, it’s only the way we set up the context which differs. </p>

</aside>

<p>In the example below, we’ve simplified the program so it only includes one goroutine, which handles context.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 128 - Using context.WithTimeout()</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"context"</code>
<code class="linenos"> 5 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 6 </code>	<code class="s2">"time"</code>
<code class="linenos"> 7 </code><code class="p">)</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="n">ctx</code> <code class="o">:=</code> <code class="n">context</code><code class="o">.</code><code class="n">Background</code><code class="p">()</code>
<code class="linenos">11 </code>	<code class="n">timeout</code> <code class="o">:=</code> <code class="mi">10</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code>
<code class="linenos">12 </code>	<code class="n">ctx</code><code class="p">,</code> <code class="n">cancel</code> <code class="o">:=</code> <code class="n">context</code><code class="o">.</code><code class="n">WithTimeout</code><code class="p">(</code><code class="n">ctx</code><code class="p">,</code> <code class="n">timeout</code><code class="p">)</code>
<code class="linenos">13 </code>	<code class="n">defer</code> <code class="n">cancel</code><code class="p">()</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code>	<code class="o">//</code> <code class="k">with</code> <code class="n">context</code>
<code class="linenos">16 </code>	<code class="n">go</code> <code class="n">func</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">17 </code>		<code class="k">for</code> <code class="p">{</code>
<code class="linenos">18 </code>			<code class="n">select</code> <code class="p">{</code>
<code class="linenos">19 </code>			<code class="n">case</code> <code class="o">&lt;-</code><code class="n">time</code><code class="o">.</code><code class="n">After</code><code class="p">(</code><code class="mi">1</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">):</code>
<code class="linenos">20 </code>				<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"I'm Joe Blogs I've got 10 seconds to talk"</code><code class="p">)</code>
<code class="linenos">21 </code>			<code class="n">case</code> <code class="o">&lt;-</code><code class="n">ctx</code><code class="o">.</code><code class="n">Done</code><code class="p">():</code>
<code class="linenos">22 </code>				<code class="n">err</code> <code class="o">:=</code> <code class="n">ctx</code><code class="o">.</code><code class="n">Err</code><code class="p">()</code>
<code class="linenos">23 </code>				<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Got to go now... '%v'</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">err</code><code class="p">)</code>
<code class="linenos">24 </code>				<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Cleanup e.t.c"</code><code class="p">)</code>
<code class="linenos">25 </code>				<code class="k">return</code>
<code class="linenos">26 </code>			<code class="p">}</code>
<code class="linenos">27 </code>		<code class="p">}</code>
<code class="linenos">28 </code>	<code class="p">}()</code>
<code class="linenos">29 </code>
<code class="linenos">30 </code>	<code class="n">time</code><code class="o">.</code><code class="n">Sleep</code><code class="p">(</code><code class="mi">12</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">)</code>
<code class="linenos">31 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Exiting"</code><code class="p">)</code>
<code class="linenos">32 </code><code class="p">}</code>
<code class="linenos">33 </code>
<code class="linenos">34 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">6</code><code class="n">y1hYI5pSdM</code>
</pre></div>

</figure>


<p>Observe the value of <code>context.Err()</code> when duration elapses versus manual cancellation.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Got to go now... <code class="s1">'context deadline exceeded'</code>
</pre></div>

</figure>


<aside class="information blurb">
    <p>Note that <code>context.WithTimeout()</code> also returns a <code>cancel</code> function and we’re using <i>defer</i> to call it. This ensures that context is cancelled regardless of the time elapsed should the program exit for another reason such as a <i>panic</i>. This avoids what the compiler terms, “context leak”.</p>

</aside>

<h3 id="leanpub-auto-context-with-deadline" class="subsection">10.2.6 Context with deadline</h3>

<p>A <i>deadline</i> on a context is similar to a <i>timeout</i>, but, rather than stating a duration in which an operation must complete as we do with <code>context.WithTimeout()</code> when using <code>context.WithDeadline()</code> we instead set an actual time in the future that the operation may not go beyond.</p>

<p>Configuring a context with a deadline is, as you might expect, very similar to setting a timeout. Note that the printed time output will be incorrect if you run this on the Go Playground.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 129 - Using context.WithDeadline()</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"context"</code>
<code class="linenos"> 5 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 6 </code>	<code class="s2">"time"</code>
<code class="linenos"> 7 </code><code class="p">)</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="n">ctx</code> <code class="o">:=</code> <code class="n">context</code><code class="o">.</code><code class="n">Background</code><code class="p">()</code>
<code class="linenos">11 </code>	<code class="n">deadline</code> <code class="o">:=</code> <code class="n">time</code><code class="o">.</code><code class="n">Now</code><code class="p">()</code><code class="o">.</code><code class="n">Add</code><code class="p">(</code><code class="mi">10</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">)</code> <code class="o">//</code> <code class="mi">10</code> <code class="n">seconds</code> <code class="ow">in</code> <code class="n">future</code>
<code class="linenos">12 </code>	<code class="n">ctx</code><code class="p">,</code> <code class="n">cancel</code> <code class="o">:=</code> <code class="n">context</code><code class="o">.</code><code class="n">WithDeadline</code><code class="p">(</code><code class="n">ctx</code><code class="p">,</code> <code class="n">deadline</code><code class="p">)</code>
<code class="linenos">13 </code>	<code class="n">defer</code> <code class="n">cancel</code><code class="p">()</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code>	<code class="o">//</code> <code class="k">with</code> <code class="n">context</code>
<code class="linenos">16 </code>	<code class="n">go</code> <code class="n">func</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">17 </code>		<code class="k">for</code> <code class="p">{</code>
<code class="linenos">18 </code>			<code class="n">select</code> <code class="p">{</code>
<code class="linenos">19 </code>			<code class="n">case</code> <code class="o">&lt;-</code><code class="n">time</code><code class="o">.</code><code class="n">After</code><code class="p">(</code><code class="mi">1</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">):</code>
<code class="linenos">20 </code>				<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"I'm Joe Blogs I can talk until </code><code class="si">%s</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">deadline</code><code class="p">)</code>
<code class="linenos">21 </code>			<code class="n">case</code> <code class="o">&lt;-</code><code class="n">ctx</code><code class="o">.</code><code class="n">Done</code><code class="p">():</code>
<code class="linenos">22 </code>				<code class="n">err</code> <code class="o">:=</code> <code class="n">ctx</code><code class="o">.</code><code class="n">Err</code><code class="p">()</code>
<code class="linenos">23 </code>				<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Got to go now... '%v'</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">err</code><code class="p">)</code>
<code class="linenos">24 </code>				<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Cleanup e.t.c"</code><code class="p">)</code>
<code class="linenos">25 </code>				<code class="k">return</code>
<code class="linenos">26 </code>			<code class="p">}</code>
<code class="linenos">27 </code>		<code class="p">}</code>
<code class="linenos">28 </code>	<code class="p">}()</code>
<code class="linenos">29 </code>
<code class="linenos">30 </code>	<code class="n">time</code><code class="o">.</code><code class="n">Sleep</code><code class="p">(</code><code class="mi">12</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">)</code>
<code class="linenos">31 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Exiting"</code><code class="p">)</code>
<code class="linenos">32 </code><code class="p">}</code>
<code class="linenos">33 </code>
<code class="linenos">34 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">MyjT3EVGkus</code>
</pre></div>

</figure>


<h3 id="leanpub-auto-sharing-data-via-context" class="subsection">10.2.7 Sharing data via context</h3>

<p>As well as carrying <i>cancellations</i>, <i>deadlines</i>, and <i>timeouts</i>,  we can also use context to share data.</p>

<p>Sharing data via context is useful when passing certain kinds of data from one function to another, or multiple goroutines, without explicitly passing it through function parameters or sharing as a global variable.</p>

<p>The focus there was on specific types of data. Incidental data, not central to the main purpose of the application is ideal for sharing via context. Examples of such data include API keys, JWT tokens, user credentials, or session tokens, which are request-scoped, relatively small in size, and not essential to the application’s business logic.</p>

<p>We should avoid using context to share large values, and, for the sake of readability, data which is part of our program’s business logic should be shared explicitly rather than within the context.</p>

<p>In the next example, we demonstrate how to share values using context. We first create a context using <code>context.WithValue()</code>, and to retrieve values from the context inside of our goroutines we simply use <code>context.Value()</code>.</p>

<aside class="information blurb">
    <p>The <i>key</i> and <i>value</i> parameters in <code>context.WithValue()</code> are <code>interface{}</code> types. On the value, that’s useful, since we can use aggregate types here. For example, we could use a struct to represent multiple request-scoped data within its fields.</p>

  <p>But why is <i>key</i> of type <code>interface{}</code>? Why not use a basic type like <i>string</i>? The answer is that keys should be custom types (actually custom comparable types) to avoid naming collisions between packages that might use context and have the same key name. By using a custom type, keys - even those of the same name - will have a different type.</p>

</aside>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 130 - Sharing data via context</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"context"</code>
<code class="linenos"> 5 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 6 </code>	<code class="s2">"time"</code>
<code class="linenos"> 7 </code><code class="p">)</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="nb">type</code> <code class="n">ctxKey</code> <code class="n">string</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">12 </code>	<code class="n">var</code> <code class="n">name</code> <code class="n">ctxKey</code> <code class="o">=</code> <code class="s2">"name"</code>
<code class="linenos">13 </code>	<code class="n">ctx</code> <code class="o">:=</code> <code class="n">context</code><code class="o">.</code><code class="n">WithValue</code><code class="p">(</code><code class="n">context</code><code class="o">.</code><code class="n">Background</code><code class="p">(),</code> <code class="n">name</code><code class="p">,</code> <code class="s2">"Joe Blogs"</code><code class="p">)</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code>	<code class="o">//</code> <code class="k">with</code> <code class="n">context</code><code class="o">.</code><code class="n">Value</code><code class="p">()</code>
<code class="linenos">16 </code>	<code class="n">go</code> <code class="n">func</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">17 </code>		<code class="k">for</code> <code class="p">{</code>
<code class="linenos">18 </code>			<code class="n">time</code><code class="o">.</code><code class="n">Sleep</code><code class="p">(</code><code class="mi">1</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">)</code>
<code class="linenos">19 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"My name is </code><code class="si">%s</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">ctx</code><code class="o">.</code><code class="n">Value</code><code class="p">(</code><code class="n">ctxKey</code><code class="p">(</code><code class="s2">"name"</code><code class="p">)))</code>
<code class="linenos">20 </code>		<code class="p">}</code>
<code class="linenos">21 </code>	<code class="p">}()</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code>	<code class="n">time</code><code class="o">.</code><code class="n">Sleep</code><code class="p">(</code><code class="mi">12</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">)</code>
<code class="linenos">24 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Exiting"</code><code class="p">)</code>
<code class="linenos">25 </code><code class="p">}</code>
<code class="linenos">26 </code>
<code class="linenos">27 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">7</code><code class="n">p504omEWsq</code>
</pre></div>

</figure>


<p>There’s no deadline or timeout set on the context in the previous example, we used context only to share a single value. We could have used <i>chaining</i> to add timeouts and deadlines, and share additional values. </p>

<p>Observe also how we created a custom type, based on <i>string</i>, and used a variable of that type for the context key.</p>

<h2 id="leanpub-auto-blocking-execution-with-waitgroups" class="section">10.3 Blocking execution with waitgroups</h2>

<p>Waitgroups provide a simple way to wait for multiple goroutines to complete, before continuing program execution. The alternative would be a naive pause for some arbitrary amount of time as we saw in the previous examples, <b>which is not recommended</b>, or implementing more complex communication over channels, purely to signal completion.  </p>

<p>Waitgroups are most useful where there is no requirement to communicate results or data between goroutines, something which would mandate the use of channels.</p>

<p>Goroutines managed by a waitgroup are capable of updating simple shared state, for example, a counter, or an array of known size.</p>

<p>In the next example, we use a waitgroup to hold execution until goroutines have completed, each populating an element in the <code>results</code> array. The example demonstrates how to orchestrate a waitgroup, and how safe state updates are possible in some circumstances.</p>

<aside class="information blurb">
    <p>Beyond a demonstration, this would be a poor application for concurrency. The code itself is very simple, and our inference <i>should</i> be that is unlikely to be faster than it’s synchronous counterpart. In my testing it was between two and three times slower to schedule goroutines, than to populate the array directly.</p>

</aside>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 131 - WaitGroup updating shared state safely</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"sync"</code>
<code class="linenos"> 6 </code>	<code class="s2">"time"</code>
<code class="linenos"> 7 </code><code class="p">)</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">10 </code>	<code class="n">t</code> <code class="o">:=</code> <code class="n">time</code><code class="o">.</code><code class="n">Now</code><code class="p">()</code>
<code class="linenos">11 </code>	<code class="n">var</code> <code class="n">results</code> <code class="p">[</code><code class="mi">30</code><code class="p">]</code><code class="nb">int</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>	<code class="n">var</code> <code class="n">wg</code> <code class="n">sync</code><code class="o">.</code><code class="n">WaitGroup</code>
<code class="linenos">14 </code>	<code class="o">//</code><code class="n">wg</code><code class="o">.</code><code class="n">Add</code><code class="p">(</code><code class="mi">29</code><code class="p">)</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code>	<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">1</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;=</code> <code class="mi">30</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos">17 </code>		<code class="n">wg</code><code class="o">.</code><code class="n">Add</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
<code class="linenos">18 </code>		<code class="n">go</code> <code class="n">func</code><code class="p">(</code><code class="n">i</code> <code class="nb">int</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">19 </code>			<code class="n">results</code><code class="p">[</code><code class="n">i</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code> <code class="o">=</code> <code class="n">i</code> <code class="o">*</code> <code class="mi">10</code>
<code class="linenos">20 </code>			<code class="n">wg</code><code class="o">.</code><code class="n">Done</code><code class="p">()</code>
<code class="linenos">21 </code>		<code class="p">}(</code><code class="n">i</code><code class="p">)</code>
<code class="linenos">22 </code>	<code class="p">}</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code>	<code class="n">wg</code><code class="o">.</code><code class="n">Wait</code><code class="p">()</code>
<code class="linenos">25 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">results</code><code class="p">)</code>
<code class="linenos">26 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Completed in"</code><code class="p">,</code> <code class="n">time</code><code class="o">.</code><code class="n">Since</code><code class="p">(</code><code class="n">t</code><code class="p">))</code>
<code class="linenos">27 </code><code class="p">}</code>
<code class="linenos">28 </code>
<code class="linenos">29 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">Z3Rh0ufgiVr</code>
</pre></div>

</figure>


<p>Running through the code. The <code>wg</code> variable is of type <i>sync.WaitGroup</i>. We’re making use of closures so not providing the <code>wg</code> argument as a parameter to the anonymous function. When a <i>sync.Waitgroup</i> typed variable is passed as an argument to a named function it should be passed by reference and not by value.</p>

<p>We add <code>1</code> to the waitgroup every time we invoke a new goroutine with <code>wg.Add(1)</code> and when each function has completed its work we call the <code>wg.Done()</code> receiver.</p>

<p><code>wg.Wait()</code> blocks execution until all goroutines report they have completed via <code>wg.Done()</code>.</p>

<aside class="information blurb">
    <p>Observe <code>wg.Add(29)</code> on line 14. It is generally better to add goroutines to the waitgroup at the point of use - for example in the loop as we do.  If there is a mismatch between the number of goroutines we add, and the number which call <code>wg.Done()</code> our program will panic at runtime. By calling <code>wg.Add(1)</code> in the loop which invokes the goroutine we prevent this possibility. Uncomment line 14, and comment out line 17 to experiment for yourself.</p>

</aside>

<p>To summarise, waitgroups are simple to reason about. The waitgroup understands how many completion notifications it should expect, and each goroutine informs the waitgroup when it has completed its work. When all goroutines are accounted for, the waitgroup unblocks and program execution continues.</p>

<h2 id="leanpub-auto-sharing-variables-using-mutexes" class="section">10.4 Sharing variables using mutexes</h2>

<p>In the previous example, we used goroutines to populate the elements of an array which had a predefined size and capacity.  It’s safe to do this, because, as the code is written, each goroutine mutates just one element in the array. We are sharing the array, but we’re not sharing the elements which comprise the array. </p>

<p>But few values can be safely shared in this way. Usually, unguarded concurrent access is unsafe, potentially giving rise to a race condition. Certainly any concurrent operation which reads a shared value and then changes that value is unsafe.</p>

<p>Consider the following example, which creates 10,000 goroutines, each incrementing the <code>myCounter</code> variable by a value of <code>1</code>.  There is a waitgroup in place, so the program blocks until all goroutines have completed. </p>

<p>We print the <code>myCounter</code> variable once the work is done and expect the printed output to be <code>10000</code>.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 132 - WaitGroup updating shared state unsafely</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"sync"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">var</code> <code class="n">myCounter</code> <code class="nb">int</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code>	<code class="n">var</code> <code class="n">wg</code> <code class="n">sync</code><code class="o">.</code><code class="n">WaitGroup</code>
<code class="linenos">12 </code>	<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="mi">10000</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos">13 </code>		<code class="n">wg</code><code class="o">.</code><code class="n">Add</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
<code class="linenos">14 </code>		<code class="n">go</code> <code class="n">func</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">15 </code>			<code class="n">myCounter</code> <code class="o">+=</code> <code class="mi">1</code>
<code class="linenos">16 </code>			<code class="n">wg</code><code class="o">.</code><code class="n">Done</code><code class="p">()</code>
<code class="linenos">17 </code>		<code class="p">}()</code>
<code class="linenos">18 </code>	<code class="p">}</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code>	<code class="n">wg</code><code class="o">.</code><code class="n">Wait</code><code class="p">()</code>
<code class="linenos">21 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Counter total is: </code><code class="si">%d</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">myCounter</code><code class="p">)</code>
<code class="linenos">22 </code><code class="p">}</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">dW1kdCrqmCu</code>
</pre></div>

</figure>


<p>Output: </p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Counter total is: <code class="m">9764</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>But it isn’t 10,000. In fact every time we run the code, we get a different result, and it’s never 10,000. Our code has a problem since there is unguarded shared access to the <code>myCounter</code> variable. Multiple goroutines can read the value in that memory and increment it, simultaneously.</p>

<p>The actual value printed for <code>myCounter</code> depends on how many goroutines manage to read and write to <code>myCounter</code> atomically before another goroutine reads the variable. There’s no way we can predict that access which is why we get a different result each time. </p>

<p>In short, we have a <i>race condition</i> or <i>data race</i>. </p>

<h3 id="leanpub-auto-implementing-mutually-exclusive-access" class="subsection">10.4.1 Implementing mutually exclusive access</h3>

<p>Mutexes are guard mechanisms which guarantee exclusive access to a piece of memory. They are part of the <code>sync</code> package along with waitgroups. To declare a variable (or struct field) which holds a value of type <code>sync.Mutex</code> we generally use the naming convention <code>mu</code>.</p>

<p>We’re going to improve the previous code and remove the race condition. We’ll use a <i>mutex</i> in the example which follows, but in section 10.3 we’ll solve the same problem using a <i>channel</i>.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 133 - Mutex to guarantee exclusivity of access</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"sync"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">var</code> <code class="n">myCounter</code> <code class="nb">int</code>
<code class="linenos">10 </code>	<code class="n">var</code> <code class="n">wg</code> <code class="n">sync</code><code class="o">.</code><code class="n">WaitGroup</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code>	<code class="n">var</code> <code class="n">mu</code> <code class="n">sync</code><code class="o">.</code><code class="n">Mutex</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code>	<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="mi">10000</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos">15 </code>		<code class="n">wg</code><code class="o">.</code><code class="n">Add</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
<code class="linenos">16 </code>		<code class="n">go</code> <code class="n">func</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">17 </code>			<code class="n">mu</code><code class="o">.</code><code class="n">Lock</code><code class="p">()</code>
<code class="linenos">18 </code>			<code class="n">defer</code> <code class="n">mu</code><code class="o">.</code><code class="n">Unlock</code><code class="p">()</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code>			<code class="n">myCounter</code> <code class="o">+=</code> <code class="mi">1</code>
<code class="linenos">21 </code>			<code class="n">wg</code><code class="o">.</code><code class="n">Done</code><code class="p">()</code>
<code class="linenos">22 </code>		<code class="p">}()</code>
<code class="linenos">23 </code>	<code class="p">}</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code>	<code class="n">wg</code><code class="o">.</code><code class="n">Wait</code><code class="p">()</code>
<code class="linenos">26 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Counter total is: </code><code class="si">%d</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">myCounter</code><code class="p">)</code>
<code class="linenos">27 </code><code class="p">}</code>
<code class="linenos">28 </code>
<code class="linenos">29 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">ZObOF_af_W9</code>
</pre></div>

</figure>


<p>Output: </p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Counter total is: <code class="m">10000</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>We added three lines of code to create a <i>mutex</i> typed variable <code>mu</code>, apply a lock with the <code>mu.Lock()</code> statement, and create a deferred call to <code>mu.Unlock()</code>.</p>

<p>When we run the program, <code>myCounter</code> outputs the expected value of <code>10000</code>. </p>

<p>By using a mutex, each goroutine is granted exclusive access to the variable. When one goroutine locks the variable for reading and writing, others have to wait until it is unlocked before they can access it.</p>

<p>We used the <i>defer</i> keyword immediately after the statement which created the lock, ensuring we didn’t forget to add it later.</p>

<p>Omitting <code>mu.Unlock()</code> would cause a deadlock at runtime, a type of panic which occurs when all goroutines dependent on a channel or mutex are blocked and cannot proceed. The runtime issues this error <code>fatal error: all goroutines are asleep - deadlock!</code> followed by a stack trace.</p>

<aside class="information blurb">
    <p>The deferred statement is executed just before the function exits. If the goroutine performs additional tasks after incrementing <code>myCounter</code>, it may result in the variable being locked for an extended period and cause other goroutines to be blocked for longer than necessary. This can lead to a longer program execution time. Should this be identified as a problem, to optimize this, it may be advisable to call <code>mu.Unlock()</code> immediately after the incrementing <code>myCounter</code>.  </p>

</aside>

<h3 id="leanpub-auto-write-only-lock" class="subsection">10.4.2 Write-only lock</h3>

<p>In many cases it will be safe to read from a shared variable as long as that variable is not being written to and Go includes <code>sync.RWMutex</code> specifically for this purpose. </p>

<p>Read operations can be performed by many goroutines simultaneously with a readers lock, but a single write operation locks the shared variable for both <i>read</i> and <i>write</i> access. </p>

<p>The shared variable remains in a consistent state, race conditions are still avoided, but, removing the majority of the read locks helps limit blocking and improve overall application performance.</p>

<p>In the writing goroutine, we use the same syntax as previously which creates a full lock.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>mu.Lock()
<code class="linenos">2 </code>defer mu.Unlock()
<code class="linenos">3 </code>myCounter++
</pre></div>

</figure>


<p>In the reading goroutine, we implement a <i>readers lock</i> like so. This will only be blocked when there is a concurrent write operation.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>mu.RLock()
<code class="linenos">2 </code>defer mu.RUnlock()
<code class="linenos">3 </code>fmt.Println("current value is:", myCounter)
</pre></div>

</figure>


<h3 id="leanpub-auto-the-race-detector" class="subsection">10.4.3 The Race Detector</h3>

<p>Spotting unsafe shared access is not always easy. In large programs with many lines of code, manual review may not be enough to spot potential race conditions. Fortunately, Go provides a <i>race detector</i> which can identify unsafe concurrent sharing of variables on our behalf.</p>

<p>To enable it, we simply add the <code>-race</code> flag to any <code>go run</code>, <code>go build</code> or <code>go test</code> command.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go run -race main.go
</pre></div>

</figure>


<p>With the <code>-race</code> flag set, the Go compiler creates a modified version of the application that can track variable access and report any unguarded shared access which could result in a data race. It does this throughout the lifetime of the program, but only over paths that are executed. </p>

<p>It’s a good idea to use this flag with <i>test</i> builds, however, a good test suite with high coverage is essential to ensure that as many execution paths as possible are checked for data races. The race detector can only identify race conditions it encounters, it does not analyse the code to find or predict them.</p>

<aside class="information blurb">
    <p>An executable compiled to include the race detector will use slightly more memory and be slightly slower. Although the difference is unlikely to be meaningful for most applications, it is worth stating.  </p>

</aside>

<h2 id="leanpub-auto-communicating-with-channels" class="section">10.5 Communicating with channels</h2>

<p>We discussed channels briefly in Chapter 7 and we’ve already seen channel mechanics employed earlier in this chapter when we considered <i>context</i>, which uses channels in its implementation to send cancellation signals.</p>

<p>For the remainder of this chapter, we’ll look at how channels provide a mechanism for messaging and signalling between concurrent goroutines.  There’s a lot to cover, but we’ll progress slowly, and hopefully logically. By the end of this chapter, we’ll have channels down. </p>

<p>Let’s get started!</p>

<h3 id="leanpub-auto-signalling-versus-messaging" class="subsection">10.5.1 Signalling versus messaging</h3>

<p>Messaging over channels speaks for itself. We pass messages, or data, which could include work to be performed, results of work and possibly errors too, between goroutines, or from goroutines back to our <i>main</i> execution.</p>

<p>But what about <i>signalling</i>? When signalling over channels, we may still send data, but the data is <i>signal</i> rather than <i>information</i>. Channels for signalling, provide a way for goroutines to inform each other - and main - of their status. </p>

<p>The idiomatic way to create a signalling channel is to use a channel of type empty struct. Although we’ll often see types of <i>bool</i> or <i>int</i> used too, the empty struct is better for a few reasons.</p>

<p>An empty struct is 0 bytes in size, so it occupies no storage. It <b>cannot</b> carry any data, so it is clear the channel is for signalling only. </p>

<p>If we use <i>bool</i> or <i>int</i> types, the intent is less clear. Is the channel being used to share state which may fluctuate between <code>true</code> and <code>false</code>, or carry a number result, or is it for signalling? We can’t be sure just by looking at the channel declaration alone. With an empty struct, there is zero ambiguity.</p>

<p>Often, we’ll use a signalling channel so goroutines may inform <i>main</i> when they have completed their work, similar to how they would call <code>wg.Done()</code> if we implemented a <i>waitgroup</i>. That’s probably one of the most common applications of signalling channels, but we can do more.</p>

<p>By way of demonstration, in this next example, we’ll solve the race condition problem we identified in the previous section. But we won’t use a mutex this time, instead, we’ll leverage the signalling (and blocking) nature of channels, to implement a guard around the shared <code>myCounter</code> variable.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 134 - Signalling channel for mutual exclusion</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"sync"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">var</code> <code class="n">myCounter</code> <code class="nb">int</code>
<code class="linenos">10 </code>	<code class="n">var</code> <code class="n">wg</code> <code class="n">sync</code><code class="o">.</code><code class="n">WaitGroup</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code>	<code class="n">var</code> <code class="n">lock</code> <code class="o">=</code> <code class="n">make</code><code class="p">(</code><code class="n">chan</code> <code class="n">struct</code><code class="p">{},</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code>	<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="mi">10000</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos">15 </code>		<code class="n">wg</code><code class="o">.</code><code class="n">Add</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
<code class="linenos">16 </code>		<code class="n">go</code> <code class="n">func</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">17 </code>			<code class="n">lock</code> <code class="o">&lt;-</code> <code class="n">struct</code><code class="p">{}{}</code>
<code class="linenos">18 </code>			<code class="n">myCounter</code> <code class="o">+=</code> <code class="mi">1</code>
<code class="linenos">19 </code>			<code class="o">&lt;-</code><code class="n">lock</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code>			<code class="n">wg</code><code class="o">.</code><code class="n">Done</code><code class="p">()</code>
<code class="linenos">22 </code>		<code class="p">}()</code>
<code class="linenos">23 </code>	<code class="p">}</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code>	<code class="n">wg</code><code class="o">.</code><code class="n">Wait</code><code class="p">()</code>
<code class="linenos">26 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Counter total is: </code><code class="si">%d</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">myCounter</code><code class="p">)</code>
<code class="linenos">27 </code><code class="p">}</code>
<code class="linenos">28 </code>
<code class="linenos">29 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">JHiaz5Rjvii</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Counter total is: <code class="m">10000</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code>Program exited.
</pre></div>

</figure>


<p>The result is correct, but we didn’t need a mutex.  Instead, we declared a channel value of type <code>struct{}</code> as the <code>lock</code> variable. The first goroutine to place a <code>struct{}</code> value on the channel, fills the channel, meaning no other goroutines can put a value on the channel as there is no capacity.</p>

<p>Once the first goroutine has completed its work and incremented <code>myCounter</code>, it reads back from the channel, discarding the value read.  The channel now has capacity again. </p>

<p>Another blocked goroutine can write a <code>struct{}</code> to the channel, which again locks the remaining goroutines out until it completes its work and reads back from the channel.</p>

<p>This process of <i>locking</i> and <i>unlocking</i> continues until all goroutines have performed their work.</p>

<aside class="information blurb">
    <p>The channel has a buffer size of <code>1</code> which is important. Try removing the buffer and see what happens. The program panics with a deadlock error.  We’ll discuss unbuffered and buffered channels, as well as why the buffer is crucial for this example, in the next section.</p>

</aside>

<p>We can see the syntax employed to place a value on the channel <code>lock &lt;- struct{}{}</code> and read back from the channel <code>&lt;- lock</code>.  As mentioned, we discarded the value we read, since it was just a signalling channel in this example. </p>

<p>Had we been sharing data - data which needed for later use - we could have captured it in a variable like so.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="n">channelValue</code> <code class="o">:=</code> <code class="o">&lt;-</code> <code class="n">dataChan</code>
</pre></div>

</figure>


<h3 id="leanpub-auto-buffered-or-unbuffered-channels" class="subsection">10.5.2 Buffered or unbuffered channels?</h3>

<p>We can create both unbuffered and buffered channels in Go. A buffered channel can have a capacity of anything from a value of <code>1</code> upwards and the buffer size is considered to be a part of the channel’s type declaration. Buffered and unbuffered channels behave differently, and we need a way to reason about that different behaviour.</p>

<p>Think of a buffered channel as a mailbox which can hold as many letters as the buffer size allows. Because it is a mailbox, users of the mailbox - the courier and recipient - can access it independently of each other. </p>

<p>As long as there is space in the mailbox, the courier can leave an item of mail in the mailbox and then continue about their business. As long as there is some mail in the mailbox the recipient can retrieve it one piece at a time. </p>

<p>Even if the mailbox has the capacity to hold only one item of mail the courier can make a delivery, and then continue about their business, and, as long as the recipient collects that item before the courier next arrives with another item, a mailbox which holds just one item of mail is sufficiently sized.</p>

<p>If there is no space in the mailbox, the courier must wait for the recipient to arrive and remove an item. If there is nothing in the mailbox when the recipient arrives, the recipient has to wait until the courier arrives to put an item in the mailbox before leaving with that item</p>

<p>So how does that compare to an unbuffered channel? Think of that as signed-for hand delivery instead.</p>

<p>When the courier arrives with an item, they can’t just deposit it in the mailbox and go about their business. They must wait for the recipient to meet them before handing over the item.</p>

<p>Similarly, if the recipient is waiting for a delivery, they must wait for the courier to arrive with their item before they can do anything else.</p>

<p>So that’s our courier analogy, let’s summarise that specifically in relation to channels.</p>

<p>An unbuffered channel blocks either the send or receive operation until both can take place simultaneously. Like hand delivery. Unbuffered channels are often referred to as <i>synchronous channels</i>.</p>

<p>A buffered channel which has contents <i>and</i> spare capacity does not block either the send or receive operation. When full, the send operation is blocked until capacity becomes available, and when empty, the receive operation is blocked until the channel contains something in the buffer to take. They’re a <i>bit</i> like a mailbox, and are often referred to as <i>asynchronous channels</i>. </p>

<p>How the buffer fills and depletes depends on the workloads being performed in the goroutines which send and receive on the channel but in many cases a buffer of 1 will be sufficient to ensure neither send nor receive operations get blocked.</p>

<p>Before we move on, let’s apply this new knowledge to Example 134. Why was the buffer important in that code, and why did the code panic if we used an unbuffered channel instead?</p>

<p>With a buffer size of one, the first goroutine could add a value to the channel and then continue its work. That work entailed incrementing the <code>myCounter</code> variable and then reading back from the channel. With the first value on the channel there was no capacity for any more values, so the rest of the goroutines had to wait until there was capacity again.</p>

<p>The problem with using an unbuffered channel here is that no goroutine is waiting to receive on the channel. The first goroutine to use it, which wants to send, has to wait until another goroutine is ready to receive before it can send. It is blocked.</p>

<p>But, no goroutine ever arrives to receive on the channel. They are all send first goroutines, which in any case, are also blocked. We have a deadlock. None of our goroutines can be scheduled by the Go scheduler. The program panics.</p>

<p>It’s a simple example but hopefully serves to illustrate how we should reason about channel communication.  The second takeaway is that it is very easy to introduce bugs when working with channel communication, in this case, by simply using a channel without a buffer.</p>

<p>Where there is a known amount of work to perform, the channel buffer can be sized to store the results of that work. A batch of worker goroutines can perform the work and place the results on the channel. Another batch can then process the results by reading from the channel buffer.  </p>

<p>A real-life example could be a series of HTTP requests for data.  The data is fetched and stored in the channel buffer, and then processed later.</p>

<p>The example below illustrates the mechanics. Operations of this kind are one of the few times we will create a channel with a buffer larger than <code>1</code>.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 135 - Sizing the buffer to store results</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"sync"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">var</code> <code class="n">wg</code> <code class="n">sync</code><code class="o">.</code><code class="n">WaitGroup</code>
<code class="linenos">10 </code>	<code class="n">store</code> <code class="o">:=</code> <code class="n">make</code><code class="p">(</code><code class="n">chan</code> <code class="nb">int</code><code class="p">,</code> <code class="mi">3</code><code class="p">)</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code>	<code class="o">//</code> <code class="n">fill</code> <code class="n">the</code> <code class="n">channel</code> <code class="n">buffer</code>
<code class="linenos">13 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Filling the buffer"</code><code class="p">)</code>
<code class="linenos">14 </code>	<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="mi">3</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos">15 </code>		<code class="n">wg</code><code class="o">.</code><code class="n">Add</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
<code class="linenos">16 </code>		<code class="n">go</code> <code class="n">func</code><code class="p">(</code><code class="n">i</code> <code class="nb">int</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">17 </code>			<code class="n">store</code> <code class="o">&lt;-</code> <code class="n">i</code>
<code class="linenos">18 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Channel buffer contains </code><code class="si">%d</code><code class="s2"> values</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="n">store</code><code class="p">))</code>
<code class="linenos">19 </code>			<code class="n">wg</code><code class="o">.</code><code class="n">Done</code><code class="p">()</code>
<code class="linenos">20 </code>		<code class="p">}(</code><code class="n">i</code><code class="p">)</code>
<code class="linenos">21 </code>	<code class="p">}</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code>	<code class="n">wg</code><code class="o">.</code><code class="n">Wait</code><code class="p">()</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code>	<code class="o">//</code> <code class="n">read</code> <code class="n">back</code> <code class="kn">from</code> <code class="nn">the</code> <code class="n">channel</code> <code class="n">buffer</code>
<code class="linenos">26 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Reading the buffer"</code><code class="p">)</code>
<code class="linenos">27 </code>	<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="mi">3</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos">28 </code>		<code class="n">wg</code><code class="o">.</code><code class="n">Add</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
<code class="linenos">29 </code>		<code class="n">go</code> <code class="n">func</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">30 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Reading value </code><code class="si">%d</code><code class="s2"> from channel buffer</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="o">&lt;-</code><code class="n">store</code><code class="p">)</code>
<code class="linenos">31 </code>			<code class="n">wg</code><code class="o">.</code><code class="n">Done</code><code class="p">()</code>
<code class="linenos">32 </code>		<code class="p">}()</code>
<code class="linenos">33 </code>	<code class="p">}</code>
<code class="linenos">34 </code>
<code class="linenos">35 </code>	<code class="n">wg</code><code class="o">.</code><code class="n">Wait</code><code class="p">()</code>
<code class="linenos">36 </code>
<code class="linenos">37 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Finished"</code><code class="p">)</code>
<code class="linenos">38 </code><code class="p">}</code>
<code class="linenos">39 </code>
<code class="linenos">40 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">YVTWPzUYht9</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code>Filling the buffer
<code class="linenos"> 2 </code>Channel buffer contains <code class="m">1</code> values
<code class="linenos"> 3 </code>Channel buffer contains <code class="m">2</code> values
<code class="linenos"> 4 </code>Channel buffer contains <code class="m">3</code> values
<code class="linenos"> 5 </code>Reading the buffer
<code class="linenos"> 6 </code>Reading value <code class="m">2</code> from channel buffer
<code class="linenos"> 7 </code>Reading value <code class="m">1</code> from channel buffer
<code class="linenos"> 8 </code>Reading value <code class="m">0</code> from channel buffer
<code class="linenos"> 9 </code>Finished
<code class="linenos">10 </code>
<code class="linenos">11 </code>Program exited.
</pre></div>

</figure>


<h3 id="leanpub-auto-unidirectional-channels" class="subsection">10.5.3 Unidirectional channels</h3>

<p>Channels themselves are bi-directional. They can receive data from goroutines which send on the channel, and they can hand over data to goroutines which receive on the channel.</p>

<p>However, the Go type system supports <i>unidirectional</i> channel typing: channel types on which it is only possible to send, and channel types on which it is only possible to receive.</p>

<p>By specifying a unidirectional type, when we share a channel around our program, although the channel itself is bi-directional, we can restrict its usage with a unidirectional type. In doing so, we add further type safety to our programs. The compiler will fail to build our program if we attempt to send on a receive-only unidirectional typed channel and vice versa.</p>

<p>Below we illustrate the syntax.  Try changing the <code>chan</code> type on line 17 to either unidirectional type.  Because the function <code>SenderReceiver()</code> performs both a <i>send</i> and a <i>receive</i> on the channel, restricting it to either direction will cause compilation to fail.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 136 - Unidirectional channel types</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">Sender</code><code class="p">(</code><code class="n">ch</code> <code class="n">chan</code><code class="o">&lt;-</code> <code class="n">string</code><code class="p">,</code> <code class="n">message</code> <code class="n">string</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 8 </code>    <code class="o">//</code> <code class="n">chan</code><code class="o">&lt;-</code> <code class="n">unidirectional</code> <code class="n">send</code>
<code class="linenos"> 9 </code>	<code class="n">ch</code> <code class="o">&lt;-</code> <code class="n">message</code>
<code class="linenos">10 </code><code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="n">func</code> <code class="n">Receiver</code><code class="p">(</code><code class="n">ch</code> <code class="o">&lt;-</code><code class="n">chan</code> <code class="n">string</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">13 </code>    <code class="o">//</code> <code class="o">&lt;-</code><code class="n">chan</code> <code class="n">unidirectional</code> <code class="n">receive</code>
<code class="linenos">14 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="o">&lt;-</code><code class="n">ch</code><code class="p">)</code>
<code class="linenos">15 </code><code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="n">func</code> <code class="n">SenderReceiver</code><code class="p">(</code><code class="n">ch</code> <code class="n">chan</code> <code class="n">string</code><code class="p">,</code> <code class="n">message</code> <code class="n">string</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">18 </code>    <code class="o">//</code> <code class="n">chan</code> <code class="n">bi</code><code class="o">-</code><code class="n">directional</code> <code class="n">send</code> <code class="ow">or</code> <code class="n">receive</code>
<code class="linenos">19 </code>	<code class="n">ch</code> <code class="o">&lt;-</code> <code class="n">message</code>
<code class="linenos">20 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="o">&lt;-</code><code class="n">ch</code><code class="p">)</code>
<code class="linenos">21 </code><code class="p">}</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">24 </code>	<code class="n">ch</code> <code class="o">:=</code> <code class="n">make</code><code class="p">(</code><code class="n">chan</code> <code class="n">string</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code>	<code class="n">Sender</code><code class="p">(</code><code class="n">ch</code><code class="p">,</code> <code class="s2">"Hello World"</code><code class="p">)</code>
<code class="linenos">27 </code>	<code class="n">Receiver</code><code class="p">(</code><code class="n">ch</code><code class="p">)</code>
<code class="linenos">28 </code>	<code class="n">SenderReceiver</code><code class="p">(</code><code class="n">ch</code><code class="p">,</code> <code class="s2">"Hello World again"</code><code class="p">)</code>
<code class="linenos">29 </code><code class="p">}</code>
<code class="linenos">30 </code>
<code class="linenos">31 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">ztggMJsU0cj</code>
</pre></div>

</figure>


<h3 id="leanpub-auto-signalling-using-an-unbuffered-channel" class="subsection">10.5.4 Signalling using an unbuffered channel</h3>

<p>So far we’ve used waitgroups to synchronise executing goroutines, but we can also utilise the blocking characteristics of an unbuffered channel in many cases.</p>

<p>In this next example, we show what is a commonly used pattern, which prevents the program from exiting until the goroutine has completed its work.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 137 - Unbuffered channel for signalling</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"time"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">done</code> <code class="o">:=</code> <code class="n">make</code><code class="p">(</code><code class="n">chan</code> <code class="n">struct</code><code class="p">{})</code>
<code class="linenos">10 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"The receive operation on the channel is blocked"</code><code class="p">)</code>
<code class="linenos">11 </code>	<code class="n">go</code> <code class="n">func</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">12 </code>		<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">5</code><code class="p">;</code> <code class="n">i</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">--</code> <code class="p">{</code>
<code class="linenos">13 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Signalling done in </code><code class="si">%d</code><code class="s2"> seconds</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">i</code><code class="p">)</code>
<code class="linenos">14 </code>			<code class="n">time</code><code class="o">.</code><code class="n">Sleep</code><code class="p">(</code><code class="mi">1</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">)</code>
<code class="linenos">15 </code>		<code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code>		<code class="n">done</code> <code class="o">&lt;-</code> <code class="n">struct</code><code class="p">{}{}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code>	<code class="p">}()</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code>	<code class="o">&lt;-</code><code class="n">done</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"OK, exiting"</code><code class="p">)</code>
<code class="linenos">24 </code><code class="p">}</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">ro8OHTv4G4x</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>The receive operation on the channel is blocked
<code class="linenos">2 </code>Signalling <code class="k">done</code> <code class="k">in</code> <code class="m">5</code> seconds
<code class="linenos">3 </code>Signalling <code class="k">done</code> <code class="k">in</code> <code class="m">4</code> seconds
<code class="linenos">4 </code>Signalling <code class="k">done</code> <code class="k">in</code> <code class="m">3</code> seconds
<code class="linenos">5 </code>Signalling <code class="k">done</code> <code class="k">in</code> <code class="m">2</code> seconds
<code class="linenos">6 </code>Signalling <code class="k">done</code> <code class="k">in</code> <code class="m">1</code> seconds
<code class="linenos">7 </code>OK, exiting
<code class="linenos">8 </code>
<code class="linenos">9 </code>Program exited.
</pre></div>

</figure>


<p>We’ve removed the waitgroup and instead use a single unbuffered channel which blocks on receive until the signal is sent on the channel. Once the receive happens, after printing some output, the program exits.</p>

<h3 id="leanpub-auto-closing-a-channel" class="subsection">10.5.5 Closing a channel</h3>

<p>There’s a limitation with the previous example.  Only one receive can take place, so only one goroutine gets the signal. When that goroutine is main, that’s fine but if we had hundreds of goroutines blocked waiting to receive, a single <i>done</i> signal would not be very useful.</p>

<p>Fortunately, we’ve another way to signal without data, by closing the channel.</p>

<p>By explicitly closing the channel, we signal that no more data will be sent on the channel. When a channel is closed in this manner, all goroutines which are blocked waiting to receive will return immediately.</p>

<p>In the example which follows, to avoid needing to send an empty struct on the channel, we simply close the channel. It’s a drop-in replacement for the previous syntax.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 138 - Signalling by closing the channel</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"time"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">done</code> <code class="o">:=</code> <code class="n">make</code><code class="p">(</code><code class="n">chan</code> <code class="n">struct</code><code class="p">{})</code>
<code class="linenos">10 </code>	<code class="n">go</code> <code class="n">func</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">11 </code>		<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">5</code><code class="p">;</code> <code class="n">i</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">--</code> <code class="p">{</code>
<code class="linenos">12 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Signalling done in </code><code class="si">%d</code><code class="s2"> seconds</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">i</code><code class="p">)</code>
<code class="linenos">13 </code>			<code class="n">time</code><code class="o">.</code><code class="n">Sleep</code><code class="p">(</code><code class="mi">1</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">)</code>
<code class="linenos">14 </code>		<code class="p">}</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code>		<code class="n">close</code><code class="p">(</code><code class="n">done</code><code class="p">)</code>
<code class="linenos">17 </code>	<code class="p">}()</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code>	<code class="o">&lt;-</code><code class="n">done</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"OK, exiting"</code><code class="p">)</code>
<code class="linenos">22 </code><code class="p">}</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">ciX1rKK</code><code class="o">-</code><code class="n">XAV</code>
</pre></div>

</figure>


<p>In this example, we have five goroutines which are blocked and waiting to receive. After a short duration, we close the channel from within <i>main</i>. This unblocks all receive operations and enables the goroutines to return.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 139 - Signalling multiple goroutines by closing the channel</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"time"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">message</code> <code class="o">:=</code> <code class="n">make</code><code class="p">(</code><code class="n">chan</code> <code class="n">string</code><code class="p">)</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code>	<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="mi">5</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos">12 </code>		<code class="n">go</code> <code class="n">func</code><code class="p">(</code><code class="n">i</code> <code class="nb">int</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">13 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"G</code><code class="si">%d</code><code class="s2"> is blocked</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">i</code><code class="p">)</code>
<code class="linenos">14 </code>			<code class="o">&lt;-</code><code class="n">message</code>
<code class="linenos">15 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"G</code><code class="si">%d</code><code class="s2"> is returning</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">i</code><code class="p">)</code>
<code class="linenos">16 </code>		<code class="p">}(</code><code class="n">i</code><code class="p">)</code>
<code class="linenos">17 </code>	<code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code>	<code class="o">&lt;-</code><code class="n">time</code><code class="o">.</code><code class="n">After</code><code class="p">(</code><code class="mi">5</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">)</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code>	<code class="n">close</code><code class="p">(</code><code class="n">message</code><code class="p">)</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code>	<code class="o">&lt;-</code><code class="n">time</code><code class="o">.</code><code class="n">After</code><code class="p">(</code><code class="mi">5</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">)</code>
<code class="linenos">24 </code><code class="p">}</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">vHFbaV5Tyg3</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code>G1 is blocked
<code class="linenos"> 2 </code>G0 is blocked
<code class="linenos"> 3 </code>G2 is blocked
<code class="linenos"> 4 </code>G3 is blocked
<code class="linenos"> 5 </code>G4 is blocked
<code class="linenos"> 6 </code>G4 is returning
<code class="linenos"> 7 </code>G1 is returning
<code class="linenos"> 8 </code>G3 is returning
<code class="linenos"> 9 </code>G2 is returning
<code class="linenos">10 </code>G0 is returning
<code class="linenos">11 </code>
<code class="linenos">12 </code>Program exited.
</pre></div>

</figure>


<aside class="information blurb">
    <p>We used another blocking receive operation in the previous example, with the <code>time.After()</code> function. This function waits for the specified duration and then sends the current time on an unbuffered channel. The receive operation blocks accordingly.</p>

</aside>

<p>When we close a channel if there is data on the channel, in a buffer, it is possible to continue to read the channel buffer even though the channel is closed. But, if we attempt to send on the channel after it has been closed, our program will panic. To avoid this risk, only the sending goroutine should close the channel, not the receiver.</p>

<p>In this final example, we demonstrate how data continues to be read from the channel after it has been closed. And, if you uncomment line 24 and run the program again, it will panic when attempting to send data on the closed channel.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 140 - Reading from a closed channel</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="n">data</code> <code class="o">:=</code> <code class="n">make</code><code class="p">(</code><code class="n">chan</code> <code class="nb">int</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Sending to channel"</code><code class="p">)</code>
<code class="linenos">11 </code>	<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="mi">10</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos">12 </code>		<code class="n">data</code> <code class="o">&lt;-</code> <code class="n">i</code>
<code class="linenos">13 </code>		<code class="k">if</code> <code class="n">i</code> <code class="o">==</code> <code class="mi">9</code> <code class="p">{</code>
<code class="linenos">14 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Closing channel"</code><code class="p">)</code>
<code class="linenos">15 </code>			<code class="n">close</code><code class="p">(</code><code class="n">data</code><code class="p">)</code>
<code class="linenos">16 </code>		<code class="p">}</code>
<code class="linenos">17 </code>	<code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Reading from closed channel"</code><code class="p">)</code>
<code class="linenos">20 </code>	<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="mi">10</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos">21 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Received:"</code><code class="p">,</code> <code class="o">&lt;-</code><code class="n">data</code><code class="p">)</code>
<code class="linenos">22 </code>	<code class="p">}</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code>	<code class="o">//</code><code class="n">data</code> <code class="o">&lt;-</code> <code class="mi">10</code>
<code class="linenos">25 </code><code class="p">}</code>
<code class="linenos">26 </code>
<code class="linenos">27 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">iedP9__fCzR</code>
</pre></div>

</figure>

<p class="fake-para">Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code>Sending to channel
<code class="linenos"> 2 </code>Closing channel
<code class="linenos"> 3 </code>Reading from closed channel
<code class="linenos"> 4 </code>Received: <code class="m">0</code>
<code class="linenos"> 5 </code>Received: <code class="m">1</code>
<code class="linenos"> 6 </code>Received: <code class="m">2</code>
<code class="linenos"> 7 </code>Received: <code class="m">3</code>
<code class="linenos"> 8 </code>Received: <code class="m">4</code>
<code class="linenos"> 9 </code>Received: <code class="m">5</code>
<code class="linenos">10 </code>Received: <code class="m">6</code>
<code class="linenos">11 </code>Received: <code class="m">7</code>
<code class="linenos">12 </code>Received: <code class="m">8</code>
<code class="linenos">13 </code>Received: <code class="m">9</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code>Program exited.
</pre></div>

</figure>

<p class="fake-para">When reading from a channel, the receiving goroutine can optionally also inspect a second return value which will inform it when the channel has been closed.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">//</code><code class="n">ok</code> <code class="n">is</code> <code class="n">false</code> <code class="n">when</code> <code class="n">the</code> <code class="n">channel</code> <code class="n">is</code> <code class="n">closed</code>
<code class="linenos">2 </code><code class="n">d</code><code class="p">,</code> <code class="n">ok</code> <code class="o">:=</code> <code class="o">&lt;-</code><code class="n">data</code>
</pre></div>

</figure>


<h3 id="leanpub-auto-using-range-with-channels" class="subsection">10.5.6 Using range with channels</h3>

<p>We can use a <i>for range</i> loop to receive from a channel indefinitely. When the channel is closed by the sender, any buffered data is read from the channel before program execution continues. </p>

<p>This approach is useful since in real-world applications we often won’t know how much data to expect.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 141 - Reading from a channel with range</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="n">data</code> <code class="o">:=</code> <code class="n">make</code><code class="p">(</code><code class="n">chan</code> <code class="nb">int</code><code class="p">)</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code>	<code class="o">//</code> <code class="n">worker</code>
<code class="linenos">11 </code>	<code class="n">go</code> <code class="n">func</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">12 </code>		<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="mi">10</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos">13 </code>			<code class="n">data</code> <code class="o">&lt;-</code> <code class="n">i</code>
<code class="linenos">14 </code>		<code class="p">}</code>
<code class="linenos">15 </code>		<code class="n">close</code><code class="p">(</code><code class="n">data</code><code class="p">)</code>
<code class="linenos">16 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Channel closed"</code><code class="p">)</code>
<code class="linenos">17 </code>	<code class="p">}()</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code>	<code class="o">//</code> <code class="n">handler</code>
<code class="linenos">20 </code>	<code class="k">for</code> <code class="n">d</code> <code class="o">:=</code> <code class="nb">range</code> <code class="n">data</code> <code class="p">{</code>
<code class="linenos">21 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Receiving </code><code class="si">%d</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">d</code><code class="p">)</code>
<code class="linenos">22 </code>	<code class="p">}</code>
<code class="linenos">23 </code><code class="p">}</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">Qdo3mWvKmmg</code>
</pre></div>

</figure>


<p>We used an unbuffered channel which means the communication between the worker and the handler is synchronous. The channel wasn’t closed until all values had been sent and received.</p>

<p>We could have used a buffered channel instead. An appropriately sized buffer would enable the worker to load the channel with all the values and then close it. Range would still have read all the data from the closed channel before continuing. This modified code example demonstrates.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 142 - Reading from a closed channel with range</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code>	<code class="s2">"time"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">data</code> <code class="o">:=</code> <code class="n">make</code><code class="p">(</code><code class="n">chan</code> <code class="nb">int</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code>	<code class="o">//</code> <code class="n">worker</code>
<code class="linenos">12 </code>	<code class="n">go</code> <code class="n">func</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">13 </code>		<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="mi">10</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos">14 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Sending data"</code><code class="p">)</code>
<code class="linenos">15 </code>			<code class="n">data</code> <code class="o">&lt;-</code> <code class="n">i</code>
<code class="linenos">16 </code>		<code class="p">}</code>
<code class="linenos">17 </code>		<code class="n">close</code><code class="p">(</code><code class="n">data</code><code class="p">)</code>
<code class="linenos">18 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Channel closed"</code><code class="p">)</code>
<code class="linenos">19 </code>	<code class="p">}()</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code>	<code class="o">//</code> <code class="n">handler</code>
<code class="linenos">22 </code>	<code class="k">for</code> <code class="n">d</code> <code class="o">:=</code> <code class="nb">range</code> <code class="n">data</code> <code class="p">{</code>
<code class="linenos">23 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Printf</code><code class="p">(</code><code class="s2">"Receiving </code><code class="si">%d</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">d</code><code class="p">)</code>
<code class="linenos">24 </code>		<code class="n">time</code><code class="o">.</code><code class="n">Sleep</code><code class="p">(</code><code class="mi">1</code> <code class="o">*</code> <code class="n">time</code><code class="o">.</code><code class="n">Second</code><code class="p">)</code>
<code class="linenos">25 </code>	<code class="p">}</code>
<code class="linenos">26 </code><code class="p">}</code>
<code class="linenos">27 </code>
<code class="linenos">28 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">X5kcrsmOpQW</code>
</pre></div>

</figure>


<h3 id="leanpub-auto-monitoring-several-channels-with-select" class="subsection">10.5.7 Monitoring several channels with select</h3>

<p>Let’s wrap up channels by talking about <i>select</i>. In many applications, it’s necessary to handle data from more than one channel. Indeed, we’ve already encountered such a scenario in our discussion of <i>context</i>, where we monitored two channels, one for a ticker, and the other for the cancellation signal.</p>

<p><i>Select</i> is used to listen for communication on several channels at the same time. Its syntax is similar to a <i>switch</i> statement, but it’s designed specifically for channel operations.</p>

<p>The <i>select</i> statement blocks indefinitely until one of its cases can run, and then it executes that case. Each case statement is waiting to read on a specific channel, so when it executes, it means we have received on that channel. </p>

<p>It’s a common pattern to use <i>select</i> inside of a <i>for</i> loop so it executes repeatedly to read multiple values from multiple channels.</p>

<p>We can add a <i>default</i> case to the select to allow execution to continue even if there is nothing to receive on any of the channels, meaning the select no longer blocks.</p>

<p>If multiple cases can receive on their channels, only one case body will be executed, which, is chosen randomly.</p>

<p>In our final example, we utilise a select statement within a <i>for</i> loop to monitor two signalling channels. All cases in the select statement are executed once. Since the pong case body does not put a value back on either channel, there is nothing further to receive so the default case is executed at the next iteration. Without data to receive on either channel, the default case would be executed indefinitely, so we <i>return</i> from main, to exit the program, ensuring it only runs once in our example.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 143 - Monitoring multiple channels with select</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"fmt"</code>
<code class="linenos"> 5 </code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 8 </code>	<code class="n">ping</code> <code class="o">:=</code> <code class="n">make</code><code class="p">(</code><code class="n">chan</code> <code class="n">struct</code><code class="p">{},</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos"> 9 </code>	<code class="n">pong</code> <code class="o">:=</code> <code class="n">make</code><code class="p">(</code><code class="n">chan</code> <code class="n">struct</code><code class="p">{},</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code>	<code class="n">ping</code> <code class="o">&lt;-</code> <code class="n">struct</code><code class="p">{}{}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>	<code class="k">for</code> <code class="p">{</code>
<code class="linenos">14 </code>		<code class="n">select</code> <code class="p">{</code>
<code class="linenos">15 </code>		<code class="n">case</code> <code class="o">&lt;-</code><code class="n">ping</code><code class="p">:</code>
<code class="linenos">16 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Ping received"</code><code class="p">)</code>
<code class="linenos">17 </code>			<code class="n">pong</code> <code class="o">&lt;-</code> <code class="n">struct</code><code class="p">{}{}</code>
<code class="linenos">18 </code>		<code class="n">case</code> <code class="o">&lt;-</code><code class="n">pong</code><code class="p">:</code>
<code class="linenos">19 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Pong received"</code><code class="p">)</code>
<code class="linenos">20 </code>		<code class="n">default</code><code class="p">:</code>
<code class="linenos">21 </code>			<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="s2">"Continuing"</code><code class="p">)</code>
<code class="linenos">22 </code>			<code class="k">return</code>
<code class="linenos">23 </code>		<code class="p">}</code>
<code class="linenos">24 </code>	<code class="p">}</code>
<code class="linenos">25 </code><code class="p">}</code>
<code class="linenos">26 </code>
<code class="linenos">27 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">L8d4dFaVta3</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>Ping received
<code class="linenos">2 </code>Pong received
<code class="linenos">3 </code>Continuing
<code class="linenos">4 </code>
<code class="linenos">5 </code>Program exited.
</pre></div>

</figure>


<h2 id="leanpub-auto-summary-2" class="section">10.6 Summary</h2>

<p>Concurrency in Go is a powerful tool which enables us to write scalable and efficient applications. Goroutines and channels make it relatively easy for us to take advantage of multiple processors and handle multiple tasks simultaneously.</p>

<p>In this chapter we’ve covered most of Go’s concurrency mechanisms and, using several simple examples, we’ve illustrated the principles being applied and key points of learning.</p>

<p>However, asynchronous code is more complicated code and programs which leverage concurrency are undoubtedly more difficult to reason about. Additionally, when we choose to use concurrency, we increase the likelihood of bugs, some of which may not be discovered until runtime. So, before utilising concurrent programming techniques, we must understand trade-offs versus benefits.</p>


<h1 id="leanpub-auto-chapter-11---quality-assurance" class="chapter">Chapter 11 - Quality Assurance</h1>

<p>Next, we’re going to discuss <i>quality assurance</i>, a catchall term for ensuring the software we create is fit for purpose today and stays that way in the future.</p>

<p>At this point in our learning journey, we should now have the skills and knowledge to write good quality <i>Go</i> code. Not just a knowledge of syntax and general concepts, but an understanding of what is happening on the machine itself: knowledge which will help us create more robust Go programs by avoiding some of the gotchas.</p>

<p>But, since we’re human, we can’t guarantee we won’t make mistakes, just like we can’t guarantee we’ll always write code which performs well enough.</p>

<p>So quality assurance is a toolset - a framework if you like - for us to use, which can help us improve the quality of the software we create, hopefully reducing the incidence of errors and bugs in our code, while ensuring performance is sufficient for the purpose.</p>

<p>Quality assurance starts with softer practices, such as <i>buddying</i> or <i>code-pairing</i>, together with peer or senior review of code submissions. If we are writing readable and clear Go code - which by now we should be - these simple practices can improve application quality as well as present learning and knowledge-sharing opportunities.</p>

<p>But quality is improved also through the use of tooling and automation. Systems for software version control, for example. Automation for build, integration and deployment of code through test environments and into production, also helps.</p>

<p>In fact, anything that can reduce manual effort and cognitive load, and improve repeatability, adds value from a perspective of software quality, not to mention productivity, but discussion of these techniques take us well beyond the scope of this book.</p>

<p>So, in what is the final chapter of Go Faster, our discussion of quality assurance, keeps the focus on Go and the tooling which it includes, to assist us with <i>testing</i>, <i>benchmarking</i> and <i>profiling</i>.</p>

<h2 id="leanpub-auto-testing-1" class="section">11.1 Testing</h2>

<p>We use <i>testing</i> to ensure our software does what it should do, and continues to do so, over time, through initial and ongoing development. </p>

<p>Some developers like to develop against tests adopting a <i>test-driven development (TDD)</i> approach as they create the feature, while others like to develop the feature and then add tests. </p>

<p>Whatever our preference, we’ll probably find ourselves using a test first approach at some point. For example, in the absence of a real-world dependency such as a database, it can make sense to write the implementation by coding against a unit test which uses a mock database in place of the dependency.</p>

<p>Ultimately, when we add tests, is a matter of preference. Our concern is only that tests should exist before we mark a feature as <i>complete</i>, to lock in the expected behaviour of that feature and that the tests are of sufficient quality and coverage, so that if that behaviour should change, our test suite would alert us.</p>

<aside class="information blurb">
    <p>Go’s included test tooling is quite minimalist, but it has everything we need. There are several third-party testing packages available which build on top of the standard library, many of which replicate syntax and functionality from other languages. Of course, you should feel free to explore any of these packages, but here we’re going to focus solely on the standard library’s <i>testing</i> package.</p>

</aside>

<h3 id="leanpub-auto-test-file-setup" class="subsection">11.1.1 Test file setup</h3>

<p>Testing can be approached from two perspectives, <i>black-box</i> and <i>white-box</i> and the approach chosen will determine how we set up our test suite.</p>

<p>But what do we mean by <i>black-box</i> and <i>white-box</i>?</p>

<p>The former only tests exported functionality and behaves like a real user, while the latter <i>can</i> test all functionality, including unexported functions - the implementation details - by creating a test suite as part of the same package as the functionality under test.</p>

<p>Testing behaviour <i>should</i> cover all the implementations that support the behaviour, which helps achieve similar coverage in the majority of cases.</p>

<p>However, when testing using the white-box approach, it’s often easier to replace dependencies with mock implementations, as the functions being tested may directly accept them. Additionally, white-box testing is often better for creating targeted tests, especially for intricate implementation details that require individual test functions to affirm their quality.</p>

<p>Assume we have a package to test which is named <code>something</code>. The code sits in a single file, <code>something.go</code>. For both testing approaches, we would add a second file for the test functions named, <code>something_test.go</code>. The suffix informs the Go tool that it should run the functions in the file during tests.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>something/
<code class="linenos">2 </code>    something.go
<code class="linenos">3 </code>    something_test.go
</pre></div>

</figure>


<p>Using a white-box testing approach, the test file would be a part of the same package namespace. We can write tests for exported and unexported functionality, and because of this, we can often inject test dependencies directly into the functions under test. </p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>package something
</pre></div>

</figure>


<p>Conversely, by adopting a black-box testing approach, our test file would sit in a different package namespace, ensuring we can only import, and so write tests for, exported functionality. In many cases, we need to create specific setup and teardown functions to create values using test dependencies, before running the tests themselves, because the functions under test do not accept them directly.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>package something_test
</pre></div>

</figure>


<p>As the codebase expands, black-box testing is typically easier to maintain. Because it concentrates solely on the outcome and not the implementation, it is not affected by any changes to the implementation.</p>

<p>White-box tests that test the implementation may require more maintenance. As development progresses and implementation details are refactored, the tests will often need revision too.</p>

<h3 id="leanpub-auto-test-functions" class="subsection">11.1.2 Test functions</h3>

<p>Regardless of the approach chosen, all <code>*_test.go</code> files need to import the standard library’s <i>testing</i> package and all test functions should be prefixed with <i>Test</i> to mark them as tests. </p>

<p>To access the testing tools each function should accept the testing package’s type <code>T</code>, a struct, which is used to manage the test state and exposes receivers for logging to the screen and signalling failures.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="n">package</code> <code class="n">something_test</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="kn">import</code> <code class="s2">"test"</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code><code class="n">func</code> <code class="n">TestFunctionToTest</code><code class="p">(</code><code class="n">t</code> <code class="o">*</code><code class="n">testing</code><code class="o">.</code><code class="n">T</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">6 </code>
<code class="linenos">7 </code><code class="p">}</code>
</pre></div>

</figure>


<p>Test functions can be run from the command line individually or as a matching group using a regex search.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go <code class="nb">test</code> -run<code class="o">=</code>TestFunction
</pre></div>

</figure>


<p><code>T</code> implements the <code>testing.TB</code> interface so includes all of these receivers. The documentation can explain each throroughly.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">type</code> <code class="nv">TB</code> <code class="nv">interface</code> {
<code class="linenos"> 2 </code>	<code class="nv">Cleanup</code><code class="ss">(</code><code class="nv">func</code><code class="ss">())</code>
<code class="linenos"> 3 </code>	<code class="nv">Error</code><code class="ss">(</code><code class="nv">args</code> ...<code class="nv">any</code><code class="ss">)</code>
<code class="linenos"> 4 </code>	<code class="nv">Errorf</code><code class="ss">(</code><code class="nv">format</code> <code class="nv">string</code>, <code class="nv">args</code> ...<code class="nv">any</code><code class="ss">)</code>
<code class="linenos"> 5 </code>	<code class="nv">Fail</code><code class="ss">()</code>
<code class="linenos"> 6 </code>	<code class="nv">FailNow</code><code class="ss">()</code>
<code class="linenos"> 7 </code>	<code class="nv">Failed</code><code class="ss">()</code> <code class="nv">bool</code>
<code class="linenos"> 8 </code>	<code class="nv">Fatal</code><code class="ss">(</code><code class="nv">args</code> ...<code class="nv">any</code><code class="ss">)</code>
<code class="linenos"> 9 </code>	<code class="nv">Fatalf</code><code class="ss">(</code><code class="nv">format</code> <code class="nv">string</code>, <code class="nv">args</code> ...<code class="nv">any</code><code class="ss">)</code>
<code class="linenos">10 </code>	<code class="nv">Helper</code><code class="ss">()</code>
<code class="linenos">11 </code>	<code class="nv">Log</code><code class="ss">(</code><code class="nv">args</code> ...<code class="nv">any</code><code class="ss">)</code>
<code class="linenos">12 </code>	<code class="nv">Logf</code><code class="ss">(</code><code class="nv">format</code> <code class="nv">string</code>, <code class="nv">args</code> ...<code class="nv">any</code><code class="ss">)</code>
<code class="linenos">13 </code>	<code class="nv">Name</code><code class="ss">()</code> <code class="nv">string</code>
<code class="linenos">14 </code>	<code class="k">Setenv</code><code class="ss">(</code><code class="nv">key</code>, <code class="nv">value</code> <code class="nv">string</code><code class="ss">)</code>
<code class="linenos">15 </code>	<code class="nv">Skip</code><code class="ss">(</code><code class="nv">args</code> ...<code class="nv">any</code><code class="ss">)</code>
<code class="linenos">16 </code>	<code class="nv">SkipNow</code><code class="ss">()</code>
<code class="linenos">17 </code>	<code class="nv">Skipf</code><code class="ss">(</code><code class="nv">format</code> <code class="nv">string</code>, <code class="nv">args</code> ...<code class="nv">any</code><code class="ss">)</code>
<code class="linenos">18 </code>	<code class="nv">Skipped</code><code class="ss">()</code> <code class="nv">bool</code>
<code class="linenos">19 </code>	<code class="nv">TempDir</code><code class="ss">()</code> <code class="nv">string</code>
<code class="linenos">20 </code>}
</pre></div>

</figure>


<p>A test ends when the <code>Test*</code> function returns.  Failure can be signalled in several ways, either with logging or without. Able to continue to run remaining test assertions or a hard stop.</p>

<p>The receivers we’ll use frequently are listed below. Some signal failures, others produce output only, and one affects how the tests are run. The included comment briefly explains each.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">//</code> <code class="nv">log</code> <code class="nv">to</code> <code class="nv">screen</code>, <code class="nv">mark</code> <code class="nv">the</code> <code class="nv">test</code> <code class="nv">as</code> <code class="nv">failed</code> <code class="nv">and</code> <code class="k">continue</code>
<code class="linenos"> 2 </code><code class="nv">t</code>.<code class="nv">Errorf</code><code class="ss">()</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="o">//</code> <code class="nv">log</code> <code class="nv">to</code> <code class="nv">screen</code>, <code class="nv">mark</code> <code class="nv">the</code> <code class="nv">test</code> <code class="nv">as</code> <code class="nv">failed</code>, <code class="nv">and</code> <code class="k">return</code>
<code class="linenos"> 5 </code><code class="nv">t</code>.<code class="nv">Fatalf</code><code class="ss">()</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="o">//</code> <code class="nv">mark</code> <code class="nv">as</code> <code class="nv">failed</code> <code class="nv">and</code> <code class="k">continue</code>
<code class="linenos"> 8 </code><code class="nv">t</code>.<code class="nv">Fail</code><code class="ss">()</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="o">//</code> <code class="nv">mark</code> <code class="nv">as</code> <code class="nv">failed</code> <code class="nv">and</code> <code class="k">return</code>
<code class="linenos">11 </code><code class="nv">t</code>.<code class="nv">FailNow</code><code class="ss">()</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="o">//</code> <code class="nv">log</code> <code class="nv">to</code> <code class="nv">screen</code>, <code class="nv">printed</code> <code class="nv">only</code> <code class="k">if</code> <code class="nv">the</code> <code class="nv">test</code> <code class="nv">fails</code>
<code class="linenos">14 </code><code class="o">//</code> <code class="nv">or</code> <code class="nv">the</code> <code class="nv">verbose</code> <code class="nv">flag</code> <code class="nv">is</code> <code class="nv">set</code> `<code class="o">-</code><code class="nv">v</code>`
<code class="linenos">15 </code><code class="nv">t</code>.<code class="nv">LogF</code><code class="ss">()</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="o">//</code> <code class="nv">Run</code> <code class="nv">test</code> <code class="nv">in</code> <code class="nv">parallel</code> <code class="nv">with</code> <code class="nv">other</code> <code class="nv">tests</code> <code class="nv">allowed</code> <code class="nv">to</code> <code class="nv">run</code> <code class="nv">in</code> <code class="nv">parallel</code>
<code class="linenos">18 </code><code class="o">//</code> <code class="nv">to</code> <code class="nv">reduce</code> <code class="nv">test</code> <code class="nv">run</code> <code class="nv">time</code>
<code class="linenos">19 </code><code class="nv">t</code>.<code class="nv">Parallel</code><code class="ss">()</code>
</pre></div>

</figure>


<h3 id="leanpub-auto-test-coverage" class="subsection">11.1.3 Test coverage</h3>

<p>The Go tool can provide an indicator of test coverage, a percentage indicator of the amount of our code that was executed when running the tests. We can obtain a coverage metric with the addition of the <code>-cover</code> flag.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>$ go <code class="nb">test</code> -cover
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>PASS
<code class="linenos">2 </code>coverage: <code class="m">67</code>.0% of statements
<code class="linenos">3 </code>ok  	github.com/golangatspeed	<code class="m">0</code>.010s
</pre></div>

</figure>


<p>A coverage report, with syntax highlighting to indicate which execution paths are covered by tests, and those which are not can be generated with the commands below.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>// generate the coverage report
<code class="linenos">2 </code>go <code class="nb">test</code> -cover -coverprofile<code class="o">=</code>cover.out
<code class="linenos">3 </code>
<code class="linenos">4 </code>// opens a web browser with the syntax highlighted coverage
<code class="linenos">5 </code>go tool cover -html<code class="o">=</code>cover.out
</pre></div>

</figure>


<h3 id="leanpub-auto-subtests" class="subsection">11.1.4 Subtests</h3>

<p>It’s common to write what is known as <i>table-driven</i> tests, where the same function is tested in repetition using several test cases, each a specific set of test inputs and expectations. </p>

<p>Since Go 1.7, we’ve been able to create subtests, by calling <code>t.Run()</code> for each test case and there are several advantages to using subtests for multiple test cases.</p>

<p>Each test case is isolated. A call to <code>t.Fatalf()</code>, or <code>t.FailNow()</code> will not prevent the next test case from being run. </p>

<p>Setup and teardown code can be used to wrap a group of subtests, reducing the time spent on these operations, which are executed if any single one of the included subtests is run. </p>

<p>Subtests can also be run from the command line, either individually or as a group using the regex search filter mentioned already, with the addition of search text representing the contents of the test case.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go <code class="nb">test</code> -run<code class="o">=</code>TestTime/<code class="s2">"in Europe"</code>
</pre></div>

</figure>


<p>We’ll leave the section on testing with an example of table-driven testing which leverage subtests. </p>

<aside class="information blurb">
    <p>Observe that we’re testing using a white-box approach in the example, and we include the test and the function under test in the same file on the Go Playground simply for convenience. In the Github repository we split the code into the appropriate files.</p>

</aside>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 144 - Example test with subtests</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"errors"</code>
<code class="linenos"> 5 </code>	<code class="s2">"testing"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">var</code> <code class="n">ERR_WOULD_OVERFLOW</code> <code class="o">=</code> <code class="n">errors</code><code class="o">.</code><code class="n">New</code><code class="p">(</code><code class="s2">"would overflow"</code><code class="p">)</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="n">func</code> <code class="n">Adder</code><code class="p">(</code><code class="nb">list</code> <code class="o">...</code><code class="n">uint8</code><code class="p">)</code> <code class="p">(</code><code class="n">uint8</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">11 </code>	<code class="n">var</code> <code class="n">t</code> <code class="n">uint8</code>
<code class="linenos">12 </code>	<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="nb">len</code><code class="p">(</code><code class="nb">list</code><code class="p">);</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos">13 </code>		<code class="k">if</code> <code class="nb">int</code><code class="p">(</code><code class="n">t</code><code class="p">)</code><code class="o">+</code><code class="nb">int</code><code class="p">(</code><code class="nb">list</code><code class="p">[</code><code class="n">i</code><code class="p">])</code> <code class="o">&gt;</code> <code class="mi">255</code> <code class="p">{</code>
<code class="linenos">14 </code>			<code class="k">return</code> <code class="mi">0</code><code class="p">,</code> <code class="n">ERR_WOULD_OVERFLOW</code>
<code class="linenos">15 </code>		<code class="p">}</code>
<code class="linenos">16 </code>		<code class="n">t</code> <code class="o">+=</code> <code class="nb">list</code><code class="p">[</code><code class="n">i</code><code class="p">]</code>
<code class="linenos">17 </code>	<code class="p">}</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code>	<code class="k">return</code> <code class="n">t</code><code class="p">,</code> <code class="n">nil</code>
<code class="linenos">20 </code><code class="p">}</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code><code class="n">func</code> <code class="n">TestAdder</code><code class="p">(</code><code class="n">t</code> <code class="o">*</code><code class="n">testing</code><code class="o">.</code><code class="n">T</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">23 </code>	<code class="n">testCases</code> <code class="o">:=</code> <code class="p">[]</code><code class="n">struct</code> <code class="p">{</code>
<code class="linenos">24 </code>		<code class="n">name</code>    <code class="n">string</code>
<code class="linenos">25 </code>		<code class="n">inputs</code>  <code class="p">[]</code><code class="n">uint8</code>
<code class="linenos">26 </code>		<code class="n">wantRes</code> <code class="n">uint8</code>
<code class="linenos">27 </code>		<code class="n">wantErr</code> <code class="n">error</code>
<code class="linenos">28 </code>	<code class="p">}{</code>
<code class="linenos">29 </code>		<code class="p">{</code>
<code class="linenos">30 </code>			<code class="s2">"simple total"</code><code class="p">,</code>
<code class="linenos">31 </code>			<code class="p">[]</code><code class="n">uint8</code><code class="p">{</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">7</code><code class="p">},</code>
<code class="linenos">32 </code>			<code class="mi">9</code><code class="p">,</code>
<code class="linenos">33 </code>			<code class="n">nil</code><code class="p">,</code>
<code class="linenos">34 </code>		<code class="p">},</code>
<code class="linenos">35 </code>		<code class="p">{</code>
<code class="linenos">36 </code>			<code class="s2">"overflow prevented"</code><code class="p">,</code>
<code class="linenos">37 </code>			<code class="p">[]</code><code class="n">uint8</code><code class="p">{</code><code class="mi">255</code><code class="p">,</code> <code class="mi">1</code><code class="p">},</code>
<code class="linenos">38 </code>			<code class="mi">0</code><code class="p">,</code>
<code class="linenos">39 </code>			<code class="n">ERR_WOULD_OVERFLOW</code><code class="p">,</code>
<code class="linenos">40 </code>		<code class="p">},</code>
<code class="linenos">41 </code>	<code class="p">}</code>
<code class="linenos">42 </code>
<code class="linenos">43 </code>	<code class="k">for</code> <code class="n">_</code><code class="p">,</code> <code class="n">tc</code> <code class="o">:=</code> <code class="nb">range</code> <code class="n">testCases</code> <code class="p">{</code>
<code class="linenos">44 </code>		<code class="n">t</code><code class="o">.</code><code class="n">Run</code><code class="p">(</code><code class="n">tc</code><code class="o">.</code><code class="n">name</code><code class="p">,</code> <code class="n">func</code><code class="p">(</code><code class="n">t</code> <code class="o">*</code><code class="n">testing</code><code class="o">.</code><code class="n">T</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">45 </code>			<code class="n">gotRes</code><code class="p">,</code> <code class="n">gotErr</code> <code class="o">:=</code> <code class="n">Adder</code><code class="p">(</code><code class="n">tc</code><code class="o">.</code><code class="n">inputs</code><code class="o">...</code><code class="p">)</code>
<code class="linenos">46 </code>			<code class="k">if</code> <code class="n">gotRes</code> <code class="o">!=</code> <code class="n">tc</code><code class="o">.</code><code class="n">wantRes</code> <code class="p">{</code>
<code class="linenos">47 </code>				<code class="n">t</code><code class="o">.</code><code class="n">Errorf</code><code class="p">(</code><code class="s2">"wanted %v got %v"</code><code class="p">,</code> <code class="n">tc</code><code class="o">.</code><code class="n">wantRes</code><code class="p">,</code> <code class="n">gotRes</code><code class="p">)</code>
<code class="linenos">48 </code>			<code class="p">}</code>
<code class="linenos">49 </code>			<code class="k">if</code> <code class="n">gotErr</code> <code class="o">!=</code> <code class="n">tc</code><code class="o">.</code><code class="n">wantErr</code> <code class="p">{</code>
<code class="linenos">50 </code>				<code class="n">t</code><code class="o">.</code><code class="n">Errorf</code><code class="p">(</code><code class="s2">"wanted error %v got %v"</code><code class="p">,</code> <code class="n">tc</code><code class="o">.</code><code class="n">wantErr</code><code class="p">,</code> <code class="n">gotErr</code><code class="p">)</code>
<code class="linenos">51 </code>			<code class="p">}</code>
<code class="linenos">52 </code>		<code class="p">})</code>
<code class="linenos">53 </code>	<code class="p">}</code>
<code class="linenos">54 </code><code class="p">}</code>
<code class="linenos">55 </code>
<code class="linenos">56 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="mi">2</code><code class="n">NNWfknTbXC</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">===</code> RUN   <code class="nv">TestAdder</code>
<code class="linenos">2 </code><code class="o">===</code> RUN   TestAdder/simple_total
<code class="linenos">3 </code><code class="o">===</code> RUN   TestAdder/overflow_prevented
<code class="linenos">4 </code>--- PASS: TestAdder <code class="o">(</code><code class="m">0</code>.00s<code class="o">)</code>
<code class="linenos">5 </code>    --- PASS: TestAdder/simple_total <code class="o">(</code><code class="m">0</code>.00s<code class="o">)</code>
<code class="linenos">6 </code>    --- PASS: TestAdder/overflow_prevented <code class="o">(</code><code class="m">0</code>.00s<code class="o">)</code>
<code class="linenos">7 </code>PASS
<code class="linenos">8 </code>
<code class="linenos">9 </code>Program exited.
</pre></div>

</figure>


<h3 id="leanpub-auto-example-tests" class="subsection">11.1.5 Example tests</h3>

<p>We’ve already mentioned <i>examples</i> in Chapter 1 when considering documentation. Examples enable us to include interactive code snippets for package functions and receivers, with the documentation for the package. </p>

<p>They don’t contain specific assertions, and they don’t use the <i>testing</i> package itself, but they’re a useful complement to tests, offering us a way to perform comparisons of printed output, without having to capture that output first.</p>

<p>Example functions have an <i>Example</i> name prefix, and live in the same <code>*_test.go</code> files as tests.</p>

<p>We can test both <i>ordered</i> and <i>unordered</i> output, and we illustrate both approaches below. For unordered output, the example test passes as long as all the output is included, the order itself doesn’t matter (ideal for map output). The second example test, requires an exact match, so the test fails since we omitted the square braces in the formatted slice output.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 145 - Examples with ordered and unordered output</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="s2">"fmt"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">func</code> <code class="n">List</code><code class="p">(</code><code class="n">ceil</code> <code class="nb">int</code><code class="p">)</code> <code class="p">[]</code><code class="nb">int</code> <code class="p">{</code>
<code class="linenos"> 6 </code>	<code class="n">var</code> <code class="n">res</code> <code class="p">[]</code><code class="nb">int</code>
<code class="linenos"> 7 </code>	<code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">ceil</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code> <code class="p">{</code>
<code class="linenos"> 8 </code>		<code class="n">res</code> <code class="o">=</code> <code class="n">append</code><code class="p">(</code><code class="n">res</code><code class="p">,</code> <code class="n">i</code><code class="p">)</code>
<code class="linenos"> 9 </code>	<code class="p">}</code>
<code class="linenos">10 </code>	<code class="k">return</code> <code class="n">res</code>
<code class="linenos">11 </code><code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="n">func</code> <code class="n">PrintList</code><code class="p">(</code><code class="nb">list</code> <code class="p">[]</code><code class="nb">int</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">14 </code>	<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="nb">list</code><code class="p">)</code>
<code class="linenos">15 </code><code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="n">func</code> <code class="n">ExampleList</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">18 </code>	<code class="k">for</code> <code class="n">_</code><code class="p">,</code> <code class="n">v</code> <code class="o">:=</code> <code class="nb">range</code> <code class="n">List</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">19 </code>		<code class="n">fmt</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">v</code><code class="p">)</code>
<code class="linenos">20 </code>	<code class="p">}</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code>	<code class="o">//</code> <code class="n">Unordered</code> <code class="n">output</code><code class="p">:</code> <code class="mi">4</code>
<code class="linenos">23 </code>	<code class="o">//</code> <code class="mi">2</code>
<code class="linenos">24 </code>	<code class="o">//</code> <code class="mi">1</code>
<code class="linenos">25 </code>	<code class="o">//</code> <code class="mi">3</code>
<code class="linenos">26 </code>	<code class="o">//</code> <code class="mi">0</code>
<code class="linenos">27 </code><code class="p">}</code>
<code class="linenos">28 </code>
<code class="linenos">29 </code><code class="n">func</code> <code class="n">ExamplePrintList</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">30 </code>	<code class="n">PrintList</code><code class="p">([]</code><code class="nb">int</code><code class="p">{</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">})</code>
<code class="linenos">31 </code>
<code class="linenos">32 </code>	<code class="o">//</code> <code class="n">Output</code><code class="p">:</code> <code class="mi">1</code> <code class="mi">2</code> <code class="mi">3</code> <code class="mi">4</code>
<code class="linenos">33 </code><code class="p">}</code>
<code class="linenos">34 </code>
<code class="linenos">35 </code><code class="o">//</code> <code class="n">Go</code> <code class="n">Playground</code><code class="p">:</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">go</code><code class="o">.</code><code class="n">dev</code><code class="o">/</code><code class="n">play</code><code class="o">/</code><code class="n">p</code><code class="o">/</code><code class="n">RRE5gXK3A87</code>
</pre></div>

</figure>


<p>Output:</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">===</code> RUN   ExampleList
<code class="linenos"> 2 </code>--- PASS: ExampleList <code class="o">(</code><code class="m">0</code>.00s<code class="o">)</code>
<code class="linenos"> 3 </code><code class="o">===</code> RUN   ExamplePrintList
<code class="linenos"> 4 </code>--- FAIL: ExamplePrintList <code class="o">(</code><code class="m">0</code>.00s<code class="o">)</code>
<code class="linenos"> 5 </code>got:
<code class="linenos"> 6 </code><code class="o">[</code><code class="m">1</code> <code class="m">2</code> <code class="m">3</code> <code class="m">4</code><code class="o">]</code>
<code class="linenos"> 7 </code>want:
<code class="linenos"> 8 </code><code class="m">1</code> <code class="m">2</code> <code class="m">3</code> <code class="m">4</code>
<code class="linenos"> 9 </code>FAIL
<code class="linenos">10 </code>
<code class="linenos">11 </code>Program exited
</pre></div>

</figure>


<h2 id="leanpub-auto-benchmarking" class="section">11.2 Benchmarking</h2>

<p>Benchmarks allow us to discover and quantify performance. Using benchmarks we can establish baselines, baselines which can be monitored as development progresses, or compared during efforts to improve the performance of a specific part of our application.</p>

<p>Benchmarking functionality is also provided by the standard library’s <i>testing</i> package. Benchmark functions reside in the same <code>*_test.go</code> files as our tests but functions are named with a <i>Benchmark</i> prefix. They must accept the <code>testing.B</code> struct type which also implements the <code>testing.TB</code> interface.</p>

<p>Benchmarks do not run in the test suite by default, they are executed when the <code>-bench</code> flag is passed with the <code>go test</code> command. This flag accepts a valid regex.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go <code class="nb">test</code> -bench<code class="o">=</code>.
</pre></div>

</figure>


<p>Within each benchmark, the function to be evaluated must be wrapped in a <i>for</i> loop. The upper bound of this loop is denoted by <code>b.N</code>. This is not a value we set. </p>

<p>By default the go test tool will aim to run the benchmarked function for at least one second, if the function completes before the second has elapsed, <code>N</code> will be increased such that the function under test is run more times. This provides a statistically better view of performance by averaging the results of multiple executions.</p>

<p>For longer running functions that may take over a second to complete, it may be desirable to manually increase the benchmarking time so that performance can be averaged over more than a single execution. We can do this by setting the <code>-benchtime</code> flag.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go <code class="nb">test</code> -bench<code class="o">=</code>longfunction -benchtime<code class="o">=</code>10s
</pre></div>

</figure>


<h2 id="leanpub-auto-profiling" class="section">11.3 Profiling</h2>

<p>Profiling is the automated process of measuring the performance characteristics of an application, to identify and remove bottlenecks and improve the performance of slow parts of the program. </p>

<p>Code review alone often isn’t sufficient to identify performance issues, but fortunately, Go provides tools which we can use to gather information about the performance of the executing application - the profiles - and then analyse that information.</p>

<p>There are two types of profiling we can perform. We can gather data from code which is under test, or, we can capture profile data from a slightly modified application during its execution.</p>

<p>Both approaches allow us to obtain information on specific performance characteristics. Which we target will depend on the problems we need to address, but common targets are <i>CPU usage</i>, <i>heap allocations</i> and <i>blocked goroutines</i>.</p>

<h3 id="leanpub-auto-obtaining-profiles-with-the-test-tool" class="subsection">11.3.1 Obtaining profiles with the test tool</h3>

<p>For code which is covered by tests, it’s very simple to obtain a profile by modifying the <code>go test</code> command. This, for example, would create a profile for heap allocations during the test run.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go <code class="nb">test</code> -memprofile<code class="o">=</code>heap.out
</pre></div>

</figure>


<h3 id="leanpub-auto-obtaining-profiles-from-a-running-program" class="subsection">11.3.2 Obtaining profiles from a running program</h3>

<p>For non-test applications, we need to modify the code slightly so that profiles can be obtained.</p>

<p>In this first example, we can obtain CPU profile information when the program exits, the profile data is written to a file <code>cpu.out</code>.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 146 - Modify code to obtain a CPU profile</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>	<code class="s2">"os"</code>
<code class="linenos"> 5 </code>	<code class="s2">"runtime/pprof"</code>
<code class="linenos"> 6 </code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>	<code class="n">f</code><code class="p">,</code> <code class="n">_</code> <code class="o">:=</code> <code class="n">os</code><code class="o">.</code><code class="n">Create</code><code class="p">(</code><code class="s2">"cpu.out"</code><code class="p">)</code>
<code class="linenos">10 </code>	<code class="n">defer</code> <code class="n">f</code><code class="o">.</code><code class="n">Close</code><code class="p">()</code>
<code class="linenos">11 </code>	<code class="n">pprof</code><code class="o">.</code><code class="n">StartCPUProfile</code><code class="p">(</code><code class="n">f</code><code class="p">)</code>
<code class="linenos">12 </code>	<code class="n">defer</code> <code class="n">pprof</code><code class="o">.</code><code class="n">StopCPUProfile</code><code class="p">()</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code>	<code class="o">//</code> <code class="n">rest</code> <code class="n">of</code> <code class="n">the</code> <code class="n">program</code>
<code class="linenos">15 </code><code class="p">}</code>
</pre></div>

</figure>


<p>It’s also possible to obtain profiling information during application execution by creating an HTTP server on a specific port and importing the <i>net/http/pprof</i> package. By adding a profiling server to our program, we can get real-time insights into the performance of our application, and identify and optimize any bottlenecks and performance issues as they occur.</p>


<figure class="code with-caption" dir="ltr">
  <figcaption>Example 147 - Realtime profiling during program execution</figcaption>
  <div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">package</code> <code class="n">main</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="p">(</code>
<code class="linenos"> 4 </code>    <code class="s2">"net/http"</code>
<code class="linenos"> 5 </code>    <code class="n">_</code> <code class="s2">"net/http/pprof"</code>
<code class="linenos"> 6 </code>    <code class="s2">"log"</code>
<code class="linenos"> 7 </code><code class="p">)</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">func</code> <code class="n">main</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">10 </code>    <code class="n">go</code> <code class="n">func</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">11 </code>        <code class="n">log</code><code class="o">.</code><code class="n">Println</code><code class="p">(</code><code class="n">http</code><code class="o">.</code><code class="n">ListenAndServe</code><code class="p">(</code><code class="s2">"localhost:8081"</code><code class="p">,</code> <code class="n">nil</code><code class="p">))</code>
<code class="linenos">12 </code>    <code class="p">}()</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code>    <code class="o">//</code> <code class="n">rest</code> <code class="n">of</code> <code class="n">the</code> <code class="n">program</code>
<code class="linenos">15 </code><code class="p">}</code>
</pre></div>

</figure>


<p>During application execution, the HTTP server exposes profiling data at several endpoints, three of which are listed here.</p>

<p>CPU Profile: http://localhost:8081/debug/pprof/profile<br>Memory profile: http://localhost:8081/debug/pprof/heap<br>Blocking profile: http://localhost:8081/debug/pprof/block</p>

<h3 id="leanpub-auto-analysing-a-profile-with-the-pprof-tool" class="subsection">11.3.3 Analysing a profile with the pprof tool</h3>

<p>Whichever method we use to obtain the profile, and regardless of profile type, to make sense of the information we need to use pprof.</p>

<p>The <i>pprof</i> tool is a command line tool that is used to analyse and visualise profiling data.  Pprof offers several ways to visualise the information which include. </p>

<ul>
  <li>
<b>Text</b>. Provides function performance statistics in a simple text format.</li>
  <li>
<b>Graphical</b>. The function call graph, with the box size used to represent execution time.</li>
  <li>
<b>Flame</b>. The relative contribution of each function to execution time in a horizontal bar graph.</li>
</ul>

<p>In the example below we specify we want text output, and pass both the profile file <code>cpu.out</code> and the compiled application to pprof. The latter is required since profile output omits function names, using their addresses instead.  Having the compiled application pprof can cross reference the address to the function name.</p>


<figure class="code " dir="ltr">
  <figcaption></figcaption>
  <div class="highlight"><pre><code></code><code class="linenos">1 </code>go tool pprof -text ./myprogram.test cpu.out
</pre></div>

</figure>


<aside class="information blurb">
    <p>When generating profiles using <code>go test</code> the compiled application will not be discarded after a test run. Instead, it is saved with the <code>.test</code> extension so it can be shared with the pprof tool.</p>

</aside>


<h1 id="leanpub-auto-glossary" class="chapter">Glossary</h1>

<p>API     - Application Programming Interface<br>CLI     - Command Line Interface<br>CPU     - Central Processing Unit<br>CRUD    - Create, Read, Update, Delete<br>FIFO    - First In First Out<br>IDE     - Integrated Development Environment<br>JSON    - JavaScript Object Notation<br>LIFO    - Last In First Out<br>NOOP    - No Operation<br>OOP     - Object-Oriented Programming<br>OS      - Operating System<br>REST    - Representational State Transfer<br>Stdout  - Standard Out<br>URL     - Uniform Resource Locator</p>

</div>
</body>
</html>
